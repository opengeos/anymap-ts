import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */import{h as F}from"./maplibre-gl-C9tqRo8a.js";import{L as ft}from"./maplibre-gl-layer-control-CbPNLzzp.js";import{D as Wt}from"./DeckLayerAdapter-CEH0-YJh.js";import{p as At,a2 as j,a1 as yt,$ as Ct,C as X,M as Ot}from"./mapbox-overlay-B3MFwkdI.js";import{W as x,C as St,A as _t,g as bt}from"./bounds-utils-CI_7BikO.js";import{P as Pt}from"./path-layer-DtS7etqG.js";import{S as Tt}from"./solid-polygon-layer-B9GT7vH1.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./preload-helper-PPVm8Dsz.js";import"./composite-layer-CqqfW37O.js";import"./cut-by-mercator-bounds-BIiGNyZq.js";import"./picking-CN0D5Hbh.js";import"./geometry-BcGx-jYG.js";import"./polygon-utils-B8iYQ3Og.js";import"./gouraud-material-DQO3ZmEl.js";import"./lighting-DGLKbg-X.js";import"./phong-shaders-wgsl-3FV41e28.js";const o=.5,n=1/6,t={N:[0,o],E:[o,0],S:[0,-o],W:[-o,0],NE:[o,o],NW:[-o,o],SE:[o,-o],SW:[-o,-o]},C=[t.W,t.SW,t.S],O=[t.S,t.SE,t.E],_=[t.E,t.NE,t.N],b=[t.NW,t.W,t.N],P=[[-o,n],[-o,-n],[-n,-o],[n,-o]],T=[[-n,-o],[n,-o],[o,-n],[o,n]],L=[[o,-n],[o,n],[n,o],[-n,o]],v=[[-o,n],[-o,-n],[n,o],[-n,o]],Y=[t.W,t.SW,t.SE,t.E],Z=[t.S,t.SE,t.NE,t.N],q=[t.NW,t.W,t.E,t.NE],K=[t.NW,t.SW,t.S,t.N],Q=[[-o,n],[-o,-n],[o,-n],[o,n]],$=[[-n,-o],[n,-o],[n,o],[-n,o]],Lt=[t.NW,t.SW,t.SE,t.NE],J=[t.NW,t.SW,t.SE,t.E,t.N],tt=[t.W,t.SW,t.SE,t.NE,t.N],ot=[t.NW,t.W,t.S,t.SE,t.NE],et=[t.NW,t.SW,t.S,t.E,t.NE],nt=[t.NW,t.W,[o,-n],[o,n],t.N],st=[[-n,-o],[n,-o],t.E,t.NE,t.N],rt=[[-o,n],[-o,-n],t.S,t.SE,t.E],it=[t.W,t.SW,t.S,[n,o],[-n,o]],at=[t.NW,t.W,[-n,-o],[n,-o],t.N],ct=[[-o,n],[-o,-n],t.E,t.NE,t.N],lt=[t.S,t.SE,t.E,[n,o],[-n,o]],gt=[t.W,t.SW,t.S,[o,-n],[o,n]],ut=[t.W,t.SW,t.SE,t.E,[n,o],[-n,o]],dt=[[-o,n],[-o,-n],t.S,t.SE,t.NE,t.N],pt=[t.NW,t.W,[-n,-o],[n,-o],t.E,t.NE],Nt=[t.NW,t.SW,t.S,[o,-n],[o,n],t.N],w=[t.W,t.SW,t.S,t.E,t.NE,t.N],G=[t.NW,t.W,t.S,t.SE,t.E,t.N],z=[[-o,n],[-o,-n],[-n,-o],[n,-o],t.E,t.NE,t.N],D=[t.W,t.SW,t.S,[o,-n],[o,n],[n,o],[-n,o]],B=[t.NW,t.W,[-n,-o],[n,-o],[o,-n],[o,n],t.N],k=[[-o,n],[-o,-n],t.S,t.SE,t.E,[n,o],[-n,o]],Et=[[-o,n],[-o,-n],[-n,-o],[n,-o],[o,-n],[o,n],[n,o],[-n,o]],vt={0:[],1:[[t.W,t.S]],2:[[t.S,t.E]],3:[[t.W,t.E]],4:[[t.N,t.E]],5:{0:[[t.W,t.S],[t.N,t.E]],1:[[t.W,t.N],[t.S,t.E]]},6:[[t.N,t.S]],7:[[t.W,t.N]],8:[[t.W,t.N]],9:[[t.N,t.S]],10:{0:[[t.W,t.N],[t.S,t.E]],1:[[t.W,t.S],[t.N,t.E]]},11:[[t.N,t.E]],12:[[t.W,t.E]],13:[[t.S,t.E]],14:[[t.W,t.S]],15:[]};function e(g){return parseInt(g,4)}const wt={[e("0000")]:[],[e("2222")]:[],[e("2221")]:[C],[e("2212")]:[O],[e("2122")]:[_],[e("1222")]:[b],[e("0001")]:[C],[e("0010")]:[O],[e("0100")]:[_],[e("1000")]:[b],[e("2220")]:[P],[e("2202")]:[T],[e("2022")]:[L],[e("0222")]:[v],[e("0002")]:[P],[e("0020")]:[T],[e("0200")]:[L],[e("2000")]:[v],[e("0011")]:[Y],[e("0110")]:[Z],[e("1100")]:[q],[e("1001")]:[K],[e("2211")]:[Y],[e("2112")]:[Z],[e("1122")]:[q],[e("1221")]:[K],[e("2200")]:[Q],[e("2002")]:[$],[e("0022")]:[Q],[e("0220")]:[$],[e("1111")]:[Lt],[e("1211")]:[J],[e("2111")]:[tt],[e("1112")]:[ot],[e("1121")]:[et],[e("1011")]:[J],[e("0111")]:[tt],[e("1110")]:[ot],[e("1101")]:[et],[e("1200")]:[nt],[e("0120")]:[st],[e("0012")]:[rt],[e("2001")]:[it],[e("1022")]:[nt],[e("2102")]:[st],[e("2210")]:[rt],[e("0221")]:[it],[e("1002")]:[at],[e("2100")]:[ct],[e("0210")]:[lt],[e("0021")]:[gt],[e("1220")]:[at],[e("0122")]:[ct],[e("2012")]:[lt],[e("2201")]:[gt],[e("0211")]:[ut],[e("2110")]:[dt],[e("1102")]:[pt],[e("1021")]:[Nt],[e("2011")]:[ut],[e("0112")]:[dt],[e("1120")]:[pt],[e("1201")]:[Nt],[e("2101")]:[w],[e("0121")]:[w],[e("1012")]:[G],[e("1210")]:[G],[e("0101")]:{0:[C,_],1:[w],2:[w]},[e("1010")]:{0:[b,O],1:[G],2:[G]},[e("2121")]:{0:[w],1:[w],2:[C,_]},[e("1212")]:{0:[G],1:[G],2:[b,O]},[e("2120")]:{0:[z],1:[z],2:[P,_]},[e("2021")]:{0:[D],1:[D],2:[C,L]},[e("1202")]:{0:[B],1:[B],2:[b,T]},[e("0212")]:{0:[k],1:[k],2:[O,v]},[e("0102")]:{0:[P,_],1:[z],2:[z]},[e("0201")]:{0:[C,L],1:[D],2:[D]},[e("1020")]:{0:[b,T],1:[B],2:[B]},[e("2010")]:{0:[O,v],1:[k],2:[k]},[e("2020")]:{0:[v,T],1:[Et],2:[P,L]},[e("0202")]:{0:[L,P],1:[Et],2:[v,T]}};function I(g,s){return Number.isNaN(g)?0:Array.isArray(s)?g<s[0]?0:g<s[1]?1:2:g>=s?1:0}function Gt(g){const{x:s,y:r,xRange:i,yRange:a,getValue:c,threshold:l}=g,N=s<i[0],u=s>=i[1]-1,d=r<a[0],h=r>=a[1]-1,S=N||u||d||h;let p=0,E,f,y,A;if(N||h)y=0;else{const m=c(s,r+1);y=I(m,l),p+=m}if(u||h)A=0;else{const m=c(s+1,r+1);A=I(m,l),p+=m}if(u||d)f=0;else{const m=c(s+1,r);f=I(m,l),p+=m}if(N||d)E=0;else{const m=c(s,r);E=I(m,l),p+=m}let W=-1;Number.isFinite(l)&&(W=y<<3|A<<2|f<<1|E),Array.isArray(l)&&(W=y<<6|A<<4|f<<2|E);let M=0;return S||(M=I(p/4,l)),{code:W,meanCode:M}}function Rt(g){const{x:s,y:r,z:i,code:a,meanCode:c}=g;let l=wt[a];Array.isArray(l)||(l=l[c]);const N=s+1,u=r+1,d=[];return l.forEach(h=>{const S=[];h.forEach(p=>{const E=N+p[0],f=u+p[1];S.push([E,f,i])}),d.push(S)}),d}function It(g){const{x:s,y:r,z:i,code:a,meanCode:c}=g;let l=vt[a];Array.isArray(l)||(l=l[c]);const N=s+1,u=r+1,d=[];return l.forEach(h=>{h.forEach(S=>{const p=N+S[0],E=u+S[1];d.push([p,E,i])})}),d}function Mt({contours:g,getValue:s,xRange:r,yRange:i}){const a=[],c=[];let l=0,N=0;for(let u=0;u<g.length;u++){const d=g[u],h=d.zIndex??u,{threshold:S}=d;for(let p=r[0]-1;p<r[1];p++)for(let E=i[0]-1;E<i[1];E++){const{code:f,meanCode:y}=Gt({getValue:s,threshold:S,x:p,y:E,xRange:r,yRange:i}),A={x:p,y:E,z:h,code:f,meanCode:y};if(Array.isArray(S)){const W=Rt(A);for(const M of W)c[N++]={vertices:M,contour:d}}else{const W=It(A);W.length>0&&(a[l++]={vertices:W,contour:d})}}}return{lines:a,polygons:c}}function zt(g){const{aggregator:s,binIdRange:r,channel:i}=g;if(s instanceof x){const a=s.getResult(i)?.buffer;if(a){const c=new Float32Array(a.readSyncWebGL().buffer);return Dt(c,r)}}if(s instanceof St){const a=s.getResult(i)?.value,c=s.getBins()?.value;if(c&&a)return Bt(a,c,s.binCount)}return null}function Dt(g,s){const[[r,i],[a,c]]=s,l=i-r,N=c-a;return(u,d)=>(u-=r,d-=a,u<0||u>=l||d<0||d>=N?NaN:g[d*l+u])}function Bt(g,s,r){const i={};for(let a=0;a<r;a++){const c=s[a*2],l=s[a*2+1];i[c]=i[c]||{},i[c][l]=g[a]}return(a,c)=>i[a]?.[c]??NaN}const kt=`uniform binOptionsUniforms {
  vec2 cellOriginCommon;
  vec2 cellSizeCommon;
} binOptions;
`,xt={name:"binOptions",vs:kt,uniformTypes:{cellOriginCommon:"vec2<f32>",cellSizeCommon:"vec2<f32>"}},ht=[255,255,255,255],Ft=1,Ut={cellSize:{type:"number",min:1,value:1e3},gridOrigin:{type:"array",compare:!0,value:[0,0]},getPosition:{type:"accessor",value:g=>g.position},getWeight:{type:"accessor",value:1},gpuAggregation:!0,aggregation:"SUM",contours:{type:"object",value:[{threshold:1}],optional:!0,compare:3},zOffset:.005};class U extends _t{getAggregatorType(){return this.props.gpuAggregation&&x.isSupported(this.context.device)?"gpu":"cpu"}createAggregator(s){return s==="cpu"?new St({dimensions:2,getBin:{sources:["positions"],getValue:({positions:r},i,a)=>{const l=this.state.aggregatorViewport.projectPosition(r),{cellSizeCommon:N,cellOriginCommon:u}=a;return[Math.floor((l[0]-u[0])/N[0]),Math.floor((l[1]-u[1])/N[1])]}},getValue:[{sources:["counts"],getValue:({counts:r})=>r}],onUpdate:this._onAggregationUpdate.bind(this)}):new x(this.context.device,{dimensions:2,channelCount:1,bufferLayout:this.getAttributeManager().getBufferLayouts({isInstanced:!1}),...super.getShaders({modules:[At,xt],vs:`
  in vec3 positions;
  in vec3 positions64Low;
  in float counts;

  void getBin(out ivec2 binId) {
    vec3 positionCommon = project_position(positions, positions64Low);
    vec2 gridCoords = floor(positionCommon.xy / binOptions.cellSizeCommon);
    binId = ivec2(gridCoords);
  }
  void getValue(out float value) {
    value = counts;
  }
  `}),onUpdate:this._onAggregationUpdate.bind(this)})}initializeState(){super.initializeState(),this.getAttributeManager().add({positions:{size:3,accessor:"getPosition",type:"float64",fp64:this.use64bitPositions()},counts:{size:1,accessor:"getWeight"}})}updateState(s){const r=super.updateState(s),{props:i,oldProps:a,changeFlags:c}=s,{aggregator:l}=this.state;if(r||c.dataChanged||i.cellSize!==a.cellSize||!j(i.gridOrigin,a.gridOrigin,1)||i.aggregation!==a.aggregation){this._updateBinOptions();const{cellSizeCommon:N,cellOriginCommon:u,binIdRange:d}=this.state;l.setProps({binIdRange:d,pointCount:this.getNumInstances(),operations:[i.aggregation],binOptions:{cellSizeCommon:N,cellOriginCommon:u}})}return j(a.contours,i.contours,2)||this.setState({contourData:null}),r}_updateBinOptions(){const s=this.getBounds(),r=[1,1];let i=[0,0],a=[[0,1],[0,1]],c=this.context.viewport;if(s&&Number.isFinite(s[0][0])){let l=[(s[0][0]+s[1][0])/2,(s[0][1]+s[1][1])/2];const{cellSize:N,gridOrigin:u}=this.props,{unitsPerMeter:d}=c.getDistanceScales(l);r[0]=d[0]*N,r[1]=d[1]*N;const h=c.projectFlat(l);i=[Math.floor((h[0]-u[0])/r[0])*r[0]+u[0],Math.floor((h[1]-u[1])/r[1])*r[1]+u[1]],l=c.unprojectFlat(i);const S=c.constructor;c=c.isGeospatial?new S({longitude:l[0],latitude:l[1],zoom:12}):new yt({position:[l[0],l[1],0],zoom:12}),i=[Math.fround(c.center[0]),Math.fround(c.center[1])],a=bt({dataBounds:s,getBinId:p=>{const E=c.projectFlat(p);return[Math.floor((E[0]-i[0])/r[0]),Math.floor((E[1]-i[1])/r[1])]}})}this.setState({cellSizeCommon:r,cellOriginCommon:i,binIdRange:a,aggregatorViewport:c})}draw(s){s.shaderModuleProps.project&&(s.shaderModuleProps.project.viewport=this.state.aggregatorViewport),super.draw(s)}_onAggregationUpdate(){const{aggregator:s,binIdRange:r}=this.state;this.setState({aggregatedValueReader:zt({aggregator:s,binIdRange:r,channel:0}),contourData:null})}_getContours(){const{aggregatedValueReader:s}=this.state;if(!s)return null;if(!this.state.contourData){const{binIdRange:r}=this.state,{contours:i}=this.props,a=Mt({contours:i,getValue:s,xRange:r[0],yRange:r[1]});this.state.contourData=a}return this.state.contourData}onAttributeChange(s){const{aggregator:r}=this.state;switch(s){case"positions":r.setNeedsUpdate(),this._updateBinOptions();const{cellSizeCommon:i,cellOriginCommon:a,binIdRange:c}=this.state;r.setProps({binIdRange:c,binOptions:{cellSizeCommon:i,cellOriginCommon:a}});break;case"counts":r.setNeedsUpdate(0);break}}renderLayers(){const s=this._getContours();if(!s)return null;const{lines:r,polygons:i}=s,{zOffset:a}=this.props,{cellOriginCommon:c,cellSizeCommon:l}=this.state,N=this.getSubLayerClass("lines",Pt),u=this.getSubLayerClass("bands",Tt),d=new Ct().translate([c[0],c[1],0]).scale([l[0],l[1],a]),h=r&&r.length>0&&new N(this.getSubLayerProps({id:"lines"}),{data:r,coordinateSystem:X.CARTESIAN,modelMatrix:d,getPath:p=>p.vertices,getColor:p=>p.contour.color??ht,getWidth:p=>p.contour.strokeWidth??Ft,widthUnits:"pixels"}),S=i&&i.length>0&&new u(this.getSubLayerProps({id:"bands"}),{data:i,coordinateSystem:X.CARTESIAN,modelMatrix:d,getPolygon:p=>p.vertices,getFillColor:p=>p.contour.color??ht});return[h,S]}getPickingInfo(s){const r=s.info,{object:i}=r;return i&&(r.object={contour:i.contour}),r}}U.layerName="ContourLayer";U.defaultProps=Ut;function Vt(g=2e3){const s=[{center:[-122.4194,37.7749],spread:.02,weight:1.5},{center:[-122.2711,37.8044],spread:.015,weight:1.2},{center:[-122.2727,37.8716],spread:.01,weight:1},{center:[-122.4098,37.7855],spread:.008,weight:2},{center:[-122.4534,37.8083],spread:.01,weight:.8},{center:[-122.3894,37.7866],spread:.01,weight:1.3}],r=[];for(let i=0;i<g;i++){const a=s[Math.floor(Math.random()*s.length)],c=Math.random()*Math.PI*2,l=Math.random()*a.spread,N=a.center[0]+Math.cos(c)*l,u=a.center[1]+Math.sin(c)*l;r.push({coordinates:[N,u],weight:Math.random()*a.weight+.5})}return r}const Ht=Vt(),jt=[{threshold:1,color:[255,255,178],strokeWidth:1},{threshold:5,color:[254,217,118],strokeWidth:1},{threshold:10,color:[254,178,76],strokeWidth:2},{threshold:20,color:[253,141,60],strokeWidth:2},{threshold:40,color:[252,78,42],strokeWidth:3},{threshold:60,color:[227,26,28],strokeWidth:3},{threshold:80,color:[189,0,38],strokeWidth:4}],R=new F.Map({container:"map",style:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",center:[-122.35,37.8],zoom:11});R.addControl(new F.NavigationControl,"top-right");R.addControl(new F.ScaleControl({unit:"metric"}),"bottom-right");const V=new Ot({layers:[]}),H=new Map,mt=new Wt(R,V,H);function Xt(){V.setProps({layers:Array.from(H.values())})}function Yt(){const g="contour-density",s=new U({id:g,data:Ht,pickable:!0,cellSize:200,contours:jt,getPosition:r=>r.coordinates,getWeight:r=>r.weight,aggregation:"SUM"});H.set(g,s),Xt(),mt.notifyLayerAdded(g)}R.on("load",()=>{R.addControl(V);const g=new ft({collapsed:!0,customLayerAdapters:[mt],panelWidth:360});R.addControl(g,"top-right"),Yt()});
