var Js=Object.defineProperty;var Ks=(s,t,e)=>t in s?Js(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var u=(s,t,e)=>Ks(s,typeof t!="symbol"?t+"":t,e);import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */import{m as he}from"./maplibre-gl-BTjYUjN0.js";import{L as tn}from"./maplibre-gl-layer-control-Bv-vXquT.js";import{D as en}from"./DeckLayerAdapter-DCj5phjl.js";import{L as sn,V as nn,i as rn,h as Vt,j as Lt,t as on,v as an,k as cn,m as ln,n as hn,o as un,p as dn,q as fn,r as f,s as ft,f as se,u as pn,x as gn,e as A,y as M,z as W,A as bt,B as ds,S as mn,D as Tn,E as yn,F as _n,d as Sn,C as qt,M as wn}from"./mapbox-overlay-CtMyNbGZ.js";import{S as En}from"./simple-mesh-layer-DMpXXWYs.js";import{p as bn,a as Cn,b as ue,D as In,G as fs,c as ps,g as gs,S as An}from"./scenegraph-layer-B2ulXbhj.js";import{C as Ln}from"./composite-layer-D5nYxRM9.js";import{E as Mn,a as Nn,b as Rn,C as Dt,P as ht,O as ms,B as Ts,R as Pn,m as On}from"./bounding-box-from-points-BWnryCDX.js";import{Q as ys,M as _s}from"./quaternion-BcOn_HKL.js";import{P as Un}from"./point-cloud-layer-BYzSvbzY.js";import{G as Dn}from"./geometry-CwO1uo58.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./matrix-Dj0fRW-l.js";import"./picking-CN0D5Hbh.js";import"./phong-material-BoTCu5o1.js";import"./lighting-p30x1bFT.js";import"./phong-shaders-wgsl-3FV41e28.js";import"./color-CUNNsFV-.js";import"./gouraud-material-NoqXAwxE.js";globalThis.probe={};const Ss=new sn({id:"@probe.gl/log"});class de extends nn{constructor(t=0,e=0){super(2),rn(t)&&arguments.length===1?this.copy(t):(Vt.debug&&(Lt(t),Lt(e)),this[0]=t,this[1]=e)}set(t,e){return this[0]=t,this[1]=e,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this.check()}fromObject(t){return Vt.debug&&(Lt(t.x),Lt(t.y)),this[0]=t.x,this[1]=t.y,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return on(this,this,t),this.check()}transformAsVector(t){return an(this,this,t),this.check()}transformByMatrix3(t){return cn(this,this,t),this.check()}transformByMatrix2x3(t){return ln(this,this,t),this.check()}transformByMatrix2(t){return hn(this,this,t),this.check()}}const Ie=`uniform meshUniforms {
  bool pickFeatureIds;
} mesh;
`,vn={name:"mesh",vs:Ie,fs:Ie,uniformTypes:{pickFeatureIds:"f32"}},xn=`#version 300 es
#define SHADER_NAME simple-mesh-layer-vs
in vec3 positions;
in vec3 normals;
in vec3 colors;
in vec2 texCoords;
in vec4 uvRegions;
in vec3 featureIdsPickingColors;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec3 instanceModelMatrixCol0;
in vec3 instanceModelMatrixCol1;
in vec3 instanceModelMatrixCol2;
out vec2 vTexCoord;
out vec3 cameraPosition;
out vec3 normals_commonspace;
out vec4 position_commonspace;
out vec4 vColor;
vec2 applyUVRegion(vec2 uv) {
#ifdef HAS_UV_REGIONS
return fract(uv) * (uvRegions.zw - uvRegions.xy) + uvRegions.xy;
#else
return uv;
#endif
}
void main(void) {
vec2 uv = applyUVRegion(texCoords);
geometry.uv = uv;
if (mesh.pickFeatureIds) {
geometry.pickingColor = featureIdsPickingColors;
} else {
geometry.pickingColor = instancePickingColors;
}
mat3 instanceModelMatrix = mat3(instanceModelMatrixCol0, instanceModelMatrixCol1, instanceModelMatrixCol2);
vTexCoord = uv;
cameraPosition = project.cameraPosition;
vColor = vec4(colors * instanceColors.rgb, instanceColors.a);
vec3 pos = (instanceModelMatrix * positions) * simpleMesh.sizeScale;
vec3 projectedPosition = project_position(positions);
position_commonspace = vec4(projectedPosition, 1.0);
gl_Position = project_common_position_to_clipspace(position_commonspace);
geometry.position = position_commonspace;
normals_commonspace = project_normal(instanceModelMatrix * normals);
geometry.normal = normals_commonspace;
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
#ifdef MODULE_PBRMATERIAL
pbr_vPosition = geometry.position.xyz;
#ifdef HAS_NORMALS
pbr_vNormal = geometry.normal;
#endif
#ifdef HAS_UV
pbr_vUV = uv;
#else
pbr_vUV = vec2(0., 0.);
#endif
geometry.uv = pbr_vUV;
#endif
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Vn=`#version 300 es
#define SHADER_NAME simple-mesh-layer-fs
precision highp float;
uniform sampler2D sampler;
in vec2 vTexCoord;
in vec3 cameraPosition;
in vec3 normals_commonspace;
in vec4 position_commonspace;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
#ifdef MODULE_PBRMATERIAL
fragColor = vColor * pbr_filterColor(vec4(0));
geometry.uv = pbr_vUV;
fragColor.a *= layer.opacity;
#else
geometry.uv = vTexCoord;
vec3 normal;
if (simpleMesh.flatShading) {
normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));
} else {
normal = normals_commonspace;
}
vec4 color = simpleMesh.hasTexture ? texture(sampler, vTexCoord) : vColor;
vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);
fragColor = vec4(lightColor, color.a * layer.opacity);
#endif
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`;function Bn(s){const t=s.positions||s.POSITION,e=t.value.length/t.size;s.COLOR_0||s.colors||(s.colors={size:4,value:new Uint8Array(e*4).fill(255),normalized:!0})}const Fn={pbrMaterial:{type:"object",value:null},featureIds:{type:"array",value:null,optional:!0}};class fe extends En{getShaders(){const t=super.getShaders();return t.modules.push(bn,vn),{...t,vs:xn,fs:Vn}}initializeState(){const{featureIds:t}=this.props;super.initializeState();const e=this.getAttributeManager();t&&e.add({featureIdsPickingColors:{type:"uint8",size:3,noAlloc:!0,update:this.calculateFeatureIdsPickingColors}})}updateState(t){super.updateState(t);const{props:e,oldProps:n}=t;e.pbrMaterial!==n.pbrMaterial&&this.updatePbrMaterialUniforms(e.pbrMaterial)}draw(t){const{featureIds:e}=this.props,{model:n}=this.state;if(!n)return;const r={pickFeatureIds:!!e},i={camera:this.context.viewport.cameraPosition};n.shaderInputs.setProps({pbrProjection:i,mesh:r}),super.draw(t)}getModel(t){const{id:e}=this.props,n=this.parseMaterial(this.props.pbrMaterial,t);this.setState({parsedPBRMaterial:n});const r=this.getShaders();return Bn(t.attributes),new un(this.context.device,{...this.getShaders(),id:e,geometry:t,bufferLayout:this.getAttributeManager().getBufferLayouts(),defines:{...r.defines,...n==null?void 0:n.defines,HAS_UV_REGIONS:t.attributes.uvRegions?1:0},parameters:n==null?void 0:n.parameters,isInstanced:!0})}updatePbrMaterialUniforms(t){const{model:e}=this.state;if(e){const{mesh:n}=this.props,r=this.parseMaterial(t,n);this.setState({parsedPBRMaterial:r});const{pbr_baseColorSampler:i}=r.bindings,{emptyTexture:o}=this.state,a={sampler:i||o,hasTexture:!!i},{camera:l,...c}={...r.bindings,...r.uniforms};e.shaderInputs.setProps({simpleMesh:a,pbrMaterial:c})}}parseMaterial(t,e){const n=!!(t.pbrMetallicRoughness&&t.pbrMetallicRoughness.baseColorTexture);return Cn(this.context.device,{unlit:n,...t},{NORMAL:e.attributes.normals,TEXCOORD_0:e.attributes.texCoords},{pbrDebug:!1,lights:!0,useTangents:!1})}calculateFeatureIdsPickingColors(t){const e=this.props.featureIds,n=new Uint8ClampedArray(e.length*t.size),r=[];for(let i=0;i<e.length;i++)this.encodePickingColor(e[i],r),n[i*3]=r[0],n[i*3+1]=r[1],n[i*3+2]=r[2];t.value=n}finalizeState(t){var e;super.finalizeState(t),(e=this.state.parsedPBRMaterial)==null||e.generatedTextures.forEach(n=>n.destroy()),this.setState({parsedPBRMaterial:null})}}fe.layerName="MeshLayer";fe.defaultProps=Fn;const zn=6378137,Gn=6378137,qn=6356752314245179e-9;function Ft(s){return s}new f;function kn(s,t=[],e=Ft){return"longitude"in s?(t[0]=e(s.longitude),t[1]=e(s.latitude),t[2]=s.height):"x"in s?(t[0]=e(s.x),t[1]=e(s.y),t[2]=s.z):(t[0]=e(s[0]),t[1]=e(s[1]),t[2]=s[2]),t}function Hn(s,t=[]){return kn(s,t,Vt._cartographicRadians?Ft:fn)}function Zn(s,t,e=Ft){return"longitude"in t?(t.longitude=e(s[0]),t.latitude=e(s[1]),t.height=s[2]):"x"in t?(t.x=e(s[0]),t.y=e(s[1]),t.z=s[2]):(t[0]=e(s[0]),t[1]=e(s[1]),t[2]=s[2]),t}function jn(s,t){return Zn(s,t,Vt._cartographicRadians?Ft:dn)}const Ae=1e-14,$n=new f,Le={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},kt={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},St={east:new f,north:new f,up:new f,west:new f,south:new f,down:new f},Wn=new f,Yn=new f,Xn=new f;function Me(s,t,e,n,r,i){const o=Le[t]&&Le[t][e];ft(o&&(!n||n===o));let a,l,c;const h=$n.copy(r);if(se(h.x,0,Ae)&&se(h.y,0,Ae)){const g=Math.sign(h.z);a=Wn.fromArray(kt[t]),t!=="east"&&t!=="west"&&a.scale(g),l=Yn.fromArray(kt[e]),e!=="east"&&e!=="west"&&l.scale(g),c=Xn.fromArray(kt[n]),n!=="east"&&n!=="west"&&c.scale(g)}else{const{up:g,east:m,north:T}=St;m.set(-h.y,h.x,0).normalize(),s.geodeticSurfaceNormal(h,g),T.copy(g).cross(m);const{down:y,west:b,south:E}=St;y.copy(g).scale(-1),b.copy(m).scale(-1),E.copy(T).scale(-1),a=St[t],l=St[e],c=St[n]}return i[0]=a.x,i[1]=a.y,i[2]=a.z,i[3]=0,i[4]=l.x,i[5]=l.y,i[6]=l.z,i[7]=0,i[8]=c.x,i[9]=c.y,i[10]=c.z,i[11]=0,i[12]=h.x,i[13]=h.y,i[14]=h.z,i[15]=1,i}const ut=new f,Qn=new f,Jn=new f;function Kn(s,t,e=[]){const{oneOverRadii:n,oneOverRadiiSquared:r,centerToleranceSquared:i}=t;ut.from(s);const o=ut.x,a=ut.y,l=ut.z,c=n.x,h=n.y,d=n.z,g=o*o*c*c,m=a*a*h*h,T=l*l*d*d,y=g+m+T,b=Math.sqrt(1/y);if(!Number.isFinite(b))return;const E=Qn;if(E.copy(s).scale(b),y<i)return E.to(e);const I=r.x,R=r.y,D=r.z,B=Jn;B.set(E.x*I*2,E.y*R*2,E.z*D*2);let P=(1-b)*ut.len()/(.5*B.len()),Q=0,z,N,$,tt;do{P-=Q,z=1/(1+P*I),N=1/(1+P*R),$=1/(1+P*D);const ct=z*z,Ct=N*N,et=$*$,yt=ct*z,_t=Ct*N,lt=et*$;tt=g*ct+m*Ct+T*et-1;const Ce=-2*(g*yt*I+m*_t*R+T*lt*D);Q=tt/Ce}while(Math.abs(tt)>Mn);return ut.scale([z,N,$]).to(e)}const Mt=new f,Ne=new f,tr=new f,H=new f,er=new f,Nt=new f;class C{constructor(t=0,e=0,n=0){this.centerToleranceSquared=Nn,ft(t>=0),ft(e>=0),ft(n>=0),this.radii=new f(t,e,n),this.radiiSquared=new f(t*t,e*e,n*n),this.radiiToTheFourth=new f(t*t*t*t,e*e*e*e,n*n*n*n),this.oneOverRadii=new f(t===0?0:1/t,e===0?0:1/e,n===0?0:1/n),this.oneOverRadiiSquared=new f(t===0?0:1/(t*t),e===0?0:1/(e*e),n===0?0:1/(n*n)),this.minimumRadius=Math.min(t,e,n),this.maximumRadius=Math.max(t,e,n),this.radiiSquared.z!==0&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}equals(t){return this===t||!!(t&&this.radii.equals(t.radii))}toString(){return this.radii.toString()}cartographicToCartesian(t,e=[0,0,0]){const n=Ne,r=tr,[,,i]=t;this.geodeticSurfaceNormalCartographic(t,n),r.copy(this.radiiSquared).scale(n);const o=Math.sqrt(n.dot(r));return r.scale(1/o),n.scale(i),r.add(n),r.to(e)}cartesianToCartographic(t,e=[0,0,0]){Nt.from(t);const n=this.scaleToGeodeticSurface(Nt,H);if(!n)return;const r=this.geodeticSurfaceNormal(n,Ne),i=er;i.copy(Nt).subtract(n);const o=Math.atan2(r.y,r.x),a=Math.asin(r.z),l=Math.sign(pn(i,Nt))*gn(i);return jn([o,a,l],e)}eastNorthUpToFixedFrame(t,e=new A){return Me(this,"east","north","up",t,e)}localFrameToFixedFrame(t,e,n,r,i=new A){return Me(this,t,e,n,r,i)}geocentricSurfaceNormal(t,e=[0,0,0]){return Mt.from(t).normalize().to(e)}geodeticSurfaceNormalCartographic(t,e=[0,0,0]){const n=Hn(t),r=n[0],i=n[1],o=Math.cos(i);return Mt.set(o*Math.cos(r),o*Math.sin(r),Math.sin(i)).normalize(),Mt.to(e)}geodeticSurfaceNormal(t,e=[0,0,0]){return Mt.from(t).scale(this.oneOverRadiiSquared).normalize().to(e)}scaleToGeodeticSurface(t,e){return Kn(t,this,e)}scaleToGeocentricSurface(t,e=[0,0,0]){H.from(t);const n=H.x,r=H.y,i=H.z,o=this.oneOverRadiiSquared,a=1/Math.sqrt(n*n*o.x+r*r*o.y+i*i*o.z);return H.multiplyScalar(a).to(e)}transformPositionToScaledSpace(t,e=[0,0,0]){return H.from(t).scale(this.oneOverRadii).to(e)}transformPositionFromScaledSpace(t,e=[0,0,0]){return H.from(t).scale(this.radii).to(e)}getSurfaceNormalIntersectionWithZAxis(t,e=0,n=[0,0,0]){ft(se(this.radii.x,this.radii.y,Rn)),ft(this.radii.z>0),H.from(t);const r=H.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(r)>=this.radii.z-e))return H.set(0,0,r).to(n)}}C.WGS84=new C(zn,Gn,qn);class sr{constructor(t,e,n){u(this,"item");u(this,"previous");u(this,"next");this.item=t,this.previous=e,this.next=n}}class nr{constructor(){u(this,"head",null);u(this,"tail",null);u(this,"_length",0)}get length(){return this._length}add(t){const e=new sr(t,this.tail,null);return this.tail?(this.tail.next=e,this.tail=e):(this.head=e,this.tail=e),++this._length,e}remove(t){t&&(t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=null,this.tail=t.previous):t.next?(t.next.previous=null,this.head=t.next):(this.head=null,this.tail=null),t.next=null,t.previous=null,--this._length)}splice(t,e){t!==e&&(this.remove(e),this._insert(t,e))}_insert(t,e){const n=t.next;t.next=e,this.tail===t?this.tail=e:n.previous=e,e.next=n,e.previous=t,++this._length}}class rr{constructor(){u(this,"_list");u(this,"_sentinel");u(this,"_trimTiles");this._list=new nr,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(t){const e=t._cacheNode;e&&this._list.splice(this._sentinel,e)}add(t,e,n){e._cacheNode||(e._cacheNode=this._list.add(e),n&&n(t,e))}unloadTile(t,e,n){const r=e._cacheNode;r&&(this._list.remove(r),e._cacheNode=null,n&&n(t,e))}unloadTiles(t,e){const n=this._trimTiles;this._trimTiles=!1;const r=this._list,i=t.maximumMemoryUsage*1024*1024,o=this._sentinel;let a=r.head;for(;a!==o&&(t.gpuMemoryUsageInBytes>i||n);){const l=a.item;a=a.next,this.unloadTile(t,l,e)}}trim(){this._trimTiles=!0}}function ir(s,t){M(s),M(t);const{rtcCenter:e,gltfUpAxis:n}=t,{computedTransform:r,boundingVolume:{center:i}}=s;let o=new A(r);switch(e&&o.translate(e),n){case"Z":break;case"Y":const d=new A().rotateX(Math.PI/2);o=o.multiplyRight(d);break;case"X":const g=new A().rotateY(-Math.PI/2);o=o.multiplyRight(g);break}t.isQuantized&&o.translate(t.quantizedVolumeOffset).scale(t.quantizedVolumeScale);const a=new f(i);t.cartesianModelMatrix=o,t.cartesianOrigin=a;const l=C.WGS84.cartesianToCartographic(a,new f),h=C.WGS84.eastNorthUpToFixedFrame(a).invert();t.cartographicModelMatrix=h.multiplyRight(o),t.cartographicOrigin=l,t.coordinateSystem||(t.modelMatrix=t.cartographicModelMatrix)}const Re=new f,Ht=new f,ne=new Dt([new ht,new ht,new ht,new ht,new ht,new ht]);function or(s,t){const{cameraDirection:e,cameraUp:n,height:r}=s,{metersPerUnit:i}=s.distanceScales,o=vt(s,s.center),a=C.WGS84.eastNorthUpToFixedFrame(o),l=s.unprojectPosition(s.cameraPosition),c=C.WGS84.cartographicToCartesian(l,new f),h=new f(a.transformAsVector(new f(e).scale(i))).normalize(),d=new f(a.transformAsVector(new f(n).scale(i))).normalize();cr(s);const g=s.constructor,{longitude:m,latitude:T,width:y,bearing:b,zoom:E}=s,I=new g({longitude:m,latitude:T,height:r,width:y,bearing:b,zoom:E,pitch:0});return{camera:{position:c,direction:h,up:d},viewport:s,topDownViewport:I,height:r,cullingVolume:ne,frameNumber:t,sseDenominator:1.15}}function ar(s,t,e){if(e===0||s.length<=e)return[s,[]];const n=[],{longitude:r,latitude:i}=t.viewport;for(const[c,h]of s.entries()){const[d,g]=h.header.mbs,m=Math.abs(r-d),T=Math.abs(i-g),y=Math.sqrt(T*T+m*m);n.push([c,y])}const o=n.sort((c,h)=>c[1]-h[1]),a=[];for(let c=0;c<e;c++)a.push(s[o[c][0]]);const l=[];for(let c=e;c<o.length;c++)l.push(s[o[c][0]]);return[a,l]}function cr(s){const t=s.getFrustumPlanes(),e=Pe(t.near,s.cameraPosition),n=vt(s,e),r=vt(s,s.cameraPosition,Ht);let i=0;ne.planes[i++].fromPointNormal(n,Re.copy(n).subtract(r));for(const o in t){if(o==="near")continue;const a=t[o],l=Pe(a,e,Ht),c=vt(s,l,Ht);ne.planes[i++].fromPointNormal(c,Re.copy(n).subtract(c))}}function Pe(s,t,e=new f){const n=s.normal.dot(t);return e.copy(s.normal).scale(s.distance-n).add(t),e}function vt(s,t,e=new f){const n=s.unprojectPosition(t);return C.WGS84.cartographicToCartesian(n,e)}const lr=6378137,hr=6378137,re=6356752314245179e-9,pt=new f;function ur(s,t){if(s instanceof ms){const{halfAxes:e}=s,n=fr(e);return Math.log2(re/(n+t[2]))}else if(s instanceof Ts){const{radius:e}=s;return Math.log2(re/(e+t[2]))}else if(s.width&&s.height){const{width:e,height:n}=s,r=Math.log2(lr/e),i=Math.log2(hr/n);return(r+i)/2}return 1}function ws(s,t,e){C.WGS84.cartographicToCartesian([s.xmax,s.ymax,s.zmax],pt);const n=Math.sqrt(Math.pow(pt[0]-e[0],2)+Math.pow(pt[1]-e[1],2)+Math.pow(pt[2]-e[2],2));return Math.log2(re/(n+t[2]))}function dr(s,t,e){const[n,r,i,o]=s;return ws({xmax:i,ymax:o,zmax:0},t,e)}function fr(s){s.getColumn(0,pt);const t=s.getColumn(1),e=s.getColumn(2);return pt.add(t).add(e).len()}const F={UNLOADED:0,LOADING:1,PROCESSING:2,READY:3,EXPIRED:4,FAILED:5};var j;(function(s){s[s.ADD=1]="ADD",s[s.REPLACE=2]="REPLACE"})(j||(j={}));var J;(function(s){s.EMPTY="empty",s.SCENEGRAPH="scenegraph",s.POINTCLOUD="pointcloud",s.MESH="mesh"})(J||(J={}));var x;(function(s){s.I3S="I3S",s.TILES3D="TILES3D"})(x||(x={}));var mt;(function(s){s.GEOMETRIC_ERROR="geometricError",s.MAX_SCREEN_THRESHOLD="maxScreenThreshold"})(mt||(mt={}));const pr={USE_OPTIMIZATION:1};function Es(s){return s!=null}const O=new f,xt=new f,gr=new f,mr=new f,rt=new f,Oe=new f,Ue=new f,De=new f;function Zt(s,t,e){if(M(s,"3D Tile: boundingVolume must be defined"),s.box)return bs(s.box,t,e);if(s.region)return _r(s.region);if(s.sphere)return yr(s.sphere,t,e);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function Tr(s,t){if(s.box)return Sr(t);if(s.region){const[e,n,r,i,o,a]=s.region;return[[W(e),W(n),o],[W(r),W(i),a]]}if(s.sphere)return wr(t);throw new Error("Unkown boundingVolume type")}function bs(s,t,e){const n=new f(s[0],s[1],s[2]);t.transform(n,n);let r=[];if(s.length===10){const c=s.slice(3,6),h=new ys;h.fromArray(s,6);const d=new f([1,0,0]),g=new f([0,1,0]),m=new f([0,0,1]);d.transformByQuaternion(h),d.scale(c[0]),g.transformByQuaternion(h),g.scale(c[1]),m.transformByQuaternion(h),m.scale(c[2]),r=[...d.toArray(),...g.toArray(),...m.toArray()]}else r=[...s.slice(3,6),...s.slice(6,9),...s.slice(9,12)];const i=t.transformAsVector(r.slice(0,3)),o=t.transformAsVector(r.slice(3,6)),a=t.transformAsVector(r.slice(6,9)),l=new _s([i[0],i[1],i[2],o[0],o[1],o[2],a[0],a[1],a[2]]);return Es(e)?(e.center=n,e.halfAxes=l,e):new ms(n,l)}function yr(s,t,e){const n=new f(s[0],s[1],s[2]);t.transform(n,n);const r=t.getScale(xt),i=Math.max(Math.max(r[0],r[1]),r[2]),o=s[3]*i;return Es(e)?(e.center=n,e.radius=o,e):new Ts(n,o)}function _r(s){const[t,e,n,r,i,o]=s,a=C.WGS84.cartographicToCartesian([W(t),W(r),i],gr),l=C.WGS84.cartographicToCartesian([W(n),W(e),o],mr),c=new f().addVectors(a,l).multiplyByScalar(.5);return C.WGS84.cartesianToCartographic(c,rt),C.WGS84.cartographicToCartesian([W(n),rt[1],rt[2]],Oe),C.WGS84.cartographicToCartesian([rt[0],W(r),rt[2]],Ue),C.WGS84.cartographicToCartesian([rt[0],rt[1],o],De),bs([...c,...Oe.subtract(c),...Ue.subtract(c),...De.subtract(c)],new A)}function Sr(s){const t=Cs(),{halfAxes:e}=s,n=new f(e.getColumn(0)),r=new f(e.getColumn(1)),i=new f(e.getColumn(2));for(let o=0;o<2;o++){for(let a=0;a<2;a++){for(let l=0;l<2;l++)O.copy(s.center),O.add(n),O.add(r),O.add(i),Is(t,O),i.negate();r.negate()}n.negate()}return t}function wr(s){const t=Cs(),{center:e,radius:n}=s,r=C.WGS84.scaleToGeodeticSurface(e,O);let i;r?i=C.WGS84.geodeticSurfaceNormal(r):i=new f(0,0,1);let o=new f(i[2],-i[1],0);o.len()>0?o.normalize():o=new f(0,1,0);const a=o.clone().cross(i);for(const l of[o,a,i]){xt.copy(l).scale(n);for(let c=0;c<2;c++)O.copy(e),O.add(xt),Is(t,O),xt.negate()}return t}function Cs(){return[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]]}function Is(s,t){C.WGS84.cartesianToCartographic(t,O),s[0][0]=Math.min(s[0][0],O[0]),s[0][1]=Math.min(s[0][1],O[1]),s[0][2]=Math.min(s[0][2],O[2]),s[1][0]=Math.max(s[1][0],O[0]),s[1][1]=Math.max(s[1][1],O[1]),s[1][2]=Math.max(s[1][2],O[2])}new f;new f;new A;new f;new f;new f;function Er(s,t){const e=s*t;return 1-Math.exp(-(e*e))}function br(s,t){if(s.dynamicScreenSpaceError&&s.dynamicScreenSpaceErrorComputedDensity){const e=s.dynamicScreenSpaceErrorComputedDensity,n=s.dynamicScreenSpaceErrorFactor;return Er(t,e)*n}return 0}function Cr(s,t,e){const n=s.tileset,r=s.parent&&s.parent.lodMetricValue||s.lodMetricValue,i=e?r:s.lodMetricValue;if(i===0)return 0;const o=Math.max(s._distanceToCamera,1e-7),{height:a,sseDenominator:l}=t,{viewDistanceScale:c}=n.options;let h=i*a*(c||1)/(o*l);return h-=br(n,o),h}const jt=new f,ve=new f,nt=new f,xe=new f,Ir=new f,$t=new A,Ve=new A;function Ar(s,t){if(s.lodMetricValue===0||isNaN(s.lodMetricValue))return"DIG";const e=2*As(s,t);return e<2?"OUT":!s.header.children||e<=s.lodMetricValue?"DRAW":s.header.children?"DIG":"OUT"}function As(s,t){const{topDownViewport:e}=t,n=s.header.mbs[1],r=s.header.mbs[0],i=s.header.mbs[2],o=s.header.mbs[3],a=[...s.boundingVolume.center],l=e.unprojectPosition(e.cameraPosition);C.WGS84.cartographicToCartesian(l,jt),ve.copy(jt).subtract(a).normalize(),C.WGS84.eastNorthUpToFixedFrame(a,$t),Ve.copy($t).invert(),nt.copy(jt).transform(Ve);const c=Math.sqrt(nt[0]*nt[0]+nt[1]*nt[1]),h=c*c/nt[2];xe.copy([nt[0],nt[1],h]);const g=xe.transform($t).subtract(a).normalize(),T=ve.cross(g).normalize().scale(o).add(a),y=C.WGS84.cartesianToCartographic(T),b=e.project([r,n,i]),E=e.project(y);return Ir.copy(b).subtract(E).magnitude()}function Lr(s){return{assetGltfUpAxis:s.asset&&s.asset.gltfUpAxis||"Y"}}class Be{constructor(t=0){u(this,"_map",new Map);u(this,"_array");u(this,"_length");this._array=new Array(t),this._length=t}get length(){return this._length}set length(t){this._length=t,t>this._array.length&&(this._array.length=t)}get values(){return this._array}get(t){return M(t<this._array.length),this._array[t]}set(t,e){M(t>=0),t>=this.length&&(this.length=t+1),this._map.has(this._array[t])&&this._map.delete(this._array[t]),this._array[t]=e,this._map.set(e,t)}delete(t){const e=this._map.get(t);e>=0&&(this._array.splice(e,1),this._map.delete(t),this.length--)}peek(){return this._array[this._length-1]}push(t){if(!this._map.has(t)){const e=this.length++;this._array[e]=t,this._map.set(t,e)}}pop(){const t=this._array[--this.length];return this._map.delete(t),t}reserve(t){M(t>=0),t>this._array.length&&(this._array.length=t)}resize(t){M(t>=0),this.length=t}trim(t){t==null&&(t=this.length),this._array.length=t}reset(){this._array=[],this._map=new Map,this._length=0}find(t){return this._map.has(t)}}const Mr={loadSiblings:!1,skipLevelOfDetail:!1,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class zt{constructor(t){u(this,"options");u(this,"root",null);u(this,"selectedTiles",{});u(this,"requestedTiles",{});u(this,"emptyTiles",{});u(this,"lastUpdate",new Date().getTime());u(this,"updateDebounceTime",1e3);u(this,"_traversalStack",new Be);u(this,"_emptyTraversalStack",new Be);u(this,"_frameNumber",null);this.options={...Mr,...t}}traversalFinished(t){return!0}traverse(t,e,n){this.root=t,this.options={...this.options,...n},this.reset(),this.updateTile(t,e),this._frameNumber=e.frameNumber,this.executeTraversal(t,e)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(t,e){const n=this._traversalStack;for(t._selectionDepth=1,n.push(t);n.length>0;){const i=n.pop();let o=!1;this.canTraverse(i,e)&&(this.updateChildTiles(i,e),o=this.updateAndPushChildren(i,e,n,i.hasRenderContent?i._selectionDepth+1:i._selectionDepth));const a=i.parent,l=!!(!a||a._shouldRefine),c=!o;i.hasRenderContent?i.refine===j.ADD?(this.loadTile(i,e),this.selectTile(i,e)):i.refine===j.REPLACE&&(this.loadTile(i,e),c&&this.selectTile(i,e)):(this.emptyTiles[i.id]=i,this.loadTile(i,e),c&&this.selectTile(i,e)),this.touchTile(i,e),i._shouldRefine=o&&l}const r=new Date().getTime();(this.traversalFinished(e)||r-this.lastUpdate>this.updateDebounceTime)&&(this.lastUpdate=r,this.options.onTraversalEnd(e))}updateChildTiles(t,e){const n=t.children;for(const r of n)this.updateTile(r,e)}updateAndPushChildren(t,e,n,r){const{loadSiblings:i,skipLevelOfDetail:o}=this.options,a=t.children;a.sort(this.compareDistanceToCamera.bind(this));const l=t.refine===j.REPLACE&&t.hasRenderContent&&!o;let c=!1,h=!0;for(const d of a)if(d._selectionDepth=r,d.isVisibleAndInRequestVolume?(n.find(d)&&n.delete(d),n.push(d),c=!0):(l||i)&&(this.loadTile(d,e),this.touchTile(d,e)),l){let g;if(d._inRequestVolume?d.hasRenderContent?g=d.contentAvailable:g=this.executeEmptyTraversal(d,e):g=!1,h=h&&g,!h)return!1}return c||(h=!1),h}updateTile(t,e){this.updateTileVisibility(t,e)}selectTile(t,e){this.shouldSelectTile(t)&&(t._selectedFrame=e.frameNumber,this.selectedTiles[t.id]=t)}loadTile(t,e){this.shouldLoadTile(t)&&(t._requestedFrame=e.frameNumber,t._priority=t._getPriority(),this.requestedTiles[t.id]=t)}touchTile(t,e){t.tileset._cache.touch(t),t._touchedFrame=e.frameNumber}canTraverse(t,e){return t.hasChildren?t.hasTilesetContent?!t.contentExpired:this.shouldRefine(t,e):!1}shouldLoadTile(t){return t.hasUnloadedContent||t.contentExpired}shouldSelectTile(t){return t.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(t,e,n=!1){let r=t._screenSpaceError;return n&&(r=t.getScreenSpaceError(e,!0)),r>t.tileset.memoryAdjustedScreenSpaceError}updateTileVisibility(t,e){const n=[];if(this.options.viewportTraversersMap)for(const r in this.options.viewportTraversersMap)this.options.viewportTraversersMap[r]===e.viewport.id&&n.push(r);else n.push(e.viewport.id);t.updateVisibility(e,n)}compareDistanceToCamera(t,e){return t._distanceToCamera-e._distanceToCamera}anyChildrenVisible(t,e){let n=!1;for(const r of t.children)r.updateVisibility(e),n=n||r.isVisibleAndInRequestVolume;return n}executeEmptyTraversal(t,e){let n=!0;const r=this._emptyTraversalStack;for(r.push(t);r.length>0;){const i=r.pop(),o=!i.hasRenderContent&&this.canTraverse(i,e),a=!i.hasRenderContent&&i.children.length===0;if(!o&&!i.contentAvailable&&!a&&(n=!1),this.updateTile(i,e),i.isVisibleAndInRequestVolume||(this.loadTile(i,e),this.touchTile(i,e)),o){const l=i.children;for(const c of l)r.push(c)}}return n}}const Fe=new f;function Nr(s){return s!=null}class ie{constructor(t,e,n,r=""){u(this,"tileset");u(this,"header");u(this,"id");u(this,"url");u(this,"parent");u(this,"refine");u(this,"type");u(this,"contentUrl");u(this,"lodMetricType","geometricError");u(this,"lodMetricValue",0);u(this,"boundingVolume",null);u(this,"content",null);u(this,"contentState",F.UNLOADED);u(this,"gpuMemoryUsageInBytes",0);u(this,"children",[]);u(this,"depth",0);u(this,"viewportIds",[]);u(this,"transform",new A);u(this,"extensions",null);u(this,"implicitTiling",null);u(this,"userData",{});u(this,"computedTransform");u(this,"hasEmptyContent",!1);u(this,"hasTilesetContent",!1);u(this,"traverser",new zt({}));u(this,"_cacheNode",null);u(this,"_frameNumber",null);u(this,"_expireDate",null);u(this,"_expiredContent",null);u(this,"_boundingBox");u(this,"_distanceToCamera",0);u(this,"_screenSpaceError",0);u(this,"_visibilityPlaneMask");u(this,"_visible");u(this,"_contentBoundingVolume");u(this,"_viewerRequestVolume");u(this,"_initialTransform",new A);u(this,"_priority",0);u(this,"_selectedFrame",0);u(this,"_requestedFrame",0);u(this,"_selectionDepth",0);u(this,"_touchedFrame",0);u(this,"_centerZDepth",0);u(this,"_shouldRefine",!1);u(this,"_stackLength",0);u(this,"_visitedFrame",0);u(this,"_inRequestVolume",!1);u(this,"_lodJudge",null);this.header=e,this.tileset=t,this.id=r||e.id,this.url=e.url,this.parent=n,this.refine=this._getRefine(e.refine),this.type=e.type,this.contentUrl=e.contentUrl,this._initializeLodMetric(e),this._initializeTransforms(e),this._initializeBoundingVolumes(e),this._initializeContent(e),this._initializeRenderingState(e),Object.seal(this)}destroy(){this.header=null}isDestroyed(){return this.header===null}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===F.READY||this.hasEmptyContent}get contentAvailable(){return!!(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===F.UNLOADED}get contentExpired(){return this.contentState===F.EXPIRED}get contentFailed(){return this.contentState===F.FAILED}get distanceToCamera(){return this._distanceToCamera}get screenSpaceError(){return this._screenSpaceError}get boundingBox(){return this._boundingBox||(this._boundingBox=Tr(this.header.boundingVolume,this.boundingVolume)),this._boundingBox}getScreenSpaceError(t,e){switch(this.tileset.type){case x.I3S:return As(this,t);case x.TILES3D:return Cr(this,t,e);default:throw new Error("Unsupported tileset type")}}unselect(){this._selectedFrame=0}_getGpuMemoryUsageInBytes(){return this.content.gpuMemoryUsageInBytes||this.content.byteLength||0}_getPriority(){const t=this.tileset._traverser,{skipLevelOfDetail:e}=t.options,n=this.refine===j.ADD||e;if(n&&!this.isVisible&&this._visible!==void 0||this.tileset._frameNumber-this._touchedFrame>=1||this.contentState===F.UNLOADED)return-1;const r=this.parent,o=r&&(!n||this._screenSpaceError===0||r.hasTilesetContent)?r._screenSpaceError:this._screenSpaceError,a=t.root?t.root._screenSpaceError:0;return Math.max(a-o,0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=F.LOADING;const e=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!e)return this.contentState=F.UNLOADED,!1;try{const n=this.tileset.getTileUrl(this.contentUrl),r=this.tileset.loader,i={...this.tileset.loadOptions,[r.id]:{...this.tileset.loadOptions[r.id],isTileset:this.type==="json",...this._getLoaderSpecificOptions(r.id)}};return this.content=await bt(n,r,i),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=F.READY,this._onContentLoaded(),!0}catch(n){throw this.contentState=F.FAILED,n}finally{e.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=F.UNLOADED,!0}updateVisibility(t,e){if(this._frameNumber===t.frameNumber)return;const n=this.parent,r=n?n._visibilityPlaneMask:Dt.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){const i=n?n.computedTransform:this.tileset.modelMatrix;this._updateTransform(i)}this._distanceToCamera=this.distanceToTile(t),this._screenSpaceError=this.getScreenSpaceError(t,!1),this._visibilityPlaneMask=this.visibility(t,r),this._visible=this._visibilityPlaneMask!==Dt.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(t),this._frameNumber=t.frameNumber,this.viewportIds=e}visibility(t,e){const{cullingVolume:n}=t,{boundingVolume:r}=this;return n.computeVisibilityWithPlaneMask(r,e)}contentVisibility(){return!0}distanceToTile(t){const e=this.boundingVolume;return Math.sqrt(Math.max(e.distanceSquaredTo(t.camera.position),0))}cameraSpaceZDepth({camera:t}){const e=this.boundingVolume;return Fe.subVectors(e.center,t.position),t.direction.dot(Fe)}insideViewerRequestVolume(t){const e=this._viewerRequestVolume;return!e||e.distanceSquaredTo(t.camera.position)<=0}updateExpiration(){if(Nr(this._expireDate)&&this.contentReady&&!this.hasEmptyContent){const t=Date.now();Date.lessThan(this._expireDate,t)&&(this.contentState=F.EXPIRED,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(t){"lodMetricType"in t?this.lodMetricType=t.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType")),"lodMetricValue"in t?this.lodMetricValue=t.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}_initializeTransforms(t){this.transform=t.transform?new A(t.transform):new A;const e=this.parent,n=this.tileset,r=e&&e.computedTransform?e.computedTransform.clone():n.modelMatrix.clone();this.computedTransform=new A(r).multiplyRight(this.transform);const i=e&&e._initialTransform?e._initialTransform.clone():new A;this._initialTransform=new A(i).multiplyRight(this.transform)}_initializeBoundingVolumes(t){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(t)}_initializeContent(t){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=F.UNLOADED,this.hasTilesetContent=!1,t.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(t){this.depth=t.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=Dt.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(t){return t||this.parent&&this.parent.refine||j.REPLACE}_isTileset(){return this.contentUrl.indexOf(".json")!==-1}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0;break}this._isTileset()?this.hasTilesetContent=!0:this.gpuMemoryUsageInBytes=this._getGpuMemoryUsageInBytes()}_updateBoundingVolume(t){this.boundingVolume=Zt(t.boundingVolume,this.computedTransform,this.boundingVolume);const e=t.content;e&&(e.boundingVolume&&(this._contentBoundingVolume=Zt(e.boundingVolume,this.computedTransform,this._contentBoundingVolume)),t.viewerRequestVolume&&(this._viewerRequestVolume=Zt(t.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(t=new A){const e=t.clone().multiplyRight(this.transform);e.equals(this.computedTransform)||(this.computedTransform=e,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(t){switch(t){case"i3s":return{...this.tileset.options.i3s,_tileOptions:{attributeUrls:this.header.attributeUrls,textureUrl:this.header.textureUrl,textureFormat:this.header.textureFormat,textureLoaderOptions:this.header.textureLoaderOptions,materialDefinition:this.header.materialDefinition,isDracoGeometry:this.header.isDracoGeometry,mbs:this.header.mbs},_tilesetOptions:{store:this.tileset.tileset.store,attributeStorageInfo:this.tileset.tileset.attributeStorageInfo,fields:this.tileset.tileset.fields},isTileHeader:!1};case"3d-tiles":case"cesium-ion":default:return Lr(this.tileset.tileset)}}}class Rr extends zt{compareDistanceToCamera(t,e){return e._distanceToCamera===0&&t._distanceToCamera===0?e._centerZDepth-t._centerZDepth:e._distanceToCamera-t._distanceToCamera}updateTileVisibility(t,e){if(super.updateTileVisibility(t,e),!t.isVisibleAndInRequestVolume)return;const n=t.children.length>0;if(t.hasTilesetContent&&n){const o=t.children[0];this.updateTileVisibility(o,e),t._visible=o._visible;return}if(this.meetsScreenSpaceErrorEarly(t,e)){t._visible=!1;return}const r=t.refine===j.REPLACE,i=t._optimChildrenWithinParent===pr.USE_OPTIMIZATION;if(r&&i&&n&&!this.anyChildrenVisible(t,e)){t._visible=!1;return}}meetsScreenSpaceErrorEarly(t,e){const{parent:n}=t;return!n||n.hasTilesetContent||n.refine!==j.ADD?!1:!this.shouldRefine(t,e,!0)}}class Pr{constructor(){u(this,"frameNumberMap",new Map)}register(t,e){const n=this.frameNumberMap.get(t)||new Map,r=n.get(e)||0;n.set(e,r+1),this.frameNumberMap.set(t,n)}deregister(t,e){const n=this.frameNumberMap.get(t);if(!n)return;const r=n.get(e)||1;n.set(e,r-1)}isZero(t,e){var r;return(((r=this.frameNumberMap.get(t))==null?void 0:r.get(e))||0)===0}}const Wt={REQUESTED:"REQUESTED",COMPLETED:"COMPLETED",ERROR:"ERROR"};class Or{constructor(){u(this,"_statusMap");u(this,"pendingTilesRegister",new Pr);this._statusMap={}}add(t,e,n,r){if(!this._statusMap[e]){const{frameNumber:i,viewport:{id:o}}=r;this._statusMap[e]={request:t,callback:n,key:e,frameState:r,status:Wt.REQUESTED},this.pendingTilesRegister.register(o,i),t().then(a=>{this._statusMap[e].status=Wt.COMPLETED;const{frameNumber:l,viewport:{id:c}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(c,l),this._statusMap[e].callback(a,r)}).catch(a=>{this._statusMap[e].status=Wt.ERROR;const{frameNumber:l,viewport:{id:c}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(c,l),n(a)})}}update(t,e){if(this._statusMap[t]){const{frameNumber:n,viewport:{id:r}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(r,n);const{frameNumber:i,viewport:{id:o}}=e;this.pendingTilesRegister.register(o,i),this._statusMap[t].frameState=e}}find(t){return this._statusMap[t]}hasPendingTiles(t,e){return!this.pendingTilesRegister.isZero(t,e)}}class Ur extends zt{constructor(e){super(e);u(this,"_tileManager");this._tileManager=new Or}traversalFinished(e){return!this._tileManager.hasPendingTiles(e.viewport.id,this._frameNumber||0)}shouldRefine(e,n){return e._lodJudge=Ar(e,n),e._lodJudge==="DIG"}updateChildTiles(e,n){const r=e.header.children||[],i=e.children,o=e.tileset;for(const a of r){const l=`${a.id}-${n.viewport.id}`,c=i&&i.find(h=>h.id===l);if(c)c&&this.updateTile(c,n);else{let h=()=>this._loadTile(a.id,o);this._tileManager.find(l)?this._tileManager.update(l,n):(o.tileset.nodePages&&(h=()=>o.tileset.nodePagesTile.formTileFromNodePages(a.id)),this._tileManager.add(h,l,g=>this._onTileLoad(g,e,l),n))}}return!1}async _loadTile(e,n){const{loader:r}=n,i=n.getTileUrl(`${n.url}/nodes/${e}`),o={...n.loadOptions,i3s:{...n.loadOptions.i3s,isTileHeader:!0}};return await bt(i,r,o)}_onTileLoad(e,n,r){const i=new ie(n.tileset,e,n,r);n.children.push(i);const o=this._tileManager.find(i.id).frameState;this.updateTile(i,o),this._frameNumber===o.frameNumber&&(this.traversalFinished(o)||new Date().getTime()-this.lastUpdate>this.updateDebounceTime)&&this.executeTraversal(i,o)}}const Dr={description:"",ellipsoid:C.WGS84,modelMatrix:new A,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,memoryCacheOverflow:1,maximumTilesSelected:0,debounceTime:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:s=>s,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,memoryAdjustedScreenSpaceError:!1,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}},Rt="Tiles In Tileset(s)",Yt="Tiles In Memory",ze="Tiles In View",Ge="Tiles To Render",qe="Tiles Loaded",Xt="Tiles Loading",ke="Tiles Unloaded",He="Failed Tile Loads",Ze="Points/Vertices",Qt="Tile Memory Use",je="Maximum Screen Space Error";class vr{constructor(t,e){u(this,"options");u(this,"loadOptions");u(this,"type");u(this,"tileset");u(this,"loader");u(this,"url");u(this,"basePath");u(this,"modelMatrix");u(this,"ellipsoid");u(this,"lodMetricType");u(this,"lodMetricValue");u(this,"refine");u(this,"root",null);u(this,"roots",{});u(this,"asset",{});u(this,"description","");u(this,"properties");u(this,"extras",null);u(this,"attributions",{});u(this,"credits",{});u(this,"stats");u(this,"contentFormats",{draco:!1,meshopt:!1,dds:!1,ktx2:!1});u(this,"cartographicCenter",null);u(this,"cartesianCenter",null);u(this,"zoom",1);u(this,"boundingVolume",null);u(this,"dynamicScreenSpaceErrorComputedDensity",0);u(this,"maximumMemoryUsage",32);u(this,"gpuMemoryUsageInBytes",0);u(this,"memoryAdjustedScreenSpaceError",0);u(this,"_cacheBytes",0);u(this,"_cacheOverflowBytes",0);u(this,"_frameNumber",0);u(this,"_queryParams",{});u(this,"_extensionsUsed",[]);u(this,"_tiles",{});u(this,"_pendingCount",0);u(this,"selectedTiles",[]);u(this,"traverseCounter",0);u(this,"geometricError",0);u(this,"lastUpdatedVieports",null);u(this,"_requestedTiles",[]);u(this,"_emptyTiles",[]);u(this,"frameStateData",{});u(this,"_traverser");u(this,"_cache",new rr);u(this,"_requestScheduler");u(this,"updatePromise",null);u(this,"tilesetInitializationPromise");this.options={...Dr,...e},this.tileset=t,this.loader=t.loader,this.type=t.type,this.url=t.url,this.basePath=t.basePath||ds(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=t.lodMetricType,this.lodMetricValue=t.lodMetricValue,this.refine=t.root.refine,this.loadOptions=this.options.loadOptions||{},this._traverser=this._initializeTraverser(),this._requestScheduler=new Pn({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this.memoryAdjustedScreenSpaceError=this.options.maximumScreenSpaceError,this._cacheBytes=this.options.maximumMemoryUsage*1024*1024,this._cacheOverflowBytes=this.options.memoryCacheOverflow*1024*1024,this.stats=new mn({id:this.url}),this._initializeStats(),this.tilesetInitializationPromise=this._initializeTileSet(t)}destroy(){this._destroy()}isLoaded(){return this._pendingCount===0&&this._frameNumber!==0&&this._requestedTiles.length===0}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return new URLSearchParams(this._queryParams).toString()}setProps(t){this.options={...this.options,...t}}getTileUrl(t){if(t.startsWith("data:"))return t;let n=t;return this.queryParams.length&&(n=`${t}${t.includes("?")?"&":"?"}${this.queryParams}`),n}hasExtension(t){return this._extensionsUsed.indexOf(t)>-1}update(t=null){this.tilesetInitializationPromise.then(()=>{!t&&this.lastUpdatedVieports?t=this.lastUpdatedVieports:this.lastUpdatedVieports=t,t&&this.doUpdate(t)})}async selectTiles(t=null){return await this.tilesetInitializationPromise,t&&(this.lastUpdatedVieports=t),this.updatePromise||(this.updatePromise=new Promise(e=>{setTimeout(()=>{this.lastUpdatedVieports&&this.doUpdate(this.lastUpdatedVieports),e(this._frameNumber),this.updatePromise=null},this.options.debounceTime)})),this.updatePromise}adjustScreenSpaceError(){this.gpuMemoryUsageInBytes<this._cacheBytes?this.memoryAdjustedScreenSpaceError=Math.max(this.memoryAdjustedScreenSpaceError/1.02,this.options.maximumScreenSpaceError):this.gpuMemoryUsageInBytes>this._cacheBytes+this._cacheOverflowBytes&&(this.memoryAdjustedScreenSpaceError*=1.02)}doUpdate(t){if("loadTiles"in this.options&&!this.options.loadTiles||this.traverseCounter>0)return;const e=t instanceof Array?t:[t];this._cache.reset(),this._frameNumber++,this.traverseCounter=e.length;const n=[];for(const r of e){const i=r.id;this._needTraverse(i)?n.push(i):this.traverseCounter--}for(const r of e){const i=r.id;if(this.roots[i]||(this.roots[i]=this._initializeTileHeaders(this.tileset,null)),!n.includes(i))continue;const o=or(r,this._frameNumber);this._traverser.traverse(this.roots[i],o,this.options)}}_needTraverse(t){let e=t;return this.options.viewportTraversersMap&&(e=this.options.viewportTraversersMap[t]),e===t}_onTraversalEnd(t){const e=t.viewport.id;this.frameStateData[e]||(this.frameStateData[e]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const n=this.frameStateData[e],r=Object.values(this._traverser.selectedTiles),[i,o]=ar(r,t,this.options.maximumTilesSelected);n.selectedTiles=i;for(const a of o)a.unselect();n._requestedTiles=Object.values(this._traverser.requestedTiles),n._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,!(this.traverseCounter>0)&&this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const t in this.frameStateData){const e=this.frameStateData[t];this.selectedTiles=this.selectedTiles.concat(e.selectedTiles),this._requestedTiles=this._requestedTiles.concat(e._requestedTiles),this._emptyTiles=this._emptyTiles.concat(e._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const t of this.selectedTiles)this._tiles[t.id]=t;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(t,e){if(t.length!==e.length)return!0;const n=new Set(t.map(o=>o.id)),r=new Set(e.map(o=>o.id));let i=t.filter(o=>!r.has(o.id)).length>0;return i=i||e.filter(o=>!n.has(o.id)).length>0,i}_loadTiles(){for(const t of this._requestedTiles)t.contentUnloaded&&this._loadTile(t)}_unloadTiles(){this._cache.unloadTiles(this,(t,e)=>t._unloadTile(e))}_updateStats(){let t=0,e=0;for(const n of this.selectedTiles)n.contentAvailable&&n.content&&(t++,n.content.pointCount?e+=n.content.pointCount:e+=n.content.vertexCount);this.stats.get(ze).count=this.selectedTiles.length,this.stats.get(Ge).count=t,this.stats.get(Ze).count=e,this.stats.get(je).count=this.memoryAdjustedScreenSpaceError}async _initializeTileSet(t){this.type===x.I3S&&(this.calculateViewPropsI3S(),t.root=await t.root),this.root=this._initializeTileHeaders(t,null),this.type===x.TILES3D&&(this._initializeTiles3DTileset(t),this.calculateViewPropsTiles3D()),this.type===x.I3S&&this._initializeI3STileset()}calculateViewPropsI3S(){var n;const t=this.tileset.fullExtent;if(t){const{xmin:r,xmax:i,ymin:o,ymax:a,zmin:l,zmax:c}=t;this.cartographicCenter=new f(r+(i-r)/2,o+(a-o)/2,l+(c-l)/2),this.cartesianCenter=new f,C.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),this.zoom=ws(t,this.cartographicCenter,this.cartesianCenter);return}const e=(n=this.tileset.store)==null?void 0:n.extent;if(e){const[r,i,o,a]=e;this.cartographicCenter=new f(r+(o-r)/2,i+(a-i)/2,0),this.cartesianCenter=new f,C.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),this.zoom=dr(e,this.cartographicCenter,this.cartesianCenter);return}console.warn("Extent is not defined in the tileset header"),this.cartographicCenter=new f,this.zoom=1}calculateViewPropsTiles3D(){const t=this.root,{center:e}=t.boundingVolume;if(!e){console.warn("center was not pre-calculated for the root tile"),this.cartographicCenter=new f,this.zoom=1;return}e[0]!==0||e[1]!==0||e[2]!==0?(this.cartographicCenter=new f,C.WGS84.cartesianToCartographic(e,this.cartographicCenter)):this.cartographicCenter=new f(0,0,-C.WGS84.radii[0]),this.cartesianCenter=e,this.zoom=ur(t.boundingVolume,this.cartographicCenter)}_initializeStats(){this.stats.get(Rt),this.stats.get(Xt),this.stats.get(Yt),this.stats.get(ze),this.stats.get(Ge),this.stats.get(qe),this.stats.get(ke),this.stats.get(He),this.stats.get(Ze),this.stats.get(Qt,"memory"),this.stats.get(je)}_initializeTileHeaders(t,e){var r;const n=new ie(this,t.root,e);if(e&&(e.children.push(n),n.depth=e.depth+1),this.type===x.TILES3D){const i=[];for(i.push(n);i.length>0;){const o=i.pop();this.stats.get(Rt).incrementCount();const a=o.header.children||[];for(const l of a){const c=new ie(this,l,o);if((r=c.contentUrl)!=null&&r.includes("?session=")){const d=new URL(c.contentUrl).searchParams.get("session");d&&(this._queryParams.session=d)}o.children.push(c),c.depth=o.depth+1,i.push(c)}}}return n}_initializeTraverser(){let t;switch(this.type){case x.TILES3D:t=Rr;break;case x.I3S:t=Ur;break;default:t=zt}return new t({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(t){this._destroySubtree(t)}async _loadTile(t){let e;try{this._onStartTileLoading(),e=await t.loadContent()}catch(n){this._onTileLoadError(t,n instanceof Error?n:new Error("load failed"))}finally{this._onEndTileLoading(),this._onTileLoad(t,e)}}_onTileLoadError(t,e){this.stats.get(He).incrementCount();const n=e.message||e.toString(),r=t.url;console.error(`A 3D tile failed to load: ${t.url} ${n}`),this.options.onTileError(t,n,r)}_onTileLoad(t,e){var n,r;if(e){if(this.type===x.I3S){const i=((r=(n=this.tileset)==null?void 0:n.nodePagesTile)==null?void 0:r.nodesInNodePages)||0;this.stats.get(Rt).reset(),this.stats.get(Rt).addCount(i)}t&&t.content&&ir(t,t.content),this.updateContentTypes(t),this._addTileToCache(t),this.options.onTileLoad(t)}}updateContentTypes(t){var e;if(this.type===x.I3S)switch(t.header.isDracoGeometry&&(this.contentFormats.draco=!0),t.header.textureFormat){case"dds":this.contentFormats.dds=!0;break;case"ktx2":this.contentFormats.ktx2=!0;break}else if(this.type===x.TILES3D){const{extensionsRemoved:n=[]}=((e=t.content)==null?void 0:e.gltf)||{};n.includes("KHR_draco_mesh_compression")&&(this.contentFormats.draco=!0),n.includes("EXT_meshopt_compression")&&(this.contentFormats.meshopt=!0),n.includes("KHR_texture_basisu")&&(this.contentFormats.ktx2=!0)}}_onStartTileLoading(){this._pendingCount++,this.stats.get(Xt).incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get(Xt).decrementCount()}_addTileToCache(t){this._cache.add(this,t,e=>e._updateCacheStats(t))}_updateCacheStats(t){this.stats.get(qe).incrementCount(),this.stats.get(Yt).incrementCount(),this.gpuMemoryUsageInBytes+=t.gpuMemoryUsageInBytes||0,this.stats.get(Qt).count=this.gpuMemoryUsageInBytes,this.options.memoryAdjustedScreenSpaceError&&this.adjustScreenSpaceError()}_unloadTile(t){this.gpuMemoryUsageInBytes-=t.gpuMemoryUsageInBytes||0,this.stats.get(Yt).decrementCount(),this.stats.get(ke).incrementCount(),this.stats.get(Qt).count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(t),t.unloadContent()}_destroy(){const t=[];for(this.root&&t.push(this.root);t.length>0;){const e=t.pop();for(const n of e.children)t.push(n);this._destroyTile(e)}this.root=null}_destroySubtree(t){const e=t,n=[];for(n.push(e);n.length>0;){t=n.pop();for(const r of t.children)n.push(r);t!==e&&this._destroyTile(t)}e.children=[]}_destroyTile(t){this._cache.unloadTile(this,t),this._unloadTile(t),t.destroy()}_initializeTiles3DTileset(t){if(t.queryString){const e=new URLSearchParams(t.queryString),n=Object.fromEntries(e.entries());this._queryParams={...this._queryParams,...n}}if(this.asset=t.asset,!this.asset)throw new Error("Tileset must have an asset property.");if(this.asset.version!=="0.0"&&this.asset.version!=="1.0"&&this.asset.version!=="1.1")throw new Error("The tileset must be 3D Tiles version either 0.0 or 1.0 or 1.1.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=t.properties,this.geometricError=t.geometricError,this._extensionsUsed=t.extensionsUsed||[],this.extras=t.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}const Ls="4.3.3",wt={COMPOSITE:"cmpt",POINT_CLOUD:"pnts",BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",GLTF:"glTF"};function Ms(s,t,e){M(s instanceof ArrayBuffer);const n=new TextDecoder("utf8"),r=new Uint8Array(s,t,e);return n.decode(r)}function xr(s,t=0){const e=new DataView(s);return`${String.fromCharCode(e.getUint8(t+0))}${String.fromCharCode(e.getUint8(t+1))}${String.fromCharCode(e.getUint8(t+2))}${String.fromCharCode(e.getUint8(t+3))}`}const Vr={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},L={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},_={...Vr,...L},Jt={[L.DOUBLE]:Float64Array,[L.FLOAT]:Float32Array,[L.UNSIGNED_SHORT]:Uint16Array,[L.UNSIGNED_INT]:Uint32Array,[L.UNSIGNED_BYTE]:Uint8Array,[L.BYTE]:Int8Array,[L.SHORT]:Int16Array,[L.INT]:Int32Array},Br={DOUBLE:L.DOUBLE,FLOAT:L.FLOAT,UNSIGNED_SHORT:L.UNSIGNED_SHORT,UNSIGNED_INT:L.UNSIGNED_INT,UNSIGNED_BYTE:L.UNSIGNED_BYTE,BYTE:L.BYTE,SHORT:L.SHORT,INT:L.INT},Kt="Failed to convert GL type";class X{static fromTypedArray(t){t=ArrayBuffer.isView(t)?t.constructor:t;for(const e in Jt)if(Jt[e]===t)return e;throw new Error(Kt)}static fromName(t){const e=Br[t];if(!e)throw new Error(Kt);return e}static getArrayType(t){switch(t){case L.UNSIGNED_SHORT_5_6_5:case L.UNSIGNED_SHORT_4_4_4_4:case L.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const e=Jt[t];if(!e)throw new Error(Kt);return e}}static getByteSize(t){return X.getArrayType(t).BYTES_PER_ELEMENT}static validate(t){return!!X.getArrayType(t)}static createTypedArray(t,e,n=0,r){r===void 0&&(r=(e.byteLength-n)/X.getByteSize(t));const i=X.getArrayType(t);return new i(e,n,r)}}function Fr(s,t){if(!s)throw new Error(`math.gl assertion failed. ${t}`)}function zr(s,t=[0,0,0]){const e=s>>11&31,n=s>>5&63,r=s&31;return t[0]=e<<3,t[1]=n<<2,t[2]=r<<3,t}new de;new f;new de;new de;function $e(s,t=255){return Tn(s,0,t)/t*2-1}function We(s){return s<0?-1:1}function Gr(s,t,e,n){if(Fr(n),s<0||s>e||t<0||t>e)throw new Error(`x and y must be unsigned normalized integers between 0 and ${e}`);if(n.x=$e(s,e),n.y=$e(t,e),n.z=1-(Math.abs(n.x)+Math.abs(n.y)),n.z<0){const r=n.x;n.x=(1-Math.abs(n.y))*We(r),n.y=(1-Math.abs(r))*We(n.y)}return n.normalize()}function qr(s,t,e){return Gr(s,t,255,e)}class pe{constructor(t,e){u(this,"json");u(this,"buffer");u(this,"featuresLength",0);u(this,"_cachedTypedArrays",{});this.json=t,this.buffer=e}getExtension(t){return this.json.extensions&&this.json.extensions[t]}hasProperty(t){return!!this.json[t]}getGlobalProperty(t,e=_.UNSIGNED_INT,n=1){const r=this.json[t];return r&&Number.isFinite(r.byteOffset)?this._getTypedArrayFromBinary(t,e,n,1,r.byteOffset):r}getPropertyArray(t,e,n){const r=this.json[t];return r&&Number.isFinite(r.byteOffset)?("componentType"in r&&(e=X.fromName(r.componentType)),this._getTypedArrayFromBinary(t,e,n,this.featuresLength,r.byteOffset)):this._getTypedArrayFromArray(t,e,r)}getProperty(t,e,n,r,i){const o=this.json[t];if(!o)return o;const a=this.getPropertyArray(t,e,n);if(n===1)return a[r];for(let l=0;l<n;++l)i[l]=a[n*r+l];return i}_getTypedArrayFromBinary(t,e,n,r,i){const o=this._cachedTypedArrays;let a=o[t];return a||(a=X.createTypedArray(e,this.buffer.buffer,this.buffer.byteOffset+i,r*n),o[t]=a),a}_getTypedArrayFromArray(t,e,n){const r=this._cachedTypedArrays;let i=r[t];return i||(i=X.createTypedArray(e,n),r[t]=i),i}}const kr={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Hr={SCALAR:(s,t)=>s[t],VEC2:(s,t)=>[s[2*t+0],s[2*t+1]],VEC3:(s,t)=>[s[3*t+0],s[3*t+1],s[3*t+2]],VEC4:(s,t)=>[s[4*t+0],s[4*t+1],s[4*t+2],s[4*t+3]],MAT2:(s,t)=>[s[4*t+0],s[4*t+1],s[4*t+2],s[4*t+3]],MAT3:(s,t)=>[s[9*t+0],s[9*t+1],s[9*t+2],s[9*t+3],s[9*t+4],s[9*t+5],s[9*t+6],s[9*t+7],s[9*t+8]],MAT4:(s,t)=>[s[16*t+0],s[16*t+1],s[16*t+2],s[16*t+3],s[16*t+4],s[16*t+5],s[16*t+6],s[16*t+7],s[16*t+8],s[16*t+9],s[16*t+10],s[16*t+11],s[16*t+12],s[16*t+13],s[16*t+14],s[16*t+15]]},Zr={SCALAR:(s,t,e)=>{t[e]=s},VEC2:(s,t,e)=>{t[2*e+0]=s[0],t[2*e+1]=s[1]},VEC3:(s,t,e)=>{t[3*e+0]=s[0],t[3*e+1]=s[1],t[3*e+2]=s[2]},VEC4:(s,t,e)=>{t[4*e+0]=s[0],t[4*e+1]=s[1],t[4*e+2]=s[2],t[4*e+3]=s[3]},MAT2:(s,t,e)=>{t[4*e+0]=s[0],t[4*e+1]=s[1],t[4*e+2]=s[2],t[4*e+3]=s[3]},MAT3:(s,t,e)=>{t[9*e+0]=s[0],t[9*e+1]=s[1],t[9*e+2]=s[2],t[9*e+3]=s[3],t[9*e+4]=s[4],t[9*e+5]=s[5],t[9*e+6]=s[6],t[9*e+7]=s[7],t[9*e+8]=s[8],t[9*e+9]=s[9]},MAT4:(s,t,e)=>{t[16*e+0]=s[0],t[16*e+1]=s[1],t[16*e+2]=s[2],t[16*e+3]=s[3],t[16*e+4]=s[4],t[16*e+5]=s[5],t[16*e+6]=s[6],t[16*e+7]=s[7],t[16*e+8]=s[8],t[16*e+9]=s[9],t[16*e+10]=s[10],t[16*e+11]=s[11],t[16*e+12]=s[12],t[16*e+13]=s[13],t[16*e+14]=s[14],t[16*e+15]=s[15]}};function jr(s,t,e,n){const{componentType:r}=s;M(s.componentType);const i=typeof r=="string"?X.fromName(r):r,o=kr[s.type],a=Hr[s.type],l=Zr[s.type];return e+=s.byteOffset,{values:X.createTypedArray(i,t,e,o*n),type:i,size:o,unpacker:a,packer:l}}const Y=s=>s!==void 0;function $r(s,t,e){if(!t)return null;let n=s.getExtension("3DTILES_batch_table_hierarchy");const r=t.HIERARCHY;return r&&(console.warn("3D Tile Parser: HIERARCHY is deprecated. Use 3DTILES_batch_table_hierarchy."),t.extensions=t.extensions||{},t.extensions["3DTILES_batch_table_hierarchy"]=r,n=r),n?Wr(n,e):null}function Wr(s,t){let e,n,r;const i=s.instancesLength,o=s.classes;let a=s.classIds,l=s.parentCounts,c=s.parentIds,h=i;Y(a.byteOffset)&&(a.componentType=defaultValue(a.componentType,GL.UNSIGNED_SHORT),a.type=AttributeType.SCALAR,r=getBinaryAccessor(a),a=r.createArrayBufferView(t.buffer,t.byteOffset+a.byteOffset,i));let d;if(Y(l))for(Y(l.byteOffset)&&(l.componentType=defaultValue(l.componentType,GL.UNSIGNED_SHORT),l.type=AttributeType.SCALAR,r=getBinaryAccessor(l),l=r.createArrayBufferView(t.buffer,t.byteOffset+l.byteOffset,i)),d=new Uint16Array(i),h=0,e=0;e<i;++e)d[e]=h,h+=l[e];Y(c)&&Y(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,r=getBinaryAccessor(c),c=r.createArrayBufferView(t.buffer,t.byteOffset+c.byteOffset,h));const g=o.length;for(e=0;e<g;++e){const b=o[e].length,E=o[e].instances,I=getBinaryProperties(b,E,t);o[e].instances=combine(I,E)}const m=new Array(g).fill(0),T=new Uint16Array(i);for(e=0;e<i;++e)n=a[e],T[e]=m[n],++m[n];const y={classes:o,classIds:a,classIndexes:T,parentCounts:l,parentIndexes:d,parentIds:c};return Qr(y),y}function Et(s,t,e){if(!s)return;const n=s.parentCounts;return s.parentIds?e(s,t):n>0?Yr(s,t,e):Xr(s,t,e)}function Yr(s,t,e){const n=s.classIds,r=s.parentCounts,i=s.parentIds,o=s.parentIndexes,a=n.length,l=scratchVisited;l.length=Math.max(l.length,a);const c=++marker,h=scratchStack;for(h.length=0,h.push(t);h.length>0;){if(t=h.pop(),l[t]===c)continue;l[t]=c;const d=e(s,t);if(Y(d))return d;const g=r[t],m=o[t];for(let T=0;T<g;++T){const y=i[m+T];y!==t&&h.push(y)}}return null}function Xr(s,t,e){let n=!0;for(;n;){const r=e(s,t);if(Y(r))return r;const i=s.parentIds[t];n=i!==t,t=i}throw new Error("traverseHierarchySingleParent")}function Qr(s){const e=s.classIds.length;for(let n=0;n<e;++n)Ns(s,n,stack)}function Ns(s,t,e){const n=s.parentCounts,r=s.parentIds,i=s.parentIndexes,a=s.classIds.length;if(!Y(r))return;assert(t<a,`Parent index ${t} exceeds the total number of instances: ${a}`),assert(e.indexOf(t)===-1,"Circular dependency detected in the batch table hierarchy."),e.push(t);const l=Y(n)?n[t]:1,c=Y(n)?i[t]:t;for(let h=0;h<l;++h){const d=r[c+h];d!==t&&Ns(s,d,e)}e.pop(t)}function v(s){return s!=null}const Pt=(s,t)=>s,Jr={HIERARCHY:!0,extensions:!0,extras:!0};class Rs{constructor(t,e,n,r={}){u(this,"json");u(this,"binary");u(this,"featureCount");u(this,"_extensions");u(this,"_properties");u(this,"_binaryProperties");u(this,"_hierarchy");var i;M(n>=0),this.json=t||{},this.binary=e,this.featureCount=n,this._extensions=((i=this.json)==null?void 0:i.extensions)||{},this._properties={};for(const o in this.json)Jr[o]||(this._properties[o]=this.json[o]);this._binaryProperties=this._initializeBinaryProperties(),r["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=$r(this,this.json,this.binary))}getExtension(t){return this.json&&this.json.extensions&&this.json.extensions[t]}memorySizeInBytes(){return 0}isClass(t,e){if(this._checkBatchId(t),M(typeof e=="string",e),this._hierarchy){const n=Et(this._hierarchy,t,(r,i)=>{const o=r.classIds[i];return r.classes[o].name===e});return v(n)}return!1}isExactClass(t,e){return M(typeof e=="string",e),this.getExactClassName(t)===e}getExactClassName(t){if(this._checkBatchId(t),this._hierarchy){const e=this._hierarchy.classIds[t];return this._hierarchy.classes[e].name}}hasProperty(t,e){return this._checkBatchId(t),M(typeof e=="string",e),v(this._properties[e])||this._hasPropertyInHierarchy(t,e)}getPropertyNames(t,e){this._checkBatchId(t),e=v(e)?e:[],e.length=0;const n=Object.keys(this._properties);return e.push(...n),this._hierarchy&&this._getPropertyNamesInHierarchy(t,e),e}getProperty(t,e){if(this._checkBatchId(t),M(typeof e=="string",e),this._binaryProperties){const r=this._binaryProperties[e];if(v(r))return this._getBinaryProperty(r,t)}const n=this._properties[e];if(v(n))return Pt(n[t]);if(this._hierarchy){const r=this._getHierarchyProperty(t,e);if(v(r))return r}}setProperty(t,e,n){const r=this.featureCount;if(this._checkBatchId(t),M(typeof e=="string",e),this._binaryProperties){const o=this._binaryProperties[e];if(o){this._setBinaryProperty(o,t,n);return}}if(this._hierarchy&&this._setHierarchyProperty(this,t,e,n))return;let i=this._properties[e];v(i)||(this._properties[e]=new Array(r),i=this._properties[e]),i[t]=Pt(n)}_checkBatchId(t){if(!(t>=0&&t<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(t,e){return t.unpack(t.typedArray,e)}_setBinaryProperty(t,e,n){t.pack(n,t.typedArray,e)}_initializeBinaryProperties(){let t=null;for(const e in this._properties){const n=this._properties[e],r=this._initializeBinaryProperty(e,n);r&&(t=t||{},t[e]=r)}return t}_initializeBinaryProperty(t,e){if("byteOffset"in e){const n=e;M(this.binary,`Property ${t} requires a batch table binary.`),M(n.type,`Property ${t} requires a type.`);const r=jr(n,this.binary.buffer,this.binary.byteOffset|0,this.featureCount);return{typedArray:r.values,componentCount:r.size,unpack:r.unpacker,pack:r.packer}}return null}_hasPropertyInHierarchy(t,e){if(!this._hierarchy)return!1;const n=Et(this._hierarchy,t,(r,i)=>{const o=r.classIds[i],a=r.classes[o].instances;return v(a[e])});return v(n)}_getPropertyNamesInHierarchy(t,e){Et(this._hierarchy,t,(n,r)=>{const i=n.classIds[r],o=n.classes[i].instances;for(const a in o)o.hasOwnProperty(a)&&e.indexOf(a)===-1&&e.push(a)})}_getHierarchyProperty(t,e){return Et(this._hierarchy,t,(n,r)=>{const i=n.classIds[r],o=n.classes[i],a=n.classIndexes[r],l=o.instances[e];return v(l)?v(l.typedArray)?this._getBinaryProperty(l,a):Pt(l[a]):null})}_setHierarchyProperty(t,e,n,r){const i=Et(this._hierarchy,e,(o,a)=>{const l=o.classIds[a],c=o.classes[l],h=o.classIndexes[a],d=c.instances[n];return v(d)?(M(a===e,`Inherited property "${n}" is read-only.`),v(d.typedArray)?this._setBinaryProperty(d,h,r):d[h]=Pt(r),!0):!1});return v(i)}}const te=4;function Gt(s,t,e=0){const n=new DataView(t);if(s.magic=n.getUint32(e,!0),e+=te,s.version=n.getUint32(e,!0),e+=te,s.byteLength=n.getUint32(e,!0),e+=te,s.version!==1)throw new Error(`3D Tile Version ${s.version} not supported`);return e}const dt=4,Ye="b3dm tile in legacy format.";function ge(s,t,e){const n=new DataView(t);let r;s.header=s.header||{};let i=n.getUint32(e,!0);e+=dt;let o=n.getUint32(e,!0);e+=dt;let a=n.getUint32(e,!0);e+=dt;let l=n.getUint32(e,!0);return e+=dt,a>=570425344?(e-=dt*2,r=i,a=o,l=0,i=0,o=0,console.warn(Ye)):l>=570425344&&(e-=dt,r=a,a=i,l=o,i=0,o=0,console.warn(Ye)),s.header.featureTableJsonByteLength=i,s.header.featureTableBinaryByteLength=o,s.header.batchTableJsonByteLength=a,s.header.batchTableBinaryByteLength=l,s.header.batchLength=r,e}function me(s,t,e,n){return e=Kr(s,t,e),e=ti(s,t,e),e}function Kr(s,t,e,n){const{featureTableJsonByteLength:r,featureTableBinaryByteLength:i,batchLength:o}=s.header||{};if(s.featureTableJson={BATCH_LENGTH:o||0},r&&r>0){const a=Ms(t,e,r);s.featureTableJson=JSON.parse(a)}return e+=r||0,s.featureTableBinary=new Uint8Array(t,e,i),e+=i||0,e}function ti(s,t,e,n){const{batchTableJsonByteLength:r,batchTableBinaryByteLength:i}=s.header||{};if(r&&r>0){const o=Ms(t,e,r);s.batchTableJson=JSON.parse(o),e+=r,i&&i>0&&(s.batchTableBinary=new Uint8Array(t,e,i),s.batchTableBinary=new Uint8Array(s.batchTableBinary),e+=i)}return e}function Ps(s,t,e){if(!t&&(!s||!s.batchIds||!e))return null;const{batchIds:n,isRGB565:r,pointCount:i=0}=s;if(n&&e){const o=new Uint8ClampedArray(i*3);for(let a=0;a<i;a++){const l=n[a],h=e.getProperty(l,"dimensions").map(d=>d*255);o[a*3]=h[0],o[a*3+1]=h[1],o[a*3+2]=h[2]}return{type:_.UNSIGNED_BYTE,value:o,size:3,normalized:!0}}if(t&&r){const o=new Uint8ClampedArray(i*3);for(let a=0;a<i;a++){const l=zr(t[a]);o[a*3]=l[0],o[a*3+1]=l[1],o[a*3+2]=l[2]}return{type:_.UNSIGNED_BYTE,value:o,size:3,normalized:!0}}return t&&t.length===i*3?{type:_.UNSIGNED_BYTE,value:t,size:3,normalized:!0}:{type:_.UNSIGNED_BYTE,value:t||new Uint8ClampedArray,size:4,normalized:!0}}const Xe=new f;function ei(s,t){if(!t)return null;if(s.isOctEncoded16P){const e=new Float32Array((s.pointsLength||0)*3);for(let n=0;n<(s.pointsLength||0);n++)qr(t[n*2],t[n*2+1],Xe),Xe.toArray(e,n*3);return{type:_.FLOAT,size:2,value:e}}return{type:_.FLOAT,size:2,value:t}}function si(s,t,e){return s.isQuantized?e["3d-tiles"]&&e["3d-tiles"].decodeQuantizedPositions?(s.isQuantized=!1,ni(s,t)):{type:_.UNSIGNED_SHORT,value:t,size:3,normalized:!0}:t}function ni(s,t){const e=new f,n=new Float32Array(s.pointCount*3);for(let r=0;r<s.pointCount;r++)e.set(t[r*3],t[r*3+1],t[r*3+2]).scale(1/s.quantizedRange).multiply(s.quantizedVolumeScale).add(s.quantizedVolumeOffset).toArray(n,r*3);return n}async function ri(s,t,e,n,r){e=Gt(s,t,e),e=ge(s,t,e),e=me(s,t,e),ii(s);const{featureTable:i,batchTable:o}=oi(s);return await ui(s,i,o,n,r),ai(s,i,n),ci(s,i,o),li(s,i),e}function ii(s){s.attributes={positions:null,colors:null,normals:null,batchIds:null},s.isQuantized=!1,s.isTranslucent=!1,s.isRGB565=!1,s.isOctEncoded16P=!1}function oi(s){const t=new pe(s.featureTableJson,s.featureTableBinary),e=t.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(e))throw new Error("POINTS_LENGTH must be defined");t.featuresLength=e,s.featuresLength=e,s.pointsLength=e,s.pointCount=e,s.rtcCenter=t.getGlobalProperty("RTC_CENTER",_.FLOAT,3);const n=hi(s,t);return{featureTable:t,batchTable:n}}function ai(s,t,e){if(s.attributes=s.attributes||{positions:null,colors:null,normals:null,batchIds:null},!s.attributes.positions){if(t.hasProperty("POSITION"))s.attributes.positions=t.getPropertyArray("POSITION",_.FLOAT,3);else if(t.hasProperty("POSITION_QUANTIZED")){const n=t.getPropertyArray("POSITION_QUANTIZED",_.UNSIGNED_SHORT,3);if(s.isQuantized=!0,s.quantizedRange=65535,s.quantizedVolumeScale=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",_.FLOAT,3),!s.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(s.quantizedVolumeOffset=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",_.FLOAT,3),!s.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");s.attributes.positions=si(s,n,e)}}if(!s.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}function ci(s,t,e){if(s.attributes=s.attributes||{positions:null,colors:null,normals:null,batchIds:null},!s.attributes.colors){let n=null;t.hasProperty("RGBA")?(n=t.getPropertyArray("RGBA",_.UNSIGNED_BYTE,4),s.isTranslucent=!0):t.hasProperty("RGB")?n=t.getPropertyArray("RGB",_.UNSIGNED_BYTE,3):t.hasProperty("RGB565")&&(n=t.getPropertyArray("RGB565",_.UNSIGNED_SHORT,1),s.isRGB565=!0),s.attributes.colors=Ps(s,n,e)}t.hasProperty("CONSTANT_RGBA")&&(s.constantRGBA=t.getGlobalProperty("CONSTANT_RGBA",_.UNSIGNED_BYTE,4))}function li(s,t){if(s.attributes=s.attributes||{positions:null,colors:null,normals:null,batchIds:null},!s.attributes.normals){let e=null;t.hasProperty("NORMAL")?e=t.getPropertyArray("NORMAL",_.FLOAT,3):t.hasProperty("NORMAL_OCT16P")&&(e=t.getPropertyArray("NORMAL_OCT16P",_.UNSIGNED_BYTE,2),s.isOctEncoded16P=!0),s.attributes.normals=ei(s,e)}}function hi(s,t){let e=null;if(!s.batchIds&&t.hasProperty("BATCH_ID")&&(s.batchIds=t.getPropertyArray("BATCH_ID",_.UNSIGNED_SHORT,1),s.batchIds)){const n=t.getGlobalProperty("BATCH_LENGTH");if(!n)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:r,batchTableBinary:i}=s;e=new Rs(r,i,n)}return e}async function ui(s,t,e,n,r){let i,o,a;const l=s.batchTableJson&&s.batchTableJson.extensions&&s.batchTableJson.extensions["3DTILES_draco_point_compression"];l&&(a=l.properties);const c=t.getExtension("3DTILES_draco_point_compression");if(c){o=c.properties;const d=c.byteOffset,g=c.byteLength;if(!o||!Number.isFinite(d)||!g)throw new Error("Draco properties, byteOffset, and byteLength must be defined");i=(s.featureTableBinary||[]).slice(d,d+g),s.hasPositions=Number.isFinite(o.POSITION),s.hasColors=Number.isFinite(o.RGB)||Number.isFinite(o.RGBA),s.hasNormals=Number.isFinite(o.NORMAL),s.hasBatchIds=Number.isFinite(o.BATCH_ID),s.isTranslucent=Number.isFinite(o.RGBA)}if(!i)return!0;const h={buffer:i,properties:{...o,...a},batchTableProperties:a};return await di(s,h,n,r)}async function di(s,t,e,n){if(!n)return;const r={...e,draco:{...e==null?void 0:e.draco,extraAttributes:t.batchTableProperties||{}}};delete r["3d-tiles"];const i=await ue(t.buffer,In,r,n),o=i.attributes.POSITION&&i.attributes.POSITION.value,a=i.attributes.COLOR_0&&i.attributes.COLOR_0.value,l=i.attributes.NORMAL&&i.attributes.NORMAL.value,c=i.attributes.BATCH_ID&&i.attributes.BATCH_ID.value,h=o&&i.attributes.POSITION.value.quantization,d=l&&i.attributes.NORMAL.value.quantization;if(h){const m=i.POSITION.data.quantization,T=m.range;s.quantizedVolumeScale=new f(T,T,T),s.quantizedVolumeOffset=new f(m.minValues),s.quantizedRange=(1<<m.quantizationBits)-1,s.isQuantizedDraco=!0}d&&(s.octEncodedRange=(1<<i.NORMAL.data.quantization.quantizationBits)-1,s.isOctEncodedDraco=!0);const g={};if(t.batchTableProperties)for(const m of Object.keys(t.batchTableProperties))i.attributes[m]&&i.attributes[m].value&&(g[m.toLowerCase()]=i.attributes[m].value);s.attributes={positions:o,colors:Ps(s,a,void 0),normals:l,batchIds:c,...g}}const oe={URI:0,EMBEDDED:1};function Os(s,t,e,n){s.rotateYtoZ=!0;const r=(s.byteOffset||0)+(s.byteLength||0)-e;if(r===0)throw new Error("glTF byte length must be greater than 0.");return s.gltfUpAxis=n!=null&&n["3d-tiles"]&&n["3d-tiles"].assetGltfUpAxis?n["3d-tiles"].assetGltfUpAxis:"Y",s.gltfArrayBuffer=yn(t,e,r),s.gltfByteOffset=0,s.gltfByteLength=r,e%4===0||console.warn(`${s.type}: embedded glb is not aligned to a 4-byte boundary.`),(s.byteOffset||0)+(s.byteLength||0)}async function Us(s,t,e,n){const r=(e==null?void 0:e["3d-tiles"])||{};if(fi(s,t),r.loadGLTF){if(!n)return;if(s.gltfUrl){const{fetch:i}=n,o=await i(s.gltfUrl,e);s.gltfArrayBuffer=await o.arrayBuffer(),s.gltfByteOffset=0}if(s.gltfArrayBuffer){const i=await ue(s.gltfArrayBuffer,fs,e,n);s.gltf=ps(i),s.gpuMemoryUsageInBytes=gs(s.gltf),delete s.gltfArrayBuffer,delete s.gltfByteOffset,delete s.gltfByteLength}}}function fi(s,t,e){switch(t){case oe.URI:if(s.gltfArrayBuffer){const n=new Uint8Array(s.gltfArrayBuffer,s.gltfByteOffset),i=new TextDecoder().decode(n);s.gltfUrl=i.replace(/[\s\0]+$/,"")}delete s.gltfArrayBuffer,delete s.gltfByteOffset,delete s.gltfByteLength;break;case oe.EMBEDDED:break;default:throw new Error("b3dm: Illegal glTF format field")}}async function pi(s,t,e,n,r){var o;e=gi(s,t,e,n),await Us(s,oe.EMBEDDED,n,r);const i=(o=s==null?void 0:s.gltf)==null?void 0:o.extensions;return i&&i.CESIUM_RTC&&(s.rtcCenter=i.CESIUM_RTC.center),e}function gi(s,t,e,n,r){e=Gt(s,t,e),e=ge(s,t,e),e=me(s,t,e),e=Os(s,t,e,n);const i=new pe(s.featureTableJson,s.featureTableBinary);return s.rtcCenter=i.getGlobalProperty("RTC_CENTER",_.FLOAT,3),e}async function mi(s,t,e,n,r){return e=Ti(s,t,e,n),await Us(s,s.gltfFormat||0,n,r),e}function Ti(s,t,e,n,r){var c;if(e=Gt(s,t,e),s.version!==1)throw new Error(`Instanced 3D Model version ${s.version} is not supported`);e=ge(s,t,e);const i=new DataView(t);if(s.gltfFormat=i.getUint32(e,!0),e+=4,e=me(s,t,e),e=Os(s,t,e,n),!((c=s==null?void 0:s.header)!=null&&c.featureTableJsonByteLength)||s.header.featureTableJsonByteLength===0)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const o=new pe(s.featureTableJson,s.featureTableBinary),a=o.getGlobalProperty("INSTANCES_LENGTH");if(o.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");s.eastNorthUp=o.getGlobalProperty("EAST_NORTH_UP"),s.rtcCenter=o.getGlobalProperty("RTC_CENTER",_.FLOAT,3);const l=new Rs(s.batchTableJson,s.batchTableBinary,a);return yi(s,o,l,a),e}function yi(s,t,e,n){const r=new Array(n),i=new f;new f,new f,new f;const o=new _s,a=new ys,l=new f,c={},h=new A,d=[],g=[],m=[],T=[];for(let y=0;y<n;y++){let b;if(t.hasProperty("POSITION"))b=t.getProperty("POSITION",_.FLOAT,3,y,i);else if(t.hasProperty("POSITION_QUANTIZED")){b=t.getProperty("POSITION_QUANTIZED",_.UNSIGNED_SHORT,3,y,i);const P=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",_.FLOAT,3);if(!P)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const Q=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",_.FLOAT,3);if(!Q)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const z=65535;for(let N=0;N<3;N++)b[N]=b[N]/z*Q[N]+P[N]}if(!b)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");if(i.copy(b),c.translation=i,s.normalUp=t.getProperty("NORMAL_UP",_.FLOAT,3,y,d),s.normalRight=t.getProperty("NORMAL_RIGHT",_.FLOAT,3,y,g),s.normalUp){if(!s.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");s.hasCustomOrientation=!0}else{if(s.octNormalUp=t.getProperty("NORMAL_UP_OCT32P",_.UNSIGNED_SHORT,2,y,d),s.octNormalRight=t.getProperty("NORMAL_RIGHT_OCT32P",_.UNSIGNED_SHORT,2,y,g),s.octNormalUp)throw s.octNormalRight?new Error("i3dm: oct-encoded orientation not implemented"):new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");s.eastNorthUp?(C.WGS84.eastNorthUpToFixedFrame(i,h),h.getRotationMatrix3(o)):o.identity()}a.fromMatrix3(o),c.rotation=a,l.set(1,1,1);const E=t.getProperty("SCALE",_.FLOAT,1,y,m);Number.isFinite(E)&&l.multiplyByScalar(E);const I=t.getProperty("SCALE_NON_UNIFORM",_.FLOAT,3,y,d);I&&l.scale(I),c.scale=l;let R=t.getProperty("BATCH_ID",_.UNSIGNED_SHORT,1,y,T);R===void 0&&(R=y);const D=new A().fromQuaternion(c.rotation);h.identity(),h.translate(c.translation),h.multiplyRight(D),h.scale(c.scale);const B=h.clone();r[y]={modelMatrix:B,batchId:R}}s.instances=r}async function _i(s,t,e,n,r,i){e=Gt(s,t,e);const o=new DataView(t);for(s.tilesLength=o.getUint32(e,!0),e+=4,s.tiles=[];s.tiles.length<s.tilesLength&&(s.byteLength||0)-e>12;){const a={shape:"tile3d"};s.tiles.push(a),e=await i(t,e,n,r,a)}return e}async function Si(s,t,e,n){var r,i;if(s.rotateYtoZ=!0,s.gltfUpAxis=(r=e==null?void 0:e["3d-tiles"])!=null&&r.assetGltfUpAxis?e["3d-tiles"].assetGltfUpAxis:"Y",(i=e==null?void 0:e["3d-tiles"])!=null&&i.loadGLTF){if(!n)return t.byteLength;const o=await ue(t,fs,e,n);s.gltf=ps(o),s.gpuMemoryUsageInBytes=gs(s.gltf)}else s.gltfArrayBuffer=t;return t.byteLength}async function Ds(s,t=0,e,n,r={shape:"tile3d"}){switch(r.byteOffset=t,r.type=xr(s,t),r.type){case wt.COMPOSITE:return await _i(r,s,t,e,n,Ds);case wt.BATCHED_3D_MODEL:return await pi(r,s,t,e,n);case wt.GLTF:return await Si(r,s,e,n);case wt.INSTANCED_3D_MODEL:return await mi(r,s,t,e,n);case wt.POINT_CLOUD:return await ri(r,s,t,e,n);default:throw new Error(`3DTileLoader: unknown type ${r.type}`)}}const wi=1952609651,Ei=1;async function bi(s,t,e){if(new Uint32Array(s.slice(0,4))[0]!==wi)throw new Error("Wrong subtree file magic number");if(new Uint32Array(s.slice(4,8))[0]!==Ei)throw new Error("Wrong subtree file verson, must be 1");const i=Qe(s.slice(8,16)),o=new Uint8Array(s,24,i),l=new TextDecoder("utf8").decode(o),c=JSON.parse(l),h=Qe(s.slice(16,24));let d=new ArrayBuffer(0);if(h&&(d=s.slice(24+i)),await Ot(c,c.tileAvailability,d,e),Array.isArray(c.contentAvailability))for(const g of c.contentAvailability)await Ot(c,g,d,e);else await Ot(c,c.contentAvailability,d,e);return await Ot(c,c.childSubtreeAvailability,d,e),c}async function Ot(s,t,e,n){const r=Number.isFinite(t.bitstream)?t.bitstream:t.bufferView;if(typeof r!="number")return;const i=s.bufferViews[r],o=s.buffers[i.buffer];if(!(n!=null&&n.baseUrl))throw new Error("Url is not provided");if(!n.fetch)throw new Error("fetch is not provided");if(o.uri){const l=`${(n==null?void 0:n.baseUrl)||""}/${o.uri}`,h=await(await n.fetch(l)).arrayBuffer();t.explicitBitstream=new Uint8Array(h,i.byteOffset,i.byteLength);return}const a=s.buffers.slice(0,i.buffer).reduce((l,c)=>l+c.byteLength,0);t.explicitBitstream=new Uint8Array(e.slice(a,a+o.byteLength),i.byteOffset,i.byteLength)}function Qe(s){const t=new DataView(s),e=t.getUint32(0,!0),n=t.getUint32(4,!0);return e+2**32*n}const vs={dataType:null,batchType:null,id:"3d-tiles-subtree",name:"3D Tiles Subtree",module:"3d-tiles",version:Ls,extensions:["subtree"],mimeTypes:["application/octet-stream"],tests:["subtree"],parse:bi,options:{}};/**
 * @license
 * Copyright 2009 The Closure Library Authors
 * Copyright 2020 Daniel Wirtz / The long.js Authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */var G=null;try{G=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch{}function w(s,t,e){this.low=s|0,this.high=t|0,this.unsigned=!!e}w.prototype.__isLong__;Object.defineProperty(w.prototype,"__isLong__",{value:!0});function U(s){return(s&&s.__isLong__)===!0}function Je(s){var t=Math.clz32(s&-s);return s?31-t:t}w.isLong=U;var Ke={},ts={};function at(s,t){var e,n,r;return t?(s>>>=0,(r=0<=s&&s<256)&&(n=ts[s],n)?n:(e=S(s,0,!0),r&&(ts[s]=e),e)):(s|=0,(r=-128<=s&&s<128)&&(n=Ke[s],n)?n:(e=S(s,s<0?-1:0,!1),r&&(Ke[s]=e),e))}w.fromInt=at;function q(s,t){if(isNaN(s))return t?K:Z;if(t){if(s<0)return K;if(s>=xs)return Fs}else{if(s<=-ss)return V;if(s+1>=ss)return Bs}return s<0?q(-s,t).neg():S(s%Tt|0,s/Tt|0,t)}w.fromNumber=q;function S(s,t,e){return new w(s,t,e)}w.fromBits=S;var Bt=Math.pow;function Te(s,t,e){if(s.length===0)throw Error("empty string");if(typeof t=="number"?(e=t,t=!1):t=!!t,s==="NaN"||s==="Infinity"||s==="+Infinity"||s==="-Infinity")return t?K:Z;if(e=e||10,e<2||36<e)throw RangeError("radix");var n;if((n=s.indexOf("-"))>0)throw Error("interior hyphen");if(n===0)return Te(s.substring(1),t,e).neg();for(var r=q(Bt(e,8)),i=Z,o=0;o<s.length;o+=8){var a=Math.min(8,s.length-o),l=parseInt(s.substring(o,o+a),e);if(a<8){var c=q(Bt(e,a));i=i.mul(c).add(q(l))}else i=i.mul(r),i=i.add(q(l))}return i.unsigned=t,i}w.fromString=Te;function k(s,t){return typeof s=="number"?q(s,t):typeof s=="string"?Te(s,t):S(s.low,s.high,typeof t=="boolean"?t:s.unsigned)}w.fromValue=k;var es=65536,Ci=1<<24,Tt=es*es,xs=Tt*Tt,ss=xs/2,ns=at(Ci),Z=at(0);w.ZERO=Z;var K=at(0,!0);w.UZERO=K;var gt=at(1);w.ONE=gt;var Vs=at(1,!0);w.UONE=Vs;var ae=at(-1);w.NEG_ONE=ae;var Bs=S(-1,2147483647,!1);w.MAX_VALUE=Bs;var Fs=S(-1,-1,!0);w.MAX_UNSIGNED_VALUE=Fs;var V=S(0,-2147483648,!1);w.MIN_VALUE=V;var p=w.prototype;p.toInt=function(){return this.unsigned?this.low>>>0:this.low};p.toNumber=function(){return this.unsigned?(this.high>>>0)*Tt+(this.low>>>0):this.high*Tt+(this.low>>>0)};p.toString=function(t){if(t=t||10,t<2||36<t)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative())if(this.eq(V)){var e=q(t),n=this.div(e),r=n.mul(e).sub(this);return n.toString(t)+r.toInt().toString(t)}else return"-"+this.neg().toString(t);for(var i=q(Bt(t,6),this.unsigned),o=this,a="";;){var l=o.div(i),c=o.sub(l.mul(i)).toInt()>>>0,h=c.toString(t);if(o=l,o.isZero())return h+a;for(;h.length<6;)h="0"+h;a=""+h+a}};p.getHighBits=function(){return this.high};p.getHighBitsUnsigned=function(){return this.high>>>0};p.getLowBits=function(){return this.low};p.getLowBitsUnsigned=function(){return this.low>>>0};p.getNumBitsAbs=function(){if(this.isNegative())return this.eq(V)?64:this.neg().getNumBitsAbs();for(var t=this.high!=0?this.high:this.low,e=31;e>0&&!(t&1<<e);e--);return this.high!=0?e+33:e+1};p.isSafeInteger=function(){var t=this.high>>21;return t?this.unsigned?!1:t===-1&&!(this.low===0&&this.high===-2097152):!0};p.isZero=function(){return this.high===0&&this.low===0};p.eqz=p.isZero;p.isNegative=function(){return!this.unsigned&&this.high<0};p.isPositive=function(){return this.unsigned||this.high>=0};p.isOdd=function(){return(this.low&1)===1};p.isEven=function(){return(this.low&1)===0};p.equals=function(t){return U(t)||(t=k(t)),this.unsigned!==t.unsigned&&this.high>>>31===1&&t.high>>>31===1?!1:this.high===t.high&&this.low===t.low};p.eq=p.equals;p.notEquals=function(t){return!this.eq(t)};p.neq=p.notEquals;p.ne=p.notEquals;p.lessThan=function(t){return this.comp(t)<0};p.lt=p.lessThan;p.lessThanOrEqual=function(t){return this.comp(t)<=0};p.lte=p.lessThanOrEqual;p.le=p.lessThanOrEqual;p.greaterThan=function(t){return this.comp(t)>0};p.gt=p.greaterThan;p.greaterThanOrEqual=function(t){return this.comp(t)>=0};p.gte=p.greaterThanOrEqual;p.ge=p.greaterThanOrEqual;p.compare=function(t){if(U(t)||(t=k(t)),this.eq(t))return 0;var e=this.isNegative(),n=t.isNegative();return e&&!n?-1:!e&&n?1:this.unsigned?t.high>>>0>this.high>>>0||t.high===this.high&&t.low>>>0>this.low>>>0?-1:1:this.sub(t).isNegative()?-1:1};p.comp=p.compare;p.negate=function(){return!this.unsigned&&this.eq(V)?V:this.not().add(gt)};p.neg=p.negate;p.add=function(t){U(t)||(t=k(t));var e=this.high>>>16,n=this.high&65535,r=this.low>>>16,i=this.low&65535,o=t.high>>>16,a=t.high&65535,l=t.low>>>16,c=t.low&65535,h=0,d=0,g=0,m=0;return m+=i+c,g+=m>>>16,m&=65535,g+=r+l,d+=g>>>16,g&=65535,d+=n+a,h+=d>>>16,d&=65535,h+=e+o,h&=65535,S(g<<16|m,h<<16|d,this.unsigned)};p.subtract=function(t){return U(t)||(t=k(t)),this.add(t.neg())};p.sub=p.subtract;p.multiply=function(t){if(this.isZero())return this;if(U(t)||(t=k(t)),G){var e=G.mul(this.low,this.high,t.low,t.high);return S(e,G.get_high(),this.unsigned)}if(t.isZero())return this.unsigned?K:Z;if(this.eq(V))return t.isOdd()?V:Z;if(t.eq(V))return this.isOdd()?V:Z;if(this.isNegative())return t.isNegative()?this.neg().mul(t.neg()):this.neg().mul(t).neg();if(t.isNegative())return this.mul(t.neg()).neg();if(this.lt(ns)&&t.lt(ns))return q(this.toNumber()*t.toNumber(),this.unsigned);var n=this.high>>>16,r=this.high&65535,i=this.low>>>16,o=this.low&65535,a=t.high>>>16,l=t.high&65535,c=t.low>>>16,h=t.low&65535,d=0,g=0,m=0,T=0;return T+=o*h,m+=T>>>16,T&=65535,m+=i*h,g+=m>>>16,m&=65535,m+=o*c,g+=m>>>16,m&=65535,g+=r*h,d+=g>>>16,g&=65535,g+=i*c,d+=g>>>16,g&=65535,g+=o*l,d+=g>>>16,g&=65535,d+=n*h+r*c+i*l+o*a,d&=65535,S(m<<16|T,d<<16|g,this.unsigned)};p.mul=p.multiply;p.divide=function(t){if(U(t)||(t=k(t)),t.isZero())throw Error("division by zero");if(G){if(!this.unsigned&&this.high===-2147483648&&t.low===-1&&t.high===-1)return this;var e=(this.unsigned?G.div_u:G.div_s)(this.low,this.high,t.low,t.high);return S(e,G.get_high(),this.unsigned)}if(this.isZero())return this.unsigned?K:Z;var n,r,i;if(this.unsigned){if(t.unsigned||(t=t.toUnsigned()),t.gt(this))return K;if(t.gt(this.shru(1)))return Vs;i=K}else{if(this.eq(V)){if(t.eq(gt)||t.eq(ae))return V;if(t.eq(V))return gt;var o=this.shr(1);return n=o.div(t).shl(1),n.eq(Z)?t.isNegative()?gt:ae:(r=this.sub(t.mul(n)),i=n.add(r.div(t)),i)}else if(t.eq(V))return this.unsigned?K:Z;if(this.isNegative())return t.isNegative()?this.neg().div(t.neg()):this.neg().div(t).neg();if(t.isNegative())return this.div(t.neg()).neg();i=Z}for(r=this;r.gte(t);){n=Math.max(1,Math.floor(r.toNumber()/t.toNumber()));for(var a=Math.ceil(Math.log(n)/Math.LN2),l=a<=48?1:Bt(2,a-48),c=q(n),h=c.mul(t);h.isNegative()||h.gt(r);)n-=l,c=q(n,this.unsigned),h=c.mul(t);c.isZero()&&(c=gt),i=i.add(c),r=r.sub(h)}return i};p.div=p.divide;p.modulo=function(t){if(U(t)||(t=k(t)),G){var e=(this.unsigned?G.rem_u:G.rem_s)(this.low,this.high,t.low,t.high);return S(e,G.get_high(),this.unsigned)}return this.sub(this.div(t).mul(t))};p.mod=p.modulo;p.rem=p.modulo;p.not=function(){return S(~this.low,~this.high,this.unsigned)};p.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32};p.clz=p.countLeadingZeros;p.countTrailingZeros=function(){return this.low?Je(this.low):Je(this.high)+32};p.ctz=p.countTrailingZeros;p.and=function(t){return U(t)||(t=k(t)),S(this.low&t.low,this.high&t.high,this.unsigned)};p.or=function(t){return U(t)||(t=k(t)),S(this.low|t.low,this.high|t.high,this.unsigned)};p.xor=function(t){return U(t)||(t=k(t)),S(this.low^t.low,this.high^t.high,this.unsigned)};p.shiftLeft=function(t){return U(t)&&(t=t.toInt()),(t&=63)===0?this:t<32?S(this.low<<t,this.high<<t|this.low>>>32-t,this.unsigned):S(0,this.low<<t-32,this.unsigned)};p.shl=p.shiftLeft;p.shiftRight=function(t){return U(t)&&(t=t.toInt()),(t&=63)===0?this:t<32?S(this.low>>>t|this.high<<32-t,this.high>>t,this.unsigned):S(this.high>>t-32,this.high>=0?0:-1,this.unsigned)};p.shr=p.shiftRight;p.shiftRightUnsigned=function(t){return U(t)&&(t=t.toInt()),(t&=63)===0?this:t<32?S(this.low>>>t|this.high<<32-t,this.high>>>t,this.unsigned):t===32?S(this.high,0,this.unsigned):S(this.high>>>t-32,0,this.unsigned)};p.shru=p.shiftRightUnsigned;p.shr_u=p.shiftRightUnsigned;p.rotateLeft=function(t){var e;return U(t)&&(t=t.toInt()),(t&=63)===0?this:t===32?S(this.high,this.low,this.unsigned):t<32?(e=32-t,S(this.low<<t|this.high>>>e,this.high<<t|this.low>>>e,this.unsigned)):(t-=32,e=32-t,S(this.high<<t|this.low>>>e,this.low<<t|this.high>>>e,this.unsigned))};p.rotl=p.rotateLeft;p.rotateRight=function(t){var e;return U(t)&&(t=t.toInt()),(t&=63)===0?this:t===32?S(this.high,this.low,this.unsigned):t<32?(e=32-t,S(this.high<<e|this.low>>>t,this.low<<e|this.high>>>t,this.unsigned)):(t-=32,e=32-t,S(this.low<<e|this.high>>>t,this.high<<e|this.low>>>t,this.unsigned))};p.rotr=p.rotateRight;p.toSigned=function(){return this.unsigned?S(this.low,this.high,!1):this};p.toUnsigned=function(){return this.unsigned?this:S(this.low,this.high,!0)};p.toBytes=function(t){return t?this.toBytesLE():this.toBytesBE()};p.toBytesLE=function(){var t=this.high,e=this.low;return[e&255,e>>>8&255,e>>>16&255,e>>>24,t&255,t>>>8&255,t>>>16&255,t>>>24]};p.toBytesBE=function(){var t=this.high,e=this.low;return[t>>>24,t>>>16&255,t>>>8&255,t&255,e>>>24,e>>>16&255,e>>>8&255,e&255]};w.fromBytes=function(t,e,n){return n?w.fromBytesLE(t,e):w.fromBytesBE(t,e)};w.fromBytesLE=function(t,e){return new w(t[0]|t[1]<<8|t[2]<<16|t[3]<<24,t[4]|t[5]<<8|t[6]<<16|t[7]<<24,e)};w.fromBytesBE=function(t,e){return new w(t[4]<<24|t[5]<<16|t[6]<<8|t[7],t[0]<<24|t[1]<<16|t[2]<<8|t[3],e)};typeof BigInt=="function"&&(w.fromBigInt=function(t,e){var n=Number(BigInt.asIntN(32,t)),r=Number(BigInt.asIntN(32,t>>BigInt(32)));return S(n,r,e)},w.fromValue=function(t,e){return typeof t=="bigint"?w.fromBigInt(t,e):k(t,e)},p.toBigInt=function(){var t=BigInt(this.low>>>0),e=BigInt(this.unsigned?this.high>>>0:this.high);return e<<BigInt(32)|t});const Ii=16;function zs(s){s==="X"&&(s="");const t=s.padEnd(Ii,"0");return w.fromString(t,!0,16)}function Ai(s){if(s.isZero())return"X";let t=s.countTrailingZeros();const e=t%4;t=(t-e)/4;const n=t;t*=4;const i=s.shiftRightUnsigned(t).toString(16).replace(/0+$/,"");return Array(17-n-i.length).join("0")+i}function Li(s,t){const e=Mi(s).shiftRightUnsigned(2);return s.add(w.fromNumber(2*t+1-4).multiply(e))}function Mi(s){return s.and(s.not().add(1))}const Ni=3,Ri=30,Pi=2*Ri+1,rs=180/Math.PI;function Oi(s){if(s.length===0)throw new Error(`Invalid Hilbert quad key ${s}`);const t=s.split("/"),e=parseInt(t[0],10),n=t[1],r=n.length;let i=0;const o=[0,0];for(let a=r-1;a>=0;a--){i=r-a;const l=n[a];let c=0,h=0;l==="1"?h=1:l==="2"?(c=1,h=1):l==="3"&&(c=1);const d=Math.pow(2,i-1);Di(d,o,c,h),o[0]+=d*c,o[1]+=d*h}if(e%2===1){const a=o[0];o[0]=o[1],o[1]=a}return{face:e,ij:o,level:i}}function Ui(s){if(s.isZero())return"";let t=s.toString(2);for(;t.length<Ni+Pi;)t="0"+t;const e=t.lastIndexOf("1"),n=t.substring(0,3),r=t.substring(3,e),i=r.length/2,o=w.fromString(n,!0,2).toString(10);let a="";if(i!==0)for(a=w.fromString(r,!0,2).toString(4);a.length<i;)a="0"+a;return`${o}/${a}`}function Gs(s,t,e){const n=1<<t;return[(s[0]+e[0])/n,(s[1]+e[1])/n]}function is(s){return s>=.5?1/3*(4*s*s-1):1/3*(1-4*(1-s)*(1-s))}function qs(s){return[is(s[0]),is(s[1])]}function ks(s,[t,e]){switch(s){case 0:return[1,t,e];case 1:return[-t,1,e];case 2:return[-t,-e,1];case 3:return[-1,-e,-t];case 4:return[e,-1,-t];case 5:return[e,t,-1];default:throw new Error("Invalid face")}}function Hs([s,t,e]){const n=Math.atan2(e,Math.sqrt(s*s+t*t));return[Math.atan2(t,s)*rs,n*rs]}function Di(s,t,e,n){if(n===0){e===1&&(t[0]=s-1-t[0],t[1]=s-1-t[1]);const r=t[0];t[0]=t[1],t[1]=r}}function vi(s){const t=Gs(s.ij,s.level,[.5,.5]),e=qs(t),n=ks(s.face,e);return Hs(n)}const xi=100;function os(s){const{face:t,ij:e,level:n}=s,r=[[0,0],[0,1],[1,1],[1,0],[0,0]],i=Math.max(1,Math.ceil(xi*Math.pow(2,-n))),o=new Float64Array(4*i*2+2);let a=0,l=0;for(let c=0;c<4;c++){const h=r[c].slice(0),d=r[c+1],g=(d[0]-h[0])/i,m=(d[1]-h[1])/i;for(let T=0;T<i;T++){h[0]+=g,h[1]+=m;const y=Gs(e,n,h),b=qs(y),E=ks(t,b),I=Hs(E);Math.abs(I[1])>89.999&&(I[0]=l);const R=I[0]-l;I[0]+=R>180?-360:R<-180?360:0,o[a++]=I[0],o[a++]=I[1],l=I[0]}}return o[a++]=o[0],o[a++]=o[1],o}function ye(s){const t=Vi(s);return Oi(t)}function Vi(s){if(s.indexOf("/")>0)return s;const t=zs(s);return Ui(t)}function Bi(s){const t=ye(s);return vi(t)}function Fi(s){let t;if(s.face===2||s.face===5){let e=null,n=0;for(let r=0;r<4;r++){const i=`${s.face}/${r}`,o=ye(i),a=os(o);(typeof e>"u"||e===null)&&(e=new Float64Array(4*a.length)),e.set(a,n),n+=a.length}t=as(e)}else{const e=os(s);t=as(e)}return t}function as(s){if(s.length%2!==0)throw new Error("Invalid corners");const t=[],e=[];for(let n=0;n<s.length;n+=2)t.push(s[n]),e.push(s[n+1]);return t.sort((n,r)=>n-r),e.sort((n,r)=>n-r),{west:t[0],east:t[t.length-1],north:e[e.length-1],south:e[0]}}function zi(s,t){const e=(t==null?void 0:t.minimumHeight)||0,n=(t==null?void 0:t.maximumHeight)||0,r=ye(s),i=Fi(r),o=i.west,a=i.south,l=i.east,c=i.north,h=[];return h.push(new f(o,c,e)),h.push(new f(l,c,e)),h.push(new f(l,a,e)),h.push(new f(o,a,e)),h.push(new f(o,c,n)),h.push(new f(l,c,n)),h.push(new f(l,a,n)),h.push(new f(o,a,n)),h}function Zs(s){const t=s.token,e={minimumHeight:s.minimumHeight,maximumHeight:s.maximumHeight},n=zi(t,e),r=Bi(t),i=r[0],o=r[1],a=C.WGS84.cartographicToCartesian([i,o,e.maximumHeight]),l=new f(a[0],a[1],a[2]);n.push(l);const c=On(n);return[...c.center,...c.halfAxes]}const Gi=4,qi=8,ki={QUADTREE:Gi,OCTREE:qi};function Hi(s,t,e){if(s!=null&&s.box){const n=zs(s.s2VolumeInfo.token),r=Li(n,t),i=Ai(r),o={...s.s2VolumeInfo};switch(o.token=i,e){case"OCTREE":const c=s.s2VolumeInfo,h=c.maximumHeight-c.minimumHeight,d=h/2,g=c.minimumHeight+h/2;c.minimumHeight=g-d,c.maximumHeight=g+d;break}return{box:Zs(o),s2VolumeInfo:o}}}async function js(s){const{subtree:t,subtreeData:e={level:0,x:0,y:0,z:0},parentData:n={mortonIndex:0,localLevel:-1,localX:0,localY:0,localZ:0},childIndex:r=0,implicitOptions:i,loaderOptions:o,s2VolumeBox:a}=s,{subdivisionScheme:l,subtreeLevels:c,maximumLevel:h,contentUrlTemplate:d,subtreesUriTemplate:g,basePath:m}=i,T={children:[],lodMetricValue:0,contentUrl:""};if(!h)return Ss.once(`Missing 'maximumLevel' or 'availableLevels' property. The subtree ${d} won't be loaded...`),T;const y=n.localLevel+1,b=e.level+y;if(b>h)return T;const E=ki[l],I=Math.log2(E),R=r&1,D=r>>1&1,B=r>>2&1,P=it(n.localX,R,1),Q=it(n.localY,D,1),z=it(n.localZ,B,1),N=it(e.x,P,y),$=it(e.y,Q,y),tt=it(e.z,z,y),ct=it(n.mortonIndex,r,I),Ct=y===c&&ee(t.childSubtreeAvailability,ct);let et,yt,_t,lt;if(Ct){const st=`${m}/${g}`,It=ce(st,b,N,$,tt);et=await bt(It,vs,o),lt=0,yt={level:b,x:N,y:$,z:tt},_t={mortonIndex:0,localLevel:0,localX:0,localY:0,localZ:0}}else et=t,lt=(E**y-1)/(E-1)+ct,yt=e,_t={mortonIndex:ct,localLevel:y,localX:P,localY:Q,localZ:z};if(!ee(et.tileAvailability,lt))return T;ee(et.contentAvailability,lt)&&(T.contentUrl=ce(d,b,N,$,tt));for(let st=0;st<E;st++){const It=Hi(a,st,l),At=await js({subtree:et,subtreeData:yt,parentData:_t,childIndex:st,implicitOptions:i,loaderOptions:o,s2VolumeBox:It});(At.contentUrl||At.children.length)&&T.children.push(At)}return T.contentUrl||T.children.length?Zi(T,{level:b,x:N,y:$,z:tt},i,a):T}function ee(s,t){let e;return Array.isArray(s)?(e=s[0],s.length>1&&Ss.once('Not supported extension "3DTILES_multiple_contents" has been detected')):e=s,"constant"in e?!!e.constant:e.explicitBitstream?Wi(t,e.explicitBitstream):!1}function Zi(s,t,e,n){const{basePath:r,refine:i,getRefine:o,lodMetricType:a,getTileType:l,rootLodMetricValue:c,rootBoundingVolume:h}=e,d=s.contentUrl&&s.contentUrl.replace(`${r}/`,""),g=c/2**t.level,m=n!=null&&n.box?{box:n.box}:h,T=ji(m,t,e.subdivisionScheme);return{children:s.children,contentUrl:s.contentUrl,content:{uri:d},id:s.contentUrl,refine:o(i),type:l(s),lodMetricType:a,lodMetricValue:g,geometricError:g,transform:s.transform,boundingVolume:T}}function ji(s,t,e){if(s.region){const{level:n,x:r,y:i,z:o}=t,[a,l,c,h,d,g]=s.region,m=2**n,T=(c-a)/m,[y,b]=[a+T*r,a+T*(r+1)],E=(h-l)/m,[I,R]=[l+E*i,l+E*(i+1)];let D,B;if(e==="OCTREE"){const P=(g-d)/m;[D,B]=[d+P*o,d+P*(o+1)]}else[D,B]=[d,g];return{region:[y,I,b,R,D,B]}}if(s.box)return s;throw new Error(`Unsupported bounding volume type ${JSON.stringify(s)}`)}function it(s,t,e){return(s<<e)+t}function ce(s,t,e,n,r){const i=$i({level:t,x:e,y:n,z:r});return s.replace(/{level}|{x}|{y}|{z}/gi,o=>i[o])}function $i(s){const t={};for(const e in s)t[`{${e}}`]=s[e];return t}function Wi(s,t){const e=Math.floor(s/8),n=s%8;return(t[e]>>n&1)===1}function _e(s,t=""){if(!t)return J.EMPTY;const n=t.split("?")[0].split(".").pop();switch(n){case"pnts":return J.POINTCLOUD;case"i3dm":case"b3dm":case"glb":case"gltf":return J.SCENEGRAPH;default:return n||J.EMPTY}}function Se(s){switch(s){case"REPLACE":case"replace":return j.REPLACE;case"ADD":case"add":return j.ADD;default:return s}}function le(s,t){if(/^[a-z][0-9a-z+.-]*:/i.test(t)){const n=new URL(s,`${t}/`);return decodeURI(n.toString())}else if(s.startsWith("/"))return s;return _n(t,s)}function cs(s,t){var r;if(!s)return null;let e;if(s.content){const i=s.content.uri||((r=s.content)==null?void 0:r.url);typeof i<"u"&&(e=le(i,t))}return{...s,id:e,contentUrl:e,lodMetricType:mt.GEOMETRIC_ERROR,lodMetricValue:s.geometricError,transformMatrix:s.transform,type:_e(s,e),refine:Se(s.refine)}}async function Yi(s,t,e){let n=null;const r=hs(s.root);r&&s.root?n=await ls(s.root,s,t,r,e):n=cs(s.root,t);const i=[];for(i.push(n);i.length>0;){const o=i.pop()||{},a=o.children||[],l=[];for(const c of a){const h=hs(c);let d;h?d=await ls(c,s,t,h,e):d=cs(c,t),d&&(l.push(d),i.push(d))}o.children=l}return n}async function ls(s,t,e,n,r){var D,B,P;const{subdivisionScheme:i,maximumLevel:o,availableLevels:a,subtreeLevels:l,subtrees:{uri:c}}=n,h=ce(c,0,0,0,0),d=le(h,e),g=await bt(d,vs,r),m=(D=s.content)==null?void 0:D.uri,T=m?le(m,e):"",y=(B=t==null?void 0:t.root)==null?void 0:B.refine,b=s.geometricError,E=(P=s.boundingVolume.extensions)==null?void 0:P["3DTILES_bounding_volume_S2"];if(E){const z={box:Zs(E),s2VolumeInfo:E};s.boundingVolume=z}const I=s.boundingVolume,R={contentUrlTemplate:T,subtreesUriTemplate:c,subdivisionScheme:i,subtreeLevels:l,maximumLevel:Number.isFinite(a)?a-1:o,refine:y,basePath:e,lodMetricType:mt.GEOMETRIC_ERROR,rootLodMetricValue:b,rootBoundingVolume:I,getTileType:_e,getRefine:Se};return await Xi(s,e,g,R,r)}async function Xi(s,t,e,n,r){if(!s)return null;const{children:i,contentUrl:o}=await js({subtree:e,implicitOptions:n,loaderOptions:r});let a,l=null;return o&&(a=o,l={uri:o.replace(`${t}/`,"")}),{...s,id:a,contentUrl:a,lodMetricType:mt.GEOMETRIC_ERROR,lodMetricValue:s.geometricError,transformMatrix:s.transform,type:_e(s,a),refine:Se(s.refine),content:l||s.content,children:i}}function hs(s){var t;return((t=s==null?void 0:s.extensions)==null?void 0:t["3DTILES_implicit_tiling"])||(s==null?void 0:s.implicitTiling)}const $s={dataType:null,batchType:null,id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:Ls,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:Qi,options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}};async function Qi(s,t={},e){const n=t["3d-tiles"]||{};let r;return n.isTileset==="auto"?r=(e==null?void 0:e.url)&&e.url.indexOf(".json")!==-1:r=n.isTileset,r?Ji(s,t,e):Ki(s,t,e)}async function Ji(s,t,e){var l;const n=JSON.parse(new TextDecoder().decode(s)),r=(e==null?void 0:e.url)||"",i=to(r),o=await Yi(n,i,t||{});return{...n,shape:"tileset3d",loader:$s,url:r,queryString:(e==null?void 0:e.queryString)||"",basePath:i,root:o||n.root,type:x.TILES3D,lodMetricType:mt.GEOMETRIC_ERROR,lodMetricValue:((l=n.root)==null?void 0:l.geometricError)||0}}async function Ki(s,t,e){const n={content:{shape:"tile3d",featureIds:null}};return await Ds(s,0,t,e,n.content),n.content}function to(s){return ds(s)}const us=[0],eo={getPointColor:{type:"accessor",value:[0,0,0,255]},pointSize:1,data:"",loader:$s,onTilesetLoad:{type:"function",value:s=>{}},onTileLoad:{type:"function",value:s=>{}},onTileUnload:{type:"function",value:s=>{}},onTileError:{type:"function",value:(s,t,e)=>{}},_getMeshColor:{type:"function",value:s=>[255,255,255]}};class we extends Ln{initializeState(){"onTileLoadFail"in this.props&&Sn.removed("onTileLoadFail","onTileError")(),this.state={layerMap:{},tileset3d:null,activeViewports:{},lastUpdatedViewports:null}}get isLoaded(){var t,e;return!!((e=(t=this.state)==null?void 0:t.tileset3d)!=null&&e.isLoaded()&&super.isLoaded)}shouldUpdateState({changeFlags:t}){return t.somethingChanged}updateState({props:t,oldProps:e,changeFlags:n}){if(t.data&&t.data!==e.data&&this._loadTileset(t.data),n.viewportChanged){const{activeViewports:r}=this.state;Object.keys(r).length&&(this._updateTileset(r),this.state.lastUpdatedViewports=r,this.state.activeViewports={})}if(n.propsChanged){const{layerMap:r}=this.state;for(const i in r)r[i].needsUpdate=!0}}activateViewport(t){const{activeViewports:e,lastUpdatedViewports:n}=this.state;this.internalState.viewport=t,e[t.id]=t;const r=n==null?void 0:n[t.id];(!r||!t.equals(r))&&(this.setChangeFlags({viewportChanged:!0}),this.setNeedsUpdate())}getPickingInfo({info:t,sourceLayer:e}){const n=e&&e.props.tile;return t.picked&&(t.object=n),t.sourceTile=n,t}filterSubLayer({layer:t,viewport:e}){const{tile:n}=t.props,{id:r}=e;return n.selected&&n.viewportIds.includes(r)}_updateAutoHighlight(t){const e=t.sourceTile,n=this.state.layerMap[e==null?void 0:e.id];n&&n.layer&&n.layer.updateAutoHighlight(t)}async _loadTileset(t){const{loadOptions:e={}}=this.props,n=this.props.loader||this.props.loaders,r=Array.isArray(n)?n[0]:n,i={loadOptions:{...e}};let o=t;if(r.preload){const c=await r.preload(t,e);c.url&&(o=c.url),c.headers&&(i.loadOptions.fetch={...i.loadOptions.fetch,headers:c.headers}),Object.assign(i,c)}const a=await bt(o,r,i.loadOptions),l=new vr(a,{onTileLoad:this._onTileLoad.bind(this),onTileUnload:this._onTileUnload.bind(this),onTileError:this.props.onTileError,...i});this.setState({tileset3d:l,layerMap:{}}),this._updateTileset(this.state.activeViewports),this.props.onTilesetLoad(l)}_onTileLoad(t){const{lastUpdatedViewports:e}=this.state;this.props.onTileLoad(t),this._updateTileset(e),this.setNeedsUpdate()}_onTileUnload(t){delete this.state.layerMap[t.id],this.props.onTileUnload(t)}_updateTileset(t){if(!t)return;const{tileset3d:e}=this.state,{timeline:n}=this.context,r=Object.keys(t).length;!n||!r||!e||e.selectTiles(Object.values(t)).then(i=>{this.state.frameNumber!==i&&this.setState({frameNumber:i})})}_getSubLayer(t,e){if(!t.content)return null;switch(t.type){case J.POINTCLOUD:return this._makePointCloudLayer(t,e);case J.SCENEGRAPH:return this._make3DModelLayer(t);case J.MESH:return this._makeSimpleMeshLayer(t,e);default:throw new Error(`Tile3DLayer: Failed to render layer of type ${t.content.type}`)}}_makePointCloudLayer(t,e){const{attributes:n,pointCount:r,constantRGBA:i,cartographicOrigin:o,modelMatrix:a}=t.content,{positions:l,normals:c,colors:h}=n;if(!l)return null;const d=e&&e.props.data||{header:{vertexCount:r},attributes:{POSITION:l,NORMAL:c,COLOR_0:h}},{pointSize:g,getPointColor:m}=this.props,T=this.getSubLayerClass("pointcloud",Un);return new T({pointSize:g},this.getSubLayerProps({id:"pointcloud"}),{id:`${this.id}-pointcloud-${t.id}`,tile:t,data:d,coordinateSystem:qt.METER_OFFSETS,coordinateOrigin:o,modelMatrix:a,getColor:i||m,_offset:0})}_make3DModelLayer(t){const{gltf:e,instances:n,cartographicOrigin:r,modelMatrix:i}=t.content,o=this.getSubLayerClass("scenegraph",An);return new o({_lighting:"pbr"},this.getSubLayerProps({id:"scenegraph"}),{id:`${this.id}-scenegraph-${t.id}`,tile:t,data:n||us,scenegraph:e,coordinateSystem:qt.METER_OFFSETS,coordinateOrigin:r,modelMatrix:i,getTransformMatrix:a=>a.modelMatrix,getPosition:[0,0,0],_offset:0})}_makeSimpleMeshLayer(t,e){const n=t.content,{attributes:r,indices:i,modelMatrix:o,cartographicOrigin:a,coordinateSystem:l=qt.METER_OFFSETS,material:c,featureIds:h}=n,{_getMeshColor:d}=this.props,g=e&&e.props.mesh||new Dn({topology:"triangle-list",attributes:so(r),indices:i}),m=this.getSubLayerClass("mesh",fe);return new m(this.getSubLayerProps({id:"mesh"}),{id:`${this.id}-mesh-${t.id}`,tile:t,mesh:g,data:us,getColor:d(t),pbrMaterial:c,modelMatrix:o,coordinateOrigin:a,coordinateSystem:l,featureIds:h,_offset:0})}renderLayers(){const{tileset3d:t,layerMap:e}=this.state;return t?t.tiles.map(n=>{const r=e[n.id]=e[n.id]||{tile:n};let{layer:i}=r;return n.selected&&(i?r.needsUpdate&&(i=this._getSubLayer(n,i),r.needsUpdate=!1):i=this._getSubLayer(n)),r.layer=i,i}).filter(Boolean):null}}we.defaultProps=eo;we.layerName="Tile3DLayer";function so(s){const t={};return t.positions={...s.positions,value:new Float32Array(s.positions.value)},s.normals&&(t.normals=s.normals),s.texCoords&&(t.texCoords=s.texCoords),s.colors&&(t.colors=s.colors),s.uvRegions&&(t.uvRegions=s.uvRegions),t}const no="https://raw.githubusercontent.com/visgl/loaders.gl/master/modules/3d-tiles/test/data/CesiumJS/Batched/BatchedColors/tileset.json",ot=new he.Map({container:"map",style:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",center:[0,0],zoom:16,pitch:60,bearing:-17});ot.addControl(new he.NavigationControl,"top-right");ot.addControl(new he.ScaleControl({unit:"metric"}),"bottom-right");const Ee=new wn({layers:[]}),be=new Map,Ws=new en(ot,Ee,be);let Ys=1;function ro(){Ee.setProps({layers:Array.from(be.values())})}function Xs(){const s="tile3d-buildings",t=new we({id:s,data:no,opacity:Ys,pointSize:2,onTilesetLoad:e=>{const{cartographicCenter:n,zoom:r}=e;n&&r&&ot.flyTo({center:[n[0],n[1]],zoom:r+2,pitch:60})}});be.set(s,t),ro(),Ws.notifyLayerAdded(s)}const Ut=document.getElementById("opacity"),io=document.getElementById("opacityValue");Ut==null||Ut.addEventListener("input",()=>{const s=parseInt(Ut.value,10);io.textContent=`${s}%`,Ys=s/100,Xs()});ot.on("load",()=>{ot.addControl(Ee);const s=new tn({collapsed:!0,customLayerAdapters:[Ws],panelWidth:360});ot.addControl(s,"top-right"),Xs()});
