import{C as Z}from"./composite-layer-D5nYxRM9.js";import{P as U,C as F,m as G,A as j,R as k}from"./bounding-box-from-points-BWnryCDX.js";import{G as Y,W as E,l as R,e as _,f as X,g as H}from"./mapbox-overlay-CtMyNbGZ.js";import{G as $}from"./geojson-layer-EKUXUQHB.js";class W{constructor(e){this.index=e,this.isVisible=!1,this.isSelected=!1,this.parent=null,this.children=[],this.content=null,this._loader=void 0,this._abortController=null,this._loaderId=0,this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1}get bbox(){return this._bbox}set bbox(e){this._bbox||(this._bbox=e,"west"in e?this.boundingBox=[[e.west,e.south],[e.east,e.north]]:this.boundingBox=[[e.left,e.top],[e.right,e.bottom]])}get data(){return this.isLoading&&this._loader?this._loader.then(()=>this.data):this.content}get isLoaded(){return this._isLoaded&&!this._needsReload}get isLoading(){return!!this._loader&&!this._isCancelled}get needsReload(){return this._needsReload||this._isCancelled}get byteLength(){const e=this.content?this.content.byteLength:0;return Number.isFinite(e)||console.error("byteLength not defined in tile data"),e}async _loadData({getData:e,requestScheduler:t,onLoad:s,onError:i}){const{index:o,id:r,bbox:l,userData:c,zoom:a}=this,u=this._loaderId;this._abortController=new AbortController;const{signal:d}=this._abortController,h=await t.scheduleRequest(this,p=>p.isSelected?1:-1);if(!h){this._isCancelled=!0;return}if(this._isCancelled){h.done();return}let f=null,m;try{f=await e({index:o,id:r,bbox:l,userData:c,zoom:a,signal:d})}catch(p){m=p||!0}finally{h.done()}if(u===this._loaderId){if(this._loader=void 0,this.content=f,this._isCancelled&&!f){this._isLoaded=!1;return}this._isLoaded=!0,this._isCancelled=!1,m?i(m,this):s(this)}}loadData(e){return this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1,this._loaderId++,this._loader=this._loadData(e),this._loader}setNeedsReload(){this.isLoading&&(this.abort(),this._loader=void 0),this._needsReload=!0}abort(){var e;this.isLoaded||(this._isCancelled=!0,(e=this._abortController)==null||e.abort())}}const y=512,w=3,N=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],D=N.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),v=D.concat([[.25,.5],[.75,.5]]);class T{constructor(e,t,s){this.x=e,this.y=t,this.z=s}get children(){if(!this._children){const e=this.x*2,t=this.y*2,s=this.z+1;this._children=[new T(e,t,s),new T(e,t+1,s),new T(e+1,t,s),new T(e+1,t+1,s)]}return this._children}update(e){const{viewport:t,cullingVolume:s,elevationBounds:i,minZ:o,maxZ:r,bounds:l,offset:c,project:a}=e,u=this.getBoundingVolume(i,c,a);if(l&&!this.insideBounds(l)||s.computeVisibility(u)<0)return!1;if(!this.childVisible){let{z:h}=this;if(h<r&&h>=o){const f=u.distanceTo(t.cameraPosition)*t.scale/t.height;h+=Math.floor(Math.log2(f))}if(h>=r)return this.selected=!0,!0}this.selected=!1,this.childVisible=!0;for(const h of this.children)h.update(e);return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(const t of this._children)t.getSelected(e);return e}insideBounds([e,t,s,i]){const o=Math.pow(2,this.z),r=y/o;return this.x*r<s&&this.y*r<i&&(this.x+1)*r>e&&(this.y+1)*r>t}getBoundingVolume(e,t,s){if(s){const c=this.z<1?v:this.z<2?D:N,a=[];for(const u of c){const d=S(this.x+u[0],this.y+u[1],this.z);d[2]=e[0],a.push(s(d)),e[0]!==e[1]&&(d[2]=e[1],a.push(s(d)))}return G(a)}const i=Math.pow(2,this.z),o=y/i,r=this.x*o+t*y,l=y-(this.y+1)*o;return new j([r,l,e[0]],[r+o,l+o,e[1]])}}function J(n,e,t,s){const i=n instanceof Y&&n.resolution?n.projectPosition:null,o=Object.values(n.getFrustumPlanes()).map(({normal:f,distance:m})=>new U(f.clone().negate(),m)),r=new F(o),l=n.distanceScales.unitsPerMeter[2],c=t&&t[0]*l||0,a=t&&t[1]*l||0,u=n instanceof E&&n.pitch<=60?e:0;if(s){const[f,m,p,L]=s,A=R([f,L]),B=R([p,m]);s=[A[0],y-A[1],B[0],y-B[1]]}const d=new T(0,0,0),h={viewport:n,project:i,cullingVolume:r,elevationBounds:[c,a],minZ:u,maxZ:e,bounds:s,offset:0};if(d.update(h),n instanceof E&&n.subViewports&&n.subViewports.length>1){for(h.offset=-1;d.update(h)&&!(--h.offset<-w););for(h.offset=1;d.update(h)&&!(++h.offset>w););}return d.getSelected()}const g=512,K=[-1/0,-1/0,1/0,1/0],Q={type:"object",value:null,validate:(n,e)=>e.optional&&n===null||typeof n=="string"||Array.isArray(n)&&n.every(t=>typeof t=="string"),equal:(n,e)=>{if(n===e)return!0;if(!Array.isArray(n)||!Array.isArray(e))return!1;const t=n.length;if(t!==e.length)return!1;for(let s=0;s<t;s++)if(n[s]!==e[s])return!1;return!0}};function M(n,e){const t=[e.transformAsPoint([n[0],n[1]]),e.transformAsPoint([n[2],n[1]]),e.transformAsPoint([n[0],n[3]]),e.transformAsPoint([n[2],n[3]])];return[Math.min(...t.map(i=>i[0])),Math.min(...t.map(i=>i[1])),Math.max(...t.map(i=>i[0])),Math.max(...t.map(i=>i[1]))]}function ee(n){return Math.abs(n.split("").reduce((e,t)=>(e<<5)-e+t.charCodeAt(0)|0,0))}function te(n,e){if(!n||!n.length)return null;const{index:t,id:s}=e;if(Array.isArray(n)){const o=ee(s)%n.length;n=n[o]}let i=n;for(const o of Object.keys(t)){const r=new RegExp(`{${o}}`,"g");i=i.replace(r,String(t[o]))}return Number.isInteger(t.y)&&Number.isInteger(t.z)&&(i=i.replace(/\{-y\}/g,String(Math.pow(2,t.z)-t.y-1))),i}function se(n,e,t){let s;return s=n.getBounds(),n.isGeospatial?[Math.max(s[0],t[0]),Math.max(s[1],t[1]),Math.min(s[2],t[2]),Math.min(s[3],t[3])]:[Math.max(Math.min(s[0],t[2]),t[0]),Math.max(Math.min(s[1],t[3]),t[1]),Math.min(Math.max(s[2],t[0]),t[2]),Math.min(Math.max(s[3],t[1]),t[3])]}function ie({viewport:n,z:e,cullRect:t}){return(n.subViewports||[n]).map(i=>x(i,e||0,t))}function x(n,e,t){if(!Array.isArray(e)){const o=t.x-n.x,r=t.y-n.y,{width:l,height:c}=t,a={targetZ:e},u=n.unproject([o,r],a),d=n.unproject([o+l,r],a),h=n.unproject([o,r+c],a),f=n.unproject([o+l,r+c],a);return[Math.min(u[0],d[0],h[0],f[0]),Math.min(u[1],d[1],h[1],f[1]),Math.max(u[0],d[0],h[0],f[0]),Math.max(u[1],d[1],h[1],f[1])]}const s=x(n,e[0],t),i=x(n,e[1],t);return[Math.min(s[0],i[0]),Math.min(s[1],i[1]),Math.max(s[2],i[2]),Math.max(s[3],i[3])]}function ne(n,e,t){return t?M(n,t).map(i=>i*e/g):n.map(s=>s*e/g)}function C(n,e){return Math.pow(2,n)*g/e}function S(n,e,t){const s=C(t,g),i=n/s*360-180,o=Math.PI-2*Math.PI*e/s,r=180/Math.PI*Math.atan(.5*(Math.exp(o)-Math.exp(-o)));return[i,r]}function P(n,e,t,s){const i=C(t,s);return[n/i*g,e/i*g]}function oe(n,e,t,s,i=g){if(n.isGeospatial){const[a,u]=S(e,t,s),[d,h]=S(e+1,t+1,s);return{west:a,north:u,east:d,south:h}}const[o,r]=P(e,t,s,i),[l,c]=P(e+1,t+1,s,i);return{left:o,top:r,right:l,bottom:c}}function re(n,e,t,s,i){const o=se(n,null,s),r=C(e,t),[l,c,a,u]=ne(o,r,i),d=[];for(let h=Math.floor(l);h<a;h++)for(let f=Math.floor(c);f<u;f++)d.push({x:h,y:f,z:e});return d}function ae({viewport:n,maxZoom:e,minZoom:t,zRange:s,extent:i,tileSize:o=g,modelMatrix:r,modelMatrixInverse:l,zoomOffset:c=0}){let a=n.isGeospatial?Math.round(n.zoom+Math.log2(g/o))+c:Math.ceil(n.zoom)+c;if(typeof t=="number"&&Number.isFinite(t)&&a<t){if(!i)return[];a=t}typeof e=="number"&&Number.isFinite(e)&&a>e&&(a=e);let u=i;return r&&l&&i&&!n.isGeospatial&&(u=M(i,r)),n.isGeospatial?J(n,a,s,i):re(n,a,o,u||K,l)}function Se(n){return/(?=.*{z})(?=.*{x})(?=.*({y}|{-y}))/.test(n)}function Me(n){return Number.isFinite(n.west)&&Number.isFinite(n.north)&&Number.isFinite(n.east)&&Number.isFinite(n.south)}function le(n){let e={},t;return s=>{for(const i in s)if(!he(s[i],e[i])){t=n(s),e=s;break}return t}}function he(n,e){if(n===e)return!0;if(Array.isArray(n)){const t=n.length;if(!e||e.length!==t)return!1;for(let s=0;s<t;s++)if(n[s]!==e[s])return!1;return!0}return!1}const V=1,b=2,ce="never",ue="no-overlap",I="best-available",de=5,fe={[I]:pe,[ue]:_e,[ce]:()=>{}},me={extent:null,tileSize:512,maxZoom:null,minZoom:null,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:"best-available",zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{}};class ge{constructor(e){this._getCullBounds=le(ie),this.opts={...me,...e},this.setOptions(this.opts),this.onTileLoad=t=>{var s,i;(i=(s=this.opts).onTileLoad)==null||i.call(s,t),this.opts.maxCacheByteSize!==null&&(this._cacheByteSize+=t.byteLength,this._resizeCache())},this._requestScheduler=new k({throttleRequests:this.opts.maxRequests>0||this.opts.debounceTime>0,maxRequests:this.opts.maxRequests,debounceTime:this.opts.debounceTime}),this._cache=new Map,this._tiles=[],this._dirty=!1,this._cacheByteSize=0,this._viewport=null,this._zRange=null,this._selectedTiles=null,this._frameNumber=0,this._modelMatrix=new _,this._modelMatrixInverse=new _}get tiles(){return this._tiles}get selectedTiles(){return this._selectedTiles}get isLoaded(){return this._selectedTiles!==null&&this._selectedTiles.every(e=>e.isLoaded)}get needsReload(){return this._selectedTiles!==null&&this._selectedTiles.some(e=>e.needsReload)}setOptions(e){Object.assign(this.opts,e),Number.isFinite(e.maxZoom)&&(this._maxZoom=Math.floor(e.maxZoom)),Number.isFinite(e.minZoom)&&(this._minZoom=Math.ceil(e.minZoom))}finalize(){for(const e of this._cache.values())e.isLoading&&e.abort();this._cache.clear(),this._tiles=[],this._selectedTiles=null}reloadAll(){for(const e of this._cache.keys()){const t=this._cache.get(e);!this._selectedTiles||!this._selectedTiles.includes(t)?this._cache.delete(e):t.setNeedsReload()}}update(e,{zRange:t,modelMatrix:s}={zRange:null,modelMatrix:null}){const i=s?new _(s):new _,o=!i.equals(this._modelMatrix);if(!this._viewport||!e.equals(this._viewport)||!X(this._zRange,t)||o){o&&(this._modelMatrixInverse=i.clone().invert(),this._modelMatrix=i),this._viewport=e,this._zRange=t;const l=this.getTileIndices({viewport:e,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:t,modelMatrix:this._modelMatrix,modelMatrixInverse:this._modelMatrixInverse});this._selectedTiles=l.map(c=>this._getTile(c,!0)),this._dirty&&this._rebuildTree()}else this.needsReload&&(this._selectedTiles=this._selectedTiles.map(l=>this._getTile(l.index,!0)));const r=this.updateTileStates();return this._pruneRequests(),this._dirty&&this._resizeCache(),r&&this._frameNumber++,this._frameNumber}isTileVisible(e,t,s){if(!e.isVisible)return!1;if(t&&this._viewport){const i=this._getCullBounds({viewport:this._viewport,z:this._zRange,cullRect:t});let{bbox:o}=e;for(const[r,l,c,a]of i){let u;if("west"in o)u=o.west<c&&o.east>r&&o.south<a&&o.north>l;else{if(s&&!_.IDENTITY.equals(s)){const[f,m,p,L]=M([o.left,o.top,o.right,o.bottom],s);o={left:f,top:m,right:p,bottom:L}}const d=Math.min(o.top,o.bottom),h=Math.max(o.top,o.bottom);u=o.left<c&&o.right>r&&d<a&&h>l}if(u)return!0}return!1}return!0}getTileIndices({viewport:e,maxZoom:t,minZoom:s,zRange:i,modelMatrix:o,modelMatrixInverse:r}){const{tileSize:l,extent:c,zoomOffset:a}=this.opts;return ae({viewport:e,maxZoom:t,minZoom:s,zRange:i,tileSize:l,extent:c,modelMatrix:o,modelMatrixInverse:r,zoomOffset:a})}getTileId(e){return`${e.x}-${e.y}-${e.z}`}getTileZoom(e){return e.z}getTileMetadata(e){const{tileSize:t}=this.opts;return{bbox:oe(this._viewport,e.x,e.y,e.z,t)}}getParentIndex(e){const t=Math.floor(e.x/2),s=Math.floor(e.y/2),i=e.z-1;return{x:t,y:s,z:i}}updateTileStates(){const e=this.opts.refinementStrategy||I,t=new Array(this._cache.size);let s=0;for(const i of this._cache.values())t[s++]=i.isVisible,i.isSelected=!1,i.isVisible=!1;for(const i of this._selectedTiles)i.isSelected=!0,i.isVisible=!0;(typeof e=="function"?e:fe[e])(Array.from(this._cache.values())),s=0;for(const i of this._cache.values())if(t[s++]!==i.isVisible)return!0;return!1}_pruneRequests(){const{maxRequests:e=0}=this.opts,t=[];let s=0;for(const i of this._cache.values())i.isLoading&&(s++,!i.isSelected&&!i.isVisible&&t.push(i));for(;e>0&&s>e&&t.length>0;)t.shift().abort(),s--}_rebuildTree(){const{_cache:e}=this;for(const t of e.values())t.parent=null,t.children&&(t.children.length=0);for(const t of e.values()){const s=this._getNearestAncestor(t);t.parent=s,s!=null&&s.children&&s.children.push(t)}}_resizeCache(){var r,l;const{_cache:e,opts:t}=this,s=t.maxCacheSize??(t.maxCacheByteSize!==null?1/0:de*this.selectedTiles.length),i=t.maxCacheByteSize??1/0;if(e.size>s||this._cacheByteSize>i){for(const[c,a]of e)if(!a.isVisible&&!a.isSelected&&(this._cacheByteSize-=t.maxCacheByteSize!==null?a.byteLength:0,e.delete(c),(l=(r=this.opts).onTileUnload)==null||l.call(r,a)),e.size<=s&&this._cacheByteSize<=i)break;this._rebuildTree(),this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort((c,a)=>c.zoom-a.zoom),this._dirty=!1)}_getTile(e,t){const s=this.getTileId(e);let i=this._cache.get(s),o=!1;return!i&&t?(i=new W(e),Object.assign(i,this.getTileMetadata(i.index)),Object.assign(i,{id:s,zoom:this.getTileZoom(i.index)}),o=!0,this._cache.set(s,i),this._dirty=!0):i&&i.needsReload&&(o=!0),i&&o&&i.loadData({getData:this.opts.getTileData,requestScheduler:this._requestScheduler,onLoad:this.onTileLoad,onError:this.opts.onTileError}),i}_getNearestAncestor(e){const{_minZoom:t=0}=this;let s=e.index;for(;this.getTileZoom(s)>t;){s=this.getParentIndex(s);const i=this._getTile(s);if(i)return i}return null}}function pe(n){for(const e of n)e.state=0;for(const e of n)e.isSelected&&!q(e)&&z(e);for(const e of n)e.isVisible=!!(e.state&b)}function _e(n){for(const t of n)t.state=0;for(const t of n)t.isSelected&&q(t);const e=Array.from(n).sort((t,s)=>t.zoom-s.zoom);for(const t of e)if(t.isVisible=!!(t.state&b),t.children&&(t.isVisible||t.state&V))for(const s of t.children)s.state=V;else t.isSelected&&z(t)}function q(n){let e=n;for(;e;){if(e.isLoaded||e.content)return e.state|=b,!0;e=e.parent}return!1}function z(n){for(const e of n.children)e.isLoaded||e.content?e.state|=b:z(e)}const ye={TilesetClass:ge,data:{type:"data",value:[]},dataComparator:Q.equal,renderSubLayers:{type:"function",value:n=>new $(n)},getTileData:{type:"function",optional:!0,value:null},onViewportLoad:{type:"function",optional:!0,value:null},onTileLoad:{type:"function",value:n=>{}},onTileUnload:{type:"function",value:n=>{}},onTileError:{type:"function",value:n=>console.error(n)},extent:{type:"array",optional:!0,value:null,compare:!0},tileSize:512,maxZoom:null,minZoom:0,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:I,zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0};class O extends Z{initializeState(){this.state={tileset:null,isLoaded:!1}}finalizeState(){var e,t;(t=(e=this.state)==null?void 0:e.tileset)==null||t.finalize()}get isLoaded(){var e,t,s;return!!((s=(t=(e=this.state)==null?void 0:e.tileset)==null?void 0:t.selectedTiles)!=null&&s.every(i=>i.isLoaded&&i.layers&&i.layers.every(o=>o.isLoaded)))}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({changeFlags:e}){let{tileset:t}=this.state;const s=e.propsOrDataChanged||e.updateTriggersChanged,i=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getTileData);t?s&&(t.setOptions(this._getTilesetOptions()),i?t.reloadAll():t.tiles.forEach(o=>{o.layers=null})):(t=new this.props.TilesetClass(this._getTilesetOptions()),this.setState({tileset:t})),this._updateTileset()}_getTilesetOptions(){const{tileSize:e,maxCacheSize:t,maxCacheByteSize:s,refinementStrategy:i,extent:o,maxZoom:r,minZoom:l,maxRequests:c,debounceTime:a,zoomOffset:u}=this.props;return{maxCacheSize:t,maxCacheByteSize:s,maxZoom:r,minZoom:l,tileSize:e,refinementStrategy:i,extent:o,maxRequests:c,debounceTime:a,zoomOffset:u,getTileData:this.getTileData.bind(this),onTileLoad:this._onTileLoad.bind(this),onTileError:this._onTileError.bind(this),onTileUnload:this._onTileUnload.bind(this)}}_updateTileset(){const e=this.state.tileset,{zRange:t,modelMatrix:s}=this.props,i=e.update(this.context.viewport,{zRange:t,modelMatrix:s}),{isLoaded:o}=e,r=this.state.isLoaded!==o,l=this.state.frameNumber!==i;o&&(r||l)&&this._onViewportLoad(),l&&this.setState({frameNumber:i}),this.state.isLoaded=o}_onViewportLoad(){const{tileset:e}=this.state,{onViewportLoad:t}=this.props;t&&t(e.selectedTiles)}_onTileLoad(e){this.props.onTileLoad(e),e.layers=null,this.setNeedsUpdate()}_onTileError(e,t){this.props.onTileError(e),t.layers=null,this.setNeedsUpdate()}_onTileUnload(e){this.props.onTileUnload(e)}getTileData(e){const{data:t,getTileData:s,fetch:i}=this.props,{signal:o}=e;return e.url=typeof t=="string"||Array.isArray(t)?te(t,e):null,s?s(e):i&&e.url?i(e.url,{propName:"data",layer:this,signal:o}):null}renderSubLayers(e){return this.props.renderSubLayers(e)}getSubLayerPropsByTile(e){return null}getPickingInfo(e){const t=e.sourceLayer,s=t.props.tile,i=e.info;return i.picked&&(i.tile=s),i.sourceTile=s,i.sourceTileSubLayer=t,i}_updateAutoHighlight(e){e.sourceTileSubLayer.updateAutoHighlight(e)}renderLayers(){return this.state.tileset.tiles.map(e=>{const t=this.getSubLayerPropsByTile(e);if(!(!e.isLoaded&&!e.content))if(e.layers)t&&e.layers[0]&&Object.keys(t).some(s=>e.layers[0].props[s]!==t[s])&&(e.layers=e.layers.map(s=>s.clone(t)));else{const s=this.renderSubLayers({...this.props,...this.getSubLayerProps({id:e.id,updateTriggers:this.props.updateTriggers}),data:e.content,_offset:0,tile:e});e.layers=H(s,Boolean).map(i=>i.clone({tile:e,...t}))}return e.layers})}filterSubLayer({layer:e,cullRect:t}){const{tile:s}=e.props,{modelMatrix:i}=this.props;return this.state.tileset.isTileVisible(s,t,i?new _(i):null)}}O.defaultProps=ye;O.layerName="TileLayer";export{ge as T,O as a,Me as b,te as g,Se as i,Q as u};
