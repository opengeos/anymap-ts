var W=Object.defineProperty,N=(r,t,e)=>t in r?W(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,u=(r,t,e)=>N(r,typeof t!="symbol"?t+"":t,e);class C{constructor(){u(this,"adapters",new Map),u(this,"changeListeners",[]),u(this,"unsubscribers",[])}register(t){if(this.adapters.set(t.type,t),t.onLayerChange){const e=t.onLayerChange((i,s)=>{this.notifyChange(i,s)});this.unsubscribers.push(e)}}unregister(t){this.adapters.delete(t)}getAllLayerIds(){const t=[];return this.adapters.forEach(e=>{t.push(...e.getLayerIds())}),t}hasLayer(t){for(const e of this.adapters.values())if(e.getLayerIds().includes(t))return!0;return!1}getAdapterForLayer(t){for(const e of this.adapters.values())if(e.getLayerIds().includes(t))return e;return null}getLayerState(t){const e=this.getAdapterForLayer(t);return e?e.getLayerState(t):null}setVisibility(t,e){const i=this.getAdapterForLayer(t);return i?(i.setVisibility(t,e),!0):!1}setOpacity(t,e){const i=this.getAdapterForLayer(t);return i?(i.setOpacity(t,e),!0):!1}getSymbolType(t){const e=this.getAdapterForLayer(t);return e&&e.getSymbolType?e.getSymbolType(t):null}onChange(t){return this.changeListeners.push(t),()=>{const e=this.changeListeners.indexOf(t);e>=0&&this.changeListeners.splice(e,1)}}notifyChange(t,e){this.changeListeners.forEach(i=>i(t,e))}destroy(){this.unsubscribers.forEach(t=>t()),this.unsubscribers=[],this.adapters.clear(),this.changeListeners=[]}}function P(r){switch(r){case"fill":return"fill-opacity";case"line":return"line-opacity";case"circle":return"circle-opacity";case"symbol":return["icon-opacity","text-opacity"];case"raster":return"raster-opacity";case"background":return"background-opacity";case"heatmap":return"heatmap-opacity";case"fill-extrusion":return"fill-extrusion-opacity";case"hillshade":return"hillshade-exaggeration";case"color-relief":return null;default:return`${r}-opacity`}}function b(r,t,e){const i=P(e);if(i===null)return 1;if(Array.isArray(i)){const a=r.getPaintProperty(t,i[0]);return a??1}const s=r.getPaintProperty(t,i);return s??1}function x(r,t,e,i){const s=P(e);s!==null&&(Array.isArray(s)?s.forEach(a=>{r.setPaintProperty(t,a,i)}):r.setPaintProperty(t,s,i))}function E(r,t){try{const e=r.getLayer(t);return e?e.type:null}catch(e){return console.warn(`Failed to get layer type for ${t}:`,e),null}}function L(r){if(Array.isArray(r))return r.map(t=>L(t));if(r&&typeof r=="object")try{return JSON.parse(JSON.stringify(r))}catch{return r}return r}function R(r,t,e){var i;if(!e.has(t))try{const s=r.getLayer(t);if(!s)return;const a={},n=(i=r.getStyle().layers)==null?void 0:i.find(l=>l.id===t);s.type==="raster"?(Object.assign(a,{"raster-opacity":1,"raster-brightness-min":0,"raster-brightness-max":1,"raster-saturation":0,"raster-contrast":0,"raster-hue-rotate":0}),n&&"paint"in n&&n.paint&&Object.entries(n.paint).forEach(([c,d])=>{c.startsWith("raster-")&&(a[c]=L(d))})):n&&"paint"in n&&n.paint&&Object.entries(n.paint).forEach(([l,c])=>{a[l]=L(c)}),e.set(t,{paint:a})}catch(s){console.warn(`Failed to cache original style for ${t}:`,s)}}function M(r,t,e){const i=e.get(t);if(!i)return{};const s={};return Object.entries(i.paint).forEach(([a,o])=>{try{const n=L(o);r.setPaintProperty(t,a,n),s[a]=n}catch(n){console.warn(`Failed to restore ${a} for ${t}:`,n)}}),s}function $(r,t,e){const i=a=>Math.max(0,Math.min(255,Math.round(a))),s=a=>{const o=i(a).toString(16);return o.length===1?`0${o}`:o};return`#${s(r)}${s(t)}${s(e)}`}function g(r){if(typeof r=="string"){if(r.startsWith("#")){if(r.length===4){const t=r[1],e=r[2],i=r[3];return`#${t}${t}${e}${e}${i}${i}`}return r}if(r.startsWith("rgb")){const t=r.match(/\d+/g);if(t&&t.length>=3){const[e,i,s]=t.map(a=>parseInt(a,10));return $(e,i,s)}}}else if(Array.isArray(r)&&r.length>=3)return $(r[0],r[1],r[2]);return"#3388ff"}function S(r,t){let e=0;if(t&&Number(t)!==1){const i=Number(t);i>0&&i<1&&(e=Math.min(4,Math.ceil(Math.abs(Math.log10(i)))))}return r.toFixed(e)}const B={fill:["fill-color","fill-outline-color"],line:["line-color"],circle:["circle-color","circle-stroke-color"],symbol:["icon-color","text-color"],background:["background-color"],heatmap:["heatmap-color"],"fill-extrusion":["fill-extrusion-color"]};function w(r){if(!Array.isArray(r)||r.length===0)return null;for(const t of r)if(typeof t=="string"){if(t.startsWith("#")||t.startsWith("rgb")||t.startsWith("hsl"))return g(t)}else if(Array.isArray(t)){const e=w(t);if(e)return e}return null}function F(r,t,e){var i;const s=B[e];if(!s)return null;for(const a of s){try{const l=r.getPaintProperty(t,a);if(l){if(typeof l=="string")return g(l);if(Array.isArray(l)){const c=w(l);if(c)return c}}}catch{}const o=r.getStyle(),n=(i=o==null?void 0:o.layers)==null?void 0:i.find(l=>l.id===t);if(n&&"paint"in n&&n.paint){const l=n.paint[a];if(l){if(typeof l=="string")return g(l);if(Array.isArray(l)){const c=w(l);if(c)return c}}}}return null}function O(r){const t=B[r.type];if(!t)return null;for(const e of t)if("paint"in r&&r.paint){const i=r.paint[e];if(i){if(typeof i=="string")return g(i);if(Array.isArray(i)){const s=w(i);if(s)return s}}}return null}function y(r,t){let e=r.replace("#","");e.length===3&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);const i=Math.max(0,parseInt(e.slice(0,2),16)-Math.round(255*t)),s=Math.max(0,parseInt(e.slice(2,4),16)-Math.round(255*t)),a=Math.max(0,parseInt(e.slice(4,6),16)-Math.round(255*t));return $(i,s,a)}function T(r,t){const i=y(t,.3);return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <rect x="2" y="2" width="${r-2*2}" height="${r-2*2}"
          fill="${t}" stroke="${i}" stroke-width="1" rx="1"/>
  </svg>`}function D(r,t,e=2){const i=r/2,s=2;return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <line x1="${s}" y1="${i}" x2="${r-s}" y2="${i}"
          stroke="${t}" stroke-width="${e}" stroke-linecap="round"/>
  </svg>`}function H(r,t){const e=r/2,i=r/2,s=r/2-3,a=y(t,.3);return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <circle cx="${e}" cy="${i}" r="${s}" fill="${t}"
            stroke="${a}" stroke-width="1"/>
  </svg>`}function V(r,t){const e=y(t,.3),i=r/2,s=r*.5,a=r*.7;return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <path d="M${i} ${r-2}
             L${i-s/2} ${r-a}
             A${s/2} ${s/2} 0 1 1 ${i+s/2} ${r-a}
             Z"
          fill="${t}" stroke="${e}" stroke-width="1"/>
    <circle cx="${i}" cy="${r-a-s/4}" r="${s/5}" fill="white"/>
  </svg>`}function _(r){const e=`rasterGrad_${Math.random().toString(36).slice(2,9)}`;return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="${e}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#e0e0e0"/>
        <stop offset="50%" stop-color="#808080"/>
        <stop offset="100%" stop-color="#404040"/>
      </linearGradient>
    </defs>
    <rect x="2" y="2" width="${r-2*2}" height="${r-2*2}"
          fill="url(#${e})" rx="1"/>
  </svg>`}function q(r,t){return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <rect x="1" y="1" width="${r-2}" height="${r-2}" fill="${t}" rx="2"/>
    <rect x="3" y="3" width="${r-6}" height="${r-6}" fill="none"
          stroke="white" stroke-width="1" stroke-opacity="0.5" rx="1"/>
  </svg>`}function U(r){const e=`heatmapGrad_${Math.random().toString(36).slice(2,9)}`;return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="${e}" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#ffff00"/>
        <stop offset="50%" stop-color="#ff8800"/>
        <stop offset="100%" stop-color="#ff0000"/>
      </radialGradient>
    </defs>
    <rect x="2" y="2" width="${r-2*2}" height="${r-2*2}"
          fill="url(#${e})" rx="1"/>
  </svg>`}function G(r){const e=`hillshadeGrad_${Math.random().toString(36).slice(2,9)}`;return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="${e}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#ffffff"/>
        <stop offset="100%" stop-color="#666666"/>
      </linearGradient>
    </defs>
    <rect x="2" y="2" width="${r-2*2}" height="${r-2*2}"
          fill="url(#${e})" rx="1"/>
  </svg>`}function j(r,t){const e=y(t,.3),i=t,s=y(t,.2),a=3;return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <polygon points="${2+a},2 ${r-2},2 ${r-2},${r-2-a} ${r-2-a},${r-2} 2,${r-2} 2,${2+a}"
             fill="${i}" stroke="${e}" stroke-width="1"/>
    <polygon points="2,${2+a} ${2+a},2 ${2+a},${r-2-a} 2,${r-2}"
             fill="${s}" stroke="${e}" stroke-width="0.5"/>
    <polygon points="${2+a},${r-2-a} ${r-2},${r-2-a} ${r-2-a},${r-2} 2,${r-2}"
             fill="${s}" stroke="${e}" stroke-width="0.5"/>
  </svg>`}function X(r,t){const i=y(t,.3);return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <rect x="2" y="2" width="${r-2*2}" height="${r-2*2}"
          fill="${t}" stroke="${i}" stroke-width="1"/>
  </svg>`}function J(r,t){const i=y(t,.3),s=(r-2*2)/2;return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <rect x="2" y="2" width="${s}" height="${s}" fill="${t}" stroke="${i}" stroke-width="0.5"/>
    <rect x="${2+s}" y="2" width="${s}" height="${s}" fill="${t}" stroke="${i}" stroke-width="0.5" opacity="0.8"/>
    <rect x="2" y="${2+s}" width="${s}" height="${s}" fill="${t}" stroke="${i}" stroke-width="0.5" opacity="0.6"/>
    <rect x="${2+s}" y="${2+s}" width="${s}" height="${s}" fill="${t}" stroke="${i}" stroke-width="0.5" opacity="0.4"/>
  </svg>`}function K(r,t){const i=y(t,.3),s=r-2*2;return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <rect x="4" y="2" width="${s-2}" height="${s-2}" fill="${y(t,.2)}" stroke="${i}" stroke-width="0.5" rx="1"/>
    <rect x="3" y="3" width="${s-2}" height="${s-2}" fill="${y(t,.1)}" stroke="${i}" stroke-width="0.5" rx="1"/>
    <rect x="2" y="4" width="${s-2}" height="${s-2}" fill="${t}" stroke="${i}" stroke-width="0.5" rx="1"/>
    <line x1="5" y1="7" x2="${2+s-5}" y2="7" stroke="${i}" stroke-width="0.5" opacity="0.5"/>
    <line x1="5" y1="10" x2="${2+s-5}" y2="10" stroke="${i}" stroke-width="0.5" opacity="0.5"/>
  </svg>`}function Z(r,t){const i=y(t,.3),s=`customRasterGrad_${Math.random().toString(36).slice(2,9)}`;return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="${s}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="${t}"/>
        <stop offset="100%" stop-color="${y(t,.4)}"/>
      </linearGradient>
    </defs>
    <rect x="2" y="2" width="${r-2*2}" height="${r-2*2}"
          fill="url(#${s})" stroke="${i}" stroke-width="1" rx="1"/>
    <line x1="${r/2}" y1="2" x2="${r/2}" y2="${r-2}" stroke="${i}" stroke-width="0.5" opacity="0.3"/>
    <line x1="2" y1="${r/2}" x2="${r-2}" y2="${r/2}" stroke="${i}" stroke-width="0.5" opacity="0.3"/>
  </svg>`}function A(r){const t=["#a8d4a8","#8ec4e8","#d4c4a8"],e="#666666";return`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg">
    <rect x="4" y="1" width="${r-6}" height="${r-6}" fill="${t[2]}" stroke="${e}" stroke-width="0.75" rx="1"/>
    <rect x="2" y="3" width="${r-6}" height="${r-6}" fill="${t[1]}" stroke="${e}" stroke-width="0.75" rx="1"/>
    <rect x="0" y="5" width="${r-6}" height="${r-6}" fill="${t[0]}" stroke="${e}" stroke-width="0.75" rx="1"/>
  </svg>`}function k(r,t,e={}){const i=e.size||16,s=e.strokeWidth||2,a=t||"#888888";switch(r){case"fill":return T(i,a);case"line":return D(i,a,s);case"circle":return H(i,a);case"symbol":return V(i,a);case"raster":return _(i);case"background":return q(i,a);case"heatmap":return U(i);case"hillshade":return G(i);case"fill-extrusion":return j(i,a);case"background-group":return A(i);case"cog":return J(i,a);case"zarr":return K(i,a);case"custom-raster":return Z(i,a);default:return X(i,a)}}function Y(r=16){return A(r)}class Q{constructor(t={}){u(this,"map"),u(this,"mapContainer"),u(this,"container"),u(this,"button"),u(this,"panel"),u(this,"resizeHandler",null),u(this,"mapResizeHandler",null),u(this,"state"),u(this,"targetLayers"),u(this,"styleEditors"),u(this,"initialSourceIds",null),u(this,"minPanelWidth"),u(this,"maxPanelWidth"),u(this,"maxPanelHeight"),u(this,"showStyleEditor"),u(this,"showOpacitySlider"),u(this,"showLayerSymbol"),u(this,"excludeDrawnLayers"),u(this,"customLayerRegistry",null),u(this,"customLayerUnsubscribe",null),u(this,"widthSliderEl",null),u(this,"widthThumbEl",null),u(this,"widthValueEl",null),u(this,"isWidthSliderActive",!1),u(this,"widthDragRectWidth",null),u(this,"widthDragStartX",null),u(this,"widthDragStartWidth",null),u(this,"widthFrame",null),this.minPanelWidth=t.panelMinWidth||240,this.maxPanelWidth=t.panelMaxWidth||420,this.maxPanelHeight=t.panelMaxHeight||600,this.showStyleEditor=t.showStyleEditor!==!1,this.showOpacitySlider=t.showOpacitySlider!==!1,this.showLayerSymbol=t.showLayerSymbol!==!1,this.excludeDrawnLayers=t.excludeDrawnLayers!==!1,this.state={collapsed:t.collapsed!==!1,panelWidth:t.panelWidth||360,activeStyleEditor:null,layerStates:t.layerStates||{},originalStyles:new Map,userInteractingWithSlider:!1,backgroundLegendOpen:!1,backgroundLayerVisibility:new Map,onlyRenderedFilter:!1},this.targetLayers=t.layers||Object.keys(this.state.layerStates),this.styleEditors=new Map,t.customLayerAdapters&&t.customLayerAdapters.length>0&&(this.customLayerRegistry=new C,t.customLayerAdapters.forEach(e=>{this.customLayerRegistry.register(e)}))}onAdd(t){this.map=t,this.mapContainer=t.getContainer();const e=this.map.getStyle();return e&&e.sources?this.initialSourceIds=new Set(Object.keys(e.sources)):this.initialSourceIds=new Set,Object.keys(this.state.layerStates).length===0&&this.autoDetectLayers(),this.container=this.createContainer(),this.button=this.createToggleButton(),this.panel=this.createPanel(),this.container.appendChild(this.button),this.mapContainer.appendChild(this.panel),this.updateWidthDisplay(),this.setupEventListeners(),this.buildLayerItems(),this.state.collapsed||requestAnimationFrame(()=>{this.updatePanelPosition()}),this.container}onRemove(){var t,e;this.customLayerUnsubscribe&&(this.customLayerUnsubscribe(),this.customLayerUnsubscribe=null),this.customLayerRegistry&&(this.customLayerRegistry.destroy(),this.customLayerRegistry=null),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.mapResizeHandler&&(this.map.off("resize",this.mapResizeHandler),this.mapResizeHandler=null),(t=this.panel.parentNode)==null||t.removeChild(this.panel),(e=this.container.parentNode)==null||e.removeChild(this.container)}autoDetectLayers(){const t=this.map.getStyle();if(!t||!t.layers)return;const e=t.layers.map(i=>i.id);if(this.targetLayers.length===0){const i=[],s=[],a=this.detectUserAddedSources();e.forEach(o=>{const n=this.map.getLayer(o);if(!n)return;if(this.excludeDrawnLayers&&this.isDrawnLayer(o)){s.push(o);return}const l=n.source;l&&a.has(l)?i.push(o):s.push(o)}),s.length>0&&(this.state.layerStates.Background={visible:!0,opacity:1,name:"Background"}),i.forEach(o=>{const n=this.map.getLayer(o);if(!n)return;const c=this.map.getLayoutProperty(o,"visibility")!=="none",d=n.type,h=b(this.map,o,d),p=this.generateFriendlyName(o);this.state.layerStates[o]={visible:c,opacity:h,name:p}})}else{const i=[],s=[];e.forEach(a=>{this.targetLayers.includes(a)?i.push(a):s.push(a)}),s.length>0&&(this.state.layerStates.Background={visible:!0,opacity:1,name:"Background"}),i.forEach(a=>{const o=this.map.getLayer(a);if(!o)return;const l=this.map.getLayoutProperty(a,"visibility")!=="none",c=o.type,d=b(this.map,a,c),h=this.generateFriendlyName(a);this.state.layerStates[a]={visible:l,opacity:d,name:h}})}this.customLayerRegistry&&this.customLayerRegistry.getAllLayerIds().forEach(s=>{if(this.state.layerStates[s])return;const a=this.customLayerRegistry.getLayerState(s);a&&(this.state.layerStates[s]={visible:a.visible,opacity:a.opacity,name:a.name,isCustomLayer:!0,customLayerType:this.customLayerRegistry.getSymbolType(s)||void 0})}),this.targetLayers=Object.keys(this.state.layerStates)}detectUserAddedSources(){const t=new Set,e=this.map.getStyle();if(!e||!e.sources)return t;const i=new Set,s=["demotiles.maplibre.org","api.maptiler.com","tiles.stadiamaps.com","api.mapbox.com","basemaps.cartocdn.com","tiles.mapbox.com","a.basemaps.cartocdn.com","b.basemaps.cartocdn.com","c.basemaps.cartocdn.com","d.basemaps.cartocdn.com","tiles.arcgis.com","server.arcgisonline.com","services.arcgisonline.com"],a=e.sprite;if(a&&typeof a=="string")try{const o=new URL(a);i.add(o.hostname)}catch{}if(e.glyphs)try{const o=new URL(e.glyphs.replace("{fontstack}","x").replace("{range}","x"));i.add(o.hostname)}catch{}for(const[o,n]of Object.entries(e.sources)){if(this.initialSourceIds&&this.initialSourceIds.has(o))continue;const l=n,c=l.type;if(c==="image"||c==="video"||c==="canvas"){t.add(o);continue}if(c==="geojson"){if(l.data&&typeof l.data=="object")t.add(o);else if(l.data&&typeof l.data=="string")try{const d=new URL(l.data);s.some(p=>d.hostname.includes(p))||i.has(d.hostname)||t.add(o)}catch{t.add(o)}continue}if(c==="raster"||c==="raster-dem"||c==="vector"){const d=l.url||l.tiles&&l.tiles[0]||"";if(d)try{const p=new URL(d.replace(/{[^}]+}/g,"0")).hostname,m=s.some(v=>p===v||p.endsWith("."+v)),f=i.has(p);!m&&!f&&t.add(o)}catch{t.add(o)}}}return t}generateFriendlyName(t){let e=t.replace(/^(layer[-_]?|gl[-_]?)/,"");return e=e.replace(/[-_]/g," "),e=e.replace(/\b\w/g,i=>i.toUpperCase()),e||t}isDrawnLayer(t){return[/^gm[-_\s]/i,/^gl-draw[-_]/i,/^mapbox-gl-draw[-_]/i,/^terra-draw[-_]/i,/^maplibre-gl-draw[-_]/i,/^draw[-_]layer/i].some(i=>i.test(t))}createContainer(){const t=document.createElement("div");return t.className="maplibregl-ctrl maplibregl-ctrl-group maplibregl-ctrl-layer-control",t}createToggleButton(){const t=document.createElement("button");t.type="button",t.title="Layer Control",t.setAttribute("aria-label","Layer Control");const e=document.createElement("span");return e.className="layer-control-icon",e.innerHTML='<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 3 3 8.25 12 13.5 21 8.25 12 3"></polygon><polyline points="3 12.75 12 18 21 12.75"></polyline><polyline points="3 17.25 12 22 21 17.25"></polyline></svg>',t.appendChild(e),t}createPanel(){const t=document.createElement("div");t.className="layer-control-panel",t.style.width=`${this.state.panelWidth}px`,t.style.maxHeight=`${this.maxPanelHeight}px`,this.state.collapsed||t.classList.add("expanded");const e=this.createPanelHeader();t.appendChild(e);const i=this.createActionButtons();return t.appendChild(i),t}getControlPosition(){const t=this.container.parentElement;return t?t.classList.contains("maplibregl-ctrl-top-left")?"top-left":t.classList.contains("maplibregl-ctrl-top-right")?"top-right":t.classList.contains("maplibregl-ctrl-bottom-left")?"bottom-left":t.classList.contains("maplibregl-ctrl-bottom-right")?"bottom-right":"top-right":"top-right"}updatePanelPosition(){if(!this.button||!this.panel||!this.mapContainer)return;const t=this.button.getBoundingClientRect(),e=this.mapContainer.getBoundingClientRect(),i=this.getControlPosition(),s=t.top-e.top,a=e.bottom-t.bottom,o=t.left-e.left,n=e.right-t.right,l=5;switch(this.panel.style.top="",this.panel.style.bottom="",this.panel.style.left="",this.panel.style.right="",i){case"top-left":this.panel.style.top=`${s+t.height+l}px`,this.panel.style.left=`${o}px`;break;case"top-right":this.panel.style.top=`${s+t.height+l}px`,this.panel.style.right=`${n}px`;break;case"bottom-left":this.panel.style.bottom=`${a+t.height+l}px`,this.panel.style.left=`${o}px`;break;case"bottom-right":this.panel.style.bottom=`${a+t.height+l}px`,this.panel.style.right=`${n}px`;break}}createActionButtons(){const t=document.createElement("div");t.className="layer-control-actions";const e=document.createElement("button");e.type="button",e.className="layer-control-action-btn",e.textContent="Show All",e.title="Show all layers",e.addEventListener("click",()=>this.setAllLayersVisibility(!0));const i=document.createElement("button");return i.type="button",i.className="layer-control-action-btn",i.textContent="Hide All",i.title="Hide all layers",i.addEventListener("click",()=>this.setAllLayersVisibility(!1)),t.appendChild(e),t.appendChild(i),t}setAllLayersVisibility(t){Object.keys(this.state.layerStates).forEach(e=>{this.toggleLayerVisibility(e,t);const i=this.panel.querySelector(`[data-layer-id="${e}"]`);if(i){const s=i.querySelector(".layer-control-checkbox");s&&(s.checked=t,s.indeterminate=!1)}})}createPanelHeader(){const t=document.createElement("div");t.className="layer-control-panel-header";const e=document.createElement("span");e.className="layer-control-panel-title",e.textContent="Layers",t.appendChild(e);const i=this.createWidthControl();return t.appendChild(i),t}createWidthControl(){const t=document.createElement("label");t.className="layer-control-width-control",t.title="Adjust layer panel width";const e=document.createElement("span");e.textContent="Width",t.appendChild(e);const i=document.createElement("div");i.className="layer-control-width-slider",i.setAttribute("role","slider"),i.setAttribute("aria-valuemin",String(this.minPanelWidth)),i.setAttribute("aria-valuemax",String(this.maxPanelWidth)),i.setAttribute("aria-valuenow",String(this.state.panelWidth)),i.setAttribute("aria-valuestep","10"),i.setAttribute("aria-label","Layer panel width"),i.tabIndex=0;const s=document.createElement("div");s.className="layer-control-width-track";const a=document.createElement("div");a.className="layer-control-width-thumb",i.appendChild(s),i.appendChild(a),this.widthSliderEl=i,this.widthThumbEl=a;const o=document.createElement("span");return o.className="layer-control-width-value",this.widthValueEl=o,t.appendChild(i),t.appendChild(o),this.updateWidthDisplay(),this.setupWidthSliderEvents(i),t}setupWidthSliderEvents(t){t.addEventListener("pointerdown",i=>{i.preventDefault();const s=t.getBoundingClientRect();this.widthDragRectWidth=s.width||1,this.widthDragStartX=i.clientX,this.widthDragStartWidth=this.state.panelWidth,this.isWidthSliderActive=!0,t.setPointerCapture(i.pointerId),this.updateWidthFromPointer(i,!0)}),t.addEventListener("pointermove",i=>{this.isWidthSliderActive&&this.updateWidthFromPointer(i)});const e=i=>{if(this.isWidthSliderActive){if(i.pointerId!==void 0)try{t.releasePointerCapture(i.pointerId)}catch{}this.isWidthSliderActive=!1,this.widthDragRectWidth=null,this.widthDragStartX=null,this.widthDragStartWidth=null,this.updateWidthDisplay()}};t.addEventListener("pointerup",e),t.addEventListener("pointercancel",e),t.addEventListener("lostpointercapture",e),t.addEventListener("keydown",i=>{let s=!0;const a=i.shiftKey?20:10;switch(i.key){case"ArrowLeft":case"ArrowDown":this.applyPanelWidth(this.state.panelWidth-a,!0);break;case"ArrowRight":case"ArrowUp":this.applyPanelWidth(this.state.panelWidth+a,!0);break;case"Home":this.applyPanelWidth(this.minPanelWidth,!0);break;case"End":this.applyPanelWidth(this.maxPanelWidth,!0);break;case"PageUp":this.applyPanelWidth(this.state.panelWidth+50,!0);break;case"PageDown":this.applyPanelWidth(this.state.panelWidth-50,!0);break;default:s=!1}s&&(i.preventDefault(),this.updateWidthDisplay())})}updateWidthFromPointer(t,e=!1){if(!this.widthSliderEl)return;const i=this.widthDragRectWidth||this.widthSliderEl.getBoundingClientRect().width||1,s=this.maxPanelWidth-this.minPanelWidth;let a;if(e){const o=this.widthSliderEl.getBoundingClientRect(),n=o.width>0?(t.clientX-o.left)/o.width:0,l=Math.min(1,Math.max(0,n));a=this.minPanelWidth+l*s,this.widthDragStartWidth=a,this.widthDragStartX=t.clientX}else{const o=t.clientX-(this.widthDragStartX||t.clientX);a=(this.widthDragStartWidth||this.state.panelWidth)+o/i*s}this.applyPanelWidth(a,this.isWidthSliderActive)}applyPanelWidth(t,e=!1){const i=Math.round(Math.min(this.maxPanelWidth,Math.max(this.minPanelWidth,t))),s=()=>{this.state.panelWidth=i;const a=`${i}px`;this.panel.style.width=a,this.updateWidthDisplay()};if(e){s();return}this.widthFrame&&cancelAnimationFrame(this.widthFrame),this.widthFrame=requestAnimationFrame(()=>{s(),this.widthFrame=null})}updateWidthDisplay(){if(this.widthValueEl&&(this.widthValueEl.textContent=`${this.state.panelWidth}px`),this.widthSliderEl){this.widthSliderEl.setAttribute("aria-valuenow",String(this.state.panelWidth));const t=(this.state.panelWidth-this.minPanelWidth)/(this.maxPanelWidth-this.minPanelWidth||1);if(this.widthThumbEl){const e=this.widthSliderEl.clientWidth;if(e===0){requestAnimationFrame(()=>this.updateWidthDisplay());return}const i=this.widthThumbEl.offsetWidth||14,a=Math.max(0,e-16-i),o=Math.min(1,Math.max(0,t)),n=8+a*o;this.widthThumbEl.style.left=`${n}px`}}}setupEventListeners(){this.button.addEventListener("click",()=>this.toggle()),document.addEventListener("click",t=>{const e=t.target;!this.container.contains(e)&&!this.panel.contains(e)&&this.collapse()}),this.resizeHandler=()=>{this.state.collapsed||this.updatePanelPosition()},window.addEventListener("resize",this.resizeHandler),this.mapResizeHandler=()=>{this.state.collapsed||this.updatePanelPosition()},this.map.on("resize",this.mapResizeHandler),this.setupLayerChangeListeners()}setupLayerChangeListeners(){this.map.on("styledata",()=>{setTimeout(()=>{this.updateLayerStatesFromMap(),this.checkForNewLayers()},100)}),this.map.on("data",t=>{t.sourceDataType==="content"&&setTimeout(()=>{this.updateLayerStatesFromMap(),this.checkForNewLayers()},100)}),this.map.on("sourcedata",t=>{t.sourceDataType==="metadata"&&setTimeout(()=>{this.checkForNewLayers()},150)}),this.customLayerRegistry&&(this.customLayerUnsubscribe=this.customLayerRegistry.onChange(()=>{setTimeout(()=>this.checkForNewLayers(),100)}))}toggle(){this.state.collapsed?this.expand():this.collapse()}expand(){this.state.collapsed=!1,this.panel.classList.add("expanded"),this.updatePanelPosition()}collapse(){this.state.collapsed=!0,this.panel.classList.remove("expanded")}buildLayerItems(){this.panel.querySelectorAll(".layer-control-item").forEach(e=>e.remove()),this.styleEditors.clear(),Object.entries(this.state.layerStates).forEach(([e,i])=>{(this.targetLayers.length===0||this.targetLayers.includes(e))&&this.addLayerItem(e,i)})}addLayerItem(t,e){const i=document.createElement("div");i.className="layer-control-item",i.setAttribute("data-layer-id",t);const s=document.createElement("div");s.className="layer-control-row";const a=document.createElement("input");a.type="checkbox",a.className="layer-control-checkbox",a.checked=e.visible,a.addEventListener("change",()=>{this.toggleLayerVisibility(t,a.checked)});const o=document.createElement("span");if(o.className="layer-control-name",o.textContent=e.name||t,o.title=e.name||t,s.appendChild(a),this.showLayerSymbol)if(t==="Background"){const n=this.createBackgroundGroupSymbol();s.appendChild(n)}else{const n=this.createLayerSymbol(t);n&&s.appendChild(n)}if(s.appendChild(o),this.showOpacitySlider){const n=document.createElement("input");n.type="range",n.className="layer-control-opacity",n.min="0",n.max="1",n.step="0.01",n.value=String(e.opacity),n.title=`Opacity: ${Math.round(e.opacity*100)}%`,n.addEventListener("mousedown",()=>{this.state.userInteractingWithSlider=!0}),n.addEventListener("mouseup",()=>{this.state.userInteractingWithSlider=!1}),n.addEventListener("input",()=>{this.changeLayerOpacity(t,parseFloat(n.value)),n.title=`Opacity: ${Math.round(parseFloat(n.value)*100)}%`}),s.appendChild(n)}if(this.showStyleEditor)if(t==="Background"){const n=this.createBackgroundLegendButton();s.appendChild(n)}else{const n=this.createStyleButton(t);n&&s.appendChild(n)}i.appendChild(s),this.panel.appendChild(i)}createLayerSymbol(t){const e=this.state.layerStates[t];if(e!=null&&e.isCustomLayer){const l=e.customLayerType||"custom-raster",d=k(l,"#4a90d9"),h=document.createElement("span");return h.className="layer-control-symbol",h.innerHTML=d,h.title=`Layer type: ${l}`,h}const i=this.map.getLayer(t);if(!i)return null;const s=i.type,a=F(this.map,t,s),o=k(s,a),n=document.createElement("span");return n.className="layer-control-symbol",n.innerHTML=o,n.title=`Layer type: ${s}`,n}createBackgroundLayerSymbol(t){const e=O(t),i=k(t.type,e,{size:14}),s=document.createElement("span");return s.className="background-legend-layer-symbol",s.innerHTML=i,s.title=`Layer type: ${t.type}`,s}createBackgroundGroupSymbol(){const t=Y(16),e=document.createElement("span");return e.className="layer-control-symbol",e.innerHTML=t,e.title="Background layers",e}toggleLayerVisibility(t,e){var i;if(t==="Background"){this.toggleBackgroundVisibility(e);return}this.state.layerStates[t]&&(this.state.layerStates[t].visible=e),!((i=this.customLayerRegistry)!=null&&i.setVisibility(t,e))&&this.map.setLayoutProperty(t,"visibility",e?"visible":"none")}changeLayerOpacity(t,e){var i;if(t==="Background"){this.changeBackgroundOpacity(e);return}if(this.state.layerStates[t]&&(this.state.layerStates[t].opacity=e),(i=this.customLayerRegistry)!=null&&i.setOpacity(t,e))return;const s=E(this.map,t);s&&x(this.map,t,s,e)}isUserAddedLayer(t){return this.state.layerStates[t]!==void 0&&t!=="Background"}toggleBackgroundVisibility(t){if(this.state.layerStates.Background&&(this.state.layerStates.Background.visible=t),(this.map.getStyle().layers||[]).forEach(i=>{this.isUserAddedLayer(i.id)||(this.state.backgroundLayerVisibility.set(i.id,t),this.map.setLayoutProperty(i.id,"visibility",t?"visible":"none"))}),this.state.backgroundLegendOpen){const i=this.panel.querySelector(".layer-control-background-legend");i&&i.querySelectorAll(".background-legend-checkbox").forEach(a=>{a.checked=t})}}changeBackgroundOpacity(t){this.state.layerStates.Background&&(this.state.layerStates.Background.opacity=t),(this.map.getStyle().layers||[]).forEach(i=>{if(!this.isUserAddedLayer(i.id)){const s=E(this.map,i.id);s&&x(this.map,i.id,s,t)}})}createBackgroundLegendButton(){const t=document.createElement("button");return t.className="layer-control-style-button layer-control-background-legend-button",t.innerHTML="&#9881;",t.title="Show background layer details",t.setAttribute("aria-label","Show background layer visibility controls"),t.setAttribute("aria-expanded",String(this.state.backgroundLegendOpen)),t.addEventListener("click",e=>{e.stopPropagation(),this.toggleBackgroundLegend()}),t}toggleBackgroundLegend(){this.state.backgroundLegendOpen?this.closeBackgroundLegend():this.openBackgroundLegend()}openBackgroundLegend(){this.state.activeStyleEditor&&this.closeStyleEditor(this.state.activeStyleEditor);const t=this.panel.querySelector('[data-layer-id="Background"]');if(!t)return;let e=t.querySelector(".layer-control-background-legend");if(e){const s=e.querySelector(".background-legend-layer-list");s&&this.populateBackgroundLayerList(s)}else e=this.createBackgroundLegendPanel(),t.appendChild(e);this.state.backgroundLegendOpen=!0;const i=t.querySelector(".layer-control-background-legend-button");i&&(i.setAttribute("aria-expanded","true"),i.classList.add("active")),setTimeout(()=>{e==null||e.scrollIntoView({behavior:"smooth",block:"nearest"})},50)}closeBackgroundLegend(){const t=this.panel.querySelector('[data-layer-id="Background"]');if(!t)return;const e=t.querySelector(".layer-control-background-legend");e&&e.remove(),this.state.backgroundLegendOpen=!1;const i=t.querySelector(".layer-control-background-legend-button");i&&(i.setAttribute("aria-expanded","false"),i.classList.remove("active"))}createBackgroundLegendPanel(){const t=document.createElement("div");t.className="layer-control-background-legend";const e=document.createElement("div");e.className="background-legend-header";const i=document.createElement("span");i.className="background-legend-title",i.textContent="Background Layers";const s=document.createElement("button");s.className="background-legend-close",s.innerHTML="&times;",s.title="Close",s.addEventListener("click",p=>{p.stopPropagation(),this.closeBackgroundLegend()}),e.appendChild(i),e.appendChild(s);const a=document.createElement("div");a.className="background-legend-actions";const o=document.createElement("button");o.className="background-legend-action-btn",o.textContent="Show All",o.addEventListener("click",()=>this.setAllBackgroundLayersVisibility(!0));const n=document.createElement("button");n.className="background-legend-action-btn",n.textContent="Hide All",n.addEventListener("click",()=>this.setAllBackgroundLayersVisibility(!1)),a.appendChild(o),a.appendChild(n);const l=document.createElement("div");l.className="background-legend-filter";const c=document.createElement("input");c.type="checkbox",c.className="background-legend-filter-checkbox",c.id="background-legend-only-rendered",c.checked=this.state.onlyRenderedFilter,c.addEventListener("change",()=>{this.state.onlyRenderedFilter=c.checked;const p=t.querySelector(".background-legend-layer-list");p&&this.populateBackgroundLayerList(p)});const d=document.createElement("label");d.className="background-legend-filter-label",d.htmlFor="background-legend-only-rendered",d.textContent="Only rendered",l.appendChild(c),l.appendChild(d);const h=document.createElement("div");return h.className="background-legend-layer-list",this.populateBackgroundLayerList(h),t.appendChild(e),t.appendChild(a),t.appendChild(l),t.appendChild(h),t}isLayerRendered(t){try{const e=this.map.getLayer(t);return!e||this.map.getLayoutProperty(t,"visibility")==="none"?!1:e.type==="raster"||e.type==="hillshade"||e.type==="background"?!0:this.map.queryRenderedFeatures({layers:[t]}).length>0}catch{return!0}}populateBackgroundLayerList(t){if(t.innerHTML="",(this.map.getStyle().layers||[]).forEach(i=>{if(!this.isUserAddedLayer(i.id)){if(this.excludeDrawnLayers&&this.isDrawnLayer(i.id)||this.state.onlyRenderedFilter&&!this.isLayerRendered(i.id))return;const s=document.createElement("div");s.className="background-legend-layer-row",s.setAttribute("data-background-layer-id",i.id);const a=document.createElement("input");a.type="checkbox",a.className="background-legend-checkbox";const n=this.map.getLayoutProperty(i.id,"visibility")!=="none";a.checked=n,this.state.backgroundLayerVisibility.set(i.id,n),a.addEventListener("change",()=>{this.toggleIndividualBackgroundLayer(i.id,a.checked)});const l=document.createElement("span");l.className="background-legend-layer-name",l.textContent=this.generateFriendlyName(i.id),l.title=i.id;const c=document.createElement("span");if(c.className="background-legend-layer-type",c.textContent=i.type,s.appendChild(a),this.showLayerSymbol){const d=this.createBackgroundLayerSymbol(i);d&&s.appendChild(d)}s.appendChild(l),s.appendChild(c),t.appendChild(s)}}),t.children.length===0){const i=document.createElement("p");i.className="background-legend-empty",i.textContent=this.state.onlyRenderedFilter?"No rendered layers in current view.":"No background layers found.",t.appendChild(i)}}toggleIndividualBackgroundLayer(t,e){this.state.backgroundLayerVisibility.set(t,e),this.map.setLayoutProperty(t,"visibility",e?"visible":"none"),this.updateBackgroundCheckboxState()}setAllBackgroundLayersVisibility(t){(this.map.getStyle().layers||[]).forEach(s=>{this.isUserAddedLayer(s.id)||(this.state.backgroundLayerVisibility.set(s.id,t),this.map.setLayoutProperty(s.id,"visibility",t?"visible":"none"))});const i=this.panel.querySelector(".layer-control-background-legend");i&&i.querySelectorAll(".background-legend-checkbox").forEach(a=>{a.checked=t}),this.updateBackgroundCheckboxState()}updateBackgroundCheckboxState(){const t=this.map.getStyle().layers||[];let e=!1,i=!0;t.forEach(a=>{if(!this.isUserAddedLayer(a.id)){const o=this.state.backgroundLayerVisibility.get(a.id);o===!0&&(e=!0),o===!1&&(i=!1)}});const s=this.panel.querySelector('[data-layer-id="Background"]');if(s){const a=s.querySelector(".layer-control-checkbox");a&&(a.checked=e,a.indeterminate=e&&!i)}this.state.layerStates.Background&&(this.state.layerStates.Background.visible=e)}createStyleButton(t){if(t==="Background")return null;const e=this.state.layerStates[t],i=(e==null?void 0:e.isCustomLayer)===!0,s=document.createElement("button");return s.className="layer-control-style-button",s.innerHTML="&#9881;",i?(s.title="Layer info (style editing not available)",s.setAttribute("aria-label",`Layer info for ${t}`)):(s.title="Edit layer style",s.setAttribute("aria-label",`Edit style for ${t}`)),s.addEventListener("click",a=>{a.stopPropagation(),this.toggleStyleEditor(t)}),s}toggleStyleEditor(t){if(this.state.activeStyleEditor===t){this.closeStyleEditor(t);return}this.state.activeStyleEditor&&this.closeStyleEditor(this.state.activeStyleEditor),this.openStyleEditor(t)}openStyleEditor(t){const e=this.panel.querySelector(`[data-layer-id="${t}"]`);if(!e)return;const i=this.state.layerStates[t];if(i!=null&&i.isCustomLayer){const a=this.createCustomLayerInfoPanel(t);e.appendChild(a),this.styleEditors.set(t,a),this.state.activeStyleEditor=t,setTimeout(()=>{a.scrollIntoView({behavior:"smooth",block:"nearest"})},50);return}this.state.originalStyles.has(t)||this.map.getLayer(t)&&R(this.map,t,this.state.originalStyles);const s=this.createStyleEditor(t);s&&(e.appendChild(s),this.styleEditors.set(t,s),this.state.activeStyleEditor=t,setTimeout(()=>{s.scrollIntoView({behavior:"smooth",block:"nearest"})},50))}createCustomLayerInfoPanel(t){const e=document.createElement("div");e.className="layer-control-style-editor layer-control-custom-info";const i=document.createElement("div");i.className="style-editor-header";const s=document.createElement("span");s.className="style-editor-title",s.textContent="Layer Info";const a=document.createElement("button");a.className="style-editor-close",a.innerHTML="&times;",a.title="Close",a.addEventListener("click",d=>{d.stopPropagation(),this.closeStyleEditor(t)}),i.appendChild(s),i.appendChild(a);const o=document.createElement("div");o.className="style-editor-controls";const n=document.createElement("p");n.className="layer-control-custom-info-text",n.textContent="This is a custom layer. Style editing is not available for this layer type. Use the visibility toggle and opacity slider to control the layer.",o.appendChild(n);const l=document.createElement("div");l.className="style-editor-actions";const c=document.createElement("button");return c.className="style-editor-button style-editor-button-close",c.textContent="Close",c.addEventListener("click",d=>{d.stopPropagation(),this.closeStyleEditor(t)}),l.appendChild(c),e.appendChild(i),e.appendChild(o),e.appendChild(l),e}closeStyleEditor(t){const e=this.styleEditors.get(t);e&&(e.remove(),this.styleEditors.delete(t)),this.state.activeStyleEditor===t&&(this.state.activeStyleEditor=null)}createStyleEditor(t){const e=this.map.getLayer(t);if(!e)return null;const i=document.createElement("div");i.className="layer-control-style-editor";const s=document.createElement("div");s.className="style-editor-header";const a=document.createElement("span");a.className="style-editor-title",a.textContent="Edit Style";const o=document.createElement("button");o.className="style-editor-close",o.innerHTML="&times;",o.title="Close",o.addEventListener("click",p=>{p.stopPropagation(),this.closeStyleEditor(t)}),s.appendChild(a),s.appendChild(o);const n=document.createElement("div");n.className="style-editor-controls";const l=e.type;this.addStyleControlsForLayerType(n,t,l);const c=document.createElement("div");c.className="style-editor-actions";const d=document.createElement("button");d.className="style-editor-button style-editor-button-reset",d.textContent="Reset",d.addEventListener("click",p=>{p.stopPropagation(),this.resetLayerStyle(t)});const h=document.createElement("button");return h.className="style-editor-button style-editor-button-close",h.textContent="Close",h.addEventListener("click",p=>{p.stopPropagation(),this.closeStyleEditor(t)}),c.appendChild(d),c.appendChild(h),i.appendChild(s),i.appendChild(n),i.appendChild(c),i}addStyleControlsForLayerType(t,e,i){switch(i){case"fill":this.addFillControls(t,e);break;case"line":this.addLineControls(t,e);break;case"circle":this.addCircleControls(t,e);break;case"raster":this.addRasterControls(t,e);break;case"symbol":this.addSymbolControls(t,e);break;default:t.textContent=`Style controls for ${i} layers not yet implemented.`}}addFillControls(t,e){var i;const a=(i=this.map.getStyle().layers)==null?void 0:i.find(c=>c.id===e);let o;a&&"paint"in a&&a.paint&&"fill-color"in a.paint&&(o=a.paint["fill-color"]),o||(o=this.map.getPaintProperty(e,"fill-color")),this.createColorControl(t,e,"fill-color","Fill Color",g(o||"#088"));const n=this.map.getPaintProperty(e,"fill-opacity");n!==void 0&&typeof n=="number"&&this.createSliderControl(t,e,"fill-opacity","Fill Opacity",n,0,1,.05);const l=this.map.getPaintProperty(e,"fill-outline-color");l!==void 0&&this.createColorControl(t,e,"fill-outline-color","Outline Color",g(l))}addLineControls(t,e){var i;const a=(i=this.map.getStyle().layers)==null?void 0:i.find(d=>d.id===e);let o;a&&"paint"in a&&a.paint&&"line-color"in a.paint&&(o=a.paint["line-color"]),o||(o=this.map.getPaintProperty(e,"line-color")),this.createColorControl(t,e,"line-color","Line Color",g(o||"#000"));const n=this.map.getPaintProperty(e,"line-width");this.createSliderControl(t,e,"line-width","Line Width",typeof n=="number"?n:1,0,20,.5);const l=this.map.getPaintProperty(e,"line-opacity");l!==void 0&&typeof l=="number"&&this.createSliderControl(t,e,"line-opacity","Line Opacity",l,0,1,.05);const c=this.map.getPaintProperty(e,"line-blur");c!==void 0&&typeof c=="number"&&this.createSliderControl(t,e,"line-blur","Line Blur",c,0,5,.1)}addCircleControls(t,e){var i;const a=(i=this.map.getStyle().layers)==null?void 0:i.find(h=>h.id===e);let o;a&&"paint"in a&&a.paint&&"circle-color"in a.paint&&(o=a.paint["circle-color"]),o||(o=this.map.getPaintProperty(e,"circle-color")),this.createColorControl(t,e,"circle-color","Circle Color",g(o||"#000"));const n=this.map.getPaintProperty(e,"circle-radius");this.createSliderControl(t,e,"circle-radius","Radius",typeof n=="number"?n:5,0,40,.5);const l=this.map.getPaintProperty(e,"circle-opacity");l!==void 0&&typeof l=="number"&&this.createSliderControl(t,e,"circle-opacity","Opacity",l,0,1,.05);const c=this.map.getPaintProperty(e,"circle-stroke-color");c!==void 0&&this.createColorControl(t,e,"circle-stroke-color","Stroke Color",g(c));const d=this.map.getPaintProperty(e,"circle-stroke-width");d!==void 0&&typeof d=="number"&&this.createSliderControl(t,e,"circle-stroke-width","Stroke Width",d,0,10,.1)}addRasterControls(t,e){const i=this.map.getPaintProperty(e,"raster-opacity");this.createSliderControl(t,e,"raster-opacity","Opacity",typeof i=="number"?i:1,0,1,.05);const s=this.map.getPaintProperty(e,"raster-brightness-min");this.createSliderControl(t,e,"raster-brightness-min","Brightness Min",typeof s=="number"?s:0,-1,1,.05);const a=this.map.getPaintProperty(e,"raster-brightness-max");this.createSliderControl(t,e,"raster-brightness-max","Brightness Max",typeof a=="number"?a:1,-1,1,.05);const o=this.map.getPaintProperty(e,"raster-saturation");this.createSliderControl(t,e,"raster-saturation","Saturation",typeof o=="number"?o:0,-1,1,.05);const n=this.map.getPaintProperty(e,"raster-contrast");this.createSliderControl(t,e,"raster-contrast","Contrast",typeof n=="number"?n:0,-1,1,.05);const l=this.map.getPaintProperty(e,"raster-hue-rotate");this.createSliderControl(t,e,"raster-hue-rotate","Hue Rotate",typeof l=="number"?l:0,0,360,5)}addSymbolControls(t,e){const i=this.map.getPaintProperty(e,"text-color");i!==void 0&&this.createColorControl(t,e,"text-color","Text Color",g(i));const s=this.map.getPaintProperty(e,"text-opacity");s!==void 0&&typeof s=="number"&&this.createSliderControl(t,e,"text-opacity","Text Opacity",s,0,1,.05);const a=this.map.getPaintProperty(e,"icon-opacity");a!==void 0&&typeof a=="number"&&this.createSliderControl(t,e,"icon-opacity","Icon Opacity",a,0,1,.05)}createColorControl(t,e,i,s,a){const o=document.createElement("div");o.className="style-control-group";const n=document.createElement("label");n.className="style-control-label",n.textContent=s;const l=document.createElement("div");l.className="style-control-color-group";const c=document.createElement("input");c.type="color",c.className="style-control-color-picker",c.value=a,c.dataset.property=i;const d=document.createElement("input");d.type="text",d.className="style-control-color-value",d.value=a,d.readOnly=!0,c.addEventListener("input",()=>{const h=c.value;d.value=h,this.map.setPaintProperty(e,i,h)}),l.appendChild(c),l.appendChild(d),o.appendChild(n),o.appendChild(l),t.appendChild(o)}createSliderControl(t,e,i,s,a,o,n,l){const c=document.createElement("div");c.className="style-control-group";const d=document.createElement("label");d.className="style-control-label",d.textContent=s;const h=document.createElement("div");h.className="style-control-input-wrapper";const p=document.createElement("input");p.type="range",p.className="style-control-slider",p.min=String(o),p.max=String(n),p.step=String(l),p.value=String(a),p.dataset.property=i;const m=document.createElement("span");m.className="style-control-value",m.textContent=S(a,l),p.addEventListener("input",()=>{const f=parseFloat(p.value);m.textContent=S(f,l),this.map.setPaintProperty(e,i,f)}),h.appendChild(p),h.appendChild(m),c.appendChild(d),c.appendChild(h),t.appendChild(c)}resetLayerStyle(t){if(!this.state.originalStyles.get(t))return;M(this.map,t,this.state.originalStyles);const i=this.styleEditors.get(t);i&&(i.querySelectorAll(".style-control-slider").forEach(o=>{var n;const l=o.dataset.property;if(l){const c=this.map.getPaintProperty(t,l);if(c!==void 0&&typeof c=="number"){o.value=String(c);const d=(n=o.parentElement)==null?void 0:n.querySelector(".style-control-value");if(d){const h=parseFloat(o.step);d.textContent=S(c,h)}}}}),i.querySelectorAll(".style-control-color-picker").forEach(o=>{var n;const l=o.dataset.property;if(l){const c=this.map.getPaintProperty(t,l);if(c!==void 0){const d=g(c);o.value=d;const h=(n=o.parentElement)==null?void 0:n.querySelector(".style-control-color-value");h&&(h.textContent=d)}}}))}updateLayerStatesFromMap(){this.state.userInteractingWithSlider||Object.keys(this.state.layerStates).forEach(t=>{var e;try{if((e=this.state.layerStates[t])!=null&&e.isCustomLayer||t==="Background")return;const i=this.map.getLayer(t);if(!i)return;const a=this.map.getLayoutProperty(t,"visibility")!=="none",o=i.type,n=b(this.map,t,o);this.state.layerStates[t]&&(this.state.layerStates[t].visible=a,this.state.layerStates[t].opacity=n),this.updateUIForLayer(t,a,n)}catch(i){console.warn(`Failed to update state for layer ${t}:`,i)}})}updateUIForLayer(t,e,i){this.panel.querySelectorAll(".layer-control-item").forEach(a=>{if(a.dataset.layerId===t){const o=a.querySelector(".layer-control-checkbox"),n=a.querySelector(".layer-control-opacity");o&&(o.checked=e),n&&(n.value=String(i),n.title=`Opacity: ${Math.round(i*100)}%`)}})}checkForNewLayers(){try{const t=this.map.getStyle();if(!t||!t.layers)return;const e=new Set(t.layers.map(n=>n.id)),i=this.targetLayers.length===0||this.targetLayers.length===1&&this.targetLayers[0]==="Background"||this.targetLayers.every(n=>n==="Background"||this.state.layerStates[n]),s=[],a=i?this.detectUserAddedSources():new Set;e.forEach(n=>{if(n!=="Background"&&!this.state.layerStates[n]){const l=this.map.getLayer(n);if(l){if(i){if(this.excludeDrawnLayers&&this.isDrawnLayer(n))return;const c=l.source;if(!c||!a.has(c))return}s.push(n)}}});const o=[];if(Object.keys(this.state.layerStates).forEach(n=>{const l=this.state.layerStates[n];n!=="Background"&&!l.isCustomLayer&&!e.has(n)&&o.push(n)}),o.length>0&&o.forEach(n=>{delete this.state.layerStates[n];const l=this.panel.querySelector(`[data-layer-id="${n}"]`);l&&l.remove(),this.state.activeStyleEditor===n&&(this.state.activeStyleEditor=null),this.styleEditors.delete(n)}),s.length>0&&s.forEach(n=>{const l=this.map.getLayer(n);if(!l)return;const c=l.type,d=b(this.map,n,c),p=this.map.getLayoutProperty(n,"visibility")!=="none";this.state.layerStates[n]={visible:p,opacity:d,name:this.generateFriendlyName(n)},this.addLayerItem(n,this.state.layerStates[n])}),this.customLayerRegistry){const n=this.customLayerRegistry.getAllLayerIds();n.forEach(l=>{if(!this.state.layerStates[l]){const c=this.customLayerRegistry.getLayerState(l);c&&(this.state.layerStates[l]={visible:c.visible,opacity:c.opacity,name:c.name,isCustomLayer:!0,customLayerType:this.customLayerRegistry.getSymbolType(l)||void 0},this.addLayerItem(l,this.state.layerStates[l]))}}),Object.keys(this.state.layerStates).forEach(l=>{if(this.state.layerStates[l].isCustomLayer&&!n.includes(l)){delete this.state.layerStates[l];const d=this.panel.querySelector(`[data-layer-id="${l}"]`);d&&d.remove(),this.state.activeStyleEditor===l&&(this.state.activeStyleEditor=null),this.styleEditors.delete(l)}})}}catch(t){console.warn("Failed to check for new layers:",t)}}registerCustomAdapter(t){this.customLayerRegistry||(this.customLayerRegistry=new C,this.customLayerUnsubscribe=this.customLayerRegistry.onChange(()=>{this.checkForNewLayers()})),this.customLayerRegistry.register(t),this.panel&&this.checkForNewLayers()}}export{Q as L};
