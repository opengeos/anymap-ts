import{r as T}from"./utils-2CUC2toc.js";import{I as k}from"./icon-layer-Bof6haF-.js";import{S as v}from"./scatterplot-layer-Dggjx1PX.js";import{T as A}from"./text-layer-DgSZVaCH.js";import{P as M}from"./path-layer-CHynATzn.js";import{S as O}from"./solid-polygon-layer-D1rmJNiJ.js";import{d as y}from"./mapbox-overlay-BJyTL8Fv.js";import{C as _}from"./composite-layer-Bi-GsFUv.js";function z(s,o){if(!s)return null;const e="startIndices"in s?s.startIndices[o]:o,t=s.featureIds.value[e];return e!==-1?W(s,t,e):null}function W(s,o,e){const t={properties:{...s.properties[o]}};for(const i in s.numericProps)t.properties[i]=s.numericProps[i].value[e];return t}function F(s,o){const e={points:null,lines:null,polygons:null};for(const t in e){const i=s[t].globalFeatureIds.value;e[t]=new Uint8ClampedArray(i.length*4);const n=[];for(let r=0;r<i.length;r++)o(i[r],n),e[t][r*4+0]=n[0],e[t][r*4+1]=n[1],e[t][r*4+2]=n[2],e[t][r*4+3]=255}return e}const f={circle:{type:v,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:k,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:A,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},P={type:M,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},L={type:O,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function c({type:s,props:o}){const e={};for(const t in o)e[t]=s.defaultProps[o[t]];return e}function x(s,o){const{transitions:e,updateTriggers:t}=s.props,i={updateTriggers:{},transitions:e&&{getPosition:e.geometry}};for(const n in o){const r=o[n];let a=s.props[n];n.startsWith("get")&&(a=s.getSubLayerAccessor(a),i.updateTriggers[r]=t[n],e&&(i.transitions[r]=e[n])),i[r]=a}return i}function R(s){if(Array.isArray(s))return s;switch(y.assert(s.type,"GeoJSON does not have type"),s.type){case"Feature":return[s];case"FeatureCollection":return y.assert(Array.isArray(s.features),"GeoJSON does not have features array"),s.features;default:return[{geometry:s}]}}function S(s,o,e={}){const t={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:i=0,endRow:n=s.length}=e;for(let r=i;r<n;r++){const a=s[r],{geometry:l}=a;if(l)if(l.type==="GeometryCollection"){y.assert(Array.isArray(l.geometries),"GeoJSON does not have geometries array");const{geometries:p}=l;for(let d=0;d<p.length;d++){const u=p[d];m(u,t,o,a,r)}}else m(l,t,o,a,r)}return t}function m(s,o,e,t,i){const{type:n,coordinates:r}=s,{pointFeatures:a,lineFeatures:l,polygonFeatures:p,polygonOutlineFeatures:d}=o;if(!E(n,r)){y.warn(`${n} coordinates are malformed`)();return}switch(n){case"Point":a.push(e({geometry:s},t,i));break;case"MultiPoint":r.forEach(u=>{a.push(e({geometry:{type:"Point",coordinates:u}},t,i))});break;case"LineString":l.push(e({geometry:s},t,i));break;case"MultiLineString":r.forEach(u=>{l.push(e({geometry:{type:"LineString",coordinates:u}},t,i))});break;case"Polygon":p.push(e({geometry:s},t,i)),r.forEach(u=>{d.push(e({geometry:{type:"LineString",coordinates:u}},t,i))});break;case"MultiPolygon":r.forEach(u=>{p.push(e({geometry:{type:"Polygon",coordinates:u}},t,i)),u.forEach(g=>{d.push(e({geometry:{type:"LineString",coordinates:g}},t,i))})});break}}const w={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function E(s,o){let e=w[s];for(y.assert(e,`Unknown GeoJSON type ${s}`);o&&--e>0;)o=o[0];return o&&Number.isFinite(o[0])}function b(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function h(s){return s.geometry.coordinates}function B(s,o){const e=b(),{pointFeatures:t,lineFeatures:i,polygonFeatures:n,polygonOutlineFeatures:r}=s;return e.points.data=t,e.points._dataDiff=o.pointFeatures&&(()=>o.pointFeatures),e.points.getPosition=h,e.lines.data=i,e.lines._dataDiff=o.lineFeatures&&(()=>o.lineFeatures),e.lines.getPath=h,e.polygons.data=n,e.polygons._dataDiff=o.polygonFeatures&&(()=>o.polygonFeatures),e.polygons.getPolygon=h,e.polygonsOutline.data=r,e.polygonsOutline._dataDiff=o.polygonOutlineFeatures&&(()=>o.polygonOutlineFeatures),e.polygonsOutline.getPath=h,e}function G(s,o){const e=b(),{points:t,lines:i,polygons:n}=s,r=F(s,o);e.points.data={length:t.positions.value.length/t.positions.size,attributes:{...t.attributes,getPosition:t.positions,instancePickingColors:{size:4,value:r.points}},properties:t.properties,numericProps:t.numericProps,featureIds:t.featureIds},e.lines.data={length:i.pathIndices.value.length-1,startIndices:i.pathIndices.value,attributes:{...i.attributes,getPath:i.positions,instancePickingColors:{size:4,value:r.lines}},properties:i.properties,numericProps:i.numericProps,featureIds:i.featureIds},e.lines._pathType="open";const a=n.positions.value.length/n.positions.size,l=Array(a).fill(1);for(const p of n.primitivePolygonIndices.value)l[p-1]=0;return e.polygons.data={length:n.polygonIndices.value.length-1,startIndices:n.polygonIndices.value,attributes:{...n.attributes,getPolygon:n.positions,instanceVertexValid:{size:1,value:new Uint16Array(l)},pickingColors:{size:4,value:r.polygons}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},e.polygons._normalize=!1,n.triangles&&(e.polygons.data.attributes.indices=n.triangles.value),e.polygonsOutline.data={length:n.primitivePolygonIndices.value.length-1,startIndices:n.primitivePolygonIndices.value,attributes:{...n.attributes,getPath:n.positions,instancePickingColors:{size:4,value:r.polygons}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},e.polygonsOutline._pathType="open",e}const N=["points","linestrings","polygons"],U={...c(f.circle),...c(f.icon),...c(f.text),...c(P),...c(L),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:s=>s.properties.icon},getText:{type:"accessor",value:s=>s.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class C extends _{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:o,changeFlags:e}){if(!e.dataChanged)return;const{data:t}=this.props,i=t&&"points"in t&&"polygons"in t&&"lines"in t;this.setState({binary:i}),i?this._updateStateBinary({props:o,changeFlags:e}):this._updateStateJSON({props:o,changeFlags:e})}_updateStateBinary({props:o,changeFlags:e}){const t=G(o.data,this.encodePickingColor);this.setState({layerProps:t})}_updateStateJSON({props:o,changeFlags:e}){const t=R(o.data),i=this.getSubLayerRow.bind(this);let n={};const r={};if(Array.isArray(e.dataChanged)){const l=this.state.features;for(const p in l)n[p]=l[p].slice(),r[p]=[];for(const p of e.dataChanged){const d=S(t,i,p);for(const u in l)r[u].push(T({data:n[u],getIndex:g=>g.__source.index,dataRange:p,replace:d[u]}))}}else n=S(t,i);const a=B(n,r);this.setState({features:n,featuresDiff:r,layerProps:a})}getPickingInfo(o){const e=super.getPickingInfo(o),{index:t,sourceLayer:i}=e;return e.featureType=N.find(n=>i.id.startsWith(`${this.id}-${n}-`)),t>=0&&i.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(e.index=this.props.data.points.globalFeatureIds.value[t]),e}_updateAutoHighlight(o){const e=`${this.id}-points-`,t=o.featureType==="points";for(const i of this.getSubLayers())i.id.startsWith(e)===t&&i.updateAutoHighlight(o)}_renderPolygonLayer(){const{extruded:o,wireframe:e}=this.props,{layerProps:t}=this.state,i="polygons-fill",n=this.shouldRenderSubLayer(i,t.polygons?.data)&&this.getSubLayerClass(i,L.type);if(n){const r=x(this,L.props),a=o&&e;return a||delete r.getLineColor,r.updateTriggers.lineColors=a,new n(r,this.getSubLayerProps({id:i,updateTriggers:r.updateTriggers}),t.polygons)}return null}_renderLineLayers(){const{extruded:o,stroked:e}=this.props,{layerProps:t}=this.state,i="polygons-stroke",n="linestrings",r=!o&&e&&this.shouldRenderSubLayer(i,t.polygonsOutline?.data)&&this.getSubLayerClass(i,P.type),a=this.shouldRenderSubLayer(n,t.lines?.data)&&this.getSubLayerClass(n,P.type);if(r||a){const l=x(this,P.props);return[r&&new r(l,this.getSubLayerProps({id:i,updateTriggers:l.updateTriggers}),t.polygonsOutline),a&&new a(l,this.getSubLayerProps({id:n,updateTriggers:l.updateTriggers}),t.lines)]}return null}_renderPointLayers(){const{pointType:o}=this.props,{layerProps:e,binary:t}=this.state;let{highlightedObjectIndex:i}=this.props;!t&&Number.isFinite(i)&&(i=e.points.data.findIndex(a=>a.__source.index===i));const n=new Set(o.split("+")),r=[];for(const a of n){const l=`points-${a}`,p=f[a],d=p&&this.shouldRenderSubLayer(l,e.points?.data)&&this.getSubLayerClass(l,p.type);if(d){const u=x(this,p.props);let g=e.points;if(a==="text"&&t){const{instancePickingColors:J,...I}=g.data.attributes;g={...g,data:{...g.data,attributes:I}}}r.push(new d(u,this.getSubLayerProps({id:l,updateTriggers:u.updateTriggers,highlightedObjectIndex:i}),g))}}return r}renderLayers(){const{extruded:o}=this.props,e=this._renderPolygonLayer(),t=this._renderLineLayers(),i=this._renderPointLayers();return[!o&&e,t,i,o&&e]}getSubLayerAccessor(o){const{binary:e}=this.state;return!e||typeof o!="function"?super.getSubLayerAccessor(o):(t,i)=>{const{data:n,index:r}=i,a=z(n,r);return o(a,i)}}}C.layerName="GeoJsonLayer";C.defaultProps=U;export{C as G};
