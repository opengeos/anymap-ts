import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */import{h as ie}from"./maplibre-gl-C9tqRo8a.js";import{L as ke}from"./maplibre-gl-layer-control-a0RI8_4U.js";import{D as Ge}from"./DeckLayerAdapter-kz44PQGX.js";import{ab as pe,ac as ze,g as Je,a2 as Ke,C as ge,M as Ze}from"./mapbox-overlay-CjL5nCza.js";import{C as Ye}from"./composite-layer-dQcQCi_n.js";import{B as je}from"./bitmap-layer-C70Ooru5.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./preload-helper-PPVm8Dsz.js";import"./picking-CN0D5Hbh.js";class He{fetch;loadOptions;_needsRefresh=!0;props;constructor(e){this.props={...e},this.loadOptions={...e.loadOptions},this.fetch=Qe(this.loadOptions)}setProps(e){this.props=Object.assign(this.props,e),this.setNeedsRefresh()}setNeedsRefresh(){this._needsRefresh=!0}getNeedsRefresh(e=!0){const r=this._needsRefresh;return e&&(this._needsRefresh=!1),r}}function Qe(t){const e=t?.fetch;if(e&&typeof e=="function")return(a,l)=>e(a,l);const r=t?.fetch;return r&&typeof r!="function"?a=>fetch(a,r):a=>fetch(a)}class oe extends He{static type="template";static testURL=e=>!1}function De(t){return typeof t=="string"?t.charAt(0).toLowerCase()+t.slice(1):t}function ne(t){if(Array.isArray(t))return t.map(e=>ne(e));if(t&&typeof t=="object"){const e={};for(const[r,a]of Object.entries(t))e[De(r)]=ne(a);return e}return t}var G={},z={},me;function ae(){return me||(me=1,(function(t){const e=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",r=e+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",a="["+e+"]["+r+"]*",l=new RegExp("^"+a+"$"),y=function(o,n){const s=[];let i=n.exec(o);for(;i;){const p=[];p.startIndex=n.lastIndex-i[0].length;const g=i.length;for(let E=0;E<g;E++)p.push(i[E]);s.push(p),i=n.exec(o)}return s},h=function(o){const n=l.exec(o);return!(n===null||typeof n>"u")};t.isExist=function(o){return typeof o<"u"},t.isEmptyObject=function(o){return Object.keys(o).length===0},t.merge=function(o,n,s){if(n){const i=Object.keys(n),p=i.length;for(let g=0;g<p;g++)s==="strict"?o[i[g]]=[n[i[g]]]:o[i[g]]=n[i[g]]}},t.getValue=function(o){return t.isExist(o)?o:""},t.isName=h,t.getAllMatches=y,t.nameRegexp=a})(z)),z}var ye;function Fe(){if(ye)return G;ye=1;const t=ae(),e={allowBooleanAttributes:!1,unpairedTags:[]};G.validate=function(u,d){d=Object.assign({},e,d);const S=[];let C=!1,c=!1;u[0]==="\uFEFF"&&(u=u.substr(1));for(let f=0;f<u.length;f++)if(u[f]==="<"&&u[f+1]==="?"){if(f+=2,f=a(u,f),f.err)return f}else if(u[f]==="<"){let m=f;if(f++,u[f]==="!"){f=l(u,f);continue}else{let x=!1;u[f]==="/"&&(x=!0,f++);let b="";for(;f<u.length&&u[f]!==">"&&u[f]!==" "&&u[f]!=="	"&&u[f]!==`
`&&u[f]!=="\r";f++)b+=u[f];if(b=b.trim(),b[b.length-1]==="/"&&(b=b.substring(0,b.length-1),f--),!I(b)){let T;return b.trim().length===0?T="Invalid space after '<'.":T="Tag '"+b+"' is an invalid name.",g("InvalidTag",T,v(u,f))}const w=o(u,f);if(w===!1)return g("InvalidAttr","Attributes for '"+b+"' have open quote.",v(u,f));let P=w.value;if(f=w.index,P[P.length-1]==="/"){const T=f-P.length;P=P.substring(0,P.length-1);const N=s(P,d);if(N===!0)C=!0;else return g(N.err.code,N.err.msg,v(u,T+N.err.line))}else if(x)if(w.tagClosed){if(P.trim().length>0)return g("InvalidTag","Closing tag '"+b+"' can't have attributes or invalid starting.",v(u,m));if(S.length===0)return g("InvalidTag","Closing tag '"+b+"' has not been opened.",v(u,m));{const T=S.pop();if(b!==T.tagName){let N=v(u,T.tagStartPos);return g("InvalidTag","Expected closing tag '"+T.tagName+"' (opened in line "+N.line+", col "+N.col+") instead of closing tag '"+b+"'.",v(u,m))}S.length==0&&(c=!0)}}else return g("InvalidTag","Closing tag '"+b+"' doesn't have proper closing.",v(u,f));else{const T=s(P,d);if(T!==!0)return g(T.err.code,T.err.msg,v(u,f-P.length+T.err.line));if(c===!0)return g("InvalidXml","Multiple possible root nodes found.",v(u,f));d.unpairedTags.indexOf(b)!==-1||S.push({tagName:b,tagStartPos:m}),C=!0}for(f++;f<u.length;f++)if(u[f]==="<")if(u[f+1]==="!"){f++,f=l(u,f);continue}else if(u[f+1]==="?"){if(f=a(u,++f),f.err)return f}else break;else if(u[f]==="&"){const T=p(u,f);if(T==-1)return g("InvalidChar","char '&' is not expected.",v(u,f));f=T}else if(c===!0&&!r(u[f]))return g("InvalidXml","Extra text at the end",v(u,f));u[f]==="<"&&f--}}else{if(r(u[f]))continue;return g("InvalidChar","char '"+u[f]+"' is not expected.",v(u,f))}if(C){if(S.length==1)return g("InvalidTag","Unclosed tag '"+S[0].tagName+"'.",v(u,S[0].tagStartPos));if(S.length>0)return g("InvalidXml","Invalid '"+JSON.stringify(S.map(f=>f.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return g("InvalidXml","Start tag expected.",1);return!0};function r(u){return u===" "||u==="	"||u===`
`||u==="\r"}function a(u,d){const S=d;for(;d<u.length;d++)if(u[d]=="?"||u[d]==" "){const C=u.substr(S,d-S);if(d>5&&C==="xml")return g("InvalidXml","XML declaration allowed only at the start of the document.",v(u,d));if(u[d]=="?"&&u[d+1]==">"){d++;break}else continue}return d}function l(u,d){if(u.length>d+5&&u[d+1]==="-"&&u[d+2]==="-"){for(d+=3;d<u.length;d++)if(u[d]==="-"&&u[d+1]==="-"&&u[d+2]===">"){d+=2;break}}else if(u.length>d+8&&u[d+1]==="D"&&u[d+2]==="O"&&u[d+3]==="C"&&u[d+4]==="T"&&u[d+5]==="Y"&&u[d+6]==="P"&&u[d+7]==="E"){let S=1;for(d+=8;d<u.length;d++)if(u[d]==="<")S++;else if(u[d]===">"&&(S--,S===0))break}else if(u.length>d+9&&u[d+1]==="["&&u[d+2]==="C"&&u[d+3]==="D"&&u[d+4]==="A"&&u[d+5]==="T"&&u[d+6]==="A"&&u[d+7]==="["){for(d+=8;d<u.length;d++)if(u[d]==="]"&&u[d+1]==="]"&&u[d+2]===">"){d+=2;break}}return d}const y='"',h="'";function o(u,d){let S="",C="",c=!1;for(;d<u.length;d++){if(u[d]===y||u[d]===h)C===""?C=u[d]:C!==u[d]||(C="");else if(u[d]===">"&&C===""){c=!0;break}S+=u[d]}return C!==""?!1:{value:S,index:d,tagClosed:c}}const n=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function s(u,d){const S=t.getAllMatches(u,n),C={};for(let c=0;c<S.length;c++){if(S[c][1].length===0)return g("InvalidAttr","Attribute '"+S[c][2]+"' has no space in starting.",L(S[c]));if(S[c][3]!==void 0&&S[c][4]===void 0)return g("InvalidAttr","Attribute '"+S[c][2]+"' is without value.",L(S[c]));if(S[c][3]===void 0&&!d.allowBooleanAttributes)return g("InvalidAttr","boolean attribute '"+S[c][2]+"' is not allowed.",L(S[c]));const f=S[c][2];if(!E(f))return g("InvalidAttr","Attribute '"+f+"' is an invalid name.",L(S[c]));if(!C.hasOwnProperty(f))C[f]=1;else return g("InvalidAttr","Attribute '"+f+"' is repeated.",L(S[c]))}return!0}function i(u,d){let S=/\d/;for(u[d]==="x"&&(d++,S=/[\da-fA-F]/);d<u.length;d++){if(u[d]===";")return d;if(!u[d].match(S))break}return-1}function p(u,d){if(d++,u[d]===";")return-1;if(u[d]==="#")return d++,i(u,d);let S=0;for(;d<u.length;d++,S++)if(!(u[d].match(/\w/)&&S<20)){if(u[d]===";")break;return-1}return d}function g(u,d,S){return{err:{code:u,msg:d,line:S.line||S,col:S.col}}}function E(u){return t.isName(u)}function I(u){return t.isName(u)}function v(u,d){const S=u.substring(0,d).split(/\r?\n/);return{line:S.length,col:S[S.length-1].length+1}}function L(u){return u.startIndex+u[1].length}return G}var X={},be;function et(){if(be)return X;be=1;const t={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(r,a){return a},attributeValueProcessor:function(r,a){return a},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(r,a,l){return r}},e=function(r){return Object.assign({},t,r)};return X.buildOptions=e,X.defaultOptions=t,X}var J,Ne;function tt(){if(Ne)return J;Ne=1;class t{constructor(r){this.tagname=r,this.child=[],this[":@"]={}}add(r,a){r==="__proto__"&&(r="#__proto__"),this.child.push({[r]:a})}addChild(r){r.tagname==="__proto__"&&(r.tagname="#__proto__"),r[":@"]&&Object.keys(r[":@"]).length>0?this.child.push({[r.tagname]:r.child,":@":r[":@"]}):this.child.push({[r.tagname]:r.child})}}return J=t,J}var K,we;function rt(){if(we)return K;we=1;const t=ae();function e(s,i){const p={};if(s[i+3]==="O"&&s[i+4]==="C"&&s[i+5]==="T"&&s[i+6]==="Y"&&s[i+7]==="P"&&s[i+8]==="E"){i=i+9;let g=1,E=!1,I=!1,v="";for(;i<s.length;i++)if(s[i]==="<"&&!I){if(E&&l(s,i)){i+=7;let L,u;[L,u,i]=r(s,i+1),u.indexOf("&")===-1&&(p[n(L)]={regx:RegExp(`&${L};`,"g"),val:u})}else if(E&&y(s,i))i+=8;else if(E&&h(s,i))i+=8;else if(E&&o(s,i))i+=9;else if(a)I=!0;else throw new Error("Invalid DOCTYPE");g++,v=""}else if(s[i]===">"){if(I?s[i-1]==="-"&&s[i-2]==="-"&&(I=!1,g--):g--,g===0)break}else s[i]==="["?E=!0:v+=s[i];if(g!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:p,i}}function r(s,i){let p="";for(;i<s.length&&s[i]!=="'"&&s[i]!=='"';i++)p+=s[i];if(p=p.trim(),p.indexOf(" ")!==-1)throw new Error("External entites are not supported");const g=s[i++];let E="";for(;i<s.length&&s[i]!==g;i++)E+=s[i];return[p,E,i]}function a(s,i){return s[i+1]==="!"&&s[i+2]==="-"&&s[i+3]==="-"}function l(s,i){return s[i+1]==="!"&&s[i+2]==="E"&&s[i+3]==="N"&&s[i+4]==="T"&&s[i+5]==="I"&&s[i+6]==="T"&&s[i+7]==="Y"}function y(s,i){return s[i+1]==="!"&&s[i+2]==="E"&&s[i+3]==="L"&&s[i+4]==="E"&&s[i+5]==="M"&&s[i+6]==="E"&&s[i+7]==="N"&&s[i+8]==="T"}function h(s,i){return s[i+1]==="!"&&s[i+2]==="A"&&s[i+3]==="T"&&s[i+4]==="T"&&s[i+5]==="L"&&s[i+6]==="I"&&s[i+7]==="S"&&s[i+8]==="T"}function o(s,i){return s[i+1]==="!"&&s[i+2]==="N"&&s[i+3]==="O"&&s[i+4]==="T"&&s[i+5]==="A"&&s[i+6]==="T"&&s[i+7]==="I"&&s[i+8]==="O"&&s[i+9]==="N"}function n(s){if(t.isName(s))return s;throw new Error(`Invalid entity name ${s}`)}return K=e,K}var Z,Ee;function st(){if(Ee)return Z;Ee=1;const t=/^[-+]?0x[a-fA-F0-9]+$/,e=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,r={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function a(h,o={}){if(o=Object.assign({},r,o),!h||typeof h!="string")return h;let n=h.trim();if(o.skipLike!==void 0&&o.skipLike.test(n))return h;if(h==="0")return 0;if(o.hex&&t.test(n))return y(n,16);if(n.search(/[eE]/)!==-1){const s=n.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(s){if(o.leadingZeros)n=(s[1]||"")+s[3];else if(!(s[2]==="0"&&s[3][0]==="."))return h;return o.eNotation?Number(n):h}else return h}else{const s=e.exec(n);if(s){const i=s[1],p=s[2];let g=l(s[3]);if(!o.leadingZeros&&p.length>0&&i&&n[2]!==".")return h;if(!o.leadingZeros&&p.length>0&&!i&&n[1]!==".")return h;if(o.leadingZeros&&p===h)return 0;{const E=Number(n),I=""+E;return I.search(/[eE]/)!==-1?o.eNotation?E:h:n.indexOf(".")!==-1?I==="0"&&g===""||I===g||i&&I==="-"+g?E:h:p?g===I||i+g===I?E:h:n===I||n===i+I?E:h}}else return h}}function l(h){return h&&h.indexOf(".")!==-1&&(h=h.replace(/0+$/,""),h==="."?h="0":h[0]==="."?h="0"+h:h[h.length-1]==="."&&(h=h.substr(0,h.length-1))),h}function y(h,o){if(parseInt)return parseInt(h,o);if(Number.parseInt)return Number.parseInt(h,o);if(window&&window.parseInt)return window.parseInt(h,o);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}return Z=a,Z}var Y,Se;function qe(){if(Se)return Y;Se=1;function t(e){return typeof e=="function"?e:Array.isArray(e)?r=>{for(const a of e)if(typeof a=="string"&&r===a||a instanceof RegExp&&a.test(r))return!0}:()=>!1}return Y=t,Y}var j,Te;function nt(){if(Te)return j;Te=1;const t=ae(),e=tt(),r=rt(),a=st(),l=qe();class y{constructor(f){this.options=f,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(m,x)=>String.fromCharCode(Number.parseInt(x,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(m,x)=>String.fromCharCode(Number.parseInt(x,16))}},this.addExternalEntities=h,this.parseXml=p,this.parseTextData=o,this.resolveNameSpace=n,this.buildAttributesMap=i,this.isItStopNode=v,this.replaceEntitiesValue=E,this.readStopNodeData=S,this.saveTextToParentTag=I,this.addChild=g,this.ignoreAttributesFn=l(this.options.ignoreAttributes)}}function h(c){const f=Object.keys(c);for(let m=0;m<f.length;m++){const x=f[m];this.lastEntities[x]={regex:new RegExp("&"+x+";","g"),val:c[x]}}}function o(c,f,m,x,b,w,P){if(c!==void 0&&(this.options.trimValues&&!x&&(c=c.trim()),c.length>0)){P||(c=this.replaceEntitiesValue(c));const T=this.options.tagValueProcessor(f,c,m,b,w);return T==null?c:typeof T!=typeof c||T!==c?T:this.options.trimValues?C(c,this.options.parseTagValue,this.options.numberParseOptions):c.trim()===c?C(c,this.options.parseTagValue,this.options.numberParseOptions):c}}function n(c){if(this.options.removeNSPrefix){const f=c.split(":"),m=c.charAt(0)==="/"?"/":"";if(f[0]==="xmlns")return"";f.length===2&&(c=m+f[1])}return c}const s=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function i(c,f,m){if(this.options.ignoreAttributes!==!0&&typeof c=="string"){const x=t.getAllMatches(c,s),b=x.length,w={};for(let P=0;P<b;P++){const T=this.resolveNameSpace(x[P][1]);if(this.ignoreAttributesFn(T,f))continue;let N=x[P][4],O=this.options.attributeNamePrefix+T;if(T.length)if(this.options.transformAttributeName&&(O=this.options.transformAttributeName(O)),O==="__proto__"&&(O="#__proto__"),N!==void 0){this.options.trimValues&&(N=N.trim()),N=this.replaceEntitiesValue(N);const A=this.options.attributeValueProcessor(T,N,f);A==null?w[O]=N:typeof A!=typeof N||A!==N?w[O]=A:w[O]=C(N,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(w[O]=!0)}if(!Object.keys(w).length)return;if(this.options.attributesGroupName){const P={};return P[this.options.attributesGroupName]=w,P}return w}}const p=function(c){c=c.replace(/\r\n?/g,`
`);const f=new e("!xml");let m=f,x="",b="";for(let w=0;w<c.length;w++)if(c[w]==="<")if(c[w+1]==="/"){const T=u(c,">",w,"Closing Tag is not closed.");let N=c.substring(w+2,T).trim();if(this.options.removeNSPrefix){const B=N.indexOf(":");B!==-1&&(N=N.substr(B+1))}this.options.transformTagName&&(N=this.options.transformTagName(N)),m&&(x=this.saveTextToParentTag(x,m,b));const O=b.substring(b.lastIndexOf(".")+1);if(N&&this.options.unpairedTags.indexOf(N)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${N}>`);let A=0;O&&this.options.unpairedTags.indexOf(O)!==-1?(A=b.lastIndexOf(".",b.lastIndexOf(".")-1),this.tagsNodeStack.pop()):A=b.lastIndexOf("."),b=b.substring(0,A),m=this.tagsNodeStack.pop(),x="",w=T}else if(c[w+1]==="?"){let T=d(c,w,!1,"?>");if(!T)throw new Error("Pi Tag is not closed.");if(x=this.saveTextToParentTag(x,m,b),!(this.options.ignoreDeclaration&&T.tagName==="?xml"||this.options.ignorePiTags)){const N=new e(T.tagName);N.add(this.options.textNodeName,""),T.tagName!==T.tagExp&&T.attrExpPresent&&(N[":@"]=this.buildAttributesMap(T.tagExp,b,T.tagName)),this.addChild(m,N,b)}w=T.closeIndex+1}else if(c.substr(w+1,3)==="!--"){const T=u(c,"-->",w+4,"Comment is not closed.");if(this.options.commentPropName){const N=c.substring(w+4,T-2);x=this.saveTextToParentTag(x,m,b),m.add(this.options.commentPropName,[{[this.options.textNodeName]:N}])}w=T}else if(c.substr(w+1,2)==="!D"){const T=r(c,w);this.docTypeEntities=T.entities,w=T.i}else if(c.substr(w+1,2)==="!["){const T=u(c,"]]>",w,"CDATA is not closed.")-2,N=c.substring(w+9,T);x=this.saveTextToParentTag(x,m,b);let O=this.parseTextData(N,m.tagname,b,!0,!1,!0,!0);O==null&&(O=""),this.options.cdataPropName?m.add(this.options.cdataPropName,[{[this.options.textNodeName]:N}]):m.add(this.options.textNodeName,O),w=T+2}else{let T=d(c,w,this.options.removeNSPrefix),N=T.tagName;const O=T.rawTagName;let A=T.tagExp,B=T.attrExpPresent,de=T.closeIndex;this.options.transformTagName&&(N=this.options.transformTagName(N)),m&&x&&m.tagname!=="!xml"&&(x=this.saveTextToParentTag(x,m,b,!1));const he=m;if(he&&this.options.unpairedTags.indexOf(he.tagname)!==-1&&(m=this.tagsNodeStack.pop(),b=b.substring(0,b.lastIndexOf("."))),N!==f.tagname&&(b+=b?"."+N:N),this.isItStopNode(this.options.stopNodes,b,N)){let R="";if(A.length>0&&A.lastIndexOf("/")===A.length-1)N[N.length-1]==="/"?(N=N.substr(0,N.length-1),b=b.substr(0,b.length-1),A=N):A=A.substr(0,A.length-1),w=T.closeIndex;else if(this.options.unpairedTags.indexOf(N)!==-1)w=T.closeIndex;else{const k=this.readStopNodeData(c,O,de+1);if(!k)throw new Error(`Unexpected end of ${O}`);w=k.i,R=k.tagContent}const W=new e(N);N!==A&&B&&(W[":@"]=this.buildAttributesMap(A,b,N)),R&&(R=this.parseTextData(R,N,b,!0,B,!0,!0)),b=b.substr(0,b.lastIndexOf(".")),W.add(this.options.textNodeName,R),this.addChild(m,W,b)}else{if(A.length>0&&A.lastIndexOf("/")===A.length-1){N[N.length-1]==="/"?(N=N.substr(0,N.length-1),b=b.substr(0,b.length-1),A=N):A=A.substr(0,A.length-1),this.options.transformTagName&&(N=this.options.transformTagName(N));const R=new e(N);N!==A&&B&&(R[":@"]=this.buildAttributesMap(A,b,N)),this.addChild(m,R,b),b=b.substr(0,b.lastIndexOf("."))}else{const R=new e(N);this.tagsNodeStack.push(m),N!==A&&B&&(R[":@"]=this.buildAttributesMap(A,b,N)),this.addChild(m,R,b),m=R}x="",w=de}}else x+=c[w];return f.child};function g(c,f,m){const x=this.options.updateTag(f.tagname,m,f[":@"]);x===!1||(typeof x=="string"&&(f.tagname=x),c.addChild(f))}const E=function(c){if(this.options.processEntities){for(let f in this.docTypeEntities){const m=this.docTypeEntities[f];c=c.replace(m.regx,m.val)}for(let f in this.lastEntities){const m=this.lastEntities[f];c=c.replace(m.regex,m.val)}if(this.options.htmlEntities)for(let f in this.htmlEntities){const m=this.htmlEntities[f];c=c.replace(m.regex,m.val)}c=c.replace(this.ampEntity.regex,this.ampEntity.val)}return c};function I(c,f,m,x){return c&&(x===void 0&&(x=f.child.length===0),c=this.parseTextData(c,f.tagname,m,!1,f[":@"]?Object.keys(f[":@"]).length!==0:!1,x),c!==void 0&&c!==""&&f.add(this.options.textNodeName,c),c=""),c}function v(c,f,m){const x="*."+m;for(const b in c){const w=c[b];if(x===w||f===w)return!0}return!1}function L(c,f,m=">"){let x,b="";for(let w=f;w<c.length;w++){let P=c[w];if(x)P===x&&(x="");else if(P==='"'||P==="'")x=P;else if(P===m[0])if(m[1]){if(c[w+1]===m[1])return{data:b,index:w}}else return{data:b,index:w};else P==="	"&&(P=" ");b+=P}}function u(c,f,m,x){const b=c.indexOf(f,m);if(b===-1)throw new Error(x);return b+f.length-1}function d(c,f,m,x=">"){const b=L(c,f+1,x);if(!b)return;let w=b.data;const P=b.index,T=w.search(/\s/);let N=w,O=!0;T!==-1&&(N=w.substring(0,T),w=w.substring(T+1).trimStart());const A=N;if(m){const B=N.indexOf(":");B!==-1&&(N=N.substr(B+1),O=N!==b.data.substr(B+1))}return{tagName:N,tagExp:w,closeIndex:P,attrExpPresent:O,rawTagName:A}}function S(c,f,m){const x=m;let b=1;for(;m<c.length;m++)if(c[m]==="<")if(c[m+1]==="/"){const w=u(c,">",m,`${f} is not closed`);if(c.substring(m+2,w).trim()===f&&(b--,b===0))return{tagContent:c.substring(x,m),i:w};m=w}else if(c[m+1]==="?")m=u(c,"?>",m+1,"StopNode is not closed.");else if(c.substr(m+1,3)==="!--")m=u(c,"-->",m+3,"StopNode is not closed.");else if(c.substr(m+1,2)==="![")m=u(c,"]]>",m,"StopNode is not closed.")-2;else{const w=d(c,m,">");w&&((w&&w.tagName)===f&&w.tagExp[w.tagExp.length-1]!=="/"&&b++,m=w.closeIndex)}}function C(c,f,m){if(f&&typeof c=="string"){const x=c.trim();return x==="true"?!0:x==="false"?!1:a(c,m)}else return t.isExist(c)?c:""}return j=y,j}var H={},xe;function it(){if(xe)return H;xe=1;function t(y,h){return e(y,h)}function e(y,h,o){let n;const s={};for(let i=0;i<y.length;i++){const p=y[i],g=r(p);let E="";if(o===void 0?E=g:E=o+"."+g,g===h.textNodeName)n===void 0?n=p[g]:n+=""+p[g];else{if(g===void 0)continue;if(p[g]){let I=e(p[g],h,E);const v=l(I,h);p[":@"]?a(I,p[":@"],E,h):Object.keys(I).length===1&&I[h.textNodeName]!==void 0&&!h.alwaysCreateTextNode?I=I[h.textNodeName]:Object.keys(I).length===0&&(h.alwaysCreateTextNode?I[h.textNodeName]="":I=""),s[g]!==void 0&&s.hasOwnProperty(g)?(Array.isArray(s[g])||(s[g]=[s[g]]),s[g].push(I)):h.isArray(g,E,v)?s[g]=[I]:s[g]=I}}}return typeof n=="string"?n.length>0&&(s[h.textNodeName]=n):n!==void 0&&(s[h.textNodeName]=n),s}function r(y){const h=Object.keys(y);for(let o=0;o<h.length;o++){const n=h[o];if(n!==":@")return n}}function a(y,h,o,n){if(h){const s=Object.keys(h),i=s.length;for(let p=0;p<i;p++){const g=s[p];n.isArray(g,o+"."+g,!0,!0)?y[g]=[h[g]]:y[g]=h[g]}}}function l(y,h){const{textNodeName:o}=h,n=Object.keys(y).length;return!!(n===0||n===1&&(y[o]||typeof y[o]=="boolean"||y[o]===0))}return H.prettify=t,H}var Q,ve;function ot(){if(ve)return Q;ve=1;const{buildOptions:t}=et(),e=nt(),{prettify:r}=it(),a=Fe();class l{constructor(h){this.externalEntities={},this.options=t(h)}parse(h,o){if(typeof h!="string")if(h.toString)h=h.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(o){o===!0&&(o={});const i=a.validate(h,o);if(i!==!0)throw Error(`${i.err.msg}:${i.err.line}:${i.err.col}`)}const n=new e(this.options);n.addExternalEntities(this.externalEntities);const s=n.parseXml(h);return this.options.preserveOrder||s===void 0?s:r(s,this.options)}addEntity(h,o){if(o.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(h.indexOf("&")!==-1||h.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(o==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[h]=o}}return Q=l,Q}var D,Ie;function at(){if(Ie)return D;Ie=1;const t=`
`;function e(o,n){let s="";return n.format&&n.indentBy.length>0&&(s=t),r(o,n,"",s)}function r(o,n,s,i){let p="",g=!1;for(let E=0;E<o.length;E++){const I=o[E],v=a(I);if(v===void 0)continue;let L="";if(s.length===0?L=v:L=`${s}.${v}`,v===n.textNodeName){let c=I[v];y(L,n)||(c=n.tagValueProcessor(v,c),c=h(c,n)),g&&(p+=i),p+=c,g=!1;continue}else if(v===n.cdataPropName){g&&(p+=i),p+=`<![CDATA[${I[v][0][n.textNodeName]}]]>`,g=!1;continue}else if(v===n.commentPropName){p+=i+`<!--${I[v][0][n.textNodeName]}-->`,g=!0;continue}else if(v[0]==="?"){const c=l(I[":@"],n),f=v==="?xml"?"":i;let m=I[v][0][n.textNodeName];m=m.length!==0?" "+m:"",p+=f+`<${v}${m}${c}?>`,g=!0;continue}let u=i;u!==""&&(u+=n.indentBy);const d=l(I[":@"],n),S=i+`<${v}${d}`,C=r(I[v],n,L,u);n.unpairedTags.indexOf(v)!==-1?n.suppressUnpairedNode?p+=S+">":p+=S+"/>":(!C||C.length===0)&&n.suppressEmptyNode?p+=S+"/>":C&&C.endsWith(">")?p+=S+`>${C}${i}</${v}>`:(p+=S+">",C&&i!==""&&(C.includes("/>")||C.includes("</"))?p+=i+n.indentBy+C+i:p+=C,p+=`</${v}>`),g=!0}return p}function a(o){const n=Object.keys(o);for(let s=0;s<n.length;s++){const i=n[s];if(o.hasOwnProperty(i)&&i!==":@")return i}}function l(o,n){let s="";if(o&&!n.ignoreAttributes)for(let i in o){if(!o.hasOwnProperty(i))continue;let p=n.attributeValueProcessor(i,o[i]);p=h(p,n),p===!0&&n.suppressBooleanAttributes?s+=` ${i.substr(n.attributeNamePrefix.length)}`:s+=` ${i.substr(n.attributeNamePrefix.length)}="${p}"`}return s}function y(o,n){o=o.substr(0,o.length-n.textNodeName.length-1);let s=o.substr(o.lastIndexOf(".")+1);for(let i in n.stopNodes)if(n.stopNodes[i]===o||n.stopNodes[i]==="*."+s)return!0;return!1}function h(o,n){if(o&&o.length>0&&n.processEntities)for(let s=0;s<n.entities.length;s++){const i=n.entities[s];o=o.replace(i.regex,i.val)}return o}return D=e,D}var ee,Pe;function ut(){if(Pe)return ee;Pe=1;const t=at(),e=qe(),r={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(o,n){return n},attributeValueProcessor:function(o,n){return n},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function a(o){this.options=Object.assign({},r,o),this.options.ignoreAttributes===!0||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=e(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=h),this.processTextOrObjNode=l,this.options.format?(this.indentate=y,this.tagEndChar=`>
`,this.newLine=`
`):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}a.prototype.build=function(o){return this.options.preserveOrder?t(o,this.options):(Array.isArray(o)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(o={[this.options.arrayNodeName]:o}),this.j2x(o,0,[]).val)},a.prototype.j2x=function(o,n,s){let i="",p="";const g=s.join(".");for(let E in o)if(Object.prototype.hasOwnProperty.call(o,E))if(typeof o[E]>"u")this.isAttribute(E)&&(p+="");else if(o[E]===null)this.isAttribute(E)||E===this.options.cdataPropName?p+="":E[0]==="?"?p+=this.indentate(n)+"<"+E+"?"+this.tagEndChar:p+=this.indentate(n)+"<"+E+"/"+this.tagEndChar;else if(o[E]instanceof Date)p+=this.buildTextValNode(o[E],E,"",n);else if(typeof o[E]!="object"){const I=this.isAttribute(E);if(I&&!this.ignoreAttributesFn(I,g))i+=this.buildAttrPairStr(I,""+o[E]);else if(!I)if(E===this.options.textNodeName){let v=this.options.tagValueProcessor(E,""+o[E]);p+=this.replaceEntitiesValue(v)}else p+=this.buildTextValNode(o[E],E,"",n)}else if(Array.isArray(o[E])){const I=o[E].length;let v="",L="";for(let u=0;u<I;u++){const d=o[E][u];if(!(typeof d>"u"))if(d===null)E[0]==="?"?p+=this.indentate(n)+"<"+E+"?"+this.tagEndChar:p+=this.indentate(n)+"<"+E+"/"+this.tagEndChar;else if(typeof d=="object")if(this.options.oneListGroup){const S=this.j2x(d,n+1,s.concat(E));v+=S.val,this.options.attributesGroupName&&d.hasOwnProperty(this.options.attributesGroupName)&&(L+=S.attrStr)}else v+=this.processTextOrObjNode(d,E,n,s);else if(this.options.oneListGroup){let S=this.options.tagValueProcessor(E,d);S=this.replaceEntitiesValue(S),v+=S}else v+=this.buildTextValNode(d,E,"",n)}this.options.oneListGroup&&(v=this.buildObjectNode(v,E,L,n)),p+=v}else if(this.options.attributesGroupName&&E===this.options.attributesGroupName){const I=Object.keys(o[E]),v=I.length;for(let L=0;L<v;L++)i+=this.buildAttrPairStr(I[L],""+o[E][I[L]])}else p+=this.processTextOrObjNode(o[E],E,n,s);return{attrStr:i,val:p}},a.prototype.buildAttrPairStr=function(o,n){return n=this.options.attributeValueProcessor(o,""+n),n=this.replaceEntitiesValue(n),this.options.suppressBooleanAttributes&&n==="true"?" "+o:" "+o+'="'+n+'"'};function l(o,n,s,i){const p=this.j2x(o,s+1,i.concat(n));return o[this.options.textNodeName]!==void 0&&Object.keys(o).length===1?this.buildTextValNode(o[this.options.textNodeName],n,p.attrStr,s):this.buildObjectNode(p.val,n,p.attrStr,s)}a.prototype.buildObjectNode=function(o,n,s,i){if(o==="")return n[0]==="?"?this.indentate(i)+"<"+n+s+"?"+this.tagEndChar:this.indentate(i)+"<"+n+s+this.closeTag(n)+this.tagEndChar;{let p="</"+n+this.tagEndChar,g="";return n[0]==="?"&&(g="?",p=""),(s||s==="")&&o.indexOf("<")===-1?this.indentate(i)+"<"+n+s+g+">"+o+p:this.options.commentPropName!==!1&&n===this.options.commentPropName&&g.length===0?this.indentate(i)+`<!--${o}-->`+this.newLine:this.indentate(i)+"<"+n+s+g+this.tagEndChar+o+this.indentate(i)+p}},a.prototype.closeTag=function(o){let n="";return this.options.unpairedTags.indexOf(o)!==-1?this.options.suppressUnpairedNode||(n="/"):this.options.suppressEmptyNode?n="/":n=`></${o}`,n},a.prototype.buildTextValNode=function(o,n,s,i){if(this.options.cdataPropName!==!1&&n===this.options.cdataPropName)return this.indentate(i)+`<![CDATA[${o}]]>`+this.newLine;if(this.options.commentPropName!==!1&&n===this.options.commentPropName)return this.indentate(i)+`<!--${o}-->`+this.newLine;if(n[0]==="?")return this.indentate(i)+"<"+n+s+"?"+this.tagEndChar;{let p=this.options.tagValueProcessor(n,o);return p=this.replaceEntitiesValue(p),p===""?this.indentate(i)+"<"+n+s+this.closeTag(n)+this.tagEndChar:this.indentate(i)+"<"+n+s+">"+p+"</"+n+this.tagEndChar}},a.prototype.replaceEntitiesValue=function(o){if(o&&o.length>0&&this.options.processEntities)for(let n=0;n<this.options.entities.length;n++){const s=this.options.entities[n];o=o.replace(s.regex,s.val)}return o};function y(o){return this.options.indentBy.repeat(o)}function h(o){return o.startsWith(this.options.attributeNamePrefix)&&o!==this.options.textNodeName?o.substr(this.attrPrefixLen):!1}return ee=a,ee}var te,Ae;function ct(){if(Ae)return te;Ae=1;const t=Fe(),e=ot(),r=ut();return te={XMLParser:e,XMLValidator:t,XMLBuilder:r},te}var ft=ct();function Ce(t,e){if(e?._parser&&e._parser!=="fast-xml-parser")throw new Error(e?._parser);const r={allowBooleanAttributes:!0,ignoreDeclaration:!0,removeNSPrefix:e?.removeNSPrefix,textNodeName:e?.textNodeName,isArray:(l,y,h,o)=>!!e?.arrayPaths?.some(s=>y===s),...e?._fastXML},a=lt(t,r);return e?.uncapitalizeKeys?ne(a):a}function lt(t,e){return new ft.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"",...e}).parse(t)}const dt="4.3.3",F={dataType:null,batchType:null,name:"XML",id:"xml",module:"xml",version:dt,worker:!1,extensions:["xml"],mimeTypes:["application/xml","text/xml"],testText:ht,options:{xml:{_parser:"fast-xml-parser",uncapitalizeKeys:!1,removeNSPrefix:!1,textNodeName:"value",arrayPaths:[]}},parse:async(t,e)=>Ce(new TextDecoder().decode(t),{...F.options.xml,...e?.xml}),parseTextSync:(t,e)=>Ce(t,{...F.options.xml,...e?.xml})};function ht(t){return t.startsWith("<?xml")}function pt(t,e){const r=F.parseTextSync?.(t,e),a=r?.ServiceExceptionReport?.ServiceException||r?.["ogc:ServiceExceptionReport"]?.["ogc:ServiceException"];return typeof a=="string"?a:a.value||a.code||"Unknown error"}const gt="4.3.3",V={dataType:null,batchType:null,id:"wms-error",name:"WMS Error",module:"wms",version:gt,worker:!1,extensions:["xml"],mimeTypes:["application/vnd.ogc.se_xml","application/xml","text/xml"],testText:mt,options:{wms:{throwOnError:!1}},parse:async(t,e)=>re(new TextDecoder().decode(t),e),parseSync:(t,e)=>re(new TextDecoder().decode(t),e),parseTextSync:(t,e)=>re(t,e)};function mt(t){return t.startsWith("<?xml")}function re(t,e){const r={...V.options.wms,...e?.wms},a=pt(t,r),l=r.minimalErrors?a:`WMS Service error: ${a}`;if(r.throwOnError)throw new Error(l);return l}function q(t){return Array.isArray(t)?t:t?[t]:[]}function $(t){const e=q(t);return e.length>0&&e.every(r=>typeof r=="string")?e:[]}function U(t,e=void 0){switch(typeof t){case"number":return t;case"string":return parseFloat(t);default:return}}function se(t,e=void 0){switch(typeof t){case"number":return t;case"string":return parseInt(t,10);default:return}}function M(t){switch(t){case"true":return!0;case"false":return!1;case"1":return!0;case"0":return!1;default:return!1}}function Le(t,e){const r=F.parseTextSync?.(t,e),a=r.WMT_MS_Capabilities||r.WMS_Capabilities||r,l=yt(a);if(e?.inheritedLayerProps)for(const y of l.layers)Ue(y,null);return e?.includeRawJSON&&(l.json=a),e?.includeXMLText&&(l.xml=t),l}function yt(t){const e={version:String(t.version||""),name:String(t.Service?.Name||"unnamed"),title:t.Service?.Title?String(t.Service?.Title):void 0,abstract:t.Service?.Abstract?String(t.Service?.Abstract):void 0,keywords:$(t.Service?.KeywordList?.Keyword),fees:t.Service?.Fees?JSON.stringify(t.Service?.Fees):void 0,accessConstraints:t.Service?.AccessConstraints?JSON.stringify(t.Service?.AccessConstraints):void 0,layerLimit:se(t.Service?.LayerLimit),maxWidth:se(t.Service?.maxWidth),maxHeight:se(t.Service?.maxHeight),layers:[],requests:bt(t.Capability?.Request),exceptions:Nt(t.Exception)},r=q(t.Capability?.Layer);for(const a of r)e.layers.push(Xe(a));for(const[a,l]of Object.entries(e))l===void 0&&delete e[a];return e}function bt(t){const e={};for(const[r,a]of Object.entries(t||{})){const l=$(a?.Format);e[r]={mimeTypes:l}}return e}function Nt(t){if(q(t?.Format).length>0)return{mimeTypes:$(t)}}function Xe(t){const e={title:String(t?.Title||""),name:t?.Name&&String(t?.Name),abstract:t?.Name&&String(t?.Abstract),keywords:$(t.KeywordList?.Keyword)},r=t?.CRS||t?.SRS;r&&Array.isArray(r)&&r.every(s=>typeof s=="string")&&(e.crs=r);let a=t?.EX_GeographicBoundingBox&&wt(t?.EX_GeographicBoundingBox);a&&(e.geographicBoundingBox=a),a=t?.LatLonBoundingBox&&Et(t?.LatLonBoundingBox),a&&(e.geographicBoundingBox=a);const l=t?.BoundingBox&&St(t?.BoundingBox);l&&l.length>0&&(e.boundingBoxes=l);const h=q(t?.Dimension).map(s=>xt(s));h.length&&(e.dimensions=h),t?.opaque&&(e.opaque=M(t?.opaque)),t?.cascaded&&(e.cascaded=M(t?.cascaded)),t?.queryable&&(e.queryable=M(t?.queryable));const o=q(t?.Layer),n=[];for(const s of o)n.push(Xe(s));n.length>0&&(e.layers=n);for(const[s,i]of Object.entries(e))i===void 0&&delete e[s];return e}function wt(t){const{westBoundLongitude:e,northBoundLatitude:r,eastBoundLongitude:a,southBoundLatitude:l}=t;return[[e,l],[a,r]]}function Et(t){const{minx:e,miny:r,maxx:a,maxy:l}=t;return[[e,r],[a,l]]}function St(t){return q(t).map(r=>Tt(r))}function Tt(t){const{CRS:e,SRS:r,minx:a,miny:l,maxx:y,maxy:h,resx:o,resy:n}=t,s={crs:e||r,boundingBox:[[U(a),U(l)],[U(y),U(h)]]};return o&&(s.xResolution=o),n&&(s.yResolution=n),s}function xt(t){const{name:e,units:r,value:a}=t,l={name:e,units:r,extent:a};return t.unitSymbol&&(l.unitSymbol=t.unitSymbol),t.default&&(l.defaultValue=t.default),t.multipleValues&&(l.multipleValues=M(t.multipleValues)),t.nearestValue&&(l.nearestValue=M(t.nearestValue)),t.current&&(l.current=M(t.current)),l}function Ue(t,e){e?.geographicBoundingBox&&!t.geographicBoundingBox&&(t.geographicBoundingBox=[...e.geographicBoundingBox]),e?.crs&&!t.crs&&(t.crs=[...e.crs]),e?.boundingBoxes&&!t.boundingBoxes&&(t.boundingBoxes=[...e.boundingBoxes]),e?.dimensions&&!t.dimensions&&(t.dimensions=[...e.dimensions]);for(const r of t.layers||[])Ue(r,t)}const vt="4.3.3",ue={dataType:null,batchType:null,id:"wms-capabilities",name:"WMS Capabilities",module:"wms",version:vt,worker:!1,extensions:["xml"],mimeTypes:["application/vnd.ogc.wms_xml","application/xml","text/xml"],testText:It,options:{wms:{}},parse:async(t,e)=>Le(new TextDecoder().decode(t),e?.wms),parseTextSync:(t,e)=>Le(t,e?.wms)};function It(t){return t.startsWith("<?xml")}function Oe(t,e){const a=(F.parseTextSync?.(t,e)).FeatureInfoResponse?.FIELDS||[];return{features:(Array.isArray(a)?a:[a]).map(y=>Pt(y))}}function Pt(t){return{attributes:t||{},type:"",bounds:{bottom:0,top:0,left:0,right:0}}}const At={...ue,dataType:null,id:"wms-feature-info",name:"WMS FeatureInfo",parse:async(t,e)=>Oe(new TextDecoder().decode(t),e),parseTextSync:(t,e)=>Oe(t,e)};function Re(t,e){return F.parseTextSync?.(t,e)}const Ct={...ue,dataType:null,id:"wms-layer-description",name:"WMS DescribeLayer",parse:async(t,e)=>Re(new TextDecoder().decode(t),e),parseTextSync:(t,e)=>Re(t,e)},Lt={name:"Web Map Service (OGC WMS)",id:"wms",module:"wms",version:"0.0.0",extensions:[],mimeTypes:[],options:{wms:{}},type:"wms",fromUrl:!0,fromBlob:!1,testURL:t=>t.toLowerCase().includes("wms"),createDataSource:(t,e)=>new Ot(t,e)};class Ot extends oe{url;data;substituteCRS84;flipCRS;wmsParameters;vendorParameters;capabilities=null;constructor(e,r){super(r),this.url=e,this.data=e,this.substituteCRS84=r.wms?.substituteCRS84??r.substituteCRS84??!1,this.flipCRS=["EPSG:4326"],this.wmsParameters={layers:void 0,query_layers:void 0,styles:void 0,version:"1.3.0",crs:"EPSG:4326",format:"image/png",info_format:"text/plain",transparent:void 0,time:void 0,elevation:void 0,...r.wmsParameters,...r.wms?.wmsParameters},this.vendorParameters=r.wms?.vendorParameters||r.vendorParameters||{}}async getMetadata(){const e=await this.getCapabilities();return this.normalizeMetadata(e)}async getImage(e){const{boundingBox:r,bbox:a,...l}=e,y={bbox:r?[...r[0],...r[1]]:a,...l};return await this.getMap(y)}normalizeMetadata(e){return e}async getCapabilities(e,r){const a=this.getCapabilitiesURL(e,r),l=await this.fetch(a),y=await l.arrayBuffer();this._checkResponse(l,y);const h=await ue.parse(y,this.loadOptions);return this.capabilities=h,h}async getMap(e,r){const a=this.getMapURL(e,r),l=await this.fetch(a),y=await l.arrayBuffer();this._checkResponse(l,y);try{return await pe.parse(y,this.loadOptions)}catch{throw this._parseError(y)}}async getFeatureInfo(e,r){const a=this.getFeatureInfoURL(e,r),l=await this.fetch(a),y=await l.arrayBuffer();return this._checkResponse(l,y),await At.parse(y,this.loadOptions)}async getFeatureInfoText(e,r){const a=this.getFeatureInfoURL(e,r),l=await this.fetch(a),y=await l.arrayBuffer();return this._checkResponse(l,y),new TextDecoder().decode(y)}async describeLayer(e,r){const a=this.describeLayerURL(e,r),l=await this.fetch(a),y=await l.arrayBuffer();return this._checkResponse(l,y),await Ct.parse(y,this.loadOptions)}async getLegendGraphic(e,r){const a=this.getLegendGraphicURL(e,r),l=await this.fetch(a),y=await l.arrayBuffer();this._checkResponse(l,y);try{return await pe.parse(y,this.loadOptions)}catch{throw this._parseError(y)}}getCapabilitiesURL(e,r){const a={version:this.wmsParameters.version,...e};return this._getWMSUrl("GetCapabilities",a,r)}getMapURL(e,r){e=this._getWMS130Parameters(e);const a={version:this.wmsParameters.version,format:this.wmsParameters.format,transparent:this.wmsParameters.transparent,time:this.wmsParameters.time,elevation:this.wmsParameters.elevation,layers:this.wmsParameters.layers,styles:this.wmsParameters.styles,crs:this.wmsParameters.crs,...e};return this._getWMSUrl("GetMap",a,r)}getFeatureInfoURL(e,r){e=this._getWMS130Parameters(e);const{boundingBox:a,bbox:l}=e;e.bbox=a?[...a[0],...a[1]]:l;const y={version:this.wmsParameters.version,info_format:this.wmsParameters.info_format,layers:this.wmsParameters.layers,query_layers:this.wmsParameters.query_layers,styles:this.wmsParameters.styles,crs:this.wmsParameters.crs,...e};return this._getWMSUrl("GetFeatureInfo",y,r)}describeLayerURL(e,r){const a={version:this.wmsParameters.version,...e};return this._getWMSUrl("DescribeLayer",a,r)}getLegendGraphicURL(e,r){const a={version:this.wmsParameters.version,...e};return this._getWMSUrl("GetLegendGraphic",a,r)}_parseWMSUrl(e){const[r,a]=e.split("?"),l=a.split("&"),y={};for(const h of l){const[o,n]=h.split("=");y[o]=n}return{url:r,parameters:y}}_getWMSUrl(e,r,a){let l=this.url,y=!0;const h={service:"WMS",version:r.version,request:e,...r,...this.vendorParameters,...a},o=["transparent","time","elevation"];for(const[n,s]of Object.entries(h))(!o.includes(n)||s)&&(l+=y?"?":"&",y=!1,l+=this._getURLParameter(n,s,r));return encodeURI(l)}_getWMS130Parameters(e){const r={...e};return r.srs&&(r.crs=r.crs||r.srs,delete r.srs),r}_getURLParameter(e,r,a){switch(e){case"crs":a.version!=="1.3.0"?e="srs":this.substituteCRS84&&r==="EPSG:4326"&&(r="CRS:84");break;case"srs":a.version==="1.3.0"&&(e="crs");break;case"bbox":const l=this._flipBoundingBox(r,a);l&&(r=l);break;case"x":a.version==="1.3.0"&&(e="i");break;case"y":a.version==="1.3.0"&&(e="j");break}return e=e.toUpperCase(),Array.isArray(r)?`${e}=${r.join(",")}`:`${e}=${r?String(r):""}`}_flipBoundingBox(e,r){if(!Array.isArray(e)||e.length!==4)return null;const a=r.version==="1.3.0"&&this.flipCRS.includes(r.crs||"")&&!(this.substituteCRS84&&r.crs==="EPSG:4326"),l=e;return a?[l[1],l[0],l[3],l[2]]:l}async _fetchArrayBuffer(e){const r=await this.fetch(e),a=await r.arrayBuffer();return this._checkResponse(r,a),a}_checkResponse(e,r){const a=e.headers["content-type"];if(!e.ok||V.mimeTypes.includes(a)){const l=ze(this.loadOptions,{wms:{throwOnError:!0}}),y=V.parseSync?.(r,l);throw new Error(y)}}_parseError(e){const r=V.parseSync?.(e,this.loadOptions);return new Error(r)}}const Rt={name:"ArcGISImageServer",id:"arcgis-image-server",module:"wms",version:"0.0.0",extensions:[],mimeTypes:[],options:{"arcgis-image-server":{}},type:"arcgis-image-server",fromUrl:!0,fromBlob:!1,testURL:t=>t.toLowerCase().includes("ImageServer"),createDataSource:(t,e)=>new Bt(t,e)};class Bt extends oe{url;data;constructor(e,r){super(r),this.url=e,this.data=e}async getMetadata(){return await this.metadata()}async getImage(e){throw new Error("not implemented")}async metadata(){throw new Error("not implemented")}exportImage(e){throw new Error("not implemented")}metadataURL(e){return`${this.url}?f=pjson`}exportImageURL(e){const r=`bbox=${e.bbox[0]},${e.bbox[1]},${e.bbox[2]},${e.bbox[3]}`,a=`size=${e.width},${e.height}`,l={...e,bbox:r,size:a};return delete l.width,delete l.height,this.getUrl("exportImage",l)}getUrl(e,r,a){let l=`${this.url}/${e}`,y=!0;for(const[h,o]of Object.entries(r))l+=y?"?":"&",y=!1,Array.isArray(o)?l+=`${h.toUpperCase()}=${o.join(",")}`:l+=`${h.toUpperCase()}=${o?String(o):""}`;return l}async checkResponse(e){if(!e.ok)throw new Error("error")}}const Mt=[Lt,Rt];function _t(t,e=Mt){const{type:r="auto"}=t,a=r==="auto"?qt(t.url,e):Ft(r,e);if(!a)throw new Error("Not a valid image source type");return a.createDataSource(t.url,t)}function Ft(t,e){for(const r of e)if(r.type===t)return r;return null}function qt(t,e){for(const r of e)if(r.testURL&&r.testURL(t))return r;return null}const Be=6378137*Math.PI;function Me(t){const e=Je(t);return e[0]=(e[0]/256-1)*Be,e[1]=(e[1]/256-1)*Be,e}const Xt={id:"imagery-layer",data:"",serviceType:"auto",srs:"auto",layers:{type:"array",compare:!0,value:[]},onMetadataLoad:{type:"function",value:()=>{}},onMetadataLoadError:{type:"function",value:console.error},onImageLoadStart:{type:"function",value:()=>{}},onImageLoad:{type:"function",value:()=>{}},onImageLoadError:{type:"function",compare:!1,value:(t,e)=>console.error(e,t)}};class ce extends Ye{get isLoaded(){return this.state?.loadCounter===0&&super.isLoaded}shouldUpdateState(){return!0}initializeState(){this.state._nextRequestId=0,this.state.lastRequestId=-1,this.state.loadCounter=0}updateState({changeFlags:e,props:r,oldProps:a}){const{viewport:l}=this.context;e.dataChanged||r.serviceType!==a.serviceType?(this.state.imageSource=this._createImageSource(r),this._loadMetadata(),this.debounce(()=>this.loadImage(l,"image source changed"),0)):Ke(r.layers,a.layers,1)?e.viewportChanged&&this.debounce(()=>this.loadImage(l,"viewport changed")):this.debounce(()=>this.loadImage(l,"layers changed"),0)}finalizeState(){}renderLayers(){const{bounds:e,image:r,lastRequestParameters:a}=this.state;return r&&new je({...this.getSubLayerProps({id:"bitmap"}),_imageCoordinateSystem:a.srs==="EPSG:4326"?ge.LNGLAT:ge.CARTESIAN,bounds:e,image:r})}async getFeatureInfoText(e,r){const{lastRequestParameters:a}=this.state;return a?await this.state.imageSource.getFeatureInfoText?.({...a,query_layers:a.layers,x:e,y:r,info_format:"application/vnd.ogc.gml"}):""}_createImageSource(e){if(e.data instanceof oe)return e.data;if(typeof e.data=="string")return _t({url:e.data,loadOptions:e.loadOptions,type:e.serviceType});throw new Error("invalid image source in props.data")}async _loadMetadata(){const{imageSource:e}=this.state;try{this.state.loadCounter++;const r=await e.getMetadata();this.state.imageSource===e&&this.getCurrentLayer()?.props.onMetadataLoad(r)}catch(r){this.getCurrentLayer()?.props.onMetadataLoadError(r)}finally{this.state.loadCounter--}}async loadImage(e,r){const{layers:a,serviceType:l}=this.props;if(l==="wms"&&a.length===0)return;const y=e.getBounds(),{width:h,height:o}=e,n=this.getRequestId();let{srs:s}=this.props;s==="auto"&&(s=e.resolution?"EPSG:4326":"EPSG:3857");const i={width:h,height:o,boundingBox:[[y[0],y[1]],[y[2],y[3]]],layers:a,crs:s};if(s==="EPSG:3857"){const p=Me([y[0],y[1]]),g=Me([y[2],y[3]]);i.boundingBox=[p,g]}try{this.state.loadCounter++,this.props.onImageLoadStart(n);const p=await this.state.imageSource.getImage(i);this.state.lastRequestId<n&&(this.getCurrentLayer()?.props.onImageLoad(n),this.setState({image:p,bounds:y,lastRequestParameters:i,lastRequestId:n}))}catch(p){this.raiseError(p,"Load image"),this.getCurrentLayer()?.props.onImageLoadError(n,p)}finally{this.state.loadCounter--}}getRequestId(){return this.state._nextRequestId++}debounce(e,r=500){clearTimeout(this.state._timeoutId),this.state._timeoutId=setTimeout(()=>e(),r)}}ce.layerName="WMSLayer";ce.defaultProps=Xt;const _=new ie.Map({container:"map",style:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",center:[-95,40],zoom:4});_.addControl(new ie.NavigationControl,"top-right");_.addControl(new ie.ScaleControl({unit:"metric"}),"bottom-right");const fe=new Ze({layers:[]}),le=new Map,Ve=new Ge(_,fe,le);let $e=.8;function Ut(){fe.setProps({layers:Array.from(le.values())})}function We(){const t="wms-layer",e=new ce({id:t,data:"https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi",serviceType:"wms",layers:["nexrad-n0r"],opacity:$e});le.set(t,e),Ut(),Ve.notifyLayerAdded(t)}const _e=document.getElementById("opacity"),Vt=document.getElementById("opacityValue");_e?.addEventListener("input",()=>{const t=parseInt(_e.value,10);Vt.textContent=`${t}%`,$e=t/100,We()});_.on("load",()=>{_.addControl(fe);const t=new ke({collapsed:!0,customLayerAdapters:[Ve],panelWidth:360});_.addControl(t,"top-right"),We()});
