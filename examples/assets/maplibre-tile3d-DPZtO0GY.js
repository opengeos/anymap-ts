import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */import{h as ce}from"./maplibre-gl-C9tqRo8a.js";import{L as Qs}from"./maplibre-gl-layer-control-CbPNLzzp.js";import{D as Js}from"./DeckLayerAdapter-CEH0-YJh.js";import{ad as Ks,V as tn,i as en,h as vt,j as At,ae as sn,af as nn,q as rn,ag as on,ah as an,e as cn,ai as ln,aj as hn,a4 as d,a6 as dt,a0 as te,D as un,ak as dn,$ as I,al as L,am as $,Y as Et,an as us,a3 as fn,ao as pn,ap as gn,aq as mn,d as Tn,C as zt,M as yn}from"./mapbox-overlay-B3MFwkdI.js";import{S as _n}from"./simple-mesh-layer-DkNMeaDt.js";import{p as wn,a as Sn,b as le,D as En,G as ds,c as fs,g as ps,S as bn}from"./scenegraph-layer-C37vlRUd.js";import{C as Cn}from"./composite-layer-CqqfW37O.js";import{E as In,a as An,b as Ln,C as Ot,P as lt,O as gs,B as ms,R as Mn,m as Nn}from"./bounding-box-from-points-DEyWGT0V.js";import{Q as Ts,M as ys}from"./quaternion-Cnun7cGp.js";import{P as Rn}from"./point-cloud-layer-DrQQqH02.js";import{G as Pn}from"./geometry-BcGx-jYG.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./preload-helper-PPVm8Dsz.js";import"./matrix-CjxQ2B22.js";import"./picking-CN0D5Hbh.js";import"./phong-material-B3sVKYdZ.js";import"./lighting-DGLKbg-X.js";import"./phong-shaders-wgsl-3FV41e28.js";import"./color-CUNNsFV-.js";import"./gouraud-material-DQO3ZmEl.js";globalThis.probe={};const _s=new Ks({id:"@probe.gl/log"});class he extends tn{constructor(t=0,e=0){super(2),en(t)&&arguments.length===1?this.copy(t):(vt.debug&&(At(t),At(e)),this[0]=t,this[1]=e)}set(t,e){return this[0]=t,this[1]=e,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this.check()}fromObject(t){return vt.debug&&(At(t.x),At(t.y)),this[0]=t.x,this[1]=t.y,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return sn(this,this,t),this.check()}transformAsVector(t){return nn(this,this,t),this.check()}transformByMatrix3(t){return rn(this,this,t),this.check()}transformByMatrix2x3(t){return on(this,this,t),this.check()}transformByMatrix2(t){return an(this,this,t),this.check()}}const be=`uniform meshUniforms {
  bool pickFeatureIds;
} mesh;
`,On={name:"mesh",vs:be,fs:be,uniformTypes:{pickFeatureIds:"f32"}},Un=`#version 300 es
#define SHADER_NAME simple-mesh-layer-vs
in vec3 positions;
in vec3 normals;
in vec3 colors;
in vec2 texCoords;
in vec4 uvRegions;
in vec3 featureIdsPickingColors;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec3 instanceModelMatrixCol0;
in vec3 instanceModelMatrixCol1;
in vec3 instanceModelMatrixCol2;
out vec2 vTexCoord;
out vec3 cameraPosition;
out vec3 normals_commonspace;
out vec4 position_commonspace;
out vec4 vColor;
vec2 applyUVRegion(vec2 uv) {
#ifdef HAS_UV_REGIONS
return fract(uv) * (uvRegions.zw - uvRegions.xy) + uvRegions.xy;
#else
return uv;
#endif
}
void main(void) {
vec2 uv = applyUVRegion(texCoords);
geometry.uv = uv;
if (mesh.pickFeatureIds) {
geometry.pickingColor = featureIdsPickingColors;
} else {
geometry.pickingColor = instancePickingColors;
}
mat3 instanceModelMatrix = mat3(instanceModelMatrixCol0, instanceModelMatrixCol1, instanceModelMatrixCol2);
vTexCoord = uv;
cameraPosition = project.cameraPosition;
vColor = vec4(colors * instanceColors.rgb, instanceColors.a);
vec3 pos = (instanceModelMatrix * positions) * simpleMesh.sizeScale;
vec3 projectedPosition = project_position(positions);
position_commonspace = vec4(projectedPosition, 1.0);
gl_Position = project_common_position_to_clipspace(position_commonspace);
geometry.position = position_commonspace;
normals_commonspace = project_normal(instanceModelMatrix * normals);
geometry.normal = normals_commonspace;
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
#ifdef MODULE_PBRMATERIAL
pbr_vPosition = geometry.position.xyz;
#ifdef HAS_NORMALS
pbr_vNormal = geometry.normal;
#endif
#ifdef HAS_UV
pbr_vUV = uv;
#else
pbr_vUV = vec2(0., 0.);
#endif
geometry.uv = pbr_vUV;
#endif
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Dn=`#version 300 es
#define SHADER_NAME simple-mesh-layer-fs
precision highp float;
uniform sampler2D sampler;
in vec2 vTexCoord;
in vec3 cameraPosition;
in vec3 normals_commonspace;
in vec4 position_commonspace;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
#ifdef MODULE_PBRMATERIAL
fragColor = vColor * pbr_filterColor(vec4(0));
geometry.uv = pbr_vUV;
fragColor.a *= layer.opacity;
#else
geometry.uv = vTexCoord;
vec3 normal;
if (simpleMesh.flatShading) {
normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));
} else {
normal = normals_commonspace;
}
vec4 color = simpleMesh.hasTexture ? texture(sampler, vTexCoord) : vColor;
vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);
fragColor = vec4(lightColor, color.a * layer.opacity);
#endif
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`;function vn(s){const t=s.positions||s.POSITION,e=t.value.length/t.size;s.COLOR_0||s.colors||(s.colors={size:4,value:new Uint8Array(e*4).fill(255),normalized:!0})}const xn={pbrMaterial:{type:"object",value:null},featureIds:{type:"array",value:null,optional:!0}};class ue extends _n{getShaders(){const t=super.getShaders();return t.modules.push(wn,On),{...t,vs:Un,fs:Dn}}initializeState(){const{featureIds:t}=this.props;super.initializeState();const e=this.getAttributeManager();t&&e.add({featureIdsPickingColors:{type:"uint8",size:3,noAlloc:!0,update:this.calculateFeatureIdsPickingColors}})}updateState(t){super.updateState(t);const{props:e,oldProps:n}=t;e.pbrMaterial!==n.pbrMaterial&&this.updatePbrMaterialUniforms(e.pbrMaterial)}draw(t){const{featureIds:e}=this.props,{model:n}=this.state;if(!n)return;const r={pickFeatureIds:!!e},i={camera:this.context.viewport.cameraPosition};n.shaderInputs.setProps({pbrProjection:i,mesh:r}),super.draw(t)}getModel(t){const{id:e}=this.props,n=this.parseMaterial(this.props.pbrMaterial,t);this.setState({parsedPBRMaterial:n});const r=this.getShaders();return vn(t.attributes),new cn(this.context.device,{...this.getShaders(),id:e,geometry:t,bufferLayout:this.getAttributeManager().getBufferLayouts(),defines:{...r.defines,...n?.defines,HAS_UV_REGIONS:t.attributes.uvRegions?1:0},parameters:n?.parameters,isInstanced:!0})}updatePbrMaterialUniforms(t){const{model:e}=this.state;if(e){const{mesh:n}=this.props,r=this.parseMaterial(t,n);this.setState({parsedPBRMaterial:r});const{pbr_baseColorSampler:i}=r.bindings,{emptyTexture:o}=this.state,a={sampler:i||o,hasTexture:!!i},{camera:l,...c}={...r.bindings,...r.uniforms};e.shaderInputs.setProps({simpleMesh:a,pbrMaterial:c})}}parseMaterial(t,e){const n=!!(t.pbrMetallicRoughness&&t.pbrMetallicRoughness.baseColorTexture);return Sn(this.context.device,{unlit:n,...t},{NORMAL:e.attributes.normals,TEXCOORD_0:e.attributes.texCoords},{pbrDebug:!1,lights:!0,useTangents:!1})}calculateFeatureIdsPickingColors(t){const e=this.props.featureIds,n=new Uint8ClampedArray(e.length*t.size),r=[];for(let i=0;i<e.length;i++)this.encodePickingColor(e[i],r),n[i*3]=r[0],n[i*3+1]=r[1],n[i*3+2]=r[2];t.value=n}finalizeState(t){super.finalizeState(t),this.state.parsedPBRMaterial?.generatedTextures.forEach(e=>e.destroy()),this.setState({parsedPBRMaterial:null})}}ue.layerName="MeshLayer";ue.defaultProps=xn;const Vn=6378137,Bn=6378137,Fn=6356752314245179e-9;function Vt(s){return s}new d;function zn(s,t=[],e=Vt){return"longitude"in s?(t[0]=e(s.longitude),t[1]=e(s.latitude),t[2]=s.height):"x"in s?(t[0]=e(s.x),t[1]=e(s.y),t[2]=s.z):(t[0]=e(s[0]),t[1]=e(s[1]),t[2]=s[2]),t}function Gn(s,t=[]){return zn(s,t,vt._cartographicRadians?Vt:hn)}function qn(s,t,e=Vt){return"longitude"in t?(t.longitude=e(s[0]),t.latitude=e(s[1]),t.height=s[2]):"x"in t?(t.x=e(s[0]),t.y=e(s[1]),t.z=s[2]):(t[0]=e(s[0]),t[1]=e(s[1]),t[2]=s[2]),t}function kn(s,t){return qn(s,t,vt._cartographicRadians?Vt:ln)}const Ce=1e-14,Hn=new d,Ie={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},Gt={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},_t={east:new d,north:new d,up:new d,west:new d,south:new d,down:new d},Zn=new d,jn=new d,$n=new d;function Ae(s,t,e,n,r,i){const o=Ie[t]&&Ie[t][e];dt(o&&(!n||n===o));let a,l,c;const h=Hn.copy(r);if(te(h.x,0,Ce)&&te(h.y,0,Ce)){const p=Math.sign(h.z);a=Zn.fromArray(Gt[t]),t!=="east"&&t!=="west"&&a.scale(p),l=jn.fromArray(Gt[e]),e!=="east"&&e!=="west"&&l.scale(p),c=$n.fromArray(Gt[n]),n!=="east"&&n!=="west"&&c.scale(p)}else{const{up:p,east:g,north:m}=_t;g.set(-h.y,h.x,0).normalize(),s.geodeticSurfaceNormal(h,p),m.copy(p).cross(g);const{down:T,west:E,south:S}=_t;T.copy(p).scale(-1),E.copy(g).scale(-1),S.copy(m).scale(-1),a=_t[t],l=_t[e],c=_t[n]}return i[0]=a.x,i[1]=a.y,i[2]=a.z,i[3]=0,i[4]=l.x,i[5]=l.y,i[6]=l.z,i[7]=0,i[8]=c.x,i[9]=c.y,i[10]=c.z,i[11]=0,i[12]=h.x,i[13]=h.y,i[14]=h.z,i[15]=1,i}const ht=new d,Wn=new d,Yn=new d;function Xn(s,t,e=[]){const{oneOverRadii:n,oneOverRadiiSquared:r,centerToleranceSquared:i}=t;ht.from(s);const o=ht.x,a=ht.y,l=ht.z,c=n.x,h=n.y,u=n.z,p=o*o*c*c,g=a*a*h*h,m=l*l*u*u,T=p+g+m,E=Math.sqrt(1/T);if(!Number.isFinite(E))return;const S=Wn;if(S.copy(s).scale(E),T<i)return S.to(e);const C=r.x,N=r.y,V=r.z,B=Yn;B.set(S.x*C*2,S.y*N*2,S.z*V*2);let v=(1-E)*ht.len()/(.5*B.len()),J=0,Z,M,j,K;do{v-=J,Z=1/(1+v*C),M=1/(1+v*N),j=1/(1+v*V);const at=Z*Z,bt=M*M,tt=j*j,Tt=at*Z,yt=bt*M,ct=tt*j;K=p*at+g*bt+m*tt-1;const Ee=-2*(p*Tt*C+g*yt*N+m*ct*V);J=K/Ee}while(Math.abs(K)>In);return ht.scale([Z,M,j]).to(e)}const Lt=new d,Le=new d,Qn=new d,q=new d,Jn=new d,Mt=new d;class b{constructor(t=0,e=0,n=0){this.centerToleranceSquared=An,dt(t>=0),dt(e>=0),dt(n>=0),this.radii=new d(t,e,n),this.radiiSquared=new d(t*t,e*e,n*n),this.radiiToTheFourth=new d(t*t*t*t,e*e*e*e,n*n*n*n),this.oneOverRadii=new d(t===0?0:1/t,e===0?0:1/e,n===0?0:1/n),this.oneOverRadiiSquared=new d(t===0?0:1/(t*t),e===0?0:1/(e*e),n===0?0:1/(n*n)),this.minimumRadius=Math.min(t,e,n),this.maximumRadius=Math.max(t,e,n),this.radiiSquared.z!==0&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}equals(t){return this===t||!!(t&&this.radii.equals(t.radii))}toString(){return this.radii.toString()}cartographicToCartesian(t,e=[0,0,0]){const n=Le,r=Qn,[,,i]=t;this.geodeticSurfaceNormalCartographic(t,n),r.copy(this.radiiSquared).scale(n);const o=Math.sqrt(n.dot(r));return r.scale(1/o),n.scale(i),r.add(n),r.to(e)}cartesianToCartographic(t,e=[0,0,0]){Mt.from(t);const n=this.scaleToGeodeticSurface(Mt,q);if(!n)return;const r=this.geodeticSurfaceNormal(n,Le),i=Jn;i.copy(Mt).subtract(n);const o=Math.atan2(r.y,r.x),a=Math.asin(r.z),l=Math.sign(un(i,Mt))*dn(i);return kn([o,a,l],e)}eastNorthUpToFixedFrame(t,e=new I){return Ae(this,"east","north","up",t,e)}localFrameToFixedFrame(t,e,n,r,i=new I){return Ae(this,t,e,n,r,i)}geocentricSurfaceNormal(t,e=[0,0,0]){return Lt.from(t).normalize().to(e)}geodeticSurfaceNormalCartographic(t,e=[0,0,0]){const n=Gn(t),r=n[0],i=n[1],o=Math.cos(i);return Lt.set(o*Math.cos(r),o*Math.sin(r),Math.sin(i)).normalize(),Lt.to(e)}geodeticSurfaceNormal(t,e=[0,0,0]){return Lt.from(t).scale(this.oneOverRadiiSquared).normalize().to(e)}scaleToGeodeticSurface(t,e){return Xn(t,this,e)}scaleToGeocentricSurface(t,e=[0,0,0]){q.from(t);const n=q.x,r=q.y,i=q.z,o=this.oneOverRadiiSquared,a=1/Math.sqrt(n*n*o.x+r*r*o.y+i*i*o.z);return q.multiplyScalar(a).to(e)}transformPositionToScaledSpace(t,e=[0,0,0]){return q.from(t).scale(this.oneOverRadii).to(e)}transformPositionFromScaledSpace(t,e=[0,0,0]){return q.from(t).scale(this.radii).to(e)}getSurfaceNormalIntersectionWithZAxis(t,e=0,n=[0,0,0]){dt(te(this.radii.x,this.radii.y,Ln)),dt(this.radii.z>0),q.from(t);const r=q.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(r)>=this.radii.z-e))return q.set(0,0,r).to(n)}}b.WGS84=new b(Vn,Bn,Fn);class Kn{item;previous;next;constructor(t,e,n){this.item=t,this.previous=e,this.next=n}}class tr{head=null;tail=null;_length=0;get length(){return this._length}add(t){const e=new Kn(t,this.tail,null);return this.tail?(this.tail.next=e,this.tail=e):(this.head=e,this.tail=e),++this._length,e}remove(t){t&&(t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=null,this.tail=t.previous):t.next?(t.next.previous=null,this.head=t.next):(this.head=null,this.tail=null),t.next=null,t.previous=null,--this._length)}splice(t,e){t!==e&&(this.remove(e),this._insert(t,e))}_insert(t,e){const n=t.next;t.next=e,this.tail===t?this.tail=e:n.previous=e,e.next=n,e.previous=t,++this._length}}class er{_list;_sentinel;_trimTiles;constructor(){this._list=new tr,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(t){const e=t._cacheNode;e&&this._list.splice(this._sentinel,e)}add(t,e,n){e._cacheNode||(e._cacheNode=this._list.add(e),n&&n(t,e))}unloadTile(t,e,n){const r=e._cacheNode;r&&(this._list.remove(r),e._cacheNode=null,n&&n(t,e))}unloadTiles(t,e){const n=this._trimTiles;this._trimTiles=!1;const r=this._list,i=t.maximumMemoryUsage*1024*1024,o=this._sentinel;let a=r.head;for(;a!==o&&(t.gpuMemoryUsageInBytes>i||n);){const l=a.item;a=a.next,this.unloadTile(t,l,e)}}trim(){this._trimTiles=!0}}function sr(s,t){L(s),L(t);const{rtcCenter:e,gltfUpAxis:n}=t,{computedTransform:r,boundingVolume:{center:i}}=s;let o=new I(r);switch(e&&o.translate(e),n){case"Z":break;case"Y":const u=new I().rotateX(Math.PI/2);o=o.multiplyRight(u);break;case"X":const p=new I().rotateY(-Math.PI/2);o=o.multiplyRight(p);break}t.isQuantized&&o.translate(t.quantizedVolumeOffset).scale(t.quantizedVolumeScale);const a=new d(i);t.cartesianModelMatrix=o,t.cartesianOrigin=a;const l=b.WGS84.cartesianToCartographic(a,new d),h=b.WGS84.eastNorthUpToFixedFrame(a).invert();t.cartographicModelMatrix=h.multiplyRight(o),t.cartographicOrigin=l,t.coordinateSystem||(t.modelMatrix=t.cartographicModelMatrix)}const Me=new d,qt=new d,ee=new Ot([new lt,new lt,new lt,new lt,new lt,new lt]);function nr(s,t){const{cameraDirection:e,cameraUp:n,height:r}=s,{metersPerUnit:i}=s.distanceScales,o=Ut(s,s.center),a=b.WGS84.eastNorthUpToFixedFrame(o),l=s.unprojectPosition(s.cameraPosition),c=b.WGS84.cartographicToCartesian(l,new d),h=new d(a.transformAsVector(new d(e).scale(i))).normalize(),u=new d(a.transformAsVector(new d(n).scale(i))).normalize();ir(s);const p=s.constructor,{longitude:g,latitude:m,width:T,bearing:E,zoom:S}=s,C=new p({longitude:g,latitude:m,height:r,width:T,bearing:E,zoom:S,pitch:0});return{camera:{position:c,direction:h,up:u},viewport:s,topDownViewport:C,height:r,cullingVolume:ee,frameNumber:t,sseDenominator:1.15}}function rr(s,t,e){if(e===0||s.length<=e)return[s,[]];const n=[],{longitude:r,latitude:i}=t.viewport;for(const[c,h]of s.entries()){const[u,p]=h.header.mbs,g=Math.abs(r-u),m=Math.abs(i-p),T=Math.sqrt(m*m+g*g);n.push([c,T])}const o=n.sort((c,h)=>c[1]-h[1]),a=[];for(let c=0;c<e;c++)a.push(s[o[c][0]]);const l=[];for(let c=e;c<o.length;c++)l.push(s[o[c][0]]);return[a,l]}function ir(s){const t=s.getFrustumPlanes(),e=Ne(t.near,s.cameraPosition),n=Ut(s,e),r=Ut(s,s.cameraPosition,qt);let i=0;ee.planes[i++].fromPointNormal(n,Me.copy(n).subtract(r));for(const o in t){if(o==="near")continue;const a=t[o],l=Ne(a,e,qt),c=Ut(s,l,qt);ee.planes[i++].fromPointNormal(c,Me.copy(n).subtract(c))}}function Ne(s,t,e=new d){const n=s.normal.dot(t);return e.copy(s.normal).scale(s.distance-n).add(t),e}function Ut(s,t,e=new d){const n=s.unprojectPosition(t);return b.WGS84.cartographicToCartesian(n,e)}const or=6378137,ar=6378137,se=6356752314245179e-9,ft=new d;function cr(s,t){if(s instanceof gs){const{halfAxes:e}=s,n=hr(e);return Math.log2(se/(n+t[2]))}else if(s instanceof ms){const{radius:e}=s;return Math.log2(se/(e+t[2]))}else if(s.width&&s.height){const{width:e,height:n}=s,r=Math.log2(or/e),i=Math.log2(ar/n);return(r+i)/2}return 1}function ws(s,t,e){b.WGS84.cartographicToCartesian([s.xmax,s.ymax,s.zmax],ft);const n=Math.sqrt(Math.pow(ft[0]-e[0],2)+Math.pow(ft[1]-e[1],2)+Math.pow(ft[2]-e[2],2));return Math.log2(se/(n+t[2]))}function lr(s,t,e){const[n,r,i,o]=s;return ws({xmax:i,ymax:o,zmax:0},t,e)}function hr(s){s.getColumn(0,ft);const t=s.getColumn(1),e=s.getColumn(2);return ft.add(t).add(e).len()}const x={UNLOADED:0,LOADING:1,PROCESSING:2,READY:3,EXPIRED:4,FAILED:5};var H;(function(s){s[s.ADD=1]="ADD",s[s.REPLACE=2]="REPLACE"})(H||(H={}));var X;(function(s){s.EMPTY="empty",s.SCENEGRAPH="scenegraph",s.POINTCLOUD="pointcloud",s.MESH="mesh"})(X||(X={}));var U;(function(s){s.I3S="I3S",s.TILES3D="TILES3D"})(U||(U={}));var gt;(function(s){s.GEOMETRIC_ERROR="geometricError",s.MAX_SCREEN_THRESHOLD="maxScreenThreshold"})(gt||(gt={}));const ur={USE_OPTIMIZATION:1};function Ss(s){return s!=null}const R=new d,Dt=new d,dr=new d,fr=new d,nt=new d,Re=new d,Pe=new d,Oe=new d;function kt(s,t,e){if(L(s,"3D Tile: boundingVolume must be defined"),s.box)return Es(s.box,t,e);if(s.region)return mr(s.region);if(s.sphere)return gr(s.sphere,t,e);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function pr(s,t){if(s.box)return Tr(t);if(s.region){const[e,n,r,i,o,a]=s.region;return[[$(e),$(n),o],[$(r),$(i),a]]}if(s.sphere)return yr(t);throw new Error("Unkown boundingVolume type")}function Es(s,t,e){const n=new d(s[0],s[1],s[2]);t.transform(n,n);let r=[];if(s.length===10){const c=s.slice(3,6),h=new Ts;h.fromArray(s,6);const u=new d([1,0,0]),p=new d([0,1,0]),g=new d([0,0,1]);u.transformByQuaternion(h),u.scale(c[0]),p.transformByQuaternion(h),p.scale(c[1]),g.transformByQuaternion(h),g.scale(c[2]),r=[...u.toArray(),...p.toArray(),...g.toArray()]}else r=[...s.slice(3,6),...s.slice(6,9),...s.slice(9,12)];const i=t.transformAsVector(r.slice(0,3)),o=t.transformAsVector(r.slice(3,6)),a=t.transformAsVector(r.slice(6,9)),l=new ys([i[0],i[1],i[2],o[0],o[1],o[2],a[0],a[1],a[2]]);return Ss(e)?(e.center=n,e.halfAxes=l,e):new gs(n,l)}function gr(s,t,e){const n=new d(s[0],s[1],s[2]);t.transform(n,n);const r=t.getScale(Dt),i=Math.max(Math.max(r[0],r[1]),r[2]),o=s[3]*i;return Ss(e)?(e.center=n,e.radius=o,e):new ms(n,o)}function mr(s){const[t,e,n,r,i,o]=s,a=b.WGS84.cartographicToCartesian([$(t),$(r),i],dr),l=b.WGS84.cartographicToCartesian([$(n),$(e),o],fr),c=new d().addVectors(a,l).multiplyByScalar(.5);return b.WGS84.cartesianToCartographic(c,nt),b.WGS84.cartographicToCartesian([$(n),nt[1],nt[2]],Re),b.WGS84.cartographicToCartesian([nt[0],$(r),nt[2]],Pe),b.WGS84.cartographicToCartesian([nt[0],nt[1],o],Oe),Es([...c,...Re.subtract(c),...Pe.subtract(c),...Oe.subtract(c)],new I)}function Tr(s){const t=bs(),{halfAxes:e}=s,n=new d(e.getColumn(0)),r=new d(e.getColumn(1)),i=new d(e.getColumn(2));for(let o=0;o<2;o++){for(let a=0;a<2;a++){for(let l=0;l<2;l++)R.copy(s.center),R.add(n),R.add(r),R.add(i),Cs(t,R),i.negate();r.negate()}n.negate()}return t}function yr(s){const t=bs(),{center:e,radius:n}=s,r=b.WGS84.scaleToGeodeticSurface(e,R);let i;r?i=b.WGS84.geodeticSurfaceNormal(r):i=new d(0,0,1);let o=new d(i[2],-i[1],0);o.len()>0?o.normalize():o=new d(0,1,0);const a=o.clone().cross(i);for(const l of[o,a,i]){Dt.copy(l).scale(n);for(let c=0;c<2;c++)R.copy(e),R.add(Dt),Cs(t,R),Dt.negate()}return t}function bs(){return[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]]}function Cs(s,t){b.WGS84.cartesianToCartographic(t,R),s[0][0]=Math.min(s[0][0],R[0]),s[0][1]=Math.min(s[0][1],R[1]),s[0][2]=Math.min(s[0][2],R[2]),s[1][0]=Math.max(s[1][0],R[0]),s[1][1]=Math.max(s[1][1],R[1]),s[1][2]=Math.max(s[1][2],R[2])}new d;new d;new I;new d;new d;new d;function _r(s,t){const e=s*t;return 1-Math.exp(-(e*e))}function wr(s,t){if(s.dynamicScreenSpaceError&&s.dynamicScreenSpaceErrorComputedDensity){const e=s.dynamicScreenSpaceErrorComputedDensity,n=s.dynamicScreenSpaceErrorFactor;return _r(t,e)*n}return 0}function Sr(s,t,e){const n=s.tileset,r=s.parent&&s.parent.lodMetricValue||s.lodMetricValue,i=e?r:s.lodMetricValue;if(i===0)return 0;const o=Math.max(s._distanceToCamera,1e-7),{height:a,sseDenominator:l}=t,{viewDistanceScale:c}=n.options;let h=i*a*(c||1)/(o*l);return h-=wr(n,o),h}const Ht=new d,Ue=new d,st=new d,De=new d,Er=new d,Zt=new I,ve=new I;function br(s,t){if(s.lodMetricValue===0||isNaN(s.lodMetricValue))return"DIG";const e=2*Is(s,t);return e<2?"OUT":!s.header.children||e<=s.lodMetricValue?"DRAW":s.header.children?"DIG":"OUT"}function Is(s,t){const{topDownViewport:e}=t,n=s.header.mbs[1],r=s.header.mbs[0],i=s.header.mbs[2],o=s.header.mbs[3],a=[...s.boundingVolume.center],l=e.unprojectPosition(e.cameraPosition);b.WGS84.cartographicToCartesian(l,Ht),Ue.copy(Ht).subtract(a).normalize(),b.WGS84.eastNorthUpToFixedFrame(a,Zt),ve.copy(Zt).invert(),st.copy(Ht).transform(ve);const c=Math.sqrt(st[0]*st[0]+st[1]*st[1]),h=c*c/st[2];De.copy([st[0],st[1],h]);const p=De.transform(Zt).subtract(a).normalize(),m=Ue.cross(p).normalize().scale(o).add(a),T=b.WGS84.cartesianToCartographic(m),E=e.project([r,n,i]),S=e.project(T);return Er.copy(E).subtract(S).magnitude()}function Cr(s){return{assetGltfUpAxis:s.asset&&s.asset.gltfUpAxis||"Y"}}class xe{_map=new Map;_array;_length;constructor(t=0){this._array=new Array(t),this._length=t}get length(){return this._length}set length(t){this._length=t,t>this._array.length&&(this._array.length=t)}get values(){return this._array}get(t){return L(t<this._array.length),this._array[t]}set(t,e){L(t>=0),t>=this.length&&(this.length=t+1),this._map.has(this._array[t])&&this._map.delete(this._array[t]),this._array[t]=e,this._map.set(e,t)}delete(t){const e=this._map.get(t);e>=0&&(this._array.splice(e,1),this._map.delete(t),this.length--)}peek(){return this._array[this._length-1]}push(t){if(!this._map.has(t)){const e=this.length++;this._array[e]=t,this._map.set(t,e)}}pop(){const t=this._array[--this.length];return this._map.delete(t),t}reserve(t){L(t>=0),t>this._array.length&&(this._array.length=t)}resize(t){L(t>=0),this.length=t}trim(t){t==null&&(t=this.length),this._array.length=t}reset(){this._array=[],this._map=new Map,this._length=0}find(t){return this._map.has(t)}}const Ir={loadSiblings:!1,skipLevelOfDetail:!1,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class Bt{options;root=null;selectedTiles={};requestedTiles={};emptyTiles={};lastUpdate=new Date().getTime();updateDebounceTime=1e3;_traversalStack=new xe;_emptyTraversalStack=new xe;_frameNumber=null;traversalFinished(t){return!0}constructor(t){this.options={...Ir,...t}}traverse(t,e,n){this.root=t,this.options={...this.options,...n},this.reset(),this.updateTile(t,e),this._frameNumber=e.frameNumber,this.executeTraversal(t,e)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(t,e){const n=this._traversalStack;for(t._selectionDepth=1,n.push(t);n.length>0;){const i=n.pop();let o=!1;this.canTraverse(i,e)&&(this.updateChildTiles(i,e),o=this.updateAndPushChildren(i,e,n,i.hasRenderContent?i._selectionDepth+1:i._selectionDepth));const a=i.parent,l=!!(!a||a._shouldRefine),c=!o;i.hasRenderContent?i.refine===H.ADD?(this.loadTile(i,e),this.selectTile(i,e)):i.refine===H.REPLACE&&(this.loadTile(i,e),c&&this.selectTile(i,e)):(this.emptyTiles[i.id]=i,this.loadTile(i,e),c&&this.selectTile(i,e)),this.touchTile(i,e),i._shouldRefine=o&&l}const r=new Date().getTime();(this.traversalFinished(e)||r-this.lastUpdate>this.updateDebounceTime)&&(this.lastUpdate=r,this.options.onTraversalEnd(e))}updateChildTiles(t,e){const n=t.children;for(const r of n)this.updateTile(r,e)}updateAndPushChildren(t,e,n,r){const{loadSiblings:i,skipLevelOfDetail:o}=this.options,a=t.children;a.sort(this.compareDistanceToCamera.bind(this));const l=t.refine===H.REPLACE&&t.hasRenderContent&&!o;let c=!1,h=!0;for(const u of a)if(u._selectionDepth=r,u.isVisibleAndInRequestVolume?(n.find(u)&&n.delete(u),n.push(u),c=!0):(l||i)&&(this.loadTile(u,e),this.touchTile(u,e)),l){let p;if(u._inRequestVolume?u.hasRenderContent?p=u.contentAvailable:p=this.executeEmptyTraversal(u,e):p=!1,h=h&&p,!h)return!1}return c||(h=!1),h}updateTile(t,e){this.updateTileVisibility(t,e)}selectTile(t,e){this.shouldSelectTile(t)&&(t._selectedFrame=e.frameNumber,this.selectedTiles[t.id]=t)}loadTile(t,e){this.shouldLoadTile(t)&&(t._requestedFrame=e.frameNumber,t._priority=t._getPriority(),this.requestedTiles[t.id]=t)}touchTile(t,e){t.tileset._cache.touch(t),t._touchedFrame=e.frameNumber}canTraverse(t,e){return t.hasChildren?t.hasTilesetContent?!t.contentExpired:this.shouldRefine(t,e):!1}shouldLoadTile(t){return t.hasUnloadedContent||t.contentExpired}shouldSelectTile(t){return t.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(t,e,n=!1){let r=t._screenSpaceError;return n&&(r=t.getScreenSpaceError(e,!0)),r>t.tileset.memoryAdjustedScreenSpaceError}updateTileVisibility(t,e){const n=[];if(this.options.viewportTraversersMap)for(const r in this.options.viewportTraversersMap)this.options.viewportTraversersMap[r]===e.viewport.id&&n.push(r);else n.push(e.viewport.id);t.updateVisibility(e,n)}compareDistanceToCamera(t,e){return t._distanceToCamera-e._distanceToCamera}anyChildrenVisible(t,e){let n=!1;for(const r of t.children)r.updateVisibility(e),n=n||r.isVisibleAndInRequestVolume;return n}executeEmptyTraversal(t,e){let n=!0;const r=this._emptyTraversalStack;for(r.push(t);r.length>0;){const i=r.pop(),o=!i.hasRenderContent&&this.canTraverse(i,e),a=!i.hasRenderContent&&i.children.length===0;if(!o&&!i.contentAvailable&&!a&&(n=!1),this.updateTile(i,e),i.isVisibleAndInRequestVolume||(this.loadTile(i,e),this.touchTile(i,e)),o){const l=i.children;for(const c of l)r.push(c)}}return n}}const Ve=new d;function Ar(s){return s!=null}class ne{tileset;header;id;url;parent;refine;type;contentUrl;lodMetricType="geometricError";lodMetricValue=0;boundingVolume=null;content=null;contentState=x.UNLOADED;gpuMemoryUsageInBytes=0;children=[];depth=0;viewportIds=[];transform=new I;extensions=null;implicitTiling=null;userData={};computedTransform;hasEmptyContent=!1;hasTilesetContent=!1;traverser=new Bt({});_cacheNode=null;_frameNumber=null;_expireDate=null;_expiredContent=null;_boundingBox=void 0;_distanceToCamera=0;_screenSpaceError=0;_visibilityPlaneMask;_visible=void 0;_contentBoundingVolume;_viewerRequestVolume;_initialTransform=new I;_priority=0;_selectedFrame=0;_requestedFrame=0;_selectionDepth=0;_touchedFrame=0;_centerZDepth=0;_shouldRefine=!1;_stackLength=0;_visitedFrame=0;_inRequestVolume=!1;_lodJudge=null;constructor(t,e,n,r=""){this.header=e,this.tileset=t,this.id=r||e.id,this.url=e.url,this.parent=n,this.refine=this._getRefine(e.refine),this.type=e.type,this.contentUrl=e.contentUrl,this._initializeLodMetric(e),this._initializeTransforms(e),this._initializeBoundingVolumes(e),this._initializeContent(e),this._initializeRenderingState(e),Object.seal(this)}destroy(){this.header=null}isDestroyed(){return this.header===null}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===x.READY||this.hasEmptyContent}get contentAvailable(){return!!(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===x.UNLOADED}get contentExpired(){return this.contentState===x.EXPIRED}get contentFailed(){return this.contentState===x.FAILED}get distanceToCamera(){return this._distanceToCamera}get screenSpaceError(){return this._screenSpaceError}get boundingBox(){return this._boundingBox||(this._boundingBox=pr(this.header.boundingVolume,this.boundingVolume)),this._boundingBox}getScreenSpaceError(t,e){switch(this.tileset.type){case U.I3S:return Is(this,t);case U.TILES3D:return Sr(this,t,e);default:throw new Error("Unsupported tileset type")}}unselect(){this._selectedFrame=0}_getGpuMemoryUsageInBytes(){return this.content.gpuMemoryUsageInBytes||this.content.byteLength||0}_getPriority(){const t=this.tileset._traverser,{skipLevelOfDetail:e}=t.options,n=this.refine===H.ADD||e;if(n&&!this.isVisible&&this._visible!==void 0||this.tileset._frameNumber-this._touchedFrame>=1||this.contentState===x.UNLOADED)return-1;const r=this.parent,o=r&&(!n||this._screenSpaceError===0||r.hasTilesetContent)?r._screenSpaceError:this._screenSpaceError,a=t.root?t.root._screenSpaceError:0;return Math.max(a-o,0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=x.LOADING;const e=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!e)return this.contentState=x.UNLOADED,!1;try{const n=this.tileset.getTileUrl(this.contentUrl),r=this.tileset.loader,i={...this.tileset.loadOptions,[r.id]:{...this.tileset.loadOptions[r.id],isTileset:this.type==="json",...this._getLoaderSpecificOptions(r.id)}};return this.content=await Et(n,r,i),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=x.READY,this._onContentLoaded(),!0}catch(n){throw this.contentState=x.FAILED,n}finally{e.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=x.UNLOADED,!0}updateVisibility(t,e){if(this._frameNumber===t.frameNumber)return;const n=this.parent,r=n?n._visibilityPlaneMask:Ot.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){const i=n?n.computedTransform:this.tileset.modelMatrix;this._updateTransform(i)}this._distanceToCamera=this.distanceToTile(t),this._screenSpaceError=this.getScreenSpaceError(t,!1),this._visibilityPlaneMask=this.visibility(t,r),this._visible=this._visibilityPlaneMask!==Ot.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(t),this._frameNumber=t.frameNumber,this.viewportIds=e}visibility(t,e){const{cullingVolume:n}=t,{boundingVolume:r}=this;return n.computeVisibilityWithPlaneMask(r,e)}contentVisibility(){return!0}distanceToTile(t){const e=this.boundingVolume;return Math.sqrt(Math.max(e.distanceSquaredTo(t.camera.position),0))}cameraSpaceZDepth({camera:t}){const e=this.boundingVolume;return Ve.subVectors(e.center,t.position),t.direction.dot(Ve)}insideViewerRequestVolume(t){const e=this._viewerRequestVolume;return!e||e.distanceSquaredTo(t.camera.position)<=0}updateExpiration(){if(Ar(this._expireDate)&&this.contentReady&&!this.hasEmptyContent){const t=Date.now();Date.lessThan(this._expireDate,t)&&(this.contentState=x.EXPIRED,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(t){"lodMetricType"in t?this.lodMetricType=t.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType")),"lodMetricValue"in t?this.lodMetricValue=t.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}_initializeTransforms(t){this.transform=t.transform?new I(t.transform):new I;const e=this.parent,n=this.tileset,r=e&&e.computedTransform?e.computedTransform.clone():n.modelMatrix.clone();this.computedTransform=new I(r).multiplyRight(this.transform);const i=e&&e._initialTransform?e._initialTransform.clone():new I;this._initialTransform=new I(i).multiplyRight(this.transform)}_initializeBoundingVolumes(t){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(t)}_initializeContent(t){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=x.UNLOADED,this.hasTilesetContent=!1,t.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(t){this.depth=t.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=Ot.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(t){return t||this.parent&&this.parent.refine||H.REPLACE}_isTileset(){return this.contentUrl.indexOf(".json")!==-1}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0;break}this._isTileset()?this.hasTilesetContent=!0:this.gpuMemoryUsageInBytes=this._getGpuMemoryUsageInBytes()}_updateBoundingVolume(t){this.boundingVolume=kt(t.boundingVolume,this.computedTransform,this.boundingVolume);const e=t.content;e&&(e.boundingVolume&&(this._contentBoundingVolume=kt(e.boundingVolume,this.computedTransform,this._contentBoundingVolume)),t.viewerRequestVolume&&(this._viewerRequestVolume=kt(t.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(t=new I){const e=t.clone().multiplyRight(this.transform);e.equals(this.computedTransform)||(this.computedTransform=e,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(t){return t==="i3s"?{...this.tileset.options.i3s,_tileOptions:{attributeUrls:this.header.attributeUrls,textureUrl:this.header.textureUrl,textureFormat:this.header.textureFormat,textureLoaderOptions:this.header.textureLoaderOptions,materialDefinition:this.header.materialDefinition,isDracoGeometry:this.header.isDracoGeometry,mbs:this.header.mbs},_tilesetOptions:{store:this.tileset.tileset.store,attributeStorageInfo:this.tileset.tileset.attributeStorageInfo,fields:this.tileset.tileset.fields},isTileHeader:!1}:Cr(this.tileset.tileset)}}class Lr extends Bt{compareDistanceToCamera(t,e){return e._distanceToCamera===0&&t._distanceToCamera===0?e._centerZDepth-t._centerZDepth:e._distanceToCamera-t._distanceToCamera}updateTileVisibility(t,e){if(super.updateTileVisibility(t,e),!t.isVisibleAndInRequestVolume)return;const n=t.children.length>0;if(t.hasTilesetContent&&n){const o=t.children[0];this.updateTileVisibility(o,e),t._visible=o._visible;return}if(this.meetsScreenSpaceErrorEarly(t,e)){t._visible=!1;return}const r=t.refine===H.REPLACE,i=t._optimChildrenWithinParent===ur.USE_OPTIMIZATION;if(r&&i&&n&&!this.anyChildrenVisible(t,e)){t._visible=!1;return}}meetsScreenSpaceErrorEarly(t,e){const{parent:n}=t;return!n||n.hasTilesetContent||n.refine!==H.ADD?!1:!this.shouldRefine(t,e,!0)}}class Mr{frameNumberMap=new Map;register(t,e){const n=this.frameNumberMap.get(t)||new Map,r=n.get(e)||0;n.set(e,r+1),this.frameNumberMap.set(t,n)}deregister(t,e){const n=this.frameNumberMap.get(t);if(!n)return;const r=n.get(e)||1;n.set(e,r-1)}isZero(t,e){return(this.frameNumberMap.get(t)?.get(e)||0)===0}}const jt={REQUESTED:"REQUESTED",COMPLETED:"COMPLETED",ERROR:"ERROR"};class Nr{_statusMap;pendingTilesRegister=new Mr;constructor(){this._statusMap={}}add(t,e,n,r){if(!this._statusMap[e]){const{frameNumber:i,viewport:{id:o}}=r;this._statusMap[e]={request:t,callback:n,key:e,frameState:r,status:jt.REQUESTED},this.pendingTilesRegister.register(o,i),t().then(a=>{this._statusMap[e].status=jt.COMPLETED;const{frameNumber:l,viewport:{id:c}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(c,l),this._statusMap[e].callback(a,r)}).catch(a=>{this._statusMap[e].status=jt.ERROR;const{frameNumber:l,viewport:{id:c}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(c,l),n(a)})}}update(t,e){if(this._statusMap[t]){const{frameNumber:n,viewport:{id:r}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(r,n);const{frameNumber:i,viewport:{id:o}}=e;this.pendingTilesRegister.register(o,i),this._statusMap[t].frameState=e}}find(t){return this._statusMap[t]}hasPendingTiles(t,e){return!this.pendingTilesRegister.isZero(t,e)}}class Rr extends Bt{_tileManager;constructor(t){super(t),this._tileManager=new Nr}traversalFinished(t){return!this._tileManager.hasPendingTiles(t.viewport.id,this._frameNumber||0)}shouldRefine(t,e){return t._lodJudge=br(t,e),t._lodJudge==="DIG"}updateChildTiles(t,e){const n=t.header.children||[],r=t.children,i=t.tileset;for(const o of n){const a=`${o.id}-${e.viewport.id}`,l=r&&r.find(c=>c.id===a);if(l)l&&this.updateTile(l,e);else{let c=()=>this._loadTile(o.id,i);this._tileManager.find(a)?this._tileManager.update(a,e):(i.tileset.nodePages&&(c=()=>i.tileset.nodePagesTile.formTileFromNodePages(o.id)),this._tileManager.add(c,a,u=>this._onTileLoad(u,t,a),e))}}return!1}async _loadTile(t,e){const{loader:n}=e,r=e.getTileUrl(`${e.url}/nodes/${t}`),i={...e.loadOptions,i3s:{...e.loadOptions.i3s,isTileHeader:!0}};return await Et(r,n,i)}_onTileLoad(t,e,n){const r=new ne(e.tileset,t,e,n);e.children.push(r);const i=this._tileManager.find(r.id).frameState;this.updateTile(r,i),this._frameNumber===i.frameNumber&&(this.traversalFinished(i)||new Date().getTime()-this.lastUpdate>this.updateDebounceTime)&&this.executeTraversal(r,i)}}const Pr={description:"",ellipsoid:b.WGS84,modelMatrix:new I,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,memoryCacheOverflow:1,maximumTilesSelected:0,debounceTime:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:s=>s,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,memoryAdjustedScreenSpaceError:!1,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}},Nt="Tiles In Tileset(s)",$t="Tiles In Memory",Be="Tiles In View",Fe="Tiles To Render",ze="Tiles Loaded",Wt="Tiles Loading",Ge="Tiles Unloaded",qe="Failed Tile Loads",ke="Points/Vertices",Yt="Tile Memory Use",He="Maximum Screen Space Error";class Or{options;loadOptions;type;tileset;loader;url;basePath;modelMatrix;ellipsoid;lodMetricType;lodMetricValue;refine;root=null;roots={};asset={};description="";properties;extras=null;attributions={};credits={};stats;contentFormats={draco:!1,meshopt:!1,dds:!1,ktx2:!1};cartographicCenter=null;cartesianCenter=null;zoom=1;boundingVolume=null;dynamicScreenSpaceErrorComputedDensity=0;maximumMemoryUsage=32;gpuMemoryUsageInBytes=0;memoryAdjustedScreenSpaceError=0;_cacheBytes=0;_cacheOverflowBytes=0;_frameNumber=0;_queryParams={};_extensionsUsed=[];_tiles={};_pendingCount=0;selectedTiles=[];traverseCounter=0;geometricError=0;lastUpdatedVieports=null;_requestedTiles=[];_emptyTiles=[];frameStateData={};_traverser;_cache=new er;_requestScheduler;updatePromise=null;tilesetInitializationPromise;constructor(t,e){this.options={...Pr,...e},this.tileset=t,this.loader=t.loader,this.type=t.type,this.url=t.url,this.basePath=t.basePath||us(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=t.lodMetricType,this.lodMetricValue=t.lodMetricValue,this.refine=t.root.refine,this.loadOptions=this.options.loadOptions||{},this._traverser=this._initializeTraverser(),this._requestScheduler=new Mn({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this.memoryAdjustedScreenSpaceError=this.options.maximumScreenSpaceError,this._cacheBytes=this.options.maximumMemoryUsage*1024*1024,this._cacheOverflowBytes=this.options.memoryCacheOverflow*1024*1024,this.stats=new fn({id:this.url}),this._initializeStats(),this.tilesetInitializationPromise=this._initializeTileSet(t)}destroy(){this._destroy()}isLoaded(){return this._pendingCount===0&&this._frameNumber!==0&&this._requestedTiles.length===0}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return new URLSearchParams(this._queryParams).toString()}setProps(t){this.options={...this.options,...t}}getTileUrl(t){if(t.startsWith("data:"))return t;let n=t;return this.queryParams.length&&(n=`${t}${t.includes("?")?"&":"?"}${this.queryParams}`),n}hasExtension(t){return this._extensionsUsed.indexOf(t)>-1}update(t=null){this.tilesetInitializationPromise.then(()=>{!t&&this.lastUpdatedVieports?t=this.lastUpdatedVieports:this.lastUpdatedVieports=t,t&&this.doUpdate(t)})}async selectTiles(t=null){return await this.tilesetInitializationPromise,t&&(this.lastUpdatedVieports=t),this.updatePromise||(this.updatePromise=new Promise(e=>{setTimeout(()=>{this.lastUpdatedVieports&&this.doUpdate(this.lastUpdatedVieports),e(this._frameNumber),this.updatePromise=null},this.options.debounceTime)})),this.updatePromise}adjustScreenSpaceError(){this.gpuMemoryUsageInBytes<this._cacheBytes?this.memoryAdjustedScreenSpaceError=Math.max(this.memoryAdjustedScreenSpaceError/1.02,this.options.maximumScreenSpaceError):this.gpuMemoryUsageInBytes>this._cacheBytes+this._cacheOverflowBytes&&(this.memoryAdjustedScreenSpaceError*=1.02)}doUpdate(t){if("loadTiles"in this.options&&!this.options.loadTiles||this.traverseCounter>0)return;const e=t instanceof Array?t:[t];this._cache.reset(),this._frameNumber++,this.traverseCounter=e.length;const n=[];for(const r of e){const i=r.id;this._needTraverse(i)?n.push(i):this.traverseCounter--}for(const r of e){const i=r.id;if(this.roots[i]||(this.roots[i]=this._initializeTileHeaders(this.tileset,null)),!n.includes(i))continue;const o=nr(r,this._frameNumber);this._traverser.traverse(this.roots[i],o,this.options)}}_needTraverse(t){let e=t;return this.options.viewportTraversersMap&&(e=this.options.viewportTraversersMap[t]),e===t}_onTraversalEnd(t){const e=t.viewport.id;this.frameStateData[e]||(this.frameStateData[e]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const n=this.frameStateData[e],r=Object.values(this._traverser.selectedTiles),[i,o]=rr(r,t,this.options.maximumTilesSelected);n.selectedTiles=i;for(const a of o)a.unselect();n._requestedTiles=Object.values(this._traverser.requestedTiles),n._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,!(this.traverseCounter>0)&&this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const t in this.frameStateData){const e=this.frameStateData[t];this.selectedTiles=this.selectedTiles.concat(e.selectedTiles),this._requestedTiles=this._requestedTiles.concat(e._requestedTiles),this._emptyTiles=this._emptyTiles.concat(e._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const t of this.selectedTiles)this._tiles[t.id]=t;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(t,e){if(t.length!==e.length)return!0;const n=new Set(t.map(o=>o.id)),r=new Set(e.map(o=>o.id));let i=t.filter(o=>!r.has(o.id)).length>0;return i=i||e.filter(o=>!n.has(o.id)).length>0,i}_loadTiles(){for(const t of this._requestedTiles)t.contentUnloaded&&this._loadTile(t)}_unloadTiles(){this._cache.unloadTiles(this,(t,e)=>t._unloadTile(e))}_updateStats(){let t=0,e=0;for(const n of this.selectedTiles)n.contentAvailable&&n.content&&(t++,n.content.pointCount?e+=n.content.pointCount:e+=n.content.vertexCount);this.stats.get(Be).count=this.selectedTiles.length,this.stats.get(Fe).count=t,this.stats.get(ke).count=e,this.stats.get(He).count=this.memoryAdjustedScreenSpaceError}async _initializeTileSet(t){this.type===U.I3S&&(this.calculateViewPropsI3S(),t.root=await t.root),this.root=this._initializeTileHeaders(t,null),this.type===U.TILES3D&&(this._initializeTiles3DTileset(t),this.calculateViewPropsTiles3D()),this.type===U.I3S&&this._initializeI3STileset()}calculateViewPropsI3S(){const t=this.tileset.fullExtent;if(t){const{xmin:n,xmax:r,ymin:i,ymax:o,zmin:a,zmax:l}=t;this.cartographicCenter=new d(n+(r-n)/2,i+(o-i)/2,a+(l-a)/2),this.cartesianCenter=new d,b.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),this.zoom=ws(t,this.cartographicCenter,this.cartesianCenter);return}const e=this.tileset.store?.extent;if(e){const[n,r,i,o]=e;this.cartographicCenter=new d(n+(i-n)/2,r+(o-r)/2,0),this.cartesianCenter=new d,b.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),this.zoom=lr(e,this.cartographicCenter,this.cartesianCenter);return}console.warn("Extent is not defined in the tileset header"),this.cartographicCenter=new d,this.zoom=1}calculateViewPropsTiles3D(){const t=this.root,{center:e}=t.boundingVolume;if(!e){console.warn("center was not pre-calculated for the root tile"),this.cartographicCenter=new d,this.zoom=1;return}e[0]!==0||e[1]!==0||e[2]!==0?(this.cartographicCenter=new d,b.WGS84.cartesianToCartographic(e,this.cartographicCenter)):this.cartographicCenter=new d(0,0,-b.WGS84.radii[0]),this.cartesianCenter=e,this.zoom=cr(t.boundingVolume,this.cartographicCenter)}_initializeStats(){this.stats.get(Nt),this.stats.get(Wt),this.stats.get($t),this.stats.get(Be),this.stats.get(Fe),this.stats.get(ze),this.stats.get(Ge),this.stats.get(qe),this.stats.get(ke),this.stats.get(Yt,"memory"),this.stats.get(He)}_initializeTileHeaders(t,e){const n=new ne(this,t.root,e);if(e&&(e.children.push(n),n.depth=e.depth+1),this.type===U.TILES3D){const r=[];for(r.push(n);r.length>0;){const i=r.pop();this.stats.get(Nt).incrementCount();const o=i.header.children||[];for(const a of o){const l=new ne(this,a,i);if(l.contentUrl?.includes("?session=")){const h=new URL(l.contentUrl).searchParams.get("session");h&&(this._queryParams.session=h)}i.children.push(l),l.depth=i.depth+1,r.push(l)}}}return n}_initializeTraverser(){let t;switch(this.type){case U.TILES3D:t=Lr;break;case U.I3S:t=Rr;break;default:t=Bt}return new t({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(t){this._destroySubtree(t)}async _loadTile(t){let e;try{this._onStartTileLoading(),e=await t.loadContent()}catch(n){this._onTileLoadError(t,n instanceof Error?n:new Error("load failed"))}finally{this._onEndTileLoading(),this._onTileLoad(t,e)}}_onTileLoadError(t,e){this.stats.get(qe).incrementCount();const n=e.message||e.toString(),r=t.url;console.error(`A 3D tile failed to load: ${t.url} ${n}`),this.options.onTileError(t,n,r)}_onTileLoad(t,e){if(e){if(this.type===U.I3S){const n=this.tileset?.nodePagesTile?.nodesInNodePages||0;this.stats.get(Nt).reset(),this.stats.get(Nt).addCount(n)}t&&t.content&&sr(t,t.content),this.updateContentTypes(t),this._addTileToCache(t),this.options.onTileLoad(t)}}updateContentTypes(t){if(this.type===U.I3S)switch(t.header.isDracoGeometry&&(this.contentFormats.draco=!0),t.header.textureFormat){case"dds":this.contentFormats.dds=!0;break;case"ktx2":this.contentFormats.ktx2=!0;break}else if(this.type===U.TILES3D){const{extensionsRemoved:e=[]}=t.content?.gltf||{};e.includes("KHR_draco_mesh_compression")&&(this.contentFormats.draco=!0),e.includes("EXT_meshopt_compression")&&(this.contentFormats.meshopt=!0),e.includes("KHR_texture_basisu")&&(this.contentFormats.ktx2=!0)}}_onStartTileLoading(){this._pendingCount++,this.stats.get(Wt).incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get(Wt).decrementCount()}_addTileToCache(t){this._cache.add(this,t,e=>e._updateCacheStats(t))}_updateCacheStats(t){this.stats.get(ze).incrementCount(),this.stats.get($t).incrementCount(),this.gpuMemoryUsageInBytes+=t.gpuMemoryUsageInBytes||0,this.stats.get(Yt).count=this.gpuMemoryUsageInBytes,this.options.memoryAdjustedScreenSpaceError&&this.adjustScreenSpaceError()}_unloadTile(t){this.gpuMemoryUsageInBytes-=t.gpuMemoryUsageInBytes||0,this.stats.get($t).decrementCount(),this.stats.get(Ge).incrementCount(),this.stats.get(Yt).count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(t),t.unloadContent()}_destroy(){const t=[];for(this.root&&t.push(this.root);t.length>0;){const e=t.pop();for(const n of e.children)t.push(n);this._destroyTile(e)}this.root=null}_destroySubtree(t){const e=t,n=[];for(n.push(e);n.length>0;){t=n.pop();for(const r of t.children)n.push(r);t!==e&&this._destroyTile(t)}e.children=[]}_destroyTile(t){this._cache.unloadTile(this,t),this._unloadTile(t),t.destroy()}_initializeTiles3DTileset(t){if(t.queryString){const e=new URLSearchParams(t.queryString),n=Object.fromEntries(e.entries());this._queryParams={...this._queryParams,...n}}if(this.asset=t.asset,!this.asset)throw new Error("Tileset must have an asset property.");if(this.asset.version!=="0.0"&&this.asset.version!=="1.0"&&this.asset.version!=="1.1")throw new Error("The tileset must be 3D Tiles version either 0.0 or 1.0 or 1.1.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=t.properties,this.geometricError=t.geometricError,this._extensionsUsed=t.extensionsUsed||[],this.extras=t.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}const As="4.3.3",wt={COMPOSITE:"cmpt",POINT_CLOUD:"pnts",BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",GLTF:"glTF"};function Ls(s,t,e){L(s instanceof ArrayBuffer);const n=new TextDecoder("utf8"),r=new Uint8Array(s,t,e);return n.decode(r)}function Ur(s,t=0){const e=new DataView(s);return`${String.fromCharCode(e.getUint8(t+0))}${String.fromCharCode(e.getUint8(t+1))}${String.fromCharCode(e.getUint8(t+2))}${String.fromCharCode(e.getUint8(t+3))}`}const Dr={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},A={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},y={...Dr,...A},Xt={[A.DOUBLE]:Float64Array,[A.FLOAT]:Float32Array,[A.UNSIGNED_SHORT]:Uint16Array,[A.UNSIGNED_INT]:Uint32Array,[A.UNSIGNED_BYTE]:Uint8Array,[A.BYTE]:Int8Array,[A.SHORT]:Int16Array,[A.INT]:Int32Array},vr={DOUBLE:A.DOUBLE,FLOAT:A.FLOAT,UNSIGNED_SHORT:A.UNSIGNED_SHORT,UNSIGNED_INT:A.UNSIGNED_INT,UNSIGNED_BYTE:A.UNSIGNED_BYTE,BYTE:A.BYTE,SHORT:A.SHORT,INT:A.INT},Qt="Failed to convert GL type";class Y{static fromTypedArray(t){t=ArrayBuffer.isView(t)?t.constructor:t;for(const e in Xt)if(Xt[e]===t)return e;throw new Error(Qt)}static fromName(t){const e=vr[t];if(!e)throw new Error(Qt);return e}static getArrayType(t){switch(t){case A.UNSIGNED_SHORT_5_6_5:case A.UNSIGNED_SHORT_4_4_4_4:case A.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const e=Xt[t];if(!e)throw new Error(Qt);return e}}static getByteSize(t){return Y.getArrayType(t).BYTES_PER_ELEMENT}static validate(t){return!!Y.getArrayType(t)}static createTypedArray(t,e,n=0,r){r===void 0&&(r=(e.byteLength-n)/Y.getByteSize(t));const i=Y.getArrayType(t);return new i(e,n,r)}}function xr(s,t){if(!s)throw new Error(`math.gl assertion failed. ${t}`)}function Vr(s,t=[0,0,0]){const e=s>>11&31,n=s>>5&63,r=s&31;return t[0]=e<<3,t[1]=n<<2,t[2]=r<<3,t}new he;new d;new he;new he;function Ze(s,t=255){return pn(s,0,t)/t*2-1}function je(s){return s<0?-1:1}function Br(s,t,e,n){if(xr(n),s<0||s>e||t<0||t>e)throw new Error(`x and y must be unsigned normalized integers between 0 and ${e}`);if(n.x=Ze(s,e),n.y=Ze(t,e),n.z=1-(Math.abs(n.x)+Math.abs(n.y)),n.z<0){const r=n.x;n.x=(1-Math.abs(n.y))*je(r),n.y=(1-Math.abs(r))*je(n.y)}return n.normalize()}function Fr(s,t,e){return Br(s,t,255,e)}class de{json;buffer;featuresLength=0;_cachedTypedArrays={};constructor(t,e){this.json=t,this.buffer=e}getExtension(t){return this.json.extensions&&this.json.extensions[t]}hasProperty(t){return!!this.json[t]}getGlobalProperty(t,e=y.UNSIGNED_INT,n=1){const r=this.json[t];return r&&Number.isFinite(r.byteOffset)?this._getTypedArrayFromBinary(t,e,n,1,r.byteOffset):r}getPropertyArray(t,e,n){const r=this.json[t];return r&&Number.isFinite(r.byteOffset)?("componentType"in r&&(e=Y.fromName(r.componentType)),this._getTypedArrayFromBinary(t,e,n,this.featuresLength,r.byteOffset)):this._getTypedArrayFromArray(t,e,r)}getProperty(t,e,n,r,i){const o=this.json[t];if(!o)return o;const a=this.getPropertyArray(t,e,n);if(n===1)return a[r];for(let l=0;l<n;++l)i[l]=a[n*r+l];return i}_getTypedArrayFromBinary(t,e,n,r,i){const o=this._cachedTypedArrays;let a=o[t];return a||(a=Y.createTypedArray(e,this.buffer.buffer,this.buffer.byteOffset+i,r*n),o[t]=a),a}_getTypedArrayFromArray(t,e,n){const r=this._cachedTypedArrays;let i=r[t];return i||(i=Y.createTypedArray(e,n),r[t]=i),i}}const zr={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Gr={SCALAR:(s,t)=>s[t],VEC2:(s,t)=>[s[2*t+0],s[2*t+1]],VEC3:(s,t)=>[s[3*t+0],s[3*t+1],s[3*t+2]],VEC4:(s,t)=>[s[4*t+0],s[4*t+1],s[4*t+2],s[4*t+3]],MAT2:(s,t)=>[s[4*t+0],s[4*t+1],s[4*t+2],s[4*t+3]],MAT3:(s,t)=>[s[9*t+0],s[9*t+1],s[9*t+2],s[9*t+3],s[9*t+4],s[9*t+5],s[9*t+6],s[9*t+7],s[9*t+8]],MAT4:(s,t)=>[s[16*t+0],s[16*t+1],s[16*t+2],s[16*t+3],s[16*t+4],s[16*t+5],s[16*t+6],s[16*t+7],s[16*t+8],s[16*t+9],s[16*t+10],s[16*t+11],s[16*t+12],s[16*t+13],s[16*t+14],s[16*t+15]]},qr={SCALAR:(s,t,e)=>{t[e]=s},VEC2:(s,t,e)=>{t[2*e+0]=s[0],t[2*e+1]=s[1]},VEC3:(s,t,e)=>{t[3*e+0]=s[0],t[3*e+1]=s[1],t[3*e+2]=s[2]},VEC4:(s,t,e)=>{t[4*e+0]=s[0],t[4*e+1]=s[1],t[4*e+2]=s[2],t[4*e+3]=s[3]},MAT2:(s,t,e)=>{t[4*e+0]=s[0],t[4*e+1]=s[1],t[4*e+2]=s[2],t[4*e+3]=s[3]},MAT3:(s,t,e)=>{t[9*e+0]=s[0],t[9*e+1]=s[1],t[9*e+2]=s[2],t[9*e+3]=s[3],t[9*e+4]=s[4],t[9*e+5]=s[5],t[9*e+6]=s[6],t[9*e+7]=s[7],t[9*e+8]=s[8],t[9*e+9]=s[9]},MAT4:(s,t,e)=>{t[16*e+0]=s[0],t[16*e+1]=s[1],t[16*e+2]=s[2],t[16*e+3]=s[3],t[16*e+4]=s[4],t[16*e+5]=s[5],t[16*e+6]=s[6],t[16*e+7]=s[7],t[16*e+8]=s[8],t[16*e+9]=s[9],t[16*e+10]=s[10],t[16*e+11]=s[11],t[16*e+12]=s[12],t[16*e+13]=s[13],t[16*e+14]=s[14],t[16*e+15]=s[15]}};function kr(s,t,e,n){const{componentType:r}=s;L(s.componentType);const i=typeof r=="string"?Y.fromName(r):r,o=zr[s.type],a=Gr[s.type],l=qr[s.type];return e+=s.byteOffset,{values:Y.createTypedArray(i,t,e,o*n),type:i,size:o,unpacker:a,packer:l}}const W=s=>s!==void 0;function Hr(s,t,e){if(!t)return null;let n=s.getExtension("3DTILES_batch_table_hierarchy");const r=t.HIERARCHY;return r&&(console.warn("3D Tile Parser: HIERARCHY is deprecated. Use 3DTILES_batch_table_hierarchy."),t.extensions=t.extensions||{},t.extensions["3DTILES_batch_table_hierarchy"]=r,n=r),n?Zr(n,e):null}function Zr(s,t){let e,n,r;const i=s.instancesLength,o=s.classes;let a=s.classIds,l=s.parentCounts,c=s.parentIds,h=i;W(a.byteOffset)&&(a.componentType=defaultValue(a.componentType,GL.UNSIGNED_SHORT),a.type=AttributeType.SCALAR,r=getBinaryAccessor(a),a=r.createArrayBufferView(t.buffer,t.byteOffset+a.byteOffset,i));let u;if(W(l))for(W(l.byteOffset)&&(l.componentType=defaultValue(l.componentType,GL.UNSIGNED_SHORT),l.type=AttributeType.SCALAR,r=getBinaryAccessor(l),l=r.createArrayBufferView(t.buffer,t.byteOffset+l.byteOffset,i)),u=new Uint16Array(i),h=0,e=0;e<i;++e)u[e]=h,h+=l[e];W(c)&&W(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,r=getBinaryAccessor(c),c=r.createArrayBufferView(t.buffer,t.byteOffset+c.byteOffset,h));const p=o.length;for(e=0;e<p;++e){const E=o[e].length,S=o[e].instances,C=getBinaryProperties(E,S,t);o[e].instances=combine(C,S)}const g=new Array(p).fill(0),m=new Uint16Array(i);for(e=0;e<i;++e)n=a[e],m[e]=g[n],++g[n];const T={classes:o,classIds:a,classIndexes:m,parentCounts:l,parentIndexes:u,parentIds:c};return Wr(T),T}function St(s,t,e){if(!s)return;const n=s.parentCounts;return s.parentIds?e(s,t):n>0?jr(s,t,e):$r(s,t,e)}function jr(s,t,e){const n=s.classIds,r=s.parentCounts,i=s.parentIds,o=s.parentIndexes,a=n.length,l=scratchVisited;l.length=Math.max(l.length,a);const c=++marker,h=scratchStack;for(h.length=0,h.push(t);h.length>0;){if(t=h.pop(),l[t]===c)continue;l[t]=c;const u=e(s,t);if(W(u))return u;const p=r[t],g=o[t];for(let m=0;m<p;++m){const T=i[g+m];T!==t&&h.push(T)}}return null}function $r(s,t,e){let n=!0;for(;n;){const r=e(s,t);if(W(r))return r;const i=s.parentIds[t];n=i!==t,t=i}throw new Error("traverseHierarchySingleParent")}function Wr(s){const e=s.classIds.length;for(let n=0;n<e;++n)Ms(s,n,stack)}function Ms(s,t,e){const n=s.parentCounts,r=s.parentIds,i=s.parentIndexes,a=s.classIds.length;if(!W(r))return;assert(t<a,`Parent index ${t} exceeds the total number of instances: ${a}`),assert(e.indexOf(t)===-1,"Circular dependency detected in the batch table hierarchy."),e.push(t);const l=W(n)?n[t]:1,c=W(n)?i[t]:t;for(let h=0;h<l;++h){const u=r[c+h];u!==t&&Ms(s,u,e)}e.pop(t)}function O(s){return s!=null}const Rt=(s,t)=>s,Yr={HIERARCHY:!0,extensions:!0,extras:!0};class Ns{json;binary;featureCount;_extensions;_properties;_binaryProperties;_hierarchy;constructor(t,e,n,r={}){L(n>=0),this.json=t||{},this.binary=e,this.featureCount=n,this._extensions=this.json?.extensions||{},this._properties={};for(const i in this.json)Yr[i]||(this._properties[i]=this.json[i]);this._binaryProperties=this._initializeBinaryProperties(),r["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=Hr(this,this.json,this.binary))}getExtension(t){return this.json&&this.json.extensions&&this.json.extensions[t]}memorySizeInBytes(){return 0}isClass(t,e){if(this._checkBatchId(t),L(typeof e=="string",e),this._hierarchy){const n=St(this._hierarchy,t,(r,i)=>{const o=r.classIds[i];return r.classes[o].name===e});return O(n)}return!1}isExactClass(t,e){return L(typeof e=="string",e),this.getExactClassName(t)===e}getExactClassName(t){if(this._checkBatchId(t),this._hierarchy){const e=this._hierarchy.classIds[t];return this._hierarchy.classes[e].name}}hasProperty(t,e){return this._checkBatchId(t),L(typeof e=="string",e),O(this._properties[e])||this._hasPropertyInHierarchy(t,e)}getPropertyNames(t,e){this._checkBatchId(t),e=O(e)?e:[],e.length=0;const n=Object.keys(this._properties);return e.push(...n),this._hierarchy&&this._getPropertyNamesInHierarchy(t,e),e}getProperty(t,e){if(this._checkBatchId(t),L(typeof e=="string",e),this._binaryProperties){const r=this._binaryProperties[e];if(O(r))return this._getBinaryProperty(r,t)}const n=this._properties[e];if(O(n))return Rt(n[t]);if(this._hierarchy){const r=this._getHierarchyProperty(t,e);if(O(r))return r}}setProperty(t,e,n){const r=this.featureCount;if(this._checkBatchId(t),L(typeof e=="string",e),this._binaryProperties){const o=this._binaryProperties[e];if(o){this._setBinaryProperty(o,t,n);return}}if(this._hierarchy&&this._setHierarchyProperty(this,t,e,n))return;let i=this._properties[e];O(i)||(this._properties[e]=new Array(r),i=this._properties[e]),i[t]=Rt(n)}_checkBatchId(t){if(!(t>=0&&t<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(t,e){return t.unpack(t.typedArray,e)}_setBinaryProperty(t,e,n){t.pack(n,t.typedArray,e)}_initializeBinaryProperties(){let t=null;for(const e in this._properties){const n=this._properties[e],r=this._initializeBinaryProperty(e,n);r&&(t=t||{},t[e]=r)}return t}_initializeBinaryProperty(t,e){if("byteOffset"in e){const n=e;L(this.binary,`Property ${t} requires a batch table binary.`),L(n.type,`Property ${t} requires a type.`);const r=kr(n,this.binary.buffer,this.binary.byteOffset|0,this.featureCount);return{typedArray:r.values,componentCount:r.size,unpack:r.unpacker,pack:r.packer}}return null}_hasPropertyInHierarchy(t,e){if(!this._hierarchy)return!1;const n=St(this._hierarchy,t,(r,i)=>{const o=r.classIds[i],a=r.classes[o].instances;return O(a[e])});return O(n)}_getPropertyNamesInHierarchy(t,e){St(this._hierarchy,t,(n,r)=>{const i=n.classIds[r],o=n.classes[i].instances;for(const a in o)o.hasOwnProperty(a)&&e.indexOf(a)===-1&&e.push(a)})}_getHierarchyProperty(t,e){return St(this._hierarchy,t,(n,r)=>{const i=n.classIds[r],o=n.classes[i],a=n.classIndexes[r],l=o.instances[e];return O(l)?O(l.typedArray)?this._getBinaryProperty(l,a):Rt(l[a]):null})}_setHierarchyProperty(t,e,n,r){const i=St(this._hierarchy,e,(o,a)=>{const l=o.classIds[a],c=o.classes[l],h=o.classIndexes[a],u=c.instances[n];return O(u)?(L(a===e,`Inherited property "${n}" is read-only.`),O(u.typedArray)?this._setBinaryProperty(u,h,r):u[h]=Rt(r),!0):!1});return O(i)}}const Jt=4;function Ft(s,t,e=0){const n=new DataView(t);if(s.magic=n.getUint32(e,!0),e+=Jt,s.version=n.getUint32(e,!0),e+=Jt,s.byteLength=n.getUint32(e,!0),e+=Jt,s.version!==1)throw new Error(`3D Tile Version ${s.version} not supported`);return e}const ut=4,$e="b3dm tile in legacy format.";function fe(s,t,e){const n=new DataView(t);let r;s.header=s.header||{};let i=n.getUint32(e,!0);e+=ut;let o=n.getUint32(e,!0);e+=ut;let a=n.getUint32(e,!0);e+=ut;let l=n.getUint32(e,!0);return e+=ut,a>=570425344?(e-=ut*2,r=i,a=o,l=0,i=0,o=0,console.warn($e)):l>=570425344&&(e-=ut,r=a,a=i,l=o,i=0,o=0,console.warn($e)),s.header.featureTableJsonByteLength=i,s.header.featureTableBinaryByteLength=o,s.header.batchTableJsonByteLength=a,s.header.batchTableBinaryByteLength=l,s.header.batchLength=r,e}function pe(s,t,e,n){return e=Xr(s,t,e),e=Qr(s,t,e),e}function Xr(s,t,e,n){const{featureTableJsonByteLength:r,featureTableBinaryByteLength:i,batchLength:o}=s.header||{};if(s.featureTableJson={BATCH_LENGTH:o||0},r&&r>0){const a=Ls(t,e,r);s.featureTableJson=JSON.parse(a)}return e+=r||0,s.featureTableBinary=new Uint8Array(t,e,i),e+=i||0,e}function Qr(s,t,e,n){const{batchTableJsonByteLength:r,batchTableBinaryByteLength:i}=s.header||{};if(r&&r>0){const o=Ls(t,e,r);s.batchTableJson=JSON.parse(o),e+=r,i&&i>0&&(s.batchTableBinary=new Uint8Array(t,e,i),s.batchTableBinary=new Uint8Array(s.batchTableBinary),e+=i)}return e}function Rs(s,t,e){if(!t&&(!s||!s.batchIds||!e))return null;const{batchIds:n,isRGB565:r,pointCount:i=0}=s;if(n&&e){const o=new Uint8ClampedArray(i*3);for(let a=0;a<i;a++){const l=n[a],h=e.getProperty(l,"dimensions").map(u=>u*255);o[a*3]=h[0],o[a*3+1]=h[1],o[a*3+2]=h[2]}return{type:y.UNSIGNED_BYTE,value:o,size:3,normalized:!0}}if(t&&r){const o=new Uint8ClampedArray(i*3);for(let a=0;a<i;a++){const l=Vr(t[a]);o[a*3]=l[0],o[a*3+1]=l[1],o[a*3+2]=l[2]}return{type:y.UNSIGNED_BYTE,value:o,size:3,normalized:!0}}return t&&t.length===i*3?{type:y.UNSIGNED_BYTE,value:t,size:3,normalized:!0}:{type:y.UNSIGNED_BYTE,value:t||new Uint8ClampedArray,size:4,normalized:!0}}const We=new d;function Jr(s,t){if(!t)return null;if(s.isOctEncoded16P){const e=new Float32Array((s.pointsLength||0)*3);for(let n=0;n<(s.pointsLength||0);n++)Fr(t[n*2],t[n*2+1],We),We.toArray(e,n*3);return{type:y.FLOAT,size:2,value:e}}return{type:y.FLOAT,size:2,value:t}}function Kr(s,t,e){return s.isQuantized?e["3d-tiles"]&&e["3d-tiles"].decodeQuantizedPositions?(s.isQuantized=!1,ti(s,t)):{type:y.UNSIGNED_SHORT,value:t,size:3,normalized:!0}:t}function ti(s,t){const e=new d,n=new Float32Array(s.pointCount*3);for(let r=0;r<s.pointCount;r++)e.set(t[r*3],t[r*3+1],t[r*3+2]).scale(1/s.quantizedRange).multiply(s.quantizedVolumeScale).add(s.quantizedVolumeOffset).toArray(n,r*3);return n}async function ei(s,t,e,n,r){e=Ft(s,t,e),e=fe(s,t,e),e=pe(s,t,e),si(s);const{featureTable:i,batchTable:o}=ni(s);return await ci(s,i,o,n,r),ri(s,i,n),ii(s,i,o),oi(s,i),e}function si(s){s.attributes={positions:null,colors:null,normals:null,batchIds:null},s.isQuantized=!1,s.isTranslucent=!1,s.isRGB565=!1,s.isOctEncoded16P=!1}function ni(s){const t=new de(s.featureTableJson,s.featureTableBinary),e=t.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(e))throw new Error("POINTS_LENGTH must be defined");t.featuresLength=e,s.featuresLength=e,s.pointsLength=e,s.pointCount=e,s.rtcCenter=t.getGlobalProperty("RTC_CENTER",y.FLOAT,3);const n=ai(s,t);return{featureTable:t,batchTable:n}}function ri(s,t,e){if(s.attributes=s.attributes||{positions:null,colors:null,normals:null,batchIds:null},!s.attributes.positions){if(t.hasProperty("POSITION"))s.attributes.positions=t.getPropertyArray("POSITION",y.FLOAT,3);else if(t.hasProperty("POSITION_QUANTIZED")){const n=t.getPropertyArray("POSITION_QUANTIZED",y.UNSIGNED_SHORT,3);if(s.isQuantized=!0,s.quantizedRange=65535,s.quantizedVolumeScale=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",y.FLOAT,3),!s.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(s.quantizedVolumeOffset=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",y.FLOAT,3),!s.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");s.attributes.positions=Kr(s,n,e)}}if(!s.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}function ii(s,t,e){if(s.attributes=s.attributes||{positions:null,colors:null,normals:null,batchIds:null},!s.attributes.colors){let n=null;t.hasProperty("RGBA")?(n=t.getPropertyArray("RGBA",y.UNSIGNED_BYTE,4),s.isTranslucent=!0):t.hasProperty("RGB")?n=t.getPropertyArray("RGB",y.UNSIGNED_BYTE,3):t.hasProperty("RGB565")&&(n=t.getPropertyArray("RGB565",y.UNSIGNED_SHORT,1),s.isRGB565=!0),s.attributes.colors=Rs(s,n,e)}t.hasProperty("CONSTANT_RGBA")&&(s.constantRGBA=t.getGlobalProperty("CONSTANT_RGBA",y.UNSIGNED_BYTE,4))}function oi(s,t){if(s.attributes=s.attributes||{positions:null,colors:null,normals:null,batchIds:null},!s.attributes.normals){let e=null;t.hasProperty("NORMAL")?e=t.getPropertyArray("NORMAL",y.FLOAT,3):t.hasProperty("NORMAL_OCT16P")&&(e=t.getPropertyArray("NORMAL_OCT16P",y.UNSIGNED_BYTE,2),s.isOctEncoded16P=!0),s.attributes.normals=Jr(s,e)}}function ai(s,t){let e=null;if(!s.batchIds&&t.hasProperty("BATCH_ID")&&(s.batchIds=t.getPropertyArray("BATCH_ID",y.UNSIGNED_SHORT,1),s.batchIds)){const n=t.getGlobalProperty("BATCH_LENGTH");if(!n)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:r,batchTableBinary:i}=s;e=new Ns(r,i,n)}return e}async function ci(s,t,e,n,r){let i,o,a;const l=s.batchTableJson&&s.batchTableJson.extensions&&s.batchTableJson.extensions["3DTILES_draco_point_compression"];l&&(a=l.properties);const c=t.getExtension("3DTILES_draco_point_compression");if(c){o=c.properties;const u=c.byteOffset,p=c.byteLength;if(!o||!Number.isFinite(u)||!p)throw new Error("Draco properties, byteOffset, and byteLength must be defined");i=(s.featureTableBinary||[]).slice(u,u+p),s.hasPositions=Number.isFinite(o.POSITION),s.hasColors=Number.isFinite(o.RGB)||Number.isFinite(o.RGBA),s.hasNormals=Number.isFinite(o.NORMAL),s.hasBatchIds=Number.isFinite(o.BATCH_ID),s.isTranslucent=Number.isFinite(o.RGBA)}if(!i)return!0;const h={buffer:i,properties:{...o,...a},batchTableProperties:a};return await li(s,h,n,r)}async function li(s,t,e,n){if(!n)return;const r={...e,draco:{...e?.draco,extraAttributes:t.batchTableProperties||{}}};delete r["3d-tiles"];const i=await le(t.buffer,En,r,n),o=i.attributes.POSITION&&i.attributes.POSITION.value,a=i.attributes.COLOR_0&&i.attributes.COLOR_0.value,l=i.attributes.NORMAL&&i.attributes.NORMAL.value,c=i.attributes.BATCH_ID&&i.attributes.BATCH_ID.value,h=o&&i.attributes.POSITION.value.quantization,u=l&&i.attributes.NORMAL.value.quantization;if(h){const g=i.POSITION.data.quantization,m=g.range;s.quantizedVolumeScale=new d(m,m,m),s.quantizedVolumeOffset=new d(g.minValues),s.quantizedRange=(1<<g.quantizationBits)-1,s.isQuantizedDraco=!0}u&&(s.octEncodedRange=(1<<i.NORMAL.data.quantization.quantizationBits)-1,s.isOctEncodedDraco=!0);const p={};if(t.batchTableProperties)for(const g of Object.keys(t.batchTableProperties))i.attributes[g]&&i.attributes[g].value&&(p[g.toLowerCase()]=i.attributes[g].value);s.attributes={positions:o,colors:Rs(s,a,void 0),normals:l,batchIds:c,...p}}const re={URI:0,EMBEDDED:1};function Ps(s,t,e,n){s.rotateYtoZ=!0;const r=(s.byteOffset||0)+(s.byteLength||0)-e;if(r===0)throw new Error("glTF byte length must be greater than 0.");return s.gltfUpAxis=n?.["3d-tiles"]&&n["3d-tiles"].assetGltfUpAxis?n["3d-tiles"].assetGltfUpAxis:"Y",s.gltfArrayBuffer=gn(t,e,r),s.gltfByteOffset=0,s.gltfByteLength=r,e%4===0||console.warn(`${s.type}: embedded glb is not aligned to a 4-byte boundary.`),(s.byteOffset||0)+(s.byteLength||0)}async function Os(s,t,e,n){const r=e?.["3d-tiles"]||{};if(hi(s,t),r.loadGLTF){if(!n)return;if(s.gltfUrl){const{fetch:i}=n,o=await i(s.gltfUrl,e);s.gltfArrayBuffer=await o.arrayBuffer(),s.gltfByteOffset=0}if(s.gltfArrayBuffer){const i=await le(s.gltfArrayBuffer,ds,e,n);s.gltf=fs(i),s.gpuMemoryUsageInBytes=ps(s.gltf),delete s.gltfArrayBuffer,delete s.gltfByteOffset,delete s.gltfByteLength}}}function hi(s,t,e){switch(t){case re.URI:if(s.gltfArrayBuffer){const n=new Uint8Array(s.gltfArrayBuffer,s.gltfByteOffset),i=new TextDecoder().decode(n);s.gltfUrl=i.replace(/[\s\0]+$/,"")}delete s.gltfArrayBuffer,delete s.gltfByteOffset,delete s.gltfByteLength;break;case re.EMBEDDED:break;default:throw new Error("b3dm: Illegal glTF format field")}}async function ui(s,t,e,n,r){e=di(s,t,e,n),await Os(s,re.EMBEDDED,n,r);const i=s?.gltf?.extensions;return i&&i.CESIUM_RTC&&(s.rtcCenter=i.CESIUM_RTC.center),e}function di(s,t,e,n,r){e=Ft(s,t,e),e=fe(s,t,e),e=pe(s,t,e),e=Ps(s,t,e,n);const i=new de(s.featureTableJson,s.featureTableBinary);return s.rtcCenter=i.getGlobalProperty("RTC_CENTER",y.FLOAT,3),e}async function fi(s,t,e,n,r){return e=pi(s,t,e,n),await Os(s,s.gltfFormat||0,n,r),e}function pi(s,t,e,n,r){if(e=Ft(s,t,e),s.version!==1)throw new Error(`Instanced 3D Model version ${s.version} is not supported`);e=fe(s,t,e);const i=new DataView(t);if(s.gltfFormat=i.getUint32(e,!0),e+=4,e=pe(s,t,e),e=Ps(s,t,e,n),!s?.header?.featureTableJsonByteLength||s.header.featureTableJsonByteLength===0)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const o=new de(s.featureTableJson,s.featureTableBinary),a=o.getGlobalProperty("INSTANCES_LENGTH");if(o.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");s.eastNorthUp=o.getGlobalProperty("EAST_NORTH_UP"),s.rtcCenter=o.getGlobalProperty("RTC_CENTER",y.FLOAT,3);const l=new Ns(s.batchTableJson,s.batchTableBinary,a);return gi(s,o,l,a),e}function gi(s,t,e,n){const r=new Array(n),i=new d;new d,new d,new d;const o=new ys,a=new Ts,l=new d,c={},h=new I,u=[],p=[],g=[],m=[];for(let T=0;T<n;T++){let E;if(t.hasProperty("POSITION"))E=t.getProperty("POSITION",y.FLOAT,3,T,i);else if(t.hasProperty("POSITION_QUANTIZED")){E=t.getProperty("POSITION_QUANTIZED",y.UNSIGNED_SHORT,3,T,i);const v=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",y.FLOAT,3);if(!v)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const J=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",y.FLOAT,3);if(!J)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const Z=65535;for(let M=0;M<3;M++)E[M]=E[M]/Z*J[M]+v[M]}if(!E)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");if(i.copy(E),c.translation=i,s.normalUp=t.getProperty("NORMAL_UP",y.FLOAT,3,T,u),s.normalRight=t.getProperty("NORMAL_RIGHT",y.FLOAT,3,T,p),s.normalUp){if(!s.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");s.hasCustomOrientation=!0}else{if(s.octNormalUp=t.getProperty("NORMAL_UP_OCT32P",y.UNSIGNED_SHORT,2,T,u),s.octNormalRight=t.getProperty("NORMAL_RIGHT_OCT32P",y.UNSIGNED_SHORT,2,T,p),s.octNormalUp)throw s.octNormalRight?new Error("i3dm: oct-encoded orientation not implemented"):new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");s.eastNorthUp?(b.WGS84.eastNorthUpToFixedFrame(i,h),h.getRotationMatrix3(o)):o.identity()}a.fromMatrix3(o),c.rotation=a,l.set(1,1,1);const S=t.getProperty("SCALE",y.FLOAT,1,T,g);Number.isFinite(S)&&l.multiplyByScalar(S);const C=t.getProperty("SCALE_NON_UNIFORM",y.FLOAT,3,T,u);C&&l.scale(C),c.scale=l;let N=t.getProperty("BATCH_ID",y.UNSIGNED_SHORT,1,T,m);N===void 0&&(N=T);const V=new I().fromQuaternion(c.rotation);h.identity(),h.translate(c.translation),h.multiplyRight(V),h.scale(c.scale);const B=h.clone();r[T]={modelMatrix:B,batchId:N}}s.instances=r}async function mi(s,t,e,n,r,i){e=Ft(s,t,e);const o=new DataView(t);for(s.tilesLength=o.getUint32(e,!0),e+=4,s.tiles=[];s.tiles.length<s.tilesLength&&(s.byteLength||0)-e>12;){const a={shape:"tile3d"};s.tiles.push(a),e=await i(t,e,n,r,a)}return e}async function Ti(s,t,e,n){if(s.rotateYtoZ=!0,s.gltfUpAxis=e?.["3d-tiles"]?.assetGltfUpAxis?e["3d-tiles"].assetGltfUpAxis:"Y",e?.["3d-tiles"]?.loadGLTF){if(!n)return t.byteLength;const r=await le(t,ds,e,n);s.gltf=fs(r),s.gpuMemoryUsageInBytes=ps(s.gltf)}else s.gltfArrayBuffer=t;return t.byteLength}async function Us(s,t=0,e,n,r={shape:"tile3d"}){switch(r.byteOffset=t,r.type=Ur(s,t),r.type){case wt.COMPOSITE:return await mi(r,s,t,e,n,Us);case wt.BATCHED_3D_MODEL:return await ui(r,s,t,e,n);case wt.GLTF:return await Ti(r,s,e,n);case wt.INSTANCED_3D_MODEL:return await fi(r,s,t,e,n);case wt.POINT_CLOUD:return await ei(r,s,t,e,n);default:throw new Error(`3DTileLoader: unknown type ${r.type}`)}}const yi=1952609651,_i=1;async function wi(s,t,e){if(new Uint32Array(s.slice(0,4))[0]!==yi)throw new Error("Wrong subtree file magic number");if(new Uint32Array(s.slice(4,8))[0]!==_i)throw new Error("Wrong subtree file verson, must be 1");const i=Ye(s.slice(8,16)),o=new Uint8Array(s,24,i),l=new TextDecoder("utf8").decode(o),c=JSON.parse(l),h=Ye(s.slice(16,24));let u=new ArrayBuffer(0);if(h&&(u=s.slice(24+i)),await Pt(c,c.tileAvailability,u,e),Array.isArray(c.contentAvailability))for(const p of c.contentAvailability)await Pt(c,p,u,e);else await Pt(c,c.contentAvailability,u,e);return await Pt(c,c.childSubtreeAvailability,u,e),c}async function Pt(s,t,e,n){const r=Number.isFinite(t.bitstream)?t.bitstream:t.bufferView;if(typeof r!="number")return;const i=s.bufferViews[r],o=s.buffers[i.buffer];if(!n?.baseUrl)throw new Error("Url is not provided");if(!n.fetch)throw new Error("fetch is not provided");if(o.uri){const l=`${n?.baseUrl||""}/${o.uri}`,h=await(await n.fetch(l)).arrayBuffer();t.explicitBitstream=new Uint8Array(h,i.byteOffset,i.byteLength);return}const a=s.buffers.slice(0,i.buffer).reduce((l,c)=>l+c.byteLength,0);t.explicitBitstream=new Uint8Array(e.slice(a,a+o.byteLength),i.byteOffset,i.byteLength)}function Ye(s){const t=new DataView(s),e=t.getUint32(0,!0),n=t.getUint32(4,!0);return e+2**32*n}const Ds={dataType:null,batchType:null,id:"3d-tiles-subtree",name:"3D Tiles Subtree",module:"3d-tiles",version:As,extensions:["subtree"],mimeTypes:["application/octet-stream"],tests:["subtree"],parse:wi,options:{}};var F=null;try{F=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch{}function w(s,t,e){this.low=s|0,this.high=t|0,this.unsigned=!!e}w.prototype.__isLong__;Object.defineProperty(w.prototype,"__isLong__",{value:!0});function P(s){return(s&&s.__isLong__)===!0}function Xe(s){var t=Math.clz32(s&-s);return s?31-t:t}w.isLong=P;var Qe={},Je={};function ot(s,t){var e,n,r;return t?(s>>>=0,(r=0<=s&&s<256)&&(n=Je[s],n)?n:(e=_(s,0,!0),r&&(Je[s]=e),e)):(s|=0,(r=-128<=s&&s<128)&&(n=Qe[s],n)?n:(e=_(s,s<0?-1:0,!1),r&&(Qe[s]=e),e))}w.fromInt=ot;function z(s,t){if(isNaN(s))return t?Q:k;if(t){if(s<0)return Q;if(s>=vs)return Bs}else{if(s<=-ts)return D;if(s+1>=ts)return Vs}return s<0?z(-s,t).neg():_(s%mt|0,s/mt|0,t)}w.fromNumber=z;function _(s,t,e){return new w(s,t,e)}w.fromBits=_;var xt=Math.pow;function ge(s,t,e){if(s.length===0)throw Error("empty string");if(typeof t=="number"?(e=t,t=!1):t=!!t,s==="NaN"||s==="Infinity"||s==="+Infinity"||s==="-Infinity")return t?Q:k;if(e=e||10,e<2||36<e)throw RangeError("radix");var n;if((n=s.indexOf("-"))>0)throw Error("interior hyphen");if(n===0)return ge(s.substring(1),t,e).neg();for(var r=z(xt(e,8)),i=k,o=0;o<s.length;o+=8){var a=Math.min(8,s.length-o),l=parseInt(s.substring(o,o+a),e);if(a<8){var c=z(xt(e,a));i=i.mul(c).add(z(l))}else i=i.mul(r),i=i.add(z(l))}return i.unsigned=t,i}w.fromString=ge;function G(s,t){return typeof s=="number"?z(s,t):typeof s=="string"?ge(s,t):_(s.low,s.high,typeof t=="boolean"?t:s.unsigned)}w.fromValue=G;var Ke=65536,Si=1<<24,mt=Ke*Ke,vs=mt*mt,ts=vs/2,es=ot(Si),k=ot(0);w.ZERO=k;var Q=ot(0,!0);w.UZERO=Q;var pt=ot(1);w.ONE=pt;var xs=ot(1,!0);w.UONE=xs;var ie=ot(-1);w.NEG_ONE=ie;var Vs=_(-1,2147483647,!1);w.MAX_VALUE=Vs;var Bs=_(-1,-1,!0);w.MAX_UNSIGNED_VALUE=Bs;var D=_(0,-2147483648,!1);w.MIN_VALUE=D;var f=w.prototype;f.toInt=function(){return this.unsigned?this.low>>>0:this.low};f.toNumber=function(){return this.unsigned?(this.high>>>0)*mt+(this.low>>>0):this.high*mt+(this.low>>>0)};f.toString=function(t){if(t=t||10,t<2||36<t)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative())if(this.eq(D)){var e=z(t),n=this.div(e),r=n.mul(e).sub(this);return n.toString(t)+r.toInt().toString(t)}else return"-"+this.neg().toString(t);for(var i=z(xt(t,6),this.unsigned),o=this,a="";;){var l=o.div(i),c=o.sub(l.mul(i)).toInt()>>>0,h=c.toString(t);if(o=l,o.isZero())return h+a;for(;h.length<6;)h="0"+h;a=""+h+a}};f.getHighBits=function(){return this.high};f.getHighBitsUnsigned=function(){return this.high>>>0};f.getLowBits=function(){return this.low};f.getLowBitsUnsigned=function(){return this.low>>>0};f.getNumBitsAbs=function(){if(this.isNegative())return this.eq(D)?64:this.neg().getNumBitsAbs();for(var t=this.high!=0?this.high:this.low,e=31;e>0&&(t&1<<e)==0;e--);return this.high!=0?e+33:e+1};f.isSafeInteger=function(){var t=this.high>>21;return t?this.unsigned?!1:t===-1&&!(this.low===0&&this.high===-2097152):!0};f.isZero=function(){return this.high===0&&this.low===0};f.eqz=f.isZero;f.isNegative=function(){return!this.unsigned&&this.high<0};f.isPositive=function(){return this.unsigned||this.high>=0};f.isOdd=function(){return(this.low&1)===1};f.isEven=function(){return(this.low&1)===0};f.equals=function(t){return P(t)||(t=G(t)),this.unsigned!==t.unsigned&&this.high>>>31===1&&t.high>>>31===1?!1:this.high===t.high&&this.low===t.low};f.eq=f.equals;f.notEquals=function(t){return!this.eq(t)};f.neq=f.notEquals;f.ne=f.notEquals;f.lessThan=function(t){return this.comp(t)<0};f.lt=f.lessThan;f.lessThanOrEqual=function(t){return this.comp(t)<=0};f.lte=f.lessThanOrEqual;f.le=f.lessThanOrEqual;f.greaterThan=function(t){return this.comp(t)>0};f.gt=f.greaterThan;f.greaterThanOrEqual=function(t){return this.comp(t)>=0};f.gte=f.greaterThanOrEqual;f.ge=f.greaterThanOrEqual;f.compare=function(t){if(P(t)||(t=G(t)),this.eq(t))return 0;var e=this.isNegative(),n=t.isNegative();return e&&!n?-1:!e&&n?1:this.unsigned?t.high>>>0>this.high>>>0||t.high===this.high&&t.low>>>0>this.low>>>0?-1:1:this.sub(t).isNegative()?-1:1};f.comp=f.compare;f.negate=function(){return!this.unsigned&&this.eq(D)?D:this.not().add(pt)};f.neg=f.negate;f.add=function(t){P(t)||(t=G(t));var e=this.high>>>16,n=this.high&65535,r=this.low>>>16,i=this.low&65535,o=t.high>>>16,a=t.high&65535,l=t.low>>>16,c=t.low&65535,h=0,u=0,p=0,g=0;return g+=i+c,p+=g>>>16,g&=65535,p+=r+l,u+=p>>>16,p&=65535,u+=n+a,h+=u>>>16,u&=65535,h+=e+o,h&=65535,_(p<<16|g,h<<16|u,this.unsigned)};f.subtract=function(t){return P(t)||(t=G(t)),this.add(t.neg())};f.sub=f.subtract;f.multiply=function(t){if(this.isZero())return this;if(P(t)||(t=G(t)),F){var e=F.mul(this.low,this.high,t.low,t.high);return _(e,F.get_high(),this.unsigned)}if(t.isZero())return this.unsigned?Q:k;if(this.eq(D))return t.isOdd()?D:k;if(t.eq(D))return this.isOdd()?D:k;if(this.isNegative())return t.isNegative()?this.neg().mul(t.neg()):this.neg().mul(t).neg();if(t.isNegative())return this.mul(t.neg()).neg();if(this.lt(es)&&t.lt(es))return z(this.toNumber()*t.toNumber(),this.unsigned);var n=this.high>>>16,r=this.high&65535,i=this.low>>>16,o=this.low&65535,a=t.high>>>16,l=t.high&65535,c=t.low>>>16,h=t.low&65535,u=0,p=0,g=0,m=0;return m+=o*h,g+=m>>>16,m&=65535,g+=i*h,p+=g>>>16,g&=65535,g+=o*c,p+=g>>>16,g&=65535,p+=r*h,u+=p>>>16,p&=65535,p+=i*c,u+=p>>>16,p&=65535,p+=o*l,u+=p>>>16,p&=65535,u+=n*h+r*c+i*l+o*a,u&=65535,_(g<<16|m,u<<16|p,this.unsigned)};f.mul=f.multiply;f.divide=function(t){if(P(t)||(t=G(t)),t.isZero())throw Error("division by zero");if(F){if(!this.unsigned&&this.high===-2147483648&&t.low===-1&&t.high===-1)return this;var e=(this.unsigned?F.div_u:F.div_s)(this.low,this.high,t.low,t.high);return _(e,F.get_high(),this.unsigned)}if(this.isZero())return this.unsigned?Q:k;var n,r,i;if(this.unsigned){if(t.unsigned||(t=t.toUnsigned()),t.gt(this))return Q;if(t.gt(this.shru(1)))return xs;i=Q}else{if(this.eq(D)){if(t.eq(pt)||t.eq(ie))return D;if(t.eq(D))return pt;var o=this.shr(1);return n=o.div(t).shl(1),n.eq(k)?t.isNegative()?pt:ie:(r=this.sub(t.mul(n)),i=n.add(r.div(t)),i)}else if(t.eq(D))return this.unsigned?Q:k;if(this.isNegative())return t.isNegative()?this.neg().div(t.neg()):this.neg().div(t).neg();if(t.isNegative())return this.div(t.neg()).neg();i=k}for(r=this;r.gte(t);){n=Math.max(1,Math.floor(r.toNumber()/t.toNumber()));for(var a=Math.ceil(Math.log(n)/Math.LN2),l=a<=48?1:xt(2,a-48),c=z(n),h=c.mul(t);h.isNegative()||h.gt(r);)n-=l,c=z(n,this.unsigned),h=c.mul(t);c.isZero()&&(c=pt),i=i.add(c),r=r.sub(h)}return i};f.div=f.divide;f.modulo=function(t){if(P(t)||(t=G(t)),F){var e=(this.unsigned?F.rem_u:F.rem_s)(this.low,this.high,t.low,t.high);return _(e,F.get_high(),this.unsigned)}return this.sub(this.div(t).mul(t))};f.mod=f.modulo;f.rem=f.modulo;f.not=function(){return _(~this.low,~this.high,this.unsigned)};f.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32};f.clz=f.countLeadingZeros;f.countTrailingZeros=function(){return this.low?Xe(this.low):Xe(this.high)+32};f.ctz=f.countTrailingZeros;f.and=function(t){return P(t)||(t=G(t)),_(this.low&t.low,this.high&t.high,this.unsigned)};f.or=function(t){return P(t)||(t=G(t)),_(this.low|t.low,this.high|t.high,this.unsigned)};f.xor=function(t){return P(t)||(t=G(t)),_(this.low^t.low,this.high^t.high,this.unsigned)};f.shiftLeft=function(t){return P(t)&&(t=t.toInt()),(t&=63)===0?this:t<32?_(this.low<<t,this.high<<t|this.low>>>32-t,this.unsigned):_(0,this.low<<t-32,this.unsigned)};f.shl=f.shiftLeft;f.shiftRight=function(t){return P(t)&&(t=t.toInt()),(t&=63)===0?this:t<32?_(this.low>>>t|this.high<<32-t,this.high>>t,this.unsigned):_(this.high>>t-32,this.high>=0?0:-1,this.unsigned)};f.shr=f.shiftRight;f.shiftRightUnsigned=function(t){return P(t)&&(t=t.toInt()),(t&=63)===0?this:t<32?_(this.low>>>t|this.high<<32-t,this.high>>>t,this.unsigned):t===32?_(this.high,0,this.unsigned):_(this.high>>>t-32,0,this.unsigned)};f.shru=f.shiftRightUnsigned;f.shr_u=f.shiftRightUnsigned;f.rotateLeft=function(t){var e;return P(t)&&(t=t.toInt()),(t&=63)===0?this:t===32?_(this.high,this.low,this.unsigned):t<32?(e=32-t,_(this.low<<t|this.high>>>e,this.high<<t|this.low>>>e,this.unsigned)):(t-=32,e=32-t,_(this.high<<t|this.low>>>e,this.low<<t|this.high>>>e,this.unsigned))};f.rotl=f.rotateLeft;f.rotateRight=function(t){var e;return P(t)&&(t=t.toInt()),(t&=63)===0?this:t===32?_(this.high,this.low,this.unsigned):t<32?(e=32-t,_(this.high<<e|this.low>>>t,this.low<<e|this.high>>>t,this.unsigned)):(t-=32,e=32-t,_(this.low<<e|this.high>>>t,this.high<<e|this.low>>>t,this.unsigned))};f.rotr=f.rotateRight;f.toSigned=function(){return this.unsigned?_(this.low,this.high,!1):this};f.toUnsigned=function(){return this.unsigned?this:_(this.low,this.high,!0)};f.toBytes=function(t){return t?this.toBytesLE():this.toBytesBE()};f.toBytesLE=function(){var t=this.high,e=this.low;return[e&255,e>>>8&255,e>>>16&255,e>>>24,t&255,t>>>8&255,t>>>16&255,t>>>24]};f.toBytesBE=function(){var t=this.high,e=this.low;return[t>>>24,t>>>16&255,t>>>8&255,t&255,e>>>24,e>>>16&255,e>>>8&255,e&255]};w.fromBytes=function(t,e,n){return n?w.fromBytesLE(t,e):w.fromBytesBE(t,e)};w.fromBytesLE=function(t,e){return new w(t[0]|t[1]<<8|t[2]<<16|t[3]<<24,t[4]|t[5]<<8|t[6]<<16|t[7]<<24,e)};w.fromBytesBE=function(t,e){return new w(t[4]<<24|t[5]<<16|t[6]<<8|t[7],t[0]<<24|t[1]<<16|t[2]<<8|t[3],e)};typeof BigInt=="function"&&(w.fromBigInt=function(t,e){var n=Number(BigInt.asIntN(32,t)),r=Number(BigInt.asIntN(32,t>>BigInt(32)));return _(n,r,e)},w.fromValue=function(t,e){return typeof t=="bigint"?w.fromBigInt(t,e):G(t,e)},f.toBigInt=function(){var t=BigInt(this.low>>>0),e=BigInt(this.unsigned?this.high>>>0:this.high);return e<<BigInt(32)|t});const Ei=16;function Fs(s){s==="X"&&(s="");const t=s.padEnd(Ei,"0");return w.fromString(t,!0,16)}function bi(s){if(s.isZero())return"X";let t=s.countTrailingZeros();const e=t%4;t=(t-e)/4;const n=t;t*=4;const i=s.shiftRightUnsigned(t).toString(16).replace(/0+$/,"");return Array(17-n-i.length).join("0")+i}function Ci(s,t){const e=Ii(s).shiftRightUnsigned(2);return s.add(w.fromNumber(2*t+1-4).multiply(e))}function Ii(s){return s.and(s.not().add(1))}const Ai=3,Li=30,Mi=2*Li+1,ss=180/Math.PI;function Ni(s){if(s.length===0)throw new Error(`Invalid Hilbert quad key ${s}`);const t=s.split("/"),e=parseInt(t[0],10),n=t[1],r=n.length;let i=0;const o=[0,0];for(let a=r-1;a>=0;a--){i=r-a;const l=n[a];let c=0,h=0;l==="1"?h=1:l==="2"?(c=1,h=1):l==="3"&&(c=1);const u=Math.pow(2,i-1);Pi(u,o,c,h),o[0]+=u*c,o[1]+=u*h}if(e%2===1){const a=o[0];o[0]=o[1],o[1]=a}return{face:e,ij:o,level:i}}function Ri(s){if(s.isZero())return"";let t=s.toString(2);for(;t.length<Ai+Mi;)t="0"+t;const e=t.lastIndexOf("1"),n=t.substring(0,3),r=t.substring(3,e),i=r.length/2,o=w.fromString(n,!0,2).toString(10);let a="";if(i!==0)for(a=w.fromString(r,!0,2).toString(4);a.length<i;)a="0"+a;return`${o}/${a}`}function zs(s,t,e){const n=1<<t;return[(s[0]+e[0])/n,(s[1]+e[1])/n]}function ns(s){return s>=.5?1/3*(4*s*s-1):1/3*(1-4*(1-s)*(1-s))}function Gs(s){return[ns(s[0]),ns(s[1])]}function qs(s,[t,e]){switch(s){case 0:return[1,t,e];case 1:return[-t,1,e];case 2:return[-t,-e,1];case 3:return[-1,-e,-t];case 4:return[e,-1,-t];case 5:return[e,t,-1];default:throw new Error("Invalid face")}}function ks([s,t,e]){const n=Math.atan2(e,Math.sqrt(s*s+t*t));return[Math.atan2(t,s)*ss,n*ss]}function Pi(s,t,e,n){if(n===0){e===1&&(t[0]=s-1-t[0],t[1]=s-1-t[1]);const r=t[0];t[0]=t[1],t[1]=r}}function Oi(s){const t=zs(s.ij,s.level,[.5,.5]),e=Gs(t),n=qs(s.face,e);return ks(n)}const Ui=100;function rs(s){const{face:t,ij:e,level:n}=s,r=[[0,0],[0,1],[1,1],[1,0],[0,0]],i=Math.max(1,Math.ceil(Ui*Math.pow(2,-n))),o=new Float64Array(4*i*2+2);let a=0,l=0;for(let c=0;c<4;c++){const h=r[c].slice(0),u=r[c+1],p=(u[0]-h[0])/i,g=(u[1]-h[1])/i;for(let m=0;m<i;m++){h[0]+=p,h[1]+=g;const T=zs(e,n,h),E=Gs(T),S=qs(t,E),C=ks(S);Math.abs(C[1])>89.999&&(C[0]=l);const N=C[0]-l;C[0]+=N>180?-360:N<-180?360:0,o[a++]=C[0],o[a++]=C[1],l=C[0]}}return o[a++]=o[0],o[a++]=o[1],o}function me(s){const t=Di(s);return Ni(t)}function Di(s){if(s.indexOf("/")>0)return s;const t=Fs(s);return Ri(t)}function vi(s){const t=me(s);return Oi(t)}function xi(s){let t;if(s.face===2||s.face===5){let e=null,n=0;for(let r=0;r<4;r++){const i=`${s.face}/${r}`,o=me(i),a=rs(o);(typeof e>"u"||e===null)&&(e=new Float64Array(4*a.length)),e.set(a,n),n+=a.length}t=is(e)}else{const e=rs(s);t=is(e)}return t}function is(s){if(s.length%2!==0)throw new Error("Invalid corners");const t=[],e=[];for(let n=0;n<s.length;n+=2)t.push(s[n]),e.push(s[n+1]);return t.sort((n,r)=>n-r),e.sort((n,r)=>n-r),{west:t[0],east:t[t.length-1],north:e[e.length-1],south:e[0]}}function Vi(s,t){const e=t?.minimumHeight||0,n=t?.maximumHeight||0,r=me(s),i=xi(r),o=i.west,a=i.south,l=i.east,c=i.north,h=[];return h.push(new d(o,c,e)),h.push(new d(l,c,e)),h.push(new d(l,a,e)),h.push(new d(o,a,e)),h.push(new d(o,c,n)),h.push(new d(l,c,n)),h.push(new d(l,a,n)),h.push(new d(o,a,n)),h}function Hs(s){const t=s.token,e={minimumHeight:s.minimumHeight,maximumHeight:s.maximumHeight},n=Vi(t,e),r=vi(t),i=r[0],o=r[1],a=b.WGS84.cartographicToCartesian([i,o,e.maximumHeight]),l=new d(a[0],a[1],a[2]);n.push(l);const c=Nn(n);return[...c.center,...c.halfAxes]}const Bi=4,Fi=8,zi={QUADTREE:Bi,OCTREE:Fi};function Gi(s,t,e){if(s?.box){const n=Fs(s.s2VolumeInfo.token),r=Ci(n,t),i=bi(r),o={...s.s2VolumeInfo};if(o.token=i,e==="OCTREE"){const c=s.s2VolumeInfo,h=c.maximumHeight-c.minimumHeight,u=h/2,p=c.minimumHeight+h/2;c.minimumHeight=p-u,c.maximumHeight=p+u}return{box:Hs(o),s2VolumeInfo:o}}}async function Zs(s){const{subtree:t,subtreeData:e={level:0,x:0,y:0,z:0},parentData:n={mortonIndex:0,localLevel:-1,localX:0,localY:0,localZ:0},childIndex:r=0,implicitOptions:i,loaderOptions:o,s2VolumeBox:a}=s,{subdivisionScheme:l,subtreeLevels:c,maximumLevel:h,contentUrlTemplate:u,subtreesUriTemplate:p,basePath:g}=i,m={children:[],lodMetricValue:0,contentUrl:""};if(!h)return _s.once(`Missing 'maximumLevel' or 'availableLevels' property. The subtree ${u} won't be loaded...`),m;const T=n.localLevel+1,E=e.level+T;if(E>h)return m;const S=zi[l],C=Math.log2(S),N=r&1,V=r>>1&1,B=r>>2&1,v=rt(n.localX,N,1),J=rt(n.localY,V,1),Z=rt(n.localZ,B,1),M=rt(e.x,v,T),j=rt(e.y,J,T),K=rt(e.z,Z,T),at=rt(n.mortonIndex,r,C),bt=T===c&&Kt(t.childSubtreeAvailability,at);let tt,Tt,yt,ct;if(bt){const et=`${g}/${p}`,Ct=oe(et,E,M,j,K);tt=await Et(Ct,Ds,o),ct=0,Tt={level:E,x:M,y:j,z:K},yt={mortonIndex:0,localLevel:0,localX:0,localY:0,localZ:0}}else tt=t,ct=(S**T-1)/(S-1)+at,Tt=e,yt={mortonIndex:at,localLevel:T,localX:v,localY:J,localZ:Z};if(!Kt(tt.tileAvailability,ct))return m;Kt(tt.contentAvailability,ct)&&(m.contentUrl=oe(u,E,M,j,K));for(let et=0;et<S;et++){const Ct=Gi(a,et,l),It=await Zs({subtree:tt,subtreeData:Tt,parentData:yt,childIndex:et,implicitOptions:i,loaderOptions:o,s2VolumeBox:Ct});(It.contentUrl||It.children.length)&&m.children.push(It)}return m.contentUrl||m.children.length?qi(m,{level:E,x:M,y:j,z:K},i,a):m}function Kt(s,t){let e;return Array.isArray(s)?(e=s[0],s.length>1&&_s.once('Not supported extension "3DTILES_multiple_contents" has been detected')):e=s,"constant"in e?!!e.constant:e.explicitBitstream?Zi(t,e.explicitBitstream):!1}function qi(s,t,e,n){const{basePath:r,refine:i,getRefine:o,lodMetricType:a,getTileType:l,rootLodMetricValue:c,rootBoundingVolume:h}=e,u=s.contentUrl&&s.contentUrl.replace(`${r}/`,""),p=c/2**t.level,g=n?.box?{box:n.box}:h,m=ki(g,t,e.subdivisionScheme);return{children:s.children,contentUrl:s.contentUrl,content:{uri:u},id:s.contentUrl,refine:o(i),type:l(s),lodMetricType:a,lodMetricValue:p,geometricError:p,transform:s.transform,boundingVolume:m}}function ki(s,t,e){if(s.region){const{level:n,x:r,y:i,z:o}=t,[a,l,c,h,u,p]=s.region,g=2**n,m=(c-a)/g,[T,E]=[a+m*r,a+m*(r+1)],S=(h-l)/g,[C,N]=[l+S*i,l+S*(i+1)];let V,B;if(e==="OCTREE"){const v=(p-u)/g;[V,B]=[u+v*o,u+v*(o+1)]}else[V,B]=[u,p];return{region:[T,C,E,N,V,B]}}if(s.box)return s;throw new Error(`Unsupported bounding volume type ${JSON.stringify(s)}`)}function rt(s,t,e){return(s<<e)+t}function oe(s,t,e,n,r){const i=Hi({level:t,x:e,y:n,z:r});return s.replace(/{level}|{x}|{y}|{z}/gi,o=>i[o])}function Hi(s){const t={};for(const e in s)t[`{${e}}`]=s[e];return t}function Zi(s,t){const e=Math.floor(s/8),n=s%8;return(t[e]>>n&1)===1}function Te(s,t=""){if(!t)return X.EMPTY;const n=t.split("?")[0].split(".").pop();switch(n){case"pnts":return X.POINTCLOUD;case"i3dm":case"b3dm":case"glb":case"gltf":return X.SCENEGRAPH;default:return n||X.EMPTY}}function ye(s){switch(s){case"REPLACE":case"replace":return H.REPLACE;case"ADD":case"add":return H.ADD;default:return s}}function ae(s,t){if(/^[a-z][0-9a-z+.-]*:/i.test(t)){const n=new URL(s,`${t}/`);return decodeURI(n.toString())}else if(s.startsWith("/"))return s;return mn(t,s)}function os(s,t){if(!s)return null;let e;if(s.content){const r=s.content.uri||s.content?.url;typeof r<"u"&&(e=ae(r,t))}return{...s,id:e,contentUrl:e,lodMetricType:gt.GEOMETRIC_ERROR,lodMetricValue:s.geometricError,transformMatrix:s.transform,type:Te(s,e),refine:ye(s.refine)}}async function ji(s,t,e){let n=null;const r=cs(s.root);r&&s.root?n=await as(s.root,s,t,r,e):n=os(s.root,t);const i=[];for(i.push(n);i.length>0;){const o=i.pop()||{},a=o.children||[],l=[];for(const c of a){const h=cs(c);let u;h?u=await as(c,s,t,h,e):u=os(c,t),u&&(l.push(u),i.push(u))}o.children=l}return n}async function as(s,t,e,n,r){const{subdivisionScheme:i,maximumLevel:o,availableLevels:a,subtreeLevels:l,subtrees:{uri:c}}=n,h=oe(c,0,0,0,0),u=ae(h,e),p=await Et(u,Ds,r),g=s.content?.uri,m=g?ae(g,e):"",T=t?.root?.refine,E=s.geometricError,S=s.boundingVolume.extensions?.["3DTILES_bounding_volume_S2"];if(S){const B={box:Hs(S),s2VolumeInfo:S};s.boundingVolume=B}const C=s.boundingVolume,N={contentUrlTemplate:m,subtreesUriTemplate:c,subdivisionScheme:i,subtreeLevels:l,maximumLevel:Number.isFinite(a)?a-1:o,refine:T,basePath:e,lodMetricType:gt.GEOMETRIC_ERROR,rootLodMetricValue:E,rootBoundingVolume:C,getTileType:Te,getRefine:ye};return await $i(s,e,p,N,r)}async function $i(s,t,e,n,r){if(!s)return null;const{children:i,contentUrl:o}=await Zs({subtree:e,implicitOptions:n,loaderOptions:r});let a,l=null;return o&&(a=o,l={uri:o.replace(`${t}/`,"")}),{...s,id:a,contentUrl:a,lodMetricType:gt.GEOMETRIC_ERROR,lodMetricValue:s.geometricError,transformMatrix:s.transform,type:Te(s,a),refine:ye(s.refine),content:l||s.content,children:i}}function cs(s){return s?.extensions?.["3DTILES_implicit_tiling"]||s?.implicitTiling}const js={dataType:null,batchType:null,id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:As,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:Wi,options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}};async function Wi(s,t={},e){const n=t["3d-tiles"]||{};let r;return n.isTileset==="auto"?r=e?.url&&e.url.indexOf(".json")!==-1:r=n.isTileset,r?Yi(s,t,e):Xi(s,t,e)}async function Yi(s,t,e){const n=JSON.parse(new TextDecoder().decode(s)),r=e?.url||"",i=Qi(r),o=await ji(n,i,t||{});return{...n,shape:"tileset3d",loader:js,url:r,queryString:e?.queryString||"",basePath:i,root:o||n.root,type:U.TILES3D,lodMetricType:gt.GEOMETRIC_ERROR,lodMetricValue:n.root?.geometricError||0}}async function Xi(s,t,e){const n={content:{shape:"tile3d",featureIds:null}};return await Us(s,0,t,e,n.content),n.content}function Qi(s){return us(s)}const ls=[0],Ji={getPointColor:{type:"accessor",value:[0,0,0,255]},pointSize:1,data:"",loader:js,onTilesetLoad:{type:"function",value:s=>{}},onTileLoad:{type:"function",value:s=>{}},onTileUnload:{type:"function",value:s=>{}},onTileError:{type:"function",value:(s,t,e)=>{}},_getMeshColor:{type:"function",value:s=>[255,255,255]}};class _e extends Cn{initializeState(){"onTileLoadFail"in this.props&&Tn.removed("onTileLoadFail","onTileError")(),this.state={layerMap:{},tileset3d:null,activeViewports:{},lastUpdatedViewports:null}}get isLoaded(){return!!(this.state?.tileset3d?.isLoaded()&&super.isLoaded)}shouldUpdateState({changeFlags:t}){return t.somethingChanged}updateState({props:t,oldProps:e,changeFlags:n}){if(t.data&&t.data!==e.data&&this._loadTileset(t.data),n.viewportChanged){const{activeViewports:r}=this.state;Object.keys(r).length&&(this._updateTileset(r),this.state.lastUpdatedViewports=r,this.state.activeViewports={})}if(n.propsChanged){const{layerMap:r}=this.state;for(const i in r)r[i].needsUpdate=!0}}activateViewport(t){const{activeViewports:e,lastUpdatedViewports:n}=this.state;this.internalState.viewport=t,e[t.id]=t;const r=n?.[t.id];(!r||!t.equals(r))&&(this.setChangeFlags({viewportChanged:!0}),this.setNeedsUpdate())}getPickingInfo({info:t,sourceLayer:e}){const n=e&&e.props.tile;return t.picked&&(t.object=n),t.sourceTile=n,t}filterSubLayer({layer:t,viewport:e}){const{tile:n}=t.props,{id:r}=e;return n.selected&&n.viewportIds.includes(r)}_updateAutoHighlight(t){const e=t.sourceTile,n=this.state.layerMap[e?.id];n&&n.layer&&n.layer.updateAutoHighlight(t)}async _loadTileset(t){const{loadOptions:e={}}=this.props,n=this.props.loader||this.props.loaders,r=Array.isArray(n)?n[0]:n,i={loadOptions:{...e}};let o=t;if(r.preload){const c=await r.preload(t,e);c.url&&(o=c.url),c.headers&&(i.loadOptions.fetch={...i.loadOptions.fetch,headers:c.headers}),Object.assign(i,c)}const a=await Et(o,r,i.loadOptions),l=new Or(a,{onTileLoad:this._onTileLoad.bind(this),onTileUnload:this._onTileUnload.bind(this),onTileError:this.props.onTileError,...i});this.setState({tileset3d:l,layerMap:{}}),this._updateTileset(this.state.activeViewports),this.props.onTilesetLoad(l)}_onTileLoad(t){const{lastUpdatedViewports:e}=this.state;this.props.onTileLoad(t),this._updateTileset(e),this.setNeedsUpdate()}_onTileUnload(t){delete this.state.layerMap[t.id],this.props.onTileUnload(t)}_updateTileset(t){if(!t)return;const{tileset3d:e}=this.state,{timeline:n}=this.context,r=Object.keys(t).length;!n||!r||!e||e.selectTiles(Object.values(t)).then(i=>{this.state.frameNumber!==i&&this.setState({frameNumber:i})})}_getSubLayer(t,e){if(!t.content)return null;switch(t.type){case X.POINTCLOUD:return this._makePointCloudLayer(t,e);case X.SCENEGRAPH:return this._make3DModelLayer(t);case X.MESH:return this._makeSimpleMeshLayer(t,e);default:throw new Error(`Tile3DLayer: Failed to render layer of type ${t.content.type}`)}}_makePointCloudLayer(t,e){const{attributes:n,pointCount:r,constantRGBA:i,cartographicOrigin:o,modelMatrix:a}=t.content,{positions:l,normals:c,colors:h}=n;if(!l)return null;const u=e&&e.props.data||{header:{vertexCount:r},attributes:{POSITION:l,NORMAL:c,COLOR_0:h}},{pointSize:p,getPointColor:g}=this.props,m=this.getSubLayerClass("pointcloud",Rn);return new m({pointSize:p},this.getSubLayerProps({id:"pointcloud"}),{id:`${this.id}-pointcloud-${t.id}`,tile:t,data:u,coordinateSystem:zt.METER_OFFSETS,coordinateOrigin:o,modelMatrix:a,getColor:i||g,_offset:0})}_make3DModelLayer(t){const{gltf:e,instances:n,cartographicOrigin:r,modelMatrix:i}=t.content,o=this.getSubLayerClass("scenegraph",bn);return new o({_lighting:"pbr"},this.getSubLayerProps({id:"scenegraph"}),{id:`${this.id}-scenegraph-${t.id}`,tile:t,data:n||ls,scenegraph:e,coordinateSystem:zt.METER_OFFSETS,coordinateOrigin:r,modelMatrix:i,getTransformMatrix:a=>a.modelMatrix,getPosition:[0,0,0],_offset:0})}_makeSimpleMeshLayer(t,e){const n=t.content,{attributes:r,indices:i,modelMatrix:o,cartographicOrigin:a,coordinateSystem:l=zt.METER_OFFSETS,material:c,featureIds:h}=n,{_getMeshColor:u}=this.props,p=e&&e.props.mesh||new Pn({topology:"triangle-list",attributes:Ki(r),indices:i}),g=this.getSubLayerClass("mesh",ue);return new g(this.getSubLayerProps({id:"mesh"}),{id:`${this.id}-mesh-${t.id}`,tile:t,mesh:p,data:ls,getColor:u(t),pbrMaterial:c,modelMatrix:o,coordinateOrigin:a,coordinateSystem:l,featureIds:h,_offset:0})}renderLayers(){const{tileset3d:t,layerMap:e}=this.state;return t?t.tiles.map(n=>{const r=e[n.id]=e[n.id]||{tile:n};let{layer:i}=r;return n.selected&&(i?r.needsUpdate&&(i=this._getSubLayer(n,i),r.needsUpdate=!1):i=this._getSubLayer(n)),r.layer=i,i}).filter(Boolean):null}}_e.defaultProps=Ji;_e.layerName="Tile3DLayer";function Ki(s){const t={};return t.positions={...s.positions,value:new Float32Array(s.positions.value)},s.normals&&(t.normals=s.normals),s.texCoords&&(t.texCoords=s.texCoords),s.colors&&(t.colors=s.colors),s.uvRegions&&(t.uvRegions=s.uvRegions),t}const to="https://raw.githubusercontent.com/visgl/loaders.gl/master/modules/3d-tiles/test/data/CesiumJS/Batched/BatchedColors/tileset.json",it=new ce.Map({container:"map",style:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",center:[0,0],zoom:16,pitch:60,bearing:-17});it.addControl(new ce.NavigationControl,"top-right");it.addControl(new ce.ScaleControl({unit:"metric"}),"bottom-right");const we=new yn({layers:[]}),Se=new Map,$s=new Js(it,we,Se);let Ws=1;function eo(){we.setProps({layers:Array.from(Se.values())})}function Ys(){const s="tile3d-buildings",t=new _e({id:s,data:to,opacity:Ws,pointSize:2,onTilesetLoad:e=>{const{cartographicCenter:n,zoom:r}=e;n&&r&&it.flyTo({center:[n[0],n[1]],zoom:r+2,pitch:60})}});Se.set(s,t),eo(),$s.notifyLayerAdded(s)}const hs=document.getElementById("opacity"),so=document.getElementById("opacityValue");hs?.addEventListener("input",()=>{const s=parseInt(hs.value,10);so.textContent=`${s}%`,Ws=s/100,Ys()});it.on("load",()=>{it.addControl(we);const s=new Qs({collapsed:!0,customLayerAdapters:[$s],panelWidth:360});it.addControl(s,"top-right"),Ys()});
