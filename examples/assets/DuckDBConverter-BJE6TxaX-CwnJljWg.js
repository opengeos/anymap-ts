import{_ as R}from"./preload-helper-PPVm8Dsz.js";let k=null;function q(){return k||(k=new A),k}class A{_duckdb=null;_db=null;_worker=null;_initialized=!1;_initializing=!1;_bundleUrl;constructor(t){this._bundleUrl=t}isReady(){return this._initialized&&this._db!==null}async initialize(t){if(!this._initialized){if(this._initializing){for(;this._initializing;)await new Promise(n=>setTimeout(n,50));return}this._initializing=!0;try{t?.({stage:"initializing",percent:0,message:"Loading DuckDB WASM..."});let n;try{const e=await R(()=>import("@duckdb/duckdb-wasm"),[],import.meta.url);n=e.default||e}catch(e){throw new Error(`DuckDB WASM is not installed or failed to load. Install it with: npm install @duckdb/duckdb-wasm. Error: ${e instanceof Error?e.message:"Unknown error"}`)}this._duckdb=n,t?.({stage:"initializing",percent:30,message:"Selecting DuckDB bundle..."});let i;if(this._duckdb.getJsDelivrBundles){const e=this._duckdb.getJsDelivrBundles();i=await this._duckdb.selectBundle(e)}else{const e=this._getJsDelivrBundles();i=await this._duckdb.selectBundle(e)}t?.({stage:"initializing",percent:50,message:"Instantiating DuckDB..."});const y=new this._duckdb.ConsoleLogger(4);let u,l=null;try{l=URL.createObjectURL(new Blob([`importScripts("${i.mainWorker}");`],{type:"text/javascript"})),u=new Worker(l)}catch(e){throw l&&URL.revokeObjectURL(l),new Error(`Failed to create DuckDB worker: ${e instanceof Error?e.message:"Unknown error"}`)}this._worker=u;const h=new this._duckdb.AsyncDuckDB(y,u);try{await h.instantiate(i.mainModule,i.pthreadWorker)}catch(e){throw new Error(`Failed to instantiate DuckDB: ${e instanceof Error?e.message:"Unknown error"}`)}l&&URL.revokeObjectURL(l),this._db=h,t?.({stage:"initializing",percent:70,message:"Loading spatial extension..."});const a=await this._db.connect();try{await a.query("INSTALL spatial"),await a.query("LOAD spatial")}catch(e){console.warn("Failed to load spatial extension, some features may not work:",e)}finally{await a.close()}this._initialized=!0,t?.({stage:"initializing",percent:100,message:"DuckDB ready"})}catch(n){throw t?.({stage:"error",message:`Failed to initialize DuckDB: ${n instanceof Error?n.message:"Unknown error"}`}),n}finally{this._initializing=!1}}}_getJsDelivrBundles(){const t=this._bundleUrl||"https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@latest/dist";return{mvp:{mainModule:`${t}/duckdb-mvp.wasm`,mainWorker:`${t}/duckdb-browser-mvp.worker.js`},eh:{mainModule:`${t}/duckdb-eh.wasm`,mainWorker:`${t}/duckdb-browser-eh.worker.js`}}}async convert(t,n,i){const y=performance.now(),u=this._detectFormat(n);if(this.isReady()||await this.initialize(i),!this._db)throw new Error("DuckDB not initialized");i?.({stage:"loading",percent:0,message:`Loading ${n}...`});const l=new Uint8Array(t);await this._db.registerFileBuffer(n,l);const h=await this._db.connect();try{i?.({stage:"converting",percent:30,message:"Reading spatial data..."});let a;u==="geoparquet"||u==="parquet"?a=`read_parquet('${n}')`:a=`ST_Read('${n}')`;const e=(await h.query(`
        DESCRIBE SELECT * FROM ${a}
      `)).toArray();let d=null,D="",g=null,m=null,p=null;const o=[],v=["lat","latitude","y","lat_y","point_y"],O=["lon","lng","long","longitude","x","lon_x","long_x","point_x"],E=["wkt","wkt_geom","wkt_geometry","geometry_wkt"];for(const s of e){const r=s.column_name,b=s.column_type?.toUpperCase()||"",c=r.toLowerCase(),j=b.includes("GEOMETRY"),B=c==="geom"||c==="geometry"||c==="wkb_geometry"||c==="the_geom"||c==="shape",F=b.includes("BLOB")&&B;j||B||F?d||(d=r,D=b):v.includes(c)&&!g?(g=r,o.push(r)):O.includes(c)&&!m?(m=r,o.push(r)):E.includes(c)&&!p?p=r:o.push(r)}let $=!1,S=!1;if(!d)if(p)S=!0;else if(g&&m){$=!0;const s=o.indexOf(g);s>-1&&o.splice(s,1);const r=o.indexOf(m);r>-1&&o.splice(r,1)}else throw new Error("No geometry column found in the file. For CSV/Excel files, include a geometry column, WKT column, or lat/lon columns.");i?.({stage:"converting",percent:50,message:"Converting to GeoJSON..."});const T=o.length>0?`json_object(${o.map(s=>`'${s}', "${s}"`).join(", ")})`:"'{}'::JSON";let _,w;$&&g&&m?(_=`ST_AsGeoJSON(ST_Point("${m}", "${g}"))`,w=`"${g}" IS NOT NULL AND "${m}" IS NOT NULL`):S&&p?(_=`ST_AsGeoJSON(ST_GeomFromText("${p}"))`,w=`"${p}" IS NOT NULL AND "${p}" != ''`):D.includes("BLOB")?(_=`ST_AsGeoJSON(ST_GeomFromWKB("${d}"))`,w=`"${d}" IS NOT NULL`):(_=`ST_AsGeoJSON("${d}")`,w=`"${d}" IS NOT NULL`);const z=(await h.query(`
        SELECT json_object(
          'type', 'Feature',
          'geometry', ${_}::JSON,
          'properties', ${T}
        ) as feature
        FROM ${a}
        WHERE ${w}
      `)).toArray();i?.({stage:"converting",percent:80,message:"Building feature collection..."});const f=[],L=new Set;for(const s of z)if(s.feature)try{const r=typeof s.feature=="string"?JSON.parse(s.feature):s.feature;f.push(r),r.geometry?.type&&L.add(r.geometry.type)}catch(r){console.warn("Failed to parse feature:",r)}const N={type:"FeatureCollection",features:f},x=performance.now(),U={originalFormat:u,featureCount:f.length,geometryTypes:Array.from(L),fileSize:t.byteLength,conversionTimeMs:Math.round(x-y)};return i?.({stage:"complete",percent:100,message:`Converted ${f.length} features`}),{geojson:N,warnings:[],metadata:U}}catch(a){throw i?.({stage:"error",message:`Failed to convert: ${a instanceof Error?a.message:"Unknown error"}`}),a}finally{await h.close();try{await this._db.dropFile(n)}catch{}}}_detectFormat(t){switch(t.toLowerCase().split(".").pop()){case"gpkg":return"geopackage";case"parquet":case"geoparquet":return"geoparquet";case"shp":return"shapefile";case"geojson":case"json":return"geojson";case"kml":return"kml";case"kmz":return"kmz";case"gpx":return"gpx";case"fgb":return"flatgeobuf";case"gml":return"gml";case"topojson":return"topojson";case"csv":return"csv";case"xlsx":case"xls":return"xlsx";case"dxf":return"dxf";default:return"unknown"}}dispose(){this._db&&(this._db.terminate().catch(console.error),this._db=null),this._worker&&(this._worker.terminate(),this._worker=null),this._initialized=!1,this._duckdb=null,k===this&&(k=null)}}export{A as DuckDBConverter,q as getDuckDBConverter};
