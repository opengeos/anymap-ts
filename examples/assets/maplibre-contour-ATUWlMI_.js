import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */import{m as F}from"./maplibre-gl-BTjYUjN0.js";import{L as ft}from"./maplibre-gl-layer-control-Bv-vXquT.js";import{D as Wt}from"./DeckLayerAdapter-DCj5phjl.js";import{I as At,b as j,au as yt,e as Ct,C as X,M as Ot}from"./mapbox-overlay-CtMyNbGZ.js";import{W as x,C as St,A as _t,g as bt}from"./bounds-utils-BpcTu37T.js";import{P as Pt}from"./path-layer-BvePX-Ox.js";import{S as Tt}from"./solid-polygon-layer-CCl_BuGc.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./composite-layer-D5nYxRM9.js";import"./cut-by-mercator-bounds-DHiR3GA4.js";import"./picking-CN0D5Hbh.js";import"./geometry-CwO1uo58.js";import"./polygon-utils-B8iYQ3Og.js";import"./gouraud-material-NoqXAwxE.js";import"./lighting-p30x1bFT.js";import"./phong-shaders-wgsl-3FV41e28.js";const o=.5,n=1/6,t={N:[0,o],E:[o,0],S:[0,-o],W:[-o,0],NE:[o,o],NW:[-o,o],SE:[o,-o],SW:[-o,-o]},C=[t.W,t.SW,t.S],O=[t.S,t.SE,t.E],_=[t.E,t.NE,t.N],b=[t.NW,t.W,t.N],P=[[-o,n],[-o,-n],[-n,-o],[n,-o]],T=[[-n,-o],[n,-o],[o,-n],[o,n]],L=[[o,-n],[o,n],[n,o],[-n,o]],v=[[-o,n],[-o,-n],[n,o],[-n,o]],Y=[t.W,t.SW,t.SE,t.E],Z=[t.S,t.SE,t.NE,t.N],q=[t.NW,t.W,t.E,t.NE],K=[t.NW,t.SW,t.S,t.N],Q=[[-o,n],[-o,-n],[o,-n],[o,n]],J=[[-n,-o],[n,-o],[n,o],[-n,o]],Lt=[t.NW,t.SW,t.SE,t.NE],$=[t.NW,t.SW,t.SE,t.E,t.N],tt=[t.W,t.SW,t.SE,t.NE,t.N],ot=[t.NW,t.W,t.S,t.SE,t.NE],et=[t.NW,t.SW,t.S,t.E,t.NE],nt=[t.NW,t.W,[o,-n],[o,n],t.N],st=[[-n,-o],[n,-o],t.E,t.NE,t.N],rt=[[-o,n],[-o,-n],t.S,t.SE,t.E],it=[t.W,t.SW,t.S,[n,o],[-n,o]],at=[t.NW,t.W,[-n,-o],[n,-o],t.N],ct=[[-o,n],[-o,-n],t.E,t.NE,t.N],lt=[t.S,t.SE,t.E,[n,o],[-n,o]],gt=[t.W,t.SW,t.S,[o,-n],[o,n]],ut=[t.W,t.SW,t.SE,t.E,[n,o],[-n,o]],dt=[[-o,n],[-o,-n],t.S,t.SE,t.NE,t.N],pt=[t.NW,t.W,[-n,-o],[n,-o],t.E,t.NE],Nt=[t.NW,t.SW,t.S,[o,-n],[o,n],t.N],w=[t.W,t.SW,t.S,t.E,t.NE,t.N],G=[t.NW,t.W,t.S,t.SE,t.E,t.N],z=[[-o,n],[-o,-n],[-n,-o],[n,-o],t.E,t.NE,t.N],D=[t.W,t.SW,t.S,[o,-n],[o,n],[n,o],[-n,o]],B=[t.NW,t.W,[-n,-o],[n,-o],[o,-n],[o,n],t.N],k=[[-o,n],[-o,-n],t.S,t.SE,t.E,[n,o],[-n,o]],Et=[[-o,n],[-o,-n],[-n,-o],[n,-o],[o,-n],[o,n],[n,o],[-n,o]],vt={0:[],1:[[t.W,t.S]],2:[[t.S,t.E]],3:[[t.W,t.E]],4:[[t.N,t.E]],5:{0:[[t.W,t.S],[t.N,t.E]],1:[[t.W,t.N],[t.S,t.E]]},6:[[t.N,t.S]],7:[[t.W,t.N]],8:[[t.W,t.N]],9:[[t.N,t.S]],10:{0:[[t.W,t.N],[t.S,t.E]],1:[[t.W,t.S],[t.N,t.E]]},11:[[t.N,t.E]],12:[[t.W,t.E]],13:[[t.S,t.E]],14:[[t.W,t.S]],15:[]};function e(u){return parseInt(u,4)}const wt={[e("0000")]:[],[e("2222")]:[],[e("2221")]:[C],[e("2212")]:[O],[e("2122")]:[_],[e("1222")]:[b],[e("0001")]:[C],[e("0010")]:[O],[e("0100")]:[_],[e("1000")]:[b],[e("2220")]:[P],[e("2202")]:[T],[e("2022")]:[L],[e("0222")]:[v],[e("0002")]:[P],[e("0020")]:[T],[e("0200")]:[L],[e("2000")]:[v],[e("0011")]:[Y],[e("0110")]:[Z],[e("1100")]:[q],[e("1001")]:[K],[e("2211")]:[Y],[e("2112")]:[Z],[e("1122")]:[q],[e("1221")]:[K],[e("2200")]:[Q],[e("2002")]:[J],[e("0022")]:[Q],[e("0220")]:[J],[e("1111")]:[Lt],[e("1211")]:[$],[e("2111")]:[tt],[e("1112")]:[ot],[e("1121")]:[et],[e("1011")]:[$],[e("0111")]:[tt],[e("1110")]:[ot],[e("1101")]:[et],[e("1200")]:[nt],[e("0120")]:[st],[e("0012")]:[rt],[e("2001")]:[it],[e("1022")]:[nt],[e("2102")]:[st],[e("2210")]:[rt],[e("0221")]:[it],[e("1002")]:[at],[e("2100")]:[ct],[e("0210")]:[lt],[e("0021")]:[gt],[e("1220")]:[at],[e("0122")]:[ct],[e("2012")]:[lt],[e("2201")]:[gt],[e("0211")]:[ut],[e("2110")]:[dt],[e("1102")]:[pt],[e("1021")]:[Nt],[e("2011")]:[ut],[e("0112")]:[dt],[e("1120")]:[pt],[e("1201")]:[Nt],[e("2101")]:[w],[e("0121")]:[w],[e("1012")]:[G],[e("1210")]:[G],[e("0101")]:{0:[C,_],1:[w],2:[w]},[e("1010")]:{0:[b,O],1:[G],2:[G]},[e("2121")]:{0:[w],1:[w],2:[C,_]},[e("1212")]:{0:[G],1:[G],2:[b,O]},[e("2120")]:{0:[z],1:[z],2:[P,_]},[e("2021")]:{0:[D],1:[D],2:[C,L]},[e("1202")]:{0:[B],1:[B],2:[b,T]},[e("0212")]:{0:[k],1:[k],2:[O,v]},[e("0102")]:{0:[P,_],1:[z],2:[z]},[e("0201")]:{0:[C,L],1:[D],2:[D]},[e("1020")]:{0:[b,T],1:[B],2:[B]},[e("2010")]:{0:[O,v],1:[k],2:[k]},[e("2020")]:{0:[v,T],1:[Et],2:[P,L]},[e("0202")]:{0:[L,P],1:[Et],2:[v,T]}};function R(u,s){return Number.isNaN(u)?0:Array.isArray(s)?u<s[0]?0:u<s[1]?1:2:u>=s?1:0}function Gt(u){const{x:s,y:r,xRange:a,yRange:c,getValue:l,threshold:i}=u,d=s<a[0],g=s>=a[1]-1,p=r<c[0],h=r>=c[1]-1,S=d||g||p||h;let N=0,E,f,y,A;if(d||h)y=0;else{const m=l(s,r+1);y=R(m,i),N+=m}if(g||h)A=0;else{const m=l(s+1,r+1);A=R(m,i),N+=m}if(g||p)f=0;else{const m=l(s+1,r);f=R(m,i),N+=m}if(d||p)E=0;else{const m=l(s,r);E=R(m,i),N+=m}let W=-1;Number.isFinite(i)&&(W=y<<3|A<<2|f<<1|E),Array.isArray(i)&&(W=y<<6|A<<4|f<<2|E);let M=0;return S||(M=R(N/4,i)),{code:W,meanCode:M}}function It(u){const{x:s,y:r,z:a,code:c,meanCode:l}=u;let i=wt[c];Array.isArray(i)||(i=i[l]);const d=s+1,g=r+1,p=[];return i.forEach(h=>{const S=[];h.forEach(N=>{const E=d+N[0],f=g+N[1];S.push([E,f,a])}),p.push(S)}),p}function Rt(u){const{x:s,y:r,z:a,code:c,meanCode:l}=u;let i=vt[c];Array.isArray(i)||(i=i[l]);const d=s+1,g=r+1,p=[];return i.forEach(h=>{h.forEach(S=>{const N=d+S[0],E=g+S[1];p.push([N,E,a])})}),p}function Mt({contours:u,getValue:s,xRange:r,yRange:a}){const c=[],l=[];let i=0,d=0;for(let g=0;g<u.length;g++){const p=u[g],h=p.zIndex??g,{threshold:S}=p;for(let N=r[0]-1;N<r[1];N++)for(let E=a[0]-1;E<a[1];E++){const{code:f,meanCode:y}=Gt({getValue:s,threshold:S,x:N,y:E,xRange:r,yRange:a}),A={x:N,y:E,z:h,code:f,meanCode:y};if(Array.isArray(S)){const W=It(A);for(const M of W)l[d++]={vertices:M,contour:p}}else{const W=Rt(A);W.length>0&&(c[i++]={vertices:W,contour:p})}}}return{lines:c,polygons:l}}function zt(u){var c,l,i;const{aggregator:s,binIdRange:r,channel:a}=u;if(s instanceof x){const d=(c=s.getResult(a))==null?void 0:c.buffer;if(d){const g=new Float32Array(d.readSyncWebGL().buffer);return Dt(g,r)}}if(s instanceof St){const d=(l=s.getResult(a))==null?void 0:l.value,g=(i=s.getBins())==null?void 0:i.value;if(g&&d)return Bt(d,g,s.binCount)}return null}function Dt(u,s){const[[r,a],[c,l]]=s,i=a-r,d=l-c;return(g,p)=>(g-=r,p-=c,g<0||g>=i||p<0||p>=d?NaN:u[p*i+g])}function Bt(u,s,r){const a={};for(let c=0;c<r;c++){const l=s[c*2],i=s[c*2+1];a[l]=a[l]||{},a[l][i]=u[c]}return(c,l)=>{var i;return((i=a[c])==null?void 0:i[l])??NaN}}const kt=`uniform binOptionsUniforms {
  vec2 cellOriginCommon;
  vec2 cellSizeCommon;
} binOptions;
`,xt={name:"binOptions",vs:kt,uniformTypes:{cellOriginCommon:"vec2<f32>",cellSizeCommon:"vec2<f32>"}},ht=[255,255,255,255],Ft=1,Ut={cellSize:{type:"number",min:1,value:1e3},gridOrigin:{type:"array",compare:!0,value:[0,0]},getPosition:{type:"accessor",value:u=>u.position},getWeight:{type:"accessor",value:1},gpuAggregation:!0,aggregation:"SUM",contours:{type:"object",value:[{threshold:1}],optional:!0,compare:3},zOffset:.005};class U extends _t{getAggregatorType(){return this.props.gpuAggregation&&x.isSupported(this.context.device)?"gpu":"cpu"}createAggregator(s){return s==="cpu"?new St({dimensions:2,getBin:{sources:["positions"],getValue:({positions:r},a,c)=>{const i=this.state.aggregatorViewport.projectPosition(r),{cellSizeCommon:d,cellOriginCommon:g}=c;return[Math.floor((i[0]-g[0])/d[0]),Math.floor((i[1]-g[1])/d[1])]}},getValue:[{sources:["counts"],getValue:({counts:r})=>r}],onUpdate:this._onAggregationUpdate.bind(this)}):new x(this.context.device,{dimensions:2,channelCount:1,bufferLayout:this.getAttributeManager().getBufferLayouts({isInstanced:!1}),...super.getShaders({modules:[At,xt],vs:`
  in vec3 positions;
  in vec3 positions64Low;
  in float counts;

  void getBin(out ivec2 binId) {
    vec3 positionCommon = project_position(positions, positions64Low);
    vec2 gridCoords = floor(positionCommon.xy / binOptions.cellSizeCommon);
    binId = ivec2(gridCoords);
  }
  void getValue(out float value) {
    value = counts;
  }
  `}),onUpdate:this._onAggregationUpdate.bind(this)})}initializeState(){super.initializeState(),this.getAttributeManager().add({positions:{size:3,accessor:"getPosition",type:"float64",fp64:this.use64bitPositions()},counts:{size:1,accessor:"getWeight"}})}updateState(s){const r=super.updateState(s),{props:a,oldProps:c,changeFlags:l}=s,{aggregator:i}=this.state;if(r||l.dataChanged||a.cellSize!==c.cellSize||!j(a.gridOrigin,c.gridOrigin,1)||a.aggregation!==c.aggregation){this._updateBinOptions();const{cellSizeCommon:d,cellOriginCommon:g,binIdRange:p}=this.state;i.setProps({binIdRange:p,pointCount:this.getNumInstances(),operations:[a.aggregation],binOptions:{cellSizeCommon:d,cellOriginCommon:g}})}return j(c.contours,a.contours,2)||this.setState({contourData:null}),r}_updateBinOptions(){const s=this.getBounds(),r=[1,1];let a=[0,0],c=[[0,1],[0,1]],l=this.context.viewport;if(s&&Number.isFinite(s[0][0])){let i=[(s[0][0]+s[1][0])/2,(s[0][1]+s[1][1])/2];const{cellSize:d,gridOrigin:g}=this.props,{unitsPerMeter:p}=l.getDistanceScales(i);r[0]=p[0]*d,r[1]=p[1]*d;const h=l.projectFlat(i);a=[Math.floor((h[0]-g[0])/r[0])*r[0]+g[0],Math.floor((h[1]-g[1])/r[1])*r[1]+g[1]],i=l.unprojectFlat(a);const S=l.constructor;l=l.isGeospatial?new S({longitude:i[0],latitude:i[1],zoom:12}):new yt({position:[i[0],i[1],0],zoom:12}),a=[Math.fround(l.center[0]),Math.fround(l.center[1])],c=bt({dataBounds:s,getBinId:N=>{const E=l.projectFlat(N);return[Math.floor((E[0]-a[0])/r[0]),Math.floor((E[1]-a[1])/r[1])]}})}this.setState({cellSizeCommon:r,cellOriginCommon:a,binIdRange:c,aggregatorViewport:l})}draw(s){s.shaderModuleProps.project&&(s.shaderModuleProps.project.viewport=this.state.aggregatorViewport),super.draw(s)}_onAggregationUpdate(){const{aggregator:s,binIdRange:r}=this.state;this.setState({aggregatedValueReader:zt({aggregator:s,binIdRange:r,channel:0}),contourData:null})}_getContours(){const{aggregatedValueReader:s}=this.state;if(!s)return null;if(!this.state.contourData){const{binIdRange:r}=this.state,{contours:a}=this.props,c=Mt({contours:a,getValue:s,xRange:r[0],yRange:r[1]});this.state.contourData=c}return this.state.contourData}onAttributeChange(s){const{aggregator:r}=this.state;switch(s){case"positions":r.setNeedsUpdate(),this._updateBinOptions();const{cellSizeCommon:a,cellOriginCommon:c,binIdRange:l}=this.state;r.setProps({binIdRange:l,binOptions:{cellSizeCommon:a,cellOriginCommon:c}});break;case"counts":r.setNeedsUpdate(0);break}}renderLayers(){const s=this._getContours();if(!s)return null;const{lines:r,polygons:a}=s,{zOffset:c}=this.props,{cellOriginCommon:l,cellSizeCommon:i}=this.state,d=this.getSubLayerClass("lines",Pt),g=this.getSubLayerClass("bands",Tt),p=new Ct().translate([l[0],l[1],0]).scale([i[0],i[1],c]),h=r&&r.length>0&&new d(this.getSubLayerProps({id:"lines"}),{data:r,coordinateSystem:X.CARTESIAN,modelMatrix:p,getPath:N=>N.vertices,getColor:N=>N.contour.color??ht,getWidth:N=>N.contour.strokeWidth??Ft,widthUnits:"pixels"}),S=a&&a.length>0&&new g(this.getSubLayerProps({id:"bands"}),{data:a,coordinateSystem:X.CARTESIAN,modelMatrix:p,getPolygon:N=>N.vertices,getFillColor:N=>N.contour.color??ht});return[h,S]}getPickingInfo(s){const r=s.info,{object:a}=r;return a&&(r.object={contour:a.contour}),r}}U.layerName="ContourLayer";U.defaultProps=Ut;function Vt(u=2e3){const s=[{center:[-122.4194,37.7749],spread:.02,weight:1.5},{center:[-122.2711,37.8044],spread:.015,weight:1.2},{center:[-122.2727,37.8716],spread:.01,weight:1},{center:[-122.4098,37.7855],spread:.008,weight:2},{center:[-122.4534,37.8083],spread:.01,weight:.8},{center:[-122.3894,37.7866],spread:.01,weight:1.3}],r=[];for(let a=0;a<u;a++){const c=s[Math.floor(Math.random()*s.length)],l=Math.random()*Math.PI*2,i=Math.random()*c.spread,d=c.center[0]+Math.cos(l)*i,g=c.center[1]+Math.sin(l)*i;r.push({coordinates:[d,g],weight:Math.random()*c.weight+.5})}return r}const Ht=Vt(),jt=[{threshold:1,color:[255,255,178],strokeWidth:1},{threshold:5,color:[254,217,118],strokeWidth:1},{threshold:10,color:[254,178,76],strokeWidth:2},{threshold:20,color:[253,141,60],strokeWidth:2},{threshold:40,color:[252,78,42],strokeWidth:3},{threshold:60,color:[227,26,28],strokeWidth:3},{threshold:80,color:[189,0,38],strokeWidth:4}],I=new F.Map({container:"map",style:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",center:[-122.35,37.8],zoom:11});I.addControl(new F.NavigationControl,"top-right");I.addControl(new F.ScaleControl({unit:"metric"}),"bottom-right");const V=new Ot({layers:[]}),H=new Map,mt=new Wt(I,V,H);function Xt(){V.setProps({layers:Array.from(H.values())})}function Yt(){const u="contour-density",s=new U({id:u,data:Ht,pickable:!0,cellSize:200,contours:jt,getPosition:r=>r.coordinates,getWeight:r=>r.weight,aggregation:"SUM"});H.set(u,s),Xt(),mt.notifyLayerAdded(u)}I.on("load",()=>{I.addControl(V);const u=new ft({collapsed:!0,customLayerAdapters:[mt],panelWidth:360});I.addControl(u,"top-right"),Yt()});
