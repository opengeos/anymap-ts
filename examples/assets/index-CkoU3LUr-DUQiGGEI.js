import F from"./index-DQXdX5y1-CPlzurpS.js";import{f as $t,b as Yt,c as Ht,d as Kt,e as Xt,P as Qt}from"./geotiff-CY9Ly-G7-BOgnUBv7.js";import{CreateTexture as xt,cieLabToRGB as Jt,YCbCrToRGB as es,CMYKToRGB as ts,Colormap as ss,FilterNoDataVal as is}from"./index-C9fk_HKR-CqUpBM0p.js";import{v as j,I as wt,V as rs,O as G,E as se,S as bt,a as os,m as Mt,R as as,M as ns,l as hs,c as Tt,b as re,Z as ls,y as cs,T as us,d as ds,e as ms,n as ps,f as fs,g as gs,G as ys,Y as Be,h as w,B as xe,w as _s,X as ue,i as de,Q as xs,j as ws,D as St,k as bs,o as Ms,p as Ct,x as Ts,q as P,W as Ss,U as Cs,$ as vs,r as Ls,H as Is,s as Ps,F as je,N as Rs,t as me,u as zs,z as Os,A as Es,C as As,J as Ns,K as qs,L as Fs,P as Ue,_ as Ds,a0 as Gs,a1 as Ws,a2 as ks,a3 as Bs,a4 as js,a5 as oe}from"./maplibre-control-grid-V8FPZQDU.js";import"./preload-helper-PPVm8Dsz.js";import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */import"./maplibre-gl-BZpgQJIL.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./maplibre-gl-layer-control-BGT4Bb5x.js";const Us="Queued Requests",Vs="Active Requests",Zs="Cancelled Requests",$s="Queued Requests Ever",Ys="Active Requests Ever",Hs={id:"request-scheduler",throttleRequests:!0,maxRequests:6,debounceTime:0};class Ks{props;stats;activeRequestCount=0;requestQueue=[];requestMap=new Map;updateTimer=null;constructor(e={}){this.props={...Hs,...e},this.stats=new hs({id:this.props.id}),this.stats.get(Us),this.stats.get(Vs),this.stats.get(Zs),this.stats.get($s),this.stats.get(Ys)}scheduleRequest(e,t=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);const s={handle:e,priority:0,getPriority:t},r=new Promise(o=>(s.resolve=o,s));return this.requestQueue.push(s),this.requestMap.set(e,r),this._issueNewRequests(),r}_issueRequest(e){const{handle:t,resolve:s}=e;let r=!1;const o=()=>{r||(r=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,s?s({done:o}):Promise.resolve({done:o})}_issueNewRequests(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>this._issueNewRequestsAsync(),this.props.debounceTime)}_issueNewRequestsAsync(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=null;const e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(e!==0){this._updateAllRequests();for(let t=0;t<e;++t){const s=this.requestQueue.shift();s&&this._issueRequest(s)}}}_updateAllRequests(){const e=this.requestQueue;for(let t=0;t<e.length;++t){const s=e[t];this._updateRequest(s)||(e.splice(t,1),this.requestMap.delete(s.handle),t--)}e.sort((t,s)=>t.priority-s.priority)}_updateRequest(e){return e.priority=e.getPriority(e.handle),e.priority<0?(e.resolve(null),!1):!0}}function Xs(i){let e=1/0,t=1/0,s=1/0,r=-1/0,o=-1/0,a=-1/0;const n=i.POSITION?i.POSITION.value:[],h=n&&n.length;for(let c=0;c<h;c+=3){const u=n[c],l=n[c+1],d=n[c+2];e=u<e?u:e,t=l<t?l:t,s=d<s?d:s,r=u>r?u:r,o=l>o?l:o,a=d>a?d:a}return[[e,t,s],[r,o,a]]}let $;class Le extends qs{static get ZERO(){return $||($=new Le(0,0,0,0),Object.freeze($)),$}constructor(e=0,t=0,s=0,r=0){super(-0,-0,-0,-0),Fs(e)&&arguments.length===1?this.copy(e):(Ue.debug&&(P(e),P(t),P(s),P(r)),this[0]=e,this[1]=t,this[2]=s,this[3]=r)}set(e,t,s,r){return this[0]=e,this[1]=t,this[2]=s,this[3]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return Ue.debug&&(P(e.x),P(e.y),P(e.z),P(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=P(e)}get w(){return this[3]}set w(e){this[3]=P(e)}transform(e){return Ds(this,this,e),this.check()}transformByMatrix3(e){return St(this,this,e),this.check()}transformByMatrix2(e){return Gs(this,this,e),this.check()}transformByQuaternion(e){return Ws(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}}function Qs(){const i=new oe(9);return oe!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function Js(i,e){if(i===e){const t=e[1],s=e[2],r=e[5];i[1]=e[3],i[2]=e[6],i[3]=t,i[5]=e[7],i[6]=s,i[7]=r}else i[0]=e[0],i[1]=e[3],i[2]=e[6],i[3]=e[1],i[4]=e[4],i[5]=e[7],i[6]=e[2],i[7]=e[5],i[8]=e[8];return i}function ei(i,e){const t=e[0],s=e[1],r=e[2],o=e[3],a=e[4],n=e[5],h=e[6],c=e[7],u=e[8],l=u*a-n*c,d=-u*o+n*h,m=c*o-a*h;let p=t*l+s*d+r*m;return p?(p=1/p,i[0]=l*p,i[1]=(-u*s+r*c)*p,i[2]=(n*s-r*a)*p,i[3]=d*p,i[4]=(u*t-r*h)*p,i[5]=(-n*t+r*o)*p,i[6]=m*p,i[7]=(-c*t+s*h)*p,i[8]=(a*t-s*o)*p,i):null}function ti(i){const e=i[0],t=i[1],s=i[2],r=i[3],o=i[4],a=i[5],n=i[6],h=i[7],c=i[8];return e*(c*o-a*h)+t*(-c*r+a*n)+s*(h*r-o*n)}function Ve(i,e,t){const s=e[0],r=e[1],o=e[2],a=e[3],n=e[4],h=e[5],c=e[6],u=e[7],l=e[8],d=t[0],m=t[1],p=t[2],f=t[3],g=t[4],y=t[5],_=t[6],x=t[7],b=t[8];return i[0]=d*s+m*a+p*c,i[1]=d*r+m*n+p*u,i[2]=d*o+m*h+p*l,i[3]=f*s+g*a+y*c,i[4]=f*r+g*n+y*u,i[5]=f*o+g*h+y*l,i[6]=_*s+x*a+b*c,i[7]=_*r+x*n+b*u,i[8]=_*o+x*h+b*l,i}function si(i,e,t){const s=e[0],r=e[1],o=e[2],a=e[3],n=e[4],h=e[5],c=e[6],u=e[7],l=e[8],d=t[0],m=t[1];return i[0]=s,i[1]=r,i[2]=o,i[3]=a,i[4]=n,i[5]=h,i[6]=d*s+m*a+c,i[7]=d*r+m*n+u,i[8]=d*o+m*h+l,i}function ii(i,e,t){const s=e[0],r=e[1],o=e[2],a=e[3],n=e[4],h=e[5],c=e[6],u=e[7],l=e[8],d=Math.sin(t),m=Math.cos(t);return i[0]=m*s+d*a,i[1]=m*r+d*n,i[2]=m*o+d*h,i[3]=m*a-d*s,i[4]=m*n-d*r,i[5]=m*h-d*o,i[6]=c,i[7]=u,i[8]=l,i}function Ze(i,e,t){const s=t[0],r=t[1];return i[0]=s*e[0],i[1]=s*e[1],i[2]=s*e[2],i[3]=r*e[3],i[4]=r*e[4],i[5]=r*e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i}function ri(i,e){const t=e[0],s=e[1],r=e[2],o=e[3],a=t+t,n=s+s,h=r+r,c=t*a,u=s*a,l=s*n,d=r*a,m=r*n,p=r*h,f=o*a,g=o*n,y=o*h;return i[0]=1-l-p,i[3]=u-y,i[6]=d+g,i[1]=u+y,i[4]=1-c-p,i[7]=m-f,i[2]=d-g,i[5]=m+f,i[8]=1-c-l,i}var we;(function(i){i[i.COL0ROW0=0]="COL0ROW0",i[i.COL0ROW1=1]="COL0ROW1",i[i.COL0ROW2=2]="COL0ROW2",i[i.COL1ROW0=3]="COL1ROW0",i[i.COL1ROW1=4]="COL1ROW1",i[i.COL1ROW2=5]="COL1ROW2",i[i.COL2ROW0=6]="COL2ROW0",i[i.COL2ROW1=7]="COL2ROW1",i[i.COL2ROW2=8]="COL2ROW2"})(we||(we={}));const oi=Object.freeze([1,0,0,0,1,0,0,0,1]);class L extends ws{static get IDENTITY(){return ni()}static get ZERO(){return ai()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return we}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(oi)}fromObject(e){return this.check()}fromQuaternion(e){return ri(this,e),this.check()}set(e,t,s,r,o,a,n,h,c){return this[0]=e,this[1]=t,this[2]=s,this[3]=r,this[4]=o,this[5]=a,this[6]=n,this[7]=h,this[8]=c,this.check()}setRowMajor(e,t,s,r,o,a,n,h,c){return this[0]=e,this[1]=r,this[2]=n,this[3]=t,this[4]=o,this[5]=h,this[6]=s,this[7]=a,this[8]=c,this.check()}determinant(){return ti(this)}transpose(){return Js(this,this),this.check()}invert(){return ei(this,this),this.check()}multiplyLeft(e){return Ve(this,e,this),this.check()}multiplyRight(e){return Ve(this,this,e),this.check()}rotate(e){return ii(this,this,e),this.check()}scale(e){return Array.isArray(e)?Ze(this,this,e):Ze(this,this,[e,e]),this.check()}translate(e){return si(this,this,e),this.check()}transform(e,t){let s;switch(e.length){case 2:s=Ms(t||[-0,-0],e,this);break;case 3:s=bs(t||[-0,-0,-0],e,this);break;case 4:s=St(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Ct(s,e.length),s}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}}let Y,H=null;function ai(){return Y||(Y=new L([0,0,0,0,0,0,0,0,0]),Object.freeze(Y)),Y}function ni(){return H||(H=new L,Object.freeze(H)),H}function $e(){const i=new oe(4);return oe!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function hi(i){return i[0]=0,i[1]=0,i[2]=0,i[3]=1,i}function vt(i,e,t){t=t*.5;const s=Math.sin(t);return i[0]=s*e[0],i[1]=s*e[1],i[2]=s*e[2],i[3]=Math.cos(t),i}function Ye(i,e,t){const s=e[0],r=e[1],o=e[2],a=e[3],n=t[0],h=t[1],c=t[2],u=t[3];return i[0]=s*u+a*n+r*c-o*h,i[1]=r*u+a*h+o*n-s*c,i[2]=o*u+a*c+s*h-r*n,i[3]=a*u-s*n-r*h-o*c,i}function li(i,e,t){t*=.5;const s=e[0],r=e[1],o=e[2],a=e[3],n=Math.sin(t),h=Math.cos(t);return i[0]=s*h+a*n,i[1]=r*h+o*n,i[2]=o*h-r*n,i[3]=a*h-s*n,i}function ci(i,e,t){t*=.5;const s=e[0],r=e[1],o=e[2],a=e[3],n=Math.sin(t),h=Math.cos(t);return i[0]=s*h-o*n,i[1]=r*h+a*n,i[2]=o*h+s*n,i[3]=a*h-r*n,i}function ui(i,e,t){t*=.5;const s=e[0],r=e[1],o=e[2],a=e[3],n=Math.sin(t),h=Math.cos(t);return i[0]=s*h+r*n,i[1]=r*h-s*n,i[2]=o*h+a*n,i[3]=a*h-o*n,i}function di(i,e){const t=e[0],s=e[1],r=e[2];return i[0]=t,i[1]=s,i[2]=r,i[3]=Math.sqrt(Math.abs(1-t*t-s*s-r*r)),i}function ie(i,e,t,s){const r=e[0],o=e[1],a=e[2],n=e[3];let h=t[0],c=t[1],u=t[2],l=t[3],d,m,p,f,g;return d=r*h+o*c+a*u+n*l,d<0&&(d=-d,h=-h,c=-c,u=-u,l=-l),1-d>Bs?(m=Math.acos(d),g=Math.sin(m),p=Math.sin((1-s)*m)/g,f=Math.sin(s*m)/g):(p=1-s,f=s),i[0]=p*r+f*h,i[1]=p*o+f*c,i[2]=p*a+f*u,i[3]=p*n+f*l,i}function mi(i,e){const t=e[0],s=e[1],r=e[2],o=e[3],a=t*t+s*s+r*r+o*o,n=a?1/a:0;return i[0]=-t*n,i[1]=-s*n,i[2]=-r*n,i[3]=o*n,i}function pi(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i[3]=e[3],i}function Lt(i,e){const t=e[0]+e[4]+e[8];let s;if(t>0)s=Math.sqrt(t+1),i[3]=.5*s,s=.5/s,i[0]=(e[5]-e[7])*s,i[1]=(e[6]-e[2])*s,i[2]=(e[1]-e[3])*s;else{let r=0;e[4]>e[0]&&(r=1),e[8]>e[r*3+r]&&(r=2);const o=(r+1)%3,a=(r+2)%3;s=Math.sqrt(e[r*3+r]-e[o*3+o]-e[a*3+a]+1),i[r]=.5*s,s=.5/s,i[3]=(e[o*3+a]-e[a*3+o])*s,i[o]=(e[o*3+r]+e[r*3+o])*s,i[a]=(e[a*3+r]+e[r*3+a])*s}return i}const fi=Es,gi=Ns,yi=Is,_i=As,xi=vs,wi=Ls,It=ks,bi=(function(){const i=Ps(),e=je(1,0,0),t=je(0,1,0);return function(s,r,o){const a=Rs(r,o);return a<-.999999?(me(i,e,r),zs(i)<1e-6&&me(i,t,r),Os(i,i),vt(s,i,Math.PI),s):a>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(me(i,r,o),s[0]=i[0],s[1]=i[1],s[2]=i[2],s[3]=1+a,It(s,s))}})();(function(){const i=$e(),e=$e();return function(t,s,r,o,a,n){return ie(i,s,a,n),ie(e,r,o,n),ie(t,i,e,2*n*(1-n)),t}})();(function(){const i=Qs();return function(e,t,s,r){return i[0]=s[0],i[3]=s[1],i[6]=s[2],i[1]=r[0],i[4]=r[1],i[7]=r[2],i[2]=-t[0],i[5]=-t[1],i[8]=-t[2],It(e,Lt(e,i))}})();const Mi=[0,0,0,1];class He extends Ts{constructor(e=0,t=0,s=0,r=1){super(-0,-0,-0,-0),Array.isArray(e)&&arguments.length===1?this.copy(e):this.set(e,t,s,r)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,t,s,r){return this[0]=e,this[1]=t,this[2]=s,this[3]=r,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return Lt(this,e),this.check()}fromAxisRotation(e,t){return vt(this,e,t),this.check()}identity(){return hi(this),this.check()}setAxisAngle(e,t){return this.fromAxisRotation(e,t)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=P(e)}get y(){return this[1]}set y(e){this[1]=P(e)}get z(){return this[2]}set z(e){this[2]=P(e)}get w(){return this[3]}set w(e){this[3]=P(e)}len(){return xi(this)}lengthSquared(){return wi(this)}dot(e){return yi(this,e)}rotationTo(e,t){return bi(this,e,t),this.check()}add(e){return fi(this,this,e),this.check()}calculateW(){return di(this,this),this.check()}conjugate(){return pi(this,this),this.check()}invert(){return mi(this,this),this.check()}lerp(e,t,s){return s===void 0?this.lerp(this,e,t):(_i(this,e,t,s),this.check())}multiplyRight(e){return Ye(this,this,e),this.check()}multiplyLeft(e){return Ye(this,e,this),this.check()}normalize(){const e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,e===0&&(this[3]=1),this.check()}rotateX(e){return li(this,this,e),this.check()}rotateY(e){return ci(this,this,e),this.check()}rotateZ(e){return ui(this,this,e),this.check()}scale(e){return gi(this,this,e),this.check()}slerp(e,t,s){let r,o,a;switch(arguments.length){case 1:({start:r=Mi,target:o,ratio:a}=e);break;case 2:r=this,o=e,a=t;break;default:r=e,o=t,a=s}return ie(this,r,o,a),this.check()}transformVector4(e,t=new Le){return Ss(t,e,this),Ct(t,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,t){return this.setAxisAngle(e,t)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}}const Ti=1e-15,Si=1e-20,Pt={name:"phongMaterial",dependencies:[ps],source:ms,vs:ds,fs:us,defines:{LIGHTING_FRAGMENT:!0},uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(i){const e={...i};return e.specularColor&&(e.specularColor=e.specularColor.map(t=>t/255)),{...Pt.defaultUniforms,...e}}},Rt=[0,0,0,255],Ci=[0,0,0,255],vi={stroked:!0,filled:!0,extruded:!1,elevationScale:1,wireframe:!1,_normalize:!0,_windingOrder:"CW",lineWidthUnits:"meters",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,getPolygon:{type:"accessor",value:i=>i.polygon},getFillColor:{type:"accessor",value:Ci},getLineColor:{type:"accessor",value:Rt},getLineWidth:{type:"accessor",value:1},getElevation:{type:"accessor",value:1e3},material:!0};class Ie extends j{initializeState(){this.state={paths:[],pathsDiff:null},this.props.getLineDashArray&&bt.removed("getLineDashArray","PathStyleExtension")()}updateState({changeFlags:e}){const t=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getPolygon);if(t&&Array.isArray(e.dataChanged)){const s=this.state.paths.slice(),r=e.dataChanged.map(o=>os({data:s,getIndex:a=>a.__source.index,dataRange:o,replace:this._getPaths(o)}));this.setState({paths:s,pathsDiff:r})}else t&&this.setState({paths:this._getPaths(),pathsDiff:null})}_getPaths(e={}){const{data:t,getPolygon:s,positionFormat:r,_normalize:o}=this.props,a=[],n=r==="XY"?2:3,{startRow:h,endRow:c}=e,{iterable:u,objectInfo:l}=Mt(t,h,c);for(const d of u){l.index++;let m=s(d,l);o&&(m=as(m,n));const{holeIndices:p}=m,f=m.positions||m;if(p)for(let g=0;g<=p.length;g++){const y=f.slice(p[g-1]||0,p[g]||f.length);a.push(this.getSubLayerRow({path:y},d,l.index))}else a.push(this.getSubLayerRow({path:f},d,l.index))}return a}renderLayers(){const{data:e,_dataDiff:t,stroked:s,filled:r,extruded:o,wireframe:a,_normalize:n,_windingOrder:h,elevationScale:c,transitions:u,positionFormat:l}=this.props,{lineWidthUnits:d,lineWidthScale:m,lineWidthMinPixels:p,lineWidthMaxPixels:f,lineJointRounded:g,lineMiterLimit:y,lineDashJustified:_}=this.props,{getFillColor:x,getLineColor:b,getLineWidth:M,getLineDashArray:S,getElevation:v,getPolygon:R,updateTriggers:T,material:C}=this.props,{paths:D,pathsDiff:U}=this.state,le=this.getSubLayerClass("fill",ns),ce=this.getSubLayerClass("stroke",wt),V=this.shouldRenderSubLayer("fill",D)&&new le({_dataDiff:t,extruded:o,elevationScale:c,filled:r,wireframe:a,_normalize:n,_windingOrder:h,getElevation:v,getFillColor:x,getLineColor:o&&a?b:Rt,material:C,transitions:u},this.getSubLayerProps({id:"fill",updateTriggers:T&&{getPolygon:T.getPolygon,getElevation:T.getElevation,getFillColor:T.getFillColor,lineColors:o&&a,getLineColor:T.getLineColor}}),{data:e,positionFormat:l,getPolygon:R}),Vt=!o&&s&&this.shouldRenderSubLayer("stroke",D)&&new ce({_dataDiff:U&&(()=>U),widthUnits:d,widthScale:m,widthMinPixels:p,widthMaxPixels:f,jointRounded:g,miterLimit:y,dashJustified:_,_pathType:"loop",transitions:u&&{getWidth:u.getLineWidth,getColor:u.getLineColor,getPath:u.getPolygon},getColor:this.getSubLayerAccessor(b),getWidth:this.getSubLayerAccessor(M),getDashArray:this.getSubLayerAccessor(S)},this.getSubLayerProps({id:"stroke",updateTriggers:T&&{getWidth:T.getLineWidth,getColor:T.getLineColor,getDashArray:T.getLineDashArray}}),{data:D,positionFormat:l,getPath:Zt=>Zt.path});return[!o&&V,Vt,o&&V]}}Ie.layerName="PolygonLayer";Ie.defaultProps=vi;class Li{constructor(e){this.index=e,this.isVisible=!1,this.isSelected=!1,this.parent=null,this.children=[],this.content=null,this._loader=void 0,this._abortController=null,this._loaderId=0,this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1}get bbox(){return this._bbox}set bbox(e){this._bbox||(this._bbox=e,"west"in e?this.boundingBox=[[e.west,e.south],[e.east,e.north]]:this.boundingBox=[[e.left,e.top],[e.right,e.bottom]])}get data(){return this.isLoading&&this._loader?this._loader.then(()=>this.data):this.content}get isLoaded(){return this._isLoaded&&!this._needsReload}get isLoading(){return!!this._loader&&!this._isCancelled}get needsReload(){return this._needsReload||this._isCancelled}get byteLength(){const e=this.content?this.content.byteLength:0;return Number.isFinite(e)||console.error("byteLength not defined in tile data"),e}async _loadData({getData:e,requestScheduler:t,onLoad:s,onError:r}){const{index:o,id:a,bbox:n,userData:h,zoom:c}=this,u=this._loaderId;this._abortController=new AbortController;const{signal:l}=this._abortController,d=await t.scheduleRequest(this,f=>f.isSelected?1:-1);if(!d){this._isCancelled=!0;return}if(this._isCancelled){d.done();return}let m=null,p;try{m=await e({index:o,id:a,bbox:n,userData:h,zoom:c,signal:l})}catch(f){p=f||!0}finally{d.done()}if(u===this._loaderId){if(this._loader=void 0,this.content=m,this._isCancelled&&!m){this._isLoaded=!1;return}this._isLoaded=!0,this._isCancelled=!1,p?r(p,this):s(this)}}loadData(e){return this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1,this._loaderId++,this._loader=this._loadData(e),this._loader}setNeedsReload(){this.isLoading&&(this.abort(),this._loader=void 0),this._needsReload=!0}abort(){this.isLoaded||(this._isCancelled=!0,this._abortController?.abort())}}const I={OUTSIDE:-1,INTERSECTING:0,INSIDE:1},Ke=new w,Ii=new w;class Pe{constructor(e=[0,0,0],t=[0,0,0],s){s=s||Ke.copy(e).add(t).scale(.5),this.center=new w(s),this.halfDiagonal=new w(t).subtract(this.center),this.minimum=new w(e),this.maximum=new w(t)}clone(){return new Pe(this.minimum,this.maximum,this.center)}equals(e){return this===e||!!e&&this.minimum.equals(e.minimum)&&this.maximum.equals(e.maximum)}transform(e){return this.center.transformAsPoint(e),this.halfDiagonal.transform(e),this.minimum.transform(e),this.maximum.transform(e),this}intersectPlane(e){const{halfDiagonal:t}=this,s=Ii.from(e.normal),r=t.x*Math.abs(s.x)+t.y*Math.abs(s.y)+t.z*Math.abs(s.z),o=this.center.dot(s)+e.distance;return o-r>0?I.INSIDE:o+r<0?I.OUTSIDE:I.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){const t=Ke.from(e).subtract(this.center),{halfDiagonal:s}=this;let r=0,o;return o=Math.abs(t.x)-s.x,o>0&&(r+=o*o),o=Math.abs(t.y)-s.y,o>0&&(r+=o*o),o=Math.abs(t.z)-s.z,o>0&&(r+=o*o),r}}const Z=new w,Xe=new w;class Re{constructor(e=[0,0,0],t=0){this.radius=-0,this.center=new w,this.fromCenterRadius(e,t)}fromCenterRadius(e,t){return this.center.from(e),this.radius=t,this}fromCornerPoints(e,t){return t=Z.from(t),this.center=new w().from(e).add(t).scale(.5),this.radius=this.center.distance(t),this}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.radius===e.radius}clone(){return new Re(this.center,this.radius)}union(e){const t=this.center,s=this.radius,r=e.center,o=e.radius,a=Z.copy(r).subtract(t),n=a.magnitude();if(s>=n+o)return this.clone();if(o>=n+s)return e.clone();const h=(s+n+o)*.5;return Xe.copy(a).scale((-s+h)/n).add(t),this.center.copy(Xe),this.radius=h,this}expand(e){const t=Z.from(e).subtract(this.center).magnitude();return t>this.radius&&(this.radius=t),this}transform(e){this.center.transform(e);const t=Cs(Z,e);return this.radius=Math.max(t[0],Math.max(t[1],t[2]))*this.radius,this}distanceSquaredTo(e){const t=this.distanceTo(e);return t*t}distanceTo(e){const t=Z.from(e).subtract(this.center);return Math.max(0,t.len()-this.radius)}intersectPlane(e){const t=this.center,s=this.radius,r=e.normal.dot(t)+e.distance;return r<-s?I.OUTSIDE:r<s?I.INTERSECTING:I.INSIDE}}const Pi=new w,Ri=new w,K=new w,X=new w,Q=new w,zi=new w,Oi=new w,E={COLUMN0ROW0:0,COLUMN0ROW1:1,COLUMN0ROW2:2,COLUMN1ROW0:3,COLUMN1ROW1:4,COLUMN1ROW2:5,COLUMN2ROW0:6,COLUMN2ROW1:7,COLUMN2ROW2:8};class ze{constructor(e=[0,0,0],t=[0,0,0,0,0,0,0,0,0]){this.center=new w().from(e),this.halfAxes=new L(t)}get halfSize(){const e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),s=this.halfAxes.getColumn(2);return[new w(e).len(),new w(t).len(),new w(s).len()]}get quaternion(){const e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),s=this.halfAxes.getColumn(2),r=new w(e).normalize(),o=new w(t).normalize(),a=new w(s).normalize();return new He().fromMatrix3(new L([...r,...o,...a]))}fromCenterHalfSizeQuaternion(e,t,s){const r=new He(s),o=new L().fromQuaternion(r);return o[0]=o[0]*t[0],o[1]=o[1]*t[0],o[2]=o[2]*t[0],o[3]=o[3]*t[1],o[4]=o[4]*t[1],o[5]=o[5]*t[1],o[6]=o[6]*t[2],o[7]=o[7]*t[2],o[8]=o[8]*t[2],this.center=new w().from(e),this.halfAxes=o,this}clone(){return new ze(this.center,this.halfAxes)}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}getBoundingSphere(e=new Re){const t=this.halfAxes,s=t.getColumn(0,K),r=t.getColumn(1,X),o=t.getColumn(2,Q),a=Pi.copy(s).add(r).add(o);return e.center.copy(this.center),e.radius=a.magnitude(),e}intersectPlane(e){const t=this.center,s=e.normal,r=this.halfAxes,o=s.x,a=s.y,n=s.z,h=Math.abs(o*r[E.COLUMN0ROW0]+a*r[E.COLUMN0ROW1]+n*r[E.COLUMN0ROW2])+Math.abs(o*r[E.COLUMN1ROW0]+a*r[E.COLUMN1ROW1]+n*r[E.COLUMN1ROW2])+Math.abs(o*r[E.COLUMN2ROW0]+a*r[E.COLUMN2ROW1]+n*r[E.COLUMN2ROW2]),c=s.dot(t)+e.distance;return c<=-h?I.OUTSIDE:c>=h?I.INSIDE:I.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){const t=Ri.from(e).subtract(this.center),s=this.halfAxes,r=s.getColumn(0,K),o=s.getColumn(1,X),a=s.getColumn(2,Q),n=r.magnitude(),h=o.magnitude(),c=a.magnitude();r.normalize(),o.normalize(),a.normalize();let u=0,l;return l=Math.abs(t.dot(r))-n,l>0&&(u+=l*l),l=Math.abs(t.dot(o))-h,l>0&&(u+=l*l),l=Math.abs(t.dot(a))-c,l>0&&(u+=l*l),u}computePlaneDistances(e,t,s=[-0,-0]){let r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;const a=this.center,n=this.halfAxes,h=n.getColumn(0,K),c=n.getColumn(1,X),u=n.getColumn(2,Q),l=zi.copy(h).add(c).add(u).add(a),d=Oi.copy(l).subtract(e);let m=t.dot(d);return r=Math.min(m,r),o=Math.max(m,o),l.copy(a).add(h).add(c).subtract(u),d.copy(l).subtract(e),m=t.dot(d),r=Math.min(m,r),o=Math.max(m,o),l.copy(a).add(h).subtract(c).add(u),d.copy(l).subtract(e),m=t.dot(d),r=Math.min(m,r),o=Math.max(m,o),l.copy(a).add(h).subtract(c).subtract(u),d.copy(l).subtract(e),m=t.dot(d),r=Math.min(m,r),o=Math.max(m,o),a.copy(l).subtract(h).add(c).add(u),d.copy(l).subtract(e),m=t.dot(d),r=Math.min(m,r),o=Math.max(m,o),a.copy(l).subtract(h).add(c).subtract(u),d.copy(l).subtract(e),m=t.dot(d),r=Math.min(m,r),o=Math.max(m,o),a.copy(l).subtract(h).subtract(c).add(u),d.copy(l).subtract(e),m=t.dot(d),r=Math.min(m,r),o=Math.max(m,o),a.copy(l).subtract(h).subtract(c).subtract(u),d.copy(l).subtract(e),m=t.dot(d),r=Math.min(m,r),o=Math.max(m,o),s[0]=r,s[1]=o,s}transform(e){this.center.transformAsPoint(e);const t=this.halfAxes.getColumn(0,K);t.transformAsPoint(e);const s=this.halfAxes.getColumn(1,X);s.transformAsPoint(e);const r=this.halfAxes.getColumn(2,Q);return r.transformAsPoint(e),this.halfAxes=new L([...t,...s,...r]),this}getTransform(){throw new Error("not implemented")}}const Qe=new w,Je=new w;class B{constructor(e=[0,0,1],t=0){this.normal=new w,this.distance=-0,this.fromNormalDistance(e,t)}fromNormalDistance(e,t){return xe(Number.isFinite(t)),this.normal.from(e).normalize(),this.distance=t,this}fromPointNormal(e,t){e=Qe.from(e),this.normal.from(t).normalize();const s=-this.normal.dot(e);return this.distance=s,this}fromCoefficients(e,t,s,r){return this.normal.set(e,t,s),xe(se(this.normal.len(),1)),this.distance=r,this}clone(){return new B(this.normal,this.distance)}equals(e){return se(this.distance,e.distance)&&se(this.normal,e.normal)}getPointDistance(e){return this.normal.dot(e)+this.distance}transform(e){const t=Je.copy(this.normal).transformAsVector(e).normalize(),s=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(s,t)}projectPointOntoPlane(e,t=[0,0,0]){const s=Qe.from(e),r=this.getPointDistance(s),o=Je.copy(this.normal).scale(r);return s.subtract(o).to(t)}}const et=[new w([1,0,0]),new w([0,1,0]),new w([0,0,1])],tt=new w,Ei=new w;class O{constructor(e=[]){this.planes=e}fromBoundingSphere(e){this.planes.length=2*et.length;const t=e.center,s=e.radius;let r=0;for(const o of et){let a=this.planes[r],n=this.planes[r+1];a||(a=this.planes[r]=new B),n||(n=this.planes[r+1]=new B);const h=tt.copy(o).scale(-s).add(t);a.fromPointNormal(h,o);const c=tt.copy(o).scale(s).add(t),u=Ei.copy(o).negate();n.fromPointNormal(c,u),r+=2}return this}computeVisibility(e){let t=I.INSIDE;for(const s of this.planes)switch(e.intersectPlane(s)){case I.OUTSIDE:return I.OUTSIDE;case I.INTERSECTING:t=I.INTERSECTING;break}return t}computeVisibilityWithPlaneMask(e,t){if(xe(Number.isFinite(t),"parentPlaneMask is required."),t===O.MASK_OUTSIDE||t===O.MASK_INSIDE)return t;let s=O.MASK_INSIDE;const r=this.planes;for(let o=0;o<this.planes.length;++o){const a=o<31?1<<o:0;if(o<31&&(t&a)===0)continue;const n=r[o],h=e.intersectPlane(n);if(h===I.OUTSIDE)return O.MASK_OUTSIDE;h===I.INTERSECTING&&(s|=a)}return s}}O.MASK_OUTSIDE=4294967295;O.MASK_INSIDE=0;O.MASK_INDETERMINATE=2147483647;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;const z=new L,Ai=new L,Ni=new L,J=new L,st=new L;function qi(i,e={}){const t=Si,s=10;let r=0,o=0;const a=Ai,n=Ni;a.identity(),n.copy(i);const h=t*Fi(n);for(;o<s&&Di(n)>h;)Gi(n,J),st.copy(J).transpose(),n.multiplyRight(J),n.multiplyLeft(st),a.multiplyRight(J),++r>2&&(++o,r=0);return e.unitary=a.toTarget(e.unitary),e.diagonal=n.toTarget(e.diagonal),e}function Fi(i){let e=0;for(let t=0;t<9;++t){const s=i[t];e+=s*s}return Math.sqrt(e)}const be=[1,0,0],Me=[2,2,1];function Di(i){let e=0;for(let t=0;t<3;++t){const s=i[z.getElementIndex(Me[t],be[t])];e+=2*s*s}return Math.sqrt(e)}function Gi(i,e){const t=Ti;let s=0,r=1;for(let c=0;c<3;++c){const u=Math.abs(i[z.getElementIndex(Me[c],be[c])]);u>s&&(r=c,s=u)}const o=be[r],a=Me[r];let n=1,h=0;if(Math.abs(i[z.getElementIndex(a,o)])>t){const c=i[z.getElementIndex(a,a)],u=i[z.getElementIndex(o,o)],l=i[z.getElementIndex(a,o)],d=(c-u)/2/l;let m;d<0?m=-1/(-d+Math.sqrt(1+d*d)):m=1/(d+Math.sqrt(1+d*d)),n=1/Math.sqrt(1+m*m),h=m*n}return L.IDENTITY.to(e),e[z.getElementIndex(o,o)]=e[z.getElementIndex(a,a)]=n,e[z.getElementIndex(a,o)]=h,e[z.getElementIndex(o,a)]=-h,e}const N=new w,Wi=new w,ki=new w,Bi=new w,ji=new w,Ui=new L,Vi={diagonal:new L,unitary:new L};function zt(i,e=new ze){if(!i||i.length===0)return e.halfAxes=new L([0,0,0,0,0,0,0,0,0]),e.center=new w,e;const t=i.length,s=new w(0,0,0);for(const T of i)s.add(T);const r=1/t;s.multiplyByScalar(r);let o=0,a=0,n=0,h=0,c=0,u=0;for(const T of i){const C=N.copy(T).subtract(s);o+=C.x*C.x,a+=C.x*C.y,n+=C.x*C.z,h+=C.y*C.y,c+=C.y*C.z,u+=C.z*C.z}o*=r,a*=r,n*=r,h*=r,c*=r,u*=r;const l=Ui;l[0]=o,l[1]=a,l[2]=n,l[3]=a,l[4]=h,l[5]=c,l[6]=n,l[7]=c,l[8]=u;const{unitary:d}=qi(l,Vi),m=e.halfAxes.copy(d);let p=m.getColumn(0,ki),f=m.getColumn(1,Bi),g=m.getColumn(2,ji),y=-Number.MAX_VALUE,_=-Number.MAX_VALUE,x=-Number.MAX_VALUE,b=Number.MAX_VALUE,M=Number.MAX_VALUE,S=Number.MAX_VALUE;for(const T of i)N.copy(T),y=Math.max(N.dot(p),y),_=Math.max(N.dot(f),_),x=Math.max(N.dot(g),x),b=Math.min(N.dot(p),b),M=Math.min(N.dot(f),M),S=Math.min(N.dot(g),S);p=p.multiplyByScalar(.5*(b+y)),f=f.multiplyByScalar(.5*(M+_)),g=g.multiplyByScalar(.5*(S+x)),e.center.copy(p).add(f).add(g);const v=Wi.set(y-b,_-M,x-S).multiplyByScalar(.5),R=new L([v[0],0,0,0,v[1],0,0,0,v[2]]);return e.halfAxes.multiplyRight(R),e}const W=512,it=3,Ot=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],Et=Ot.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),Zi=Et.concat([[.25,.5],[.75,.5]]);class k{constructor(e,t,s){this.x=e,this.y=t,this.z=s}get children(){if(!this._children){const e=this.x*2,t=this.y*2,s=this.z+1;this._children=[new k(e,t,s),new k(e,t+1,s),new k(e+1,t,s),new k(e+1,t+1,s)]}return this._children}update(e){const{viewport:t,cullingVolume:s,elevationBounds:r,minZ:o,maxZ:a,bounds:n,offset:h,project:c}=e,u=this.getBoundingVolume(r,h,c);if(n&&!this.insideBounds(n)||s.computeVisibility(u)<0)return!1;if(!this.childVisible){let{z:l}=this;if(l<a&&l>=o){const d=u.distanceTo(t.cameraPosition)*t.scale/t.height;l+=Math.floor(Math.log2(d))}if(l>=a)return this.selected=!0,!0}this.selected=!1,this.childVisible=!0;for(const l of this.children)l.update(e);return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(const t of this._children)t.getSelected(e);return e}insideBounds([e,t,s,r]){const o=Math.pow(2,this.z),a=W/o;return this.x*a<s&&this.y*a<r&&(this.x+1)*a>e&&(this.y+1)*a>t}getBoundingVolume(e,t,s){if(s){const h=this.z<1?Zi:this.z<2?Et:Ot,c=[];for(const u of h){const l=Se(this.x+u[0],this.y+u[1],this.z);l[2]=e[0],c.push(s(l)),e[0]!==e[1]&&(l[2]=e[1],c.push(s(l)))}return zt(c)}const r=Math.pow(2,this.z),o=W/r,a=this.x*o+t*W,n=W-(this.y+1)*o;return new Pe([a,n,e[0]],[a+o,n+o,e[1]])}}function $i(i,e,t,s){const r=i instanceof Tt&&i.resolution?i.projectPosition:null,o=Object.values(i.getFrustumPlanes()).map(({normal:m,distance:p})=>new B(m.clone().negate(),p)),a=new O(o),n=i.distanceScales.unitsPerMeter[2],h=t&&t[0]*n||0,c=t&&t[1]*n||0,u=i instanceof Be&&i.pitch<=60?e:0;if(s){const[m,p,f,g]=s,y=re([m,g]),_=re([f,p]);s=[y[0],W-y[1],_[0],W-_[1]]}const l=new k(0,0,0),d={viewport:i,project:r,cullingVolume:a,elevationBounds:[h,c],minZ:u,maxZ:e,bounds:s,offset:0};if(l.update(d),i instanceof Be&&i.subViewports&&i.subViewports.length>1){for(d.offset=-1;l.update(d)&&!(--d.offset<-it););for(d.offset=1;l.update(d)&&!(++d.offset>it););}return l.getSelected()}const A=512,Yi=[-1/0,-1/0,1/0,1/0],Hi={equal:(i,e)=>{if(i===e)return!0;if(!Array.isArray(i)||!Array.isArray(e))return!1;const t=i.length;if(t!==e.length)return!1;for(let s=0;s<t;s++)if(i[s]!==e[s])return!1;return!0}};function Oe(i,e){const t=[e.transformAsPoint([i[0],i[1]]),e.transformAsPoint([i[2],i[1]]),e.transformAsPoint([i[0],i[3]]),e.transformAsPoint([i[2],i[3]])];return[Math.min(...t.map(s=>s[0])),Math.min(...t.map(s=>s[1])),Math.max(...t.map(s=>s[0])),Math.max(...t.map(s=>s[1]))]}function Ki(i){return Math.abs(i.split("").reduce((e,t)=>(e<<5)-e+t.charCodeAt(0)|0,0))}function Xi(i,e){if(!i||!i.length)return null;const{index:t,id:s}=e;if(Array.isArray(i)){const o=Ki(s)%i.length;i=i[o]}let r=i;for(const o of Object.keys(t)){const a=new RegExp(`{${o}}`,"g");r=r.replace(a,String(t[o]))}return Number.isInteger(t.y)&&Number.isInteger(t.z)&&(r=r.replace(/\{-y\}/g,String(Math.pow(2,t.z)-t.y-1))),r}function Qi(i,e,t){let s;return s=i.getBounds(),i.isGeospatial?[Math.max(s[0],t[0]),Math.max(s[1],t[1]),Math.min(s[2],t[2]),Math.min(s[3],t[3])]:[Math.max(Math.min(s[0],t[2]),t[0]),Math.max(Math.min(s[1],t[3]),t[1]),Math.min(Math.max(s[2],t[0]),t[2]),Math.min(Math.max(s[3],t[1]),t[3])]}function Ji({viewport:i,z:e,cullRect:t}){return(i.subViewports||[i]).map(s=>Te(s,e||0,t))}function Te(i,e,t){if(!Array.isArray(e)){const o=t.x-i.x,a=t.y-i.y,{width:n,height:h}=t,c={targetZ:e},u=i.unproject([o,a],c),l=i.unproject([o+n,a],c),d=i.unproject([o,a+h],c),m=i.unproject([o+n,a+h],c);return[Math.min(u[0],l[0],d[0],m[0]),Math.min(u[1],l[1],d[1],m[1]),Math.max(u[0],l[0],d[0],m[0]),Math.max(u[1],l[1],d[1],m[1])]}const s=Te(i,e[0],t),r=Te(i,e[1],t);return[Math.min(s[0],r[0]),Math.min(s[1],r[1]),Math.max(s[2],r[2]),Math.max(s[3],r[3])]}function er(i,e,t){return t?Oe(i,t).map(s=>s*e/A):i.map(s=>s*e/A)}function Ee(i,e){return Math.pow(2,i)*A/e}function Se(i,e,t){const s=Ee(t,A),r=i/s*360-180,o=Math.PI-2*Math.PI*e/s,a=180/Math.PI*Math.atan(.5*(Math.exp(o)-Math.exp(-o)));return[r,a]}function rt(i,e,t,s){const r=Ee(t,s);return[i/r*A,e/r*A]}function tr(i,e,t,s,r=A){if(i.isGeospatial){const[c,u]=Se(e,t,s),[l,d]=Se(e+1,t+1,s);return{west:c,north:u,east:l,south:d}}const[o,a]=rt(e,t,s,r),[n,h]=rt(e+1,t+1,s,r);return{left:o,top:a,right:n,bottom:h}}function sr(i,e,t,s,r){const o=Qi(i,null,s),a=Ee(e,t),[n,h,c,u]=er(o,a,r),l=[];for(let d=Math.floor(n);d<c;d++)for(let m=Math.floor(h);m<u;m++)l.push({x:d,y:m,z:e});return l}function ir({viewport:i,maxZoom:e,minZoom:t,zRange:s,extent:r,tileSize:o=A,modelMatrix:a,modelMatrixInverse:n,zoomOffset:h=0}){let c=i.isGeospatial?Math.round(i.zoom+Math.log2(A/o))+h:Math.ceil(i.zoom)+h;if(typeof t=="number"&&Number.isFinite(t)&&c<t){if(!r)return[];c=t}typeof e=="number"&&Number.isFinite(e)&&c>e&&(c=e);let u=r;return a&&n&&r&&!i.isGeospatial&&(u=Oe(r,a)),i.isGeospatial?$i(i,c,s,r):sr(i,c,o,u||Yi,n)}function rr(i){let e={},t;return s=>{for(const r in s)if(!or(s[r],e[r])){t=i(s),e=s;break}return t}}function or(i,e){if(i===e)return!0;if(Array.isArray(i)){const t=i.length;if(!e||e.length!==t)return!1;for(let s=0;s<t;s++)if(i[s]!==e[s])return!1;return!0}return!1}const ot=1,ne=2,ar="never",nr="no-overlap",Ae="best-available",hr=5,lr={[Ae]:ur,[nr]:dr,[ar]:()=>{}},cr={extent:null,tileSize:512,maxZoom:null,minZoom:null,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:"best-available",zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{}};class Ne{constructor(e){this._getCullBounds=rr(Ji),this.opts={...cr,...e},this.setOptions(this.opts),this.onTileLoad=t=>{this.opts.onTileLoad?.(t),this.opts.maxCacheByteSize!==null&&(this._cacheByteSize+=t.byteLength,this._resizeCache())},this._requestScheduler=new Ks({throttleRequests:this.opts.maxRequests>0||this.opts.debounceTime>0,maxRequests:this.opts.maxRequests,debounceTime:this.opts.debounceTime}),this._cache=new Map,this._tiles=[],this._dirty=!1,this._cacheByteSize=0,this._viewport=null,this._zRange=null,this._selectedTiles=null,this._frameNumber=0,this._modelMatrix=new G,this._modelMatrixInverse=new G}get tiles(){return this._tiles}get selectedTiles(){return this._selectedTiles}get isLoaded(){return this._selectedTiles!==null&&this._selectedTiles.every(e=>e.isLoaded)}get needsReload(){return this._selectedTiles!==null&&this._selectedTiles.some(e=>e.needsReload)}setOptions(e){Object.assign(this.opts,e),Number.isFinite(e.maxZoom)&&(this._maxZoom=Math.floor(e.maxZoom)),Number.isFinite(e.minZoom)&&(this._minZoom=Math.ceil(e.minZoom))}finalize(){for(const e of this._cache.values())e.isLoading&&e.abort();this._cache.clear(),this._tiles=[],this._selectedTiles=null}reloadAll(){for(const e of this._cache.keys()){const t=this._cache.get(e);!this._selectedTiles||!this._selectedTiles.includes(t)?this._cache.delete(e):t.setNeedsReload()}}update(e,{zRange:t,modelMatrix:s}={zRange:null,modelMatrix:null}){const r=s?new G(s):new G,o=!r.equals(this._modelMatrix);if(!this._viewport||!e.equals(this._viewport)||!se(this._zRange,t)||o){o&&(this._modelMatrixInverse=r.clone().invert(),this._modelMatrix=r),this._viewport=e,this._zRange=t;const n=this.getTileIndices({viewport:e,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:t,modelMatrix:this._modelMatrix,modelMatrixInverse:this._modelMatrixInverse});this._selectedTiles=n.map(h=>this._getTile(h,!0)),this._dirty&&this._rebuildTree()}else this.needsReload&&(this._selectedTiles=this._selectedTiles.map(n=>this._getTile(n.index,!0)));const a=this.updateTileStates();return this._pruneRequests(),this._dirty&&this._resizeCache(),a&&this._frameNumber++,this._frameNumber}isTileVisible(e,t,s){if(!e.isVisible)return!1;if(t&&this._viewport){const r=this._getCullBounds({viewport:this._viewport,z:this._zRange,cullRect:t});let{bbox:o}=e;for(const[a,n,h,c]of r){let u;if("west"in o)u=o.west<h&&o.east>a&&o.south<c&&o.north>n;else{if(s&&!G.IDENTITY.equals(s)){const[m,p,f,g]=Oe([o.left,o.top,o.right,o.bottom],s);o={left:m,top:p,right:f,bottom:g}}const l=Math.min(o.top,o.bottom),d=Math.max(o.top,o.bottom);u=o.left<h&&o.right>a&&l<c&&d>n}if(u)return!0}return!1}return!0}getTileIndices({viewport:e,maxZoom:t,minZoom:s,zRange:r,modelMatrix:o,modelMatrixInverse:a}){const{tileSize:n,extent:h,zoomOffset:c}=this.opts;return ir({viewport:e,maxZoom:t,minZoom:s,zRange:r,tileSize:n,extent:h,modelMatrix:o,modelMatrixInverse:a,zoomOffset:c})}getTileId(e){return`${e.x}-${e.y}-${e.z}`}getTileZoom(e){return e.z}getTileMetadata(e){const{tileSize:t}=this.opts;return{bbox:tr(this._viewport,e.x,e.y,e.z,t)}}getParentIndex(e){const t=Math.floor(e.x/2),s=Math.floor(e.y/2),r=e.z-1;return{x:t,y:s,z:r}}updateTileStates(){const e=this.opts.refinementStrategy||Ae,t=new Array(this._cache.size);let s=0;for(const r of this._cache.values())t[s++]=r.isVisible,r.isSelected=!1,r.isVisible=!1;for(const r of this._selectedTiles)r.isSelected=!0,r.isVisible=!0;(typeof e=="function"?e:lr[e])(Array.from(this._cache.values())),s=0;for(const r of this._cache.values())if(t[s++]!==r.isVisible)return!0;return!1}_pruneRequests(){const{maxRequests:e=0}=this.opts,t=[];let s=0;for(const r of this._cache.values())r.isLoading&&(s++,!r.isSelected&&!r.isVisible&&t.push(r));for(;e>0&&s>e&&t.length>0;)t.shift().abort(),s--}_rebuildTree(){const{_cache:e}=this;for(const t of e.values())t.parent=null,t.children&&(t.children.length=0);for(const t of e.values()){const s=this._getNearestAncestor(t);t.parent=s,s?.children&&s.children.push(t)}}_resizeCache(){const{_cache:e,opts:t}=this,s=t.maxCacheSize??(t.maxCacheByteSize!==null?1/0:hr*this.selectedTiles.length),r=t.maxCacheByteSize??1/0;if(e.size>s||this._cacheByteSize>r){for(const[o,a]of e)if(!a.isVisible&&!a.isSelected&&(this._cacheByteSize-=t.maxCacheByteSize!==null?a.byteLength:0,e.delete(o),this.opts.onTileUnload?.(a)),e.size<=s&&this._cacheByteSize<=r)break;this._rebuildTree(),this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort((o,a)=>o.zoom-a.zoom),this._dirty=!1)}_getTile(e,t){const s=this.getTileId(e);let r=this._cache.get(s),o=!1;return!r&&t?(r=new Li(e),Object.assign(r,this.getTileMetadata(r.index)),Object.assign(r,{id:s,zoom:this.getTileZoom(r.index)}),o=!0,this._cache.set(s,r),this._dirty=!0):r&&r.needsReload&&(o=!0),r&&o&&r.loadData({getData:this.opts.getTileData,requestScheduler:this._requestScheduler,onLoad:this.onTileLoad,onError:this.opts.onTileError}),r}_getNearestAncestor(e){const{_minZoom:t=0}=this;let s=e.index;for(;this.getTileZoom(s)>t;){s=this.getParentIndex(s);const r=this._getTile(s);if(r)return r}return null}}function ur(i){for(const e of i)e.state=0;for(const e of i)e.isSelected&&!At(e)&&qe(e);for(const e of i)e.isVisible=!!(e.state&ne)}function dr(i){for(const t of i)t.state=0;for(const t of i)t.isSelected&&At(t);const e=Array.from(i).sort((t,s)=>t.zoom-s.zoom);for(const t of e)if(t.isVisible=!!(t.state&ne),t.children&&(t.isVisible||t.state&ot))for(const s of t.children)s.state=ot;else t.isSelected&&qe(t)}function At(i){let e=i;for(;e;){if(e.isLoaded||e.content)return e.state|=ne,!0;e=e.parent}return!1}function qe(i){for(const e of i.children)e.isLoaded||e.content?e.state|=ne:qe(e)}const mr={TilesetClass:Ne,data:{type:"data",value:[]},dataComparator:Hi.equal,renderSubLayers:{type:"function",value:i=>new js(i)},getTileData:{type:"function",optional:!0,value:null},onViewportLoad:{type:"function",optional:!0,value:null},onTileLoad:{type:"function",value:i=>{}},onTileUnload:{type:"function",value:i=>{}},onTileError:{type:"function",value:i=>console.error(i)},extent:{type:"array",optional:!0,value:null,compare:!0},tileSize:512,maxZoom:null,minZoom:0,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:Ae,zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0};class he extends j{initializeState(){this.state={tileset:null,isLoaded:!1}}finalizeState(){this.state?.tileset?.finalize()}get isLoaded(){return!!this.state?.tileset?.selectedTiles?.every(e=>e.isLoaded&&e.layers&&e.layers.every(t=>t.isLoaded))}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({changeFlags:e}){let{tileset:t}=this.state;const s=e.propsOrDataChanged||e.updateTriggersChanged,r=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getTileData);t?s&&(t.setOptions(this._getTilesetOptions()),r?t.reloadAll():t.tiles.forEach(o=>{o.layers=null})):(t=new this.props.TilesetClass(this._getTilesetOptions()),this.setState({tileset:t})),this._updateTileset()}_getTilesetOptions(){const{tileSize:e,maxCacheSize:t,maxCacheByteSize:s,refinementStrategy:r,extent:o,maxZoom:a,minZoom:n,maxRequests:h,debounceTime:c,zoomOffset:u}=this.props;return{maxCacheSize:t,maxCacheByteSize:s,maxZoom:a,minZoom:n,tileSize:e,refinementStrategy:r,extent:o,maxRequests:h,debounceTime:c,zoomOffset:u,getTileData:this.getTileData.bind(this),onTileLoad:this._onTileLoad.bind(this),onTileError:this._onTileError.bind(this),onTileUnload:this._onTileUnload.bind(this)}}_updateTileset(){const e=this.state.tileset,{zRange:t,modelMatrix:s}=this.props,r=e.update(this.context.viewport,{zRange:t,modelMatrix:s}),{isLoaded:o}=e,a=this.state.isLoaded!==o,n=this.state.frameNumber!==r;o&&(a||n)&&this._onViewportLoad(),n&&this.setState({frameNumber:r}),this.state.isLoaded=o}_onViewportLoad(){const{tileset:e}=this.state,{onViewportLoad:t}=this.props;t&&t(e.selectedTiles)}_onTileLoad(e){this.props.onTileLoad(e),e.layers=null,this.setNeedsUpdate()}_onTileError(e,t){this.props.onTileError(e),t.layers=null,this.setNeedsUpdate()}_onTileUnload(e){this.props.onTileUnload(e)}getTileData(e){const{data:t,getTileData:s,fetch:r}=this.props,{signal:o}=e;return e.url=typeof t=="string"||Array.isArray(t)?Xi(t,e):null,s?s(e):r&&e.url?r(e.url,{propName:"data",layer:this,signal:o}):null}renderSubLayers(e){return this.props.renderSubLayers(e)}getSubLayerPropsByTile(e){return null}getPickingInfo(e){const t=e.sourceLayer,s=t.props.tile,r=e.info;return r.picked&&(r.tile=s),r.sourceTile=s,r.sourceTileSubLayer=t,r}_updateAutoHighlight(e){e.sourceTileSubLayer.updateAutoHighlight(e)}renderLayers(){return this.state.tileset.tiles.map(e=>{const t=this.getSubLayerPropsByTile(e);if(!(!e.isLoaded&&!e.content))if(e.layers)t&&e.layers[0]&&Object.keys(t).some(s=>e.layers[0].props[s]!==t[s])&&(e.layers=e.layers.map(s=>s.clone(t)));else{const s=this.renderSubLayers({...this.props,...this.getSubLayerProps({id:e.id,updateTriggers:this.props.updateTriggers}),data:e.content,_offset:0,tile:e});e.layers=rs(s,Boolean).map(r=>r.clone({tile:e,...t}))}return e.layers})}filterSubLayer({layer:e,cullRect:t}){const{tile:s}=e.props,{modelMatrix:r}=this.props;return this.state.tileset.isTileVisible(s,t,r?new G(r):null)}}he.defaultProps=mr;he.layerName="TileLayer";const pe=Math.PI/180,ee=new Float32Array(16),at=new Float32Array(12);function nt(i,e,t){const s=e[0]*pe,r=e[1]*pe,o=e[2]*pe,a=Math.sin(o),n=Math.sin(s),h=Math.sin(r),c=Math.cos(o),u=Math.cos(s),l=Math.cos(r),d=t[0],m=t[1],p=t[2];i[0]=d*l*u,i[1]=d*h*u,i[2]=d*-n,i[3]=m*(-h*c+l*n*a),i[4]=m*(l*c+h*n*a),i[5]=m*u*a,i[6]=p*(h*a+l*n*c),i[7]=p*(-l*a+h*n*c),i[8]=p*u*c}function ht(i){return i[0]=i[0],i[1]=i[1],i[2]=i[2],i[3]=i[4],i[4]=i[5],i[5]=i[6],i[6]=i[8],i[7]=i[9],i[8]=i[10],i[9]=i[12],i[10]=i[13],i[11]=i[14],i.subarray(0,12)}const pr={size:12,accessor:["getOrientation","getScale","getTranslation","getTransformMatrix"],shaderAttributes:{instanceModelMatrixCol0:{size:3,elementOffset:0},instanceModelMatrixCol1:{size:3,elementOffset:3},instanceModelMatrixCol2:{size:3,elementOffset:6},instanceTranslation:{size:3,elementOffset:9}},update(i,{startRow:e,endRow:t}){const{data:s,getOrientation:r,getScale:o,getTranslation:a,getTransformMatrix:n}=this.props,h=Array.isArray(n),c=h&&n.length===16,u=Array.isArray(o),l=Array.isArray(r),d=Array.isArray(a),m=c||!h&&!!n(s[0]);m?i.constant=c:i.constant=l&&u&&d;const p=i.value;if(i.constant){let f;m?(ee.set(n),f=ht(ee)):(f=at,nt(f,r,o),f.set(a,9)),i.value=new Float32Array(f)}else{let f=e*i.size;const{iterable:g,objectInfo:y}=Mt(s,e,t);for(const _ of g){y.index++;let x;if(m)ee.set(c?n:n(_,y)),x=ht(ee);else{x=at;const b=l?r:r(_,y),M=u?o:o(_,y);nt(x,b,M),x.set(d?a:a(_,y),9)}p[f++]=x[0],p[f++]=x[1],p[f++]=x[2],p[f++]=x[3],p[f++]=x[4],p[f++]=x[5],p[f++]=x[6],p[f++]=x[7],p[f++]=x[8],p[f++]=x[9],p[f++]=x[10],p[f++]=x[11]}}}};function fr(i,e){return e===de.CARTESIAN||e===de.METER_OFFSETS||e===de.DEFAULT&&!i.isGeospatial}const lt=`uniform simpleMeshUniforms {
  float sizeScale;
  bool composeModelMatrix;
  bool hasTexture;
  bool flatShading;
} simpleMesh;
`,gr={name:"simpleMesh",vs:lt,fs:lt,uniformTypes:{sizeScale:"f32",composeModelMatrix:"f32",hasTexture:"f32",flatShading:"f32"}},yr=`#version 300 es
#define SHADER_NAME simple-mesh-layer-vs
in vec3 positions;
in vec3 normals;
in vec3 colors;
in vec2 texCoords;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec3 instanceModelMatrixCol0;
in vec3 instanceModelMatrixCol1;
in vec3 instanceModelMatrixCol2;
in vec3 instanceTranslation;
out vec2 vTexCoord;
out vec3 cameraPosition;
out vec3 normals_commonspace;
out vec4 position_commonspace;
out vec4 vColor;
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = texCoords;
geometry.pickingColor = instancePickingColors;
vTexCoord = texCoords;
cameraPosition = project.cameraPosition;
vColor = vec4(colors * instanceColors.rgb, instanceColors.a);
mat3 instanceModelMatrix = mat3(instanceModelMatrixCol0, instanceModelMatrixCol1, instanceModelMatrixCol2);
vec3 pos = (instanceModelMatrix * positions) * simpleMesh.sizeScale + instanceTranslation;
if (simpleMesh.composeModelMatrix) {
DECKGL_FILTER_SIZE(pos, geometry);
normals_commonspace = project_normal(instanceModelMatrix * normals);
geometry.worldPosition += pos;
gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), position_commonspace);
geometry.position = position_commonspace;
}
else {
pos = project_size(pos);
DECKGL_FILTER_SIZE(pos, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, position_commonspace);
geometry.position = position_commonspace;
normals_commonspace = project_normal(instanceModelMatrix * normals);
}
geometry.normal = normals_commonspace;
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,_r=`#version 300 es
#define SHADER_NAME simple-mesh-layer-fs
precision highp float;
uniform sampler2D sampler;
in vec2 vTexCoord;
in vec3 cameraPosition;
in vec3 normals_commonspace;
in vec4 position_commonspace;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
geometry.uv = vTexCoord;
vec3 normal;
if (simpleMesh.flatShading) {
normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));
} else {
normal = normals_commonspace;
}
vec4 color = simpleMesh.hasTexture ? texture(sampler, vTexCoord) : vColor;
DECKGL_FILTER_COLOR(color, geometry);
vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);
fragColor = vec4(lightColor, color.a * layer.opacity);
}
`;function fe(i){const e=i.positions||i.POSITION;bt.assert(e,'no "postions" or "POSITION" attribute in mesh');const t=e.value.length/e.size;let s=i.COLOR_0||i.colors;s||(s={size:3,value:new Float32Array(t*3).fill(1)});let r=i.NORMAL||i.normals;r||(r={size:3,value:new Float32Array(t*3).fill(0)});let o=i.TEXCOORD_0||i.texCoords;return o||(o={size:2,value:new Float32Array(t*2).fill(0)}),{positions:e,colors:s,normals:r,texCoords:o}}function ct(i){return i instanceof ue?(i.attributes=fe(i.attributes),i):i.attributes?new ue({...i,topology:"triangle-list",attributes:fe(i.attributes)}):new ue({topology:"triangle-list",attributes:fe(i)})}const xr=[0,0,0,255],wr={mesh:{type:"object",value:null,async:!0},texture:{type:"image",value:null,async:!0},sizeScale:{type:"number",value:1,min:0},_instanced:!0,wireframe:!1,material:!0,getPosition:{type:"accessor",value:i=>i.position},getColor:{type:"accessor",value:xr},getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]},textureParameters:{type:"object",ignore:!0,value:null}};class ae extends ls{getShaders(){return super.getShaders({vs:yr,fs:_r,modules:[cs,Pt,fs,gr]})}getBounds(){if(this.props._instanced)return super.getBounds();let e=this.state.positionBounds;if(e)return e;const{mesh:t}=this.props;if(!t)return null;if(e=t.header?.boundingBox,!e){const{attributes:s}=ct(t);s.POSITION=s.POSITION||s.positions,e=Xs(s)}return this.state.positionBounds=e,e}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{transition:!0,type:"float64",fp64:this.use64bitPositions(),size:3,accessor:"getPosition"},instanceColors:{type:"unorm8",transition:!0,size:this.props.colorFormat.length,accessor:"getColor",defaultValue:[0,0,0,255]},instanceModelMatrix:pr}),this.setState({emptyTexture:this.context.device.createTexture({data:new Uint8Array(4),width:1,height:1})})}updateState(e){super.updateState(e);const{props:t,oldProps:s,changeFlags:r}=e;if(t.mesh!==s.mesh||r.extensionsChanged){if(this.state.positionBounds=null,this.state.model?.destroy(),t.mesh){this.state.model=this.getModel(t.mesh);const o=t.mesh.attributes||t.mesh;this.setState({hasNormals:!!(o.NORMAL||o.normals)})}this.getAttributeManager().invalidateAll()}t.texture!==s.texture&&t.texture instanceof gs&&this.setTexture(t.texture),this.state.model&&this.state.model.setTopology(this.props.wireframe?"line-strip":"triangle-list")}finalizeState(e){super.finalizeState(e),this.state.emptyTexture.delete()}draw({uniforms:e}){const{model:t}=this.state;if(!t)return;const{viewport:s,renderPass:r}=this.context,{sizeScale:o,coordinateSystem:a,_instanced:n}=this.props,h={sizeScale:o,composeModelMatrix:!n||fr(s,a),flatShading:!this.state.hasNormals};t.shaderInputs.setProps({simpleMesh:h}),t.draw(r)}get isLoaded(){return!!(this.state?.model&&super.isLoaded)}getModel(e){const t=new ys(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:ct(e),isInstanced:!0}),{texture:s}=this.props,{emptyTexture:r}=this.state,o={sampler:s||r,hasTexture:!!s};return t.shaderInputs.setProps({simpleMesh:o}),t}setTexture(e){const{emptyTexture:t,model:s}=this.state;if(s){const r={sampler:e||t,hasTexture:!!e};s.shaderInputs.setProps({simpleMesh:r})}}}ae.defaultProps=wr;ae.layerName="SimpleMeshLayer";const br=[[1/3,1/3,1/3],[.5,.5,0],[.5,0,.5],[0,.5,.5]],Mr=.125;class Tr{reprojectors;width;height;uvs;exactOutputPositions;triangles;_halfedges;_candidatesUV;_queueIndices;_queue;_errors;_pending;_pendingLen;constructor(e,t,s=t){this.reprojectors=e,this.width=t,this.height=s,this.uvs=[],this.exactOutputPositions=[],this.triangles=[],this._halfedges=[],this._candidatesUV=[],this._queueIndices=[],this._queue=[],this._errors=[],this._pending=[],this._pendingLen=0;const r=1,o=1,a=this._addPoint(0,0),n=this._addPoint(r,0),h=this._addPoint(0,o),c=this._addPoint(r,o),u=this._addTriangle(c,a,h,-1,-1,-1);this._addTriangle(a,c,n,u,-1,-1),this._flush()}run(e=Mr){if(e<=0)throw new Error("maxError must be positive");for(;this.getMaxError()>e;)this.refine()}refine(){this._step(),this._flush()}getMaxError(){return this._errors[0]}_flush(){for(let e=0;e<this._pendingLen;e++){const t=this._pending[e];this._findReprojectionCandidate(t)}this._pendingLen=0}_findReprojectionCandidate(e){const t=2*this.triangles[e*3+0],s=2*this.triangles[e*3+1],r=2*this.triangles[e*3+2],o=this.uvs[t],a=this.uvs[t+1],n=this.uvs[s],h=this.uvs[s+1],c=this.uvs[r],u=this.uvs[r+1],l=this.exactOutputPositions[t],d=this.exactOutputPositions[t+1],m=this.exactOutputPositions[s],p=this.exactOutputPositions[s+1],f=this.exactOutputPositions[r],g=this.exactOutputPositions[r+1];let y=0,_=0,x=0;for(const b of br){const M=te(o,n,c,b[0],b[1],b[2]),S=te(a,h,u,b[0],b[1],b[2]),v=te(l,m,f,b[0],b[1],b[2]),R=te(d,p,g,b[0],b[1],b[2]),T=M*(this.width-1),C=S*(this.height-1),D=this.reprojectors.inverseReproject(v,R),U=this.reprojectors.inverseTransform(D[0],D[1]),le=T-U[0],ce=C-U[1],V=Math.hypot(le,ce);V>y&&(y=V,_=M,x=S)}(_===o&&x===a||_===n&&x===h||_===c&&x===u)&&(y=0),this._candidatesUV[2*e]=_,this._candidatesUV[2*e+1]=x,this._queuePush(e,y)}_step(){const e=this._queuePop(),t=e*3+0,s=e*3+1,r=e*3+2,o=this.triangles[t],a=this.triangles[s],n=this.triangles[r],h=this.uvs[2*o],c=this.uvs[2*o+1],u=this.uvs[2*a],l=this.uvs[2*a+1],d=this.uvs[2*n],m=this.uvs[2*n+1],p=this._candidatesUV[2*e],f=this._candidatesUV[2*e+1],g=this._addPoint(p,f);if(ge(h,c,u,l,p,f)===0)this._handleCollinear(g,t);else if(ge(u,l,d,m,p,f)===0)this._handleCollinear(g,s);else if(ge(d,m,h,c,p,f)===0)this._handleCollinear(g,r);else{const y=this._halfedges[t],_=this._halfedges[s],x=this._halfedges[r],b=this._addTriangle(o,a,g,y,-1,-1,t),M=this._addTriangle(a,n,g,_,-1,b+1),S=this._addTriangle(n,o,g,x,b+2,M+1);this._legalize(b),this._legalize(M),this._legalize(S)}}_addPoint(e,t){const s=this.uvs.length>>1;this.uvs.push(e,t);const r=e*(this.width-1),o=t*(this.height-1),a=this.reprojectors.forwardTransform(r,o),n=this.reprojectors.forwardReproject(a[0],a[1]);return this.exactOutputPositions.push(n[0],n[1]),s}_addTriangle(e,t,s,r,o,a,n=this.triangles.length){const h=n/3;return this.triangles[n+0]=e,this.triangles[n+1]=t,this.triangles[n+2]=s,this._halfedges[n+0]=r,this._halfedges[n+1]=o,this._halfedges[n+2]=a,r>=0&&(this._halfedges[r]=n+0),o>=0&&(this._halfedges[o]=n+1),a>=0&&(this._halfedges[a]=n+2),this._candidatesUV[2*h+0]=0,this._candidatesUV[2*h+1]=0,this._queueIndices[h]=-1,this._pending[this._pendingLen++]=h,n}_legalize(e){const t=this._halfedges[e];if(t<0)return;const s=e-e%3,r=t-t%3,o=s+(e+1)%3,a=s+(e+2)%3,n=r+(t+2)%3,h=r+(t+1)%3,c=this.triangles[a],u=this.triangles[e],l=this.triangles[o],d=this.triangles[n],m=this.uvs;if(!Sr(m[2*c],m[2*c+1],m[2*u],m[2*u+1],m[2*l],m[2*l+1],m[2*d],m[2*d+1]))return;const p=this._halfedges[o],f=this._halfedges[a],g=this._halfedges[n],y=this._halfedges[h];this._queueRemove(s/3),this._queueRemove(r/3);const _=this._addTriangle(c,d,l,-1,g,p,s),x=this._addTriangle(d,c,u,_,f,y,r);this._legalize(_+1),this._legalize(x+2)}_handleCollinear(e,t){const s=t-t%3,r=s+(t+1)%3,o=s+(t+2)%3,a=this.triangles[o],n=this.triangles[t],h=this.triangles[r],c=this._halfedges[r],u=this._halfedges[o],l=this._halfedges[t];if(l<0){const S=this._addTriangle(e,a,n,-1,u,-1,s),v=this._addTriangle(a,e,h,S,-1,c);this._legalize(S+1),this._legalize(v+2);return}const d=l-l%3,m=d+(l+2)%3,p=d+(l+1)%3,f=this.triangles[m],g=this._halfedges[m],y=this._halfedges[p];this._queueRemove(d/3);const _=this._addTriangle(a,n,e,u,-1,-1,s),x=this._addTriangle(n,f,e,y,-1,_+1,d),b=this._addTriangle(f,h,e,g,-1,x+1),M=this._addTriangle(h,a,e,c,_+2,b+1);this._legalize(_),this._legalize(x),this._legalize(b),this._legalize(M)}_queuePush(e,t){const s=this._queue.length;this._queueIndices[e]=s,this._queue.push(e),this._errors.push(t),this._queueUp(s)}_queuePop(){const e=this._queue.length-1;return this._queueSwap(0,e),this._queueDown(0,e),this._queuePopBack()}_queuePopBack(){const e=this._queue.pop();return this._errors.pop(),this._queueIndices[e]=-1,e}_queueRemove(e){const t=this._queueIndices[e];if(t<0){const r=this._pending.indexOf(e);if(r!==-1)this._pending[r]=this._pending[--this._pendingLen];else throw new Error("Broken triangulation (something went wrong).");return}const s=this._queue.length-1;s!==t&&(this._queueSwap(t,s),this._queueDown(t,s)||this._queueUp(t)),this._queuePopBack()}_queueLess(e,t){return this._errors[e]>this._errors[t]}_queueSwap(e,t){const s=this._queue[e],r=this._queue[t];this._queue[e]=r,this._queue[t]=s,this._queueIndices[s]=t,this._queueIndices[r]=e;const o=this._errors[e];this._errors[e]=this._errors[t],this._errors[t]=o}_queueUp(e){let t=e;for(;;){const s=t-1>>1;if(s===t||!this._queueLess(t,s))break;this._queueSwap(s,t),t=s}}_queueDown(e,t){let s=e;for(;;){const r=2*s+1;if(r>=t||r<0)break;const o=r+1;let a=r;if(o<t&&this._queueLess(o,r)&&(a=o),!this._queueLess(a,s))break;this._queueSwap(s,a),s=a}return s>e}}function ge(i,e,t,s,r,o){return(t-r)*(e-o)-(s-o)*(i-r)}function Sr(i,e,t,s,r,o,a,n){const h=i-a,c=e-n,u=t-a,l=s-n,d=r-a,m=o-n,p=h*h+c*c,f=u*u+l*l,g=d*d+m*m;return h*(l*g-f*m)-c*(u*g-f*d)+p*(u*m-l*d)<0}function te(i,e,t,s,r,o){return s*i+r*e+o*t}const Cr=`#version 300 es
#define SHADER_NAME simple-mesh-layer-fs

precision highp float;

in vec2 vTexCoord;
in vec3 cameraPosition;
in vec3 normals_commonspace;
in vec4 position_commonspace;
in vec4 vColor;

out vec4 fragColor;

void main(void) {
  geometry.uv = vTexCoord;

  vec3 normal;
  if (simpleMesh.flatShading) {

  normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));
  } else {
    normal = normals_commonspace;
  }

  // We initialize color here before passing into DECKGL_FILTER_COLOR
  vec4 color;
  DECKGL_FILTER_COLOR(color, geometry);

  vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);
  fragColor = vec4(lightColor, color.a * layer.opacity);
}
`;class vr extends ae{static layerName="mesh-texture-layer";static defaultProps=ae.defaultProps;getShaders(){const e=super.getShaders(),t=e.modules;for(const s of this.props.renderPipeline)t.push(s.module);return{...e,fs:Cr,modules:t}}draw(e){const t={};for(const s of this.props.renderPipeline)t[s.module.name]=s.props||{};for(const s of super.getModels())s.shaderInputs.setProps(t);super.draw(e)}}const Lr=.125,ut=[[252,73,163],[255,51,204],[204,102,255],[153,51,255],[102,204,255],[51,153,255],[102,255,204],[51,255,170],[0,255,0],[51,204,51],[255,204,102],[255,179,71],[255,102,102],[255,80,80],[255,0,0],[204,0,0],[255,128,0],[255,153,51],[255,255,102],[255,255,51],[0,255,255],[0,204,255]],Ir={debug:!1,debugOpacity:.5};class Nt extends j{static layerName="RasterLayer";static defaultProps=Ir;initializeState(){this.setState({})}updateState(e){super.updateState(e);const{props:t,oldProps:s,changeFlags:r}=e;(r.dataChanged||t.width!==s.width||t.height!==s.height||t.reprojectionFns!==s.reprojectionFns||t.maxError!==s.maxError)&&this._generateMesh()}_generateMesh(){const{width:e,height:t,reprojectionFns:s,maxError:r=Lr}=this.props,o=new Tr(s,e+1,t+1);o.run(r);const{indices:a,positions:n,texCoords:h}=Pr(o);this.setState({reprojector:o,mesh:{positions:n,indices:a,texCoords:h}})}renderDebugLayer(){const{reprojector:e}=this.state,{debugOpacity:t}=this.props;return e?new Ie(this.getSubLayerProps({id:"polygon",data:{reprojector:e,length:e.triangles.length/3},getPolygon:(s,{index:r,data:o})=>{const a=o.reprojector.triangles,n=e.exactOutputPositions,h=a[r*3],c=a[r*3+1],u=a[r*3+2];return[[n[h*2],n[h*2+1]],[n[c*2],n[c*2+1]],[n[u*2],n[u*2+1]],[n[h*2],n[h*2+1]]]},getFillColor:(s,{index:r,target:o})=>{const a=ut[r%ut.length];return o[0]=a[0],o[1]=a[1],o[2]=a[2],o[3]=255,o},getLineColor:[0,0,0],getLineWidth:1,lineWidthUnits:"pixels",opacity:t!==void 0&&Number.isFinite(t)?Math.max(0,Math.min(1,t)):1,pickable:!1})):null}_createRenderPipeline(){if(this.props.renderPipeline instanceof ImageData){const e=this.props.renderPipeline,t=this.context.device.createTexture({format:"rgba8unorm",width:e.width,height:e.height,data:e.data});return[{module:xt,props:{textureName:t}}]}else return this.props.renderPipeline}renderLayers(){const{mesh:e}=this.state,{debug:t}=this.props;if(!e)return null;const{indices:s,positions:r,texCoords:o}=e,a=[new vr(this.getSubLayerProps({id:"raster",renderPipeline:this._createRenderPipeline(),data:[1],mesh:{indices:{value:s,size:1},attributes:{POSITION:{value:r,size:3},TEXCOORD_0:{value:o,size:2}}},_instanced:!1,getPosition:[0,0,0],getColor:[255,255,255]}))];if(t){const n=this.renderDebugLayer();n&&a.push(n)}return a}}function Pr(i){const e=i.uvs.length/2,t=new Float32Array(e*3),s=new Float32Array(i.uvs);for(let r=0;r<e;r++)t[r*3]=i.exactOutputPositions[r*2],t[r*3+1]=i.exactOutputPositions[r*2+1],t[r*3+2]=0;return{indices:new Uint32Array(i.triangles),positions:t,texCoords:s}}const dt=512,Rr=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],zr=Rr.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),Or=6378137,Ce=2*Math.PI*Or,mt=Ce/2,Er=28e-5;class Fe{x;y;z;metadata;childVisible;selected;_children;constructor(e,t,s,r){this.x=e,this.y=t,this.z=s,this.metadata=r}get tileMatrix(){return this.metadata.tileMatrices[this.z]}get children(){if(!this._children){const e=this.metadata.tileMatrices.length-1;if(this.z>=e)return this._children=null,null;const t=this.tileMatrix,s=this.z+1,r=this.metadata.tileMatrices[s],o=pt({x:this.x,y:this.y,transform:t.geotransform,tileWidth:t.tileWidth,tileHeight:t.tileHeight}),{minCol:a,maxCol:n,minRow:h,maxRow:c}=qr(o,r),u=[];for(let l=h;l<=c;l++)for(let d=a;d<=n;d++)u.push(new Fe(d,l,s,this.metadata));this._children=u.length>0?u:null}return this._children}update(e){this.childVisible=!1,this.selected=!1;const{viewport:t,cullingVolume:s,elevationBounds:r,minZ:o,maxZ:a=this.metadata.tileMatrices.length-1,project:n,bounds:h}=e,{boundingVolume:c,commonSpaceBounds:u}=this.getBoundingVolume(r,n);if(h&&!this.insideBounds(h,u)||s.computeVisibility(c)<0)return!1;const l=this.children;if(!this.childVisible&&this.z>=o){const d=Gr(c,t.zoom);if(this.tileMatrix.scaleDenominator*Er<=d||this.z>=a||l===null&&this.z>=o)return this.selected=!0,!0}if(l&&l.length>0){this.selected=!1;let d=!1;for(const m of l)m.update(e)&&(d=!0);return this.childVisible=d,d}return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(const t of this._children)t.getSelected(e);return e}insideBounds(e,t){const[s,r,o,a]=e,[n,h,c,u]=t;return n<o&&c>s&&h<a&&u>r}getBoundingVolume(e,t){return t&&_s(!1,"TODO: implement getBoundingVolume in Globe view"),this._getGenericBoundingVolume(e)}_getGenericBoundingVolume(e){const t=this.tileMatrix,{tileWidth:s,tileHeight:r,geotransform:o}=t,[a,n]=e,h=pt({x:this.x,y:this.y,transform:o,tileWidth:s,tileHeight:r}),c=Ar(zr,h,this.metadata.projectTo3857).map(g=>Nr(g)),u=[];for(const g of c)u.push([g[0],g[1],a]),a!==n&&u.push([g[0],g[1],n]);let l=Number.POSITIVE_INFINITY,d=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,p=Number.NEGATIVE_INFINITY;for(const[g,y]of c)g<l&&(l=g),y<d&&(d=y),g>m&&(m=g),y>p&&(p=y);const f=[l,d,m,p];return{boundingVolume:zt(u),commonSpaceBounds:f}}}function pt({x:i,y:e,transform:t,tileWidth:s,tileHeight:r}){const[o,a,n,h,c,u]=t;if(a!==0||h!==0)throw new Error(`Rotated/skewed geotransforms not yet supported (b=${a}, d=${h}). Only north-up, non-rotated rasters are currently supported.`);const l=i*s,d=e*r,m=(i+1)*s,p=(e+1)*r,f=o*l+a*d+n,g=h*l+c*d+u,y=o*m+a*p+n,_=h*m+c*p+u;return[Math.min(f,y),Math.min(g,_),Math.max(f,y),Math.max(g,_)]}function Ar(i,e,t){const[s,r,o,a]=e,n=[];for(const[h,c]of i){const u=s+h*(o-s),l=r+c*(a-r),d=t([u,l]);n.push(d)}return n}function Nr([i,e]){const t=Math.max(-mt,Math.min(mt,e));return[(i/Ce+.5)*dt,(t/Ce+.5)*dt]}function qr(i,e){const[t,s,r,o]=i,{tileWidth:a,tileHeight:n,cellSize:h,matrixWidth:c,matrixHeight:u,pointOfOrigin:l}=e,d=a*h,m=n*h,p=l[0],f=l[1];let g=Math.floor((t-p)/d),y=Math.floor((r-p)/d),_=Math.floor((f-o)/m),x=Math.floor((f-s)/m);return g=Math.max(0,Math.min(c-1,g)),y=Math.max(0,Math.min(c-1,y)),_=Math.max(0,Math.min(u-1,_)),x=Math.max(0,Math.min(u-1,x)),{minCol:g,maxCol:y,minRow:_,maxRow:x}}function Fr(i,e){const{viewport:t,maxZ:s,zRange:r}=e,o=t instanceof Tt&&t.resolution?t.projectPosition:null,a=Object.values(t.getFrustumPlanes()).map(({normal:T,distance:C})=>new B(T.clone().negate(),C)),n=new O(a),h=t.distanceScales.unitsPerMeter[2],c=r&&r[0]*h||0,u=r&&r[1]*h||0,l=0,{lowerLeft:d,upperRight:m}=i.wgsBounds,[p,f]=d,[g,y]=m,_=re([p,f]),x=re([g,y]),b=[_[0],_[1],x[0],x[1]],M=i.tileMatrices[0],S=[];for(let T=0;T<M.matrixHeight;T++)for(let C=0;C<M.matrixWidth;C++)S.push(new Fe(C,T,0,i));const v={viewport:t,project:o,cullingVolume:n,elevationBounds:[c,u],minZ:l,maxZ:s,bounds:b};for(const T of S)T.update(v);const R=[];for(const T of S)T.getSelected(R);return R}function Dr(i,e){return 40075016686e-3*Math.cos(i*Math.PI/180)/2**(e+8)}function Gr(i,e){const[t,s]=xs(i.center);return Dr(s,e)}class Wr extends Ne{metadata;constructor(e,t){super(t),this.metadata=e}getTileIndices(e){const t=this.metadata.tileMatrices.length-1,s=typeof e.maxZoom=="number"?Math.min(e.maxZoom,t):t;return Fr(this.metadata,{viewport:e.viewport,maxZ:s,zRange:e.zRange??null})}getTileId(e){return`${e.x}-${e.y}-${e.z}`}getParentIndex(e){if(e.z===0)return e;const t=this.metadata.tileMatrices[e.z],s=this.metadata.tileMatrices[e.z-1],r=t.cellSize/s.cellSize;return{x:Math.floor(e.x/r),y:Math.floor(e.y/r),z:e.z-1}}getTileZoom(e){return e.z}getTileMetadata(e){const{x:t,y:s,z:r}=e,{tileMatrices:o}=this.metadata,a=o[r],{geotransform:n,tileHeight:h,tileWidth:c}=a,[u,l,d,m,p,f]=n,g=t*c,y=s*h,_=(t+1)*c,x=(s+1)*h,b=[u*g+l*y+d,m*g+p*y+f],M=[u*_+l*y+d,m*_+p*y+f],S=[u*g+l*x+d,m*g+p*x+f],v=[u*_+l*x+d,m*_+p*x+f],R={topLeft:b,topRight:M,bottomLeft:S,bottomRight:v};return{bounds:[Math.min(b[0],M[0],S[0],v[0]),Math.min(b[1],M[1],S[1],v[1]),Math.max(b[0],M[0],S[0],v[0]),Math.max(b[1],M[1],S[1],v[1])],projectedBounds:R,tileWidth:c,tileHeight:h,tileMatrix:a}}}const kr={MERIT:{a:6378137},SGS85:{a:6378136},GRS80:{a:6378137},IAU76:{a:6378140},airy:{a:6377563396e-3,b:635625691e-2},APL4:{a:6378137},NWL9D:{a:6378145},mod_airy:{a:6377340189e-3,b:6356034446e-3},andrae:{a:637710443e-2},aust_SA:{a:6378160},GRS67:{a:6378160},bessel:{a:6377397155e-3},bess_nam:{a:6377483865e-3},clrk66:{a:63782064e-1,b:63565838e-1},clrk80:{a:6378249145e-3},clrk80ign:{a:63782492e-1,b:6356515},clrk58:{a:6378293645208759e-9},CPM:{a:63757387e-1},delmbr:{a:6376428},engelis:{a:637813605e-2},evrst30:{a:6377276345e-3},evrst48:{a:6377304063e-3},evrst56:{a:6377301243e-3},evrst69:{a:6377295664e-3},evrstSS:{a:6377298556e-3},fschr60:{a:6378166},fschr60m:{a:6378155},fschr68:{a:6378150},helmert:{a:6378200},hough:{a:6378270},intl:{a:6378388},kaula:{a:6378163},lerch:{a:6378139},mprts:{a:6397300},new_intl:{a:63781575e-1,b:63567722e-1},plessis:{a:6376523},krass:{a:6378245},SEasia:{a:6378155,b:63567733205e-4},walbeck:{a:6376896,b:63558348467e-4},WGS60:{a:6378165},WGS66:{a:6378145},WGS7:{a:6378135},WGS84:{a:6378137},sphere:{a:6370997,b:6370997}};function Br(i){if(jr(i))throw new Error("Cannot invert degenerate transform");const e=1/qt(i),[t,s,r,o,a,n]=i,h=a*e,c=-s*e,u=-o*e,l=t*e;return[h,c,-r*h-n*c,u,l,-r*u-n*l]}function jr(i){return qt(i)===0}function qt(i){const[e,t,s,r,o,a]=i;return e*o-t*r}function ft(i,e,t){const[s,r,o,a,n,h]=t;return[s*i+r*e+o,a*i+n*e+h]}const Ur={$schema:"https://proj.org/schemas/v0.7/projjson.schema.json",type:"GeographicCRS",name:"WGS 84 (CRS84)",datum_ensemble:{name:"World Geodetic System 1984 ensemble",members:[{name:"World Geodetic System 1984 (Transit)",id:{authority:"EPSG",code:1166}},{name:"World Geodetic System 1984 (G730)",id:{authority:"EPSG",code:1152}},{name:"World Geodetic System 1984 (G873)",id:{authority:"EPSG",code:1153}},{name:"World Geodetic System 1984 (G1150)",id:{authority:"EPSG",code:1154}},{name:"World Geodetic System 1984 (G1674)",id:{authority:"EPSG",code:1155}},{name:"World Geodetic System 1984 (G1762)",id:{authority:"EPSG",code:1156}},{name:"World Geodetic System 1984 (G2139)",id:{authority:"EPSG",code:1309}}],ellipsoid:{name:"WGS 84",semi_major_axis:6378137,inverse_flattening:298.257223563},accuracy:"2.0",id:{authority:"EPSG",code:6326}},coordinate_system:{subtype:"ellipsoidal",axis:[{name:"Geodetic longitude",abbreviation:"Lon",direction:"east",unit:"degree"},{name:"Geodetic latitude",abbreviation:"Lat",direction:"north",unit:"degree"}]},scope:"Not known.",area:"World.",bbox:{south_latitude:-90,west_longitude:-180,north_latitude:90,east_longitude:180},id:{authority:"OGC",code:"CRS84"}};async function Vr(i,e,t=Ur){const s=await i.getImage(),r=Dt(s),o=F(e,t),{forwardTransform:a,inverseTransform:n}=Ft(r);return{forwardTransform:a,inverseTransform:n,forwardReproject:(h,c)=>o.forward([h,c],!1),inverseReproject:(h,c)=>o.inverse([h,c],!1)}}function Ft(i){const e=Br(i);return{forwardTransform:(t,s)=>ft(t,s,i),inverseTransform:(t,s)=>ft(t,s,e)}}function Dt(i){const e=i.getOrigin(),t=i.getResolution(),s=i.getFileDirectory().ModelTransformation;let r=0,o=0;return s&&s.length>=16&&(r=s[1],o=s[4]),[t[0],r,e[0],o,t[1],e[1]]}const Gt=28e-5;async function Zr(i,e){const t=await i.getImage();if(!t.isTiled)throw new Error("COG TileMatrixSet requires a tiled GeoTIFF");const s=await i.getImageCount(),r=t.getBoundingBox(),o=t.getWidth(),a=t.getHeight(),n=await e(t.getGeoKeys());if(n===null)throw new Error("Could not determine coordinate reference system from GeoTIFF geo keys");const h=F(n.def,"EPSG:4326").forward,c=F(n.def,"EPSG:3857").forward,u={lowerLeft:[r[0],r[1]],upperRight:[r[2],r[3]]},l=Dt(t);if(l[1]!==0||l[3]!==0)throw new Error("COG TileMatrixSet with rotation/skewed geotransform is not supported");const d=Math.abs(l[0]),m=t.getTileWidth(),p=t.getTileHeight(),f=[{id:String(s-1),scaleDenominator:d*De(n.parsed,n.coordinatesUnits)/Gt,cellSize:d,pointOfOrigin:[l[2],l[5]],tileWidth:t.getTileWidth(),tileHeight:t.getTileHeight(),matrixWidth:Math.ceil(o/m),matrixHeight:Math.ceil(a/p),geotransform:l}];for(let g=1;g<s;g++){const y=await i.getImage(g);if(!y.isTiled)throw new Error("COG TileMatrixSet requires a tiled GeoTIFF");const _=$r({id:String(s-1-g),image:y,fullWidth:o,baseTransform:l,crs:n});f.push(_)}return f.reverse(),{crs:n,boundingBox:u,wgsBounds:Yr(u,h),tileMatrices:f,projectToWgs84:h,projectTo3857:c}}function De(i,e){const t=(e||i.units)?.toLowerCase();switch(t){case"m":case"metre":case"meter":case"meters":return 1;case"foot":return .3048;case"us survey foot":return 1200/3937}if(t==="degree"){const{a:s}=kr[i.ellps];return 2*Math.PI*s/360}throw new Error(`Unsupported CRS units: ${t}`)}function $r({id:i,image:e,fullWidth:t,baseTransform:s,crs:r}){const o=e.getWidth(),a=e.getHeight(),n=t/o,h=[s[0]*n,s[1]*n,s[2],s[3]*n,s[4]*n,s[5]],c=Math.abs(h[0]),u=e.getTileWidth(),l=e.getTileHeight();return{id:i,scaleDenominator:c*De(r.parsed,r.coordinatesUnits)/Gt,cellSize:c,pointOfOrigin:[h[2],h[5]],tileWidth:u,tileHeight:l,matrixWidth:Math.ceil(o/u),matrixHeight:Math.ceil(a/l),geotransform:h}}function Yr(i,e){const t=e(i.lowerLeft),s=e([i.upperRight[0],i.lowerLeft[1]]),r=e(i.upperRight),o=e([i.lowerLeft[0],i.upperRight[1]]),a=Math.min(t[0],s[0],r[0],o[0]),n=Math.max(t[0],s[0],r[0],o[0]),h=Math.min(t[1],s[1],r[1],o[1]),c=Math.max(t[1],s[1],r[1],o[1]);return{lowerLeft:[a,h],upperRight:[n,c]}}const Hr={metersPerUnit:De};let ye=null;function Wt(){return ye===null&&(ye=new Qt),ye}async function Kr(i,e){const t={...e,interleave:!0,enableAlpha:!0},s=await i.readRGB(t);return{texture:kt(s),height:s.height,width:s.width}}function kt(i){const{height:e,width:t}=i;if(i.length===e*t*4)return new ImageData(new Uint8ClampedArray(i),t,e);if(i.length===e*t*3){const s=i.length/3*4,r=new Uint8ClampedArray(s);for(let o=0;o<i.length/3;++o)r[o*4]=i[o*3],r[o*4+1]=i[o*3+1],r[o*4+2]=i[o*3+2],r[o*4+3]=255;return new ImageData(r,t,e)}else throw new Error(`Unexpected number of channels in raster data: ${i.length/(e*t)}`)}function Xr(i){const e=i.length/3,t=new Uint8ClampedArray(e*4),s=0,r=e,o=e*2;for(let a=0;a<e;a++)t[4*a+0]=i[s+a]>>8,t[4*a+1]=i[r+a]>>8,t[4*a+2]=i[o+a]>>8,t[4*a+3]=255;return new ImageData(t,e,1)}async function Bt(i){return typeof i=="string"?$t(i):i instanceof ArrayBuffer?Yt(i):i instanceof Blob?Ht(i):i instanceof Kt?Xt(i):i}function jt(i,e){const t=i.getBoundingBox(),[s,r,o,a]=t,n=[e.forward([s,r]),e.forward([o,r]),e.forward([o,a]),e.forward([s,a])],h=n.map(p=>p[0]),c=n.map(p=>p[1]),u=Math.min(...h),l=Math.min(...c),d=Math.max(...h),m=Math.max(...c);return{west:u,south:l,east:d,north:m}}function Qr(i){if(!i)return null;const e=i?.[i?.length-1]==="\0"?i.slice(0,-1):i;return e?.length>0?parseFloat(e):null}function Jr(i,e,t){const s=i.getFileDirectory(),r=s.SamplesPerPixel,o=Ge(r,s.BitsPerSample,s.SampleFormat);return{data:e,format:o,width:t.width,height:t.height}}function Ge(i,e,t){const s=eo(i),r=to(e),o=so(t),a=`${s}:${o}:${r}`,n=io[a];if(!n)throw new Error(`Unsupported texture format for SamplesPerPixel=${i}, BitsPerSample=${e}, SampleFormat=${t}`);return n}function eo(i){if(i===1||i===2||i===3||i===4)return i;throw new Error(`Unsupported SamplesPerPixel ${i}. Only 1, 2, 3, or 4 are supported.`)}function to(i){const e=i[0];for(let t=1;t<i.length;t++)if(i[t]!==e)throw new Error(`Unsupported varying BitsPerSample ${i}. All samples must have the same bit width.`);if(e!==8&&e!==16&&e!==32)throw new Error(`Unsupported BitsPerSample ${e}. Only 8, 16, or 32 are supported.`);return e}function so(i){const e=i[0];for(let t=1;t<i.length;t++)if(i[t]!==e)throw new Error(`Unsupported varying SampleFormat ${i}. All samples must have the same format.`);switch(e){case 1:return"unorm";case 2:return"sint";case 3:return"float";default:throw new Error(`Unsupported SampleFormat ${i}`)}}const io={"1:sint:8":"r8sint","1:uint:8":"r8uint","1:unorm:8":"r8unorm","1:float:16":"r16float","1:sint:16":"r16sint","1:uint:16":"r16uint","1:unorm:16":"r16unorm","2:sint:8":"rg8sint","2:uint:8":"rg8uint","2:unorm:8":"rg8unorm","1:float:32":"r32float","1:sint:32":"r32sint","1:uint:32":"r32uint","2:float:16":"rg16float","2:sint:16":"rg16sint","2:uint:16":"rg16uint","2:unorm:16":"rg16unorm","4:sint:8":"rgba8sint","4:uint:8":"rgba8uint","4:unorm:8":"rgba8unorm","3:uint:16":"rgb16unorm-webgl","2:float:32":"rg32float","2:sint:32":"rg32sint","2:uint:32":"rg32uint","4:float:16":"rgba16float","4:sint:16":"rgba16sint","4:uint:16":"rgba16uint","4:unorm:16":"rgba16unorm","3:float:32":"rgb32float-webgl","4:float:32":"rgba32float","4:sint:32":"rgba32sint","4:uint:32":"rgba32uint"},Io=Object.freeze(Object.defineProperty({__proto__:null,createTextureProps:Jr,inferTextureFormat:Ge},Symbol.toStringTag,{value:"Module"}));var q;(function(i){i[i.WhiteIsZero=0]="WhiteIsZero",i[i.BlackIsZero=1]="BlackIsZero",i[i.RGB=2]="RGB",i[i.Palette=3]="Palette",i[i.TransparencyMask=4]="TransparencyMask",i[i.CMYK=5]="CMYK",i[i.YCbCr=6]="YCbCr",i[i.CIELab=8]="CIELab",i[i.ICCLab=9]="ICCLab"})(q||(q={}));var gt;(function(i){i[i.Chunky=1]="Chunky",i[i.Planar=2]="Planar"})(gt||(gt={}));function ro(i,e){const{SampleFormat:t}=i;if(t[0]===1)return oo(i,e);throw new Error(`Inferring render pipeline for non-unsigned integers not yet supported. Found SampleFormat: ${t}`)}function oo(i,e){const{BitsPerSample:t,ColorMap:s,GDAL_NODATA:r,PhotometricInterpretation:o,SampleFormat:a,SamplesPerPixel:n}=i,h=[{module:xt,props:{textureName:d=>d.texture}}],c=Qr(r);if(c!==null){const d=c/255;h.push({module:is,props:{value:d}})}const u=ao(o,e,s);u&&h.push(u);const l=o===q.Palette?{magFilter:"nearest",minFilter:"nearest"}:{magFilter:"linear",minFilter:"linear"};return{getTileData:async(d,m)=>{const{device:p}=m,f={...m,interleave:!0};let g=await d.readRasters(f),y=n;n===3&&(g=kt(g),y=4);const _=Ge(y,t,a);return{texture:p.createTexture({data:g,format:_,width:g.width,height:g.height,sampler:l}),height:g.height,width:g.width}},renderTile:d=>h.map((m,p)=>no(m,d))}}function ao(i,e,t){switch(i){case q.RGB:return null;case q.Palette:{if(!t)throw new Error("ColorMap is required for PhotometricInterpretation Palette");const{data:s,width:r,height:o}=Xr(t),a=e.createTexture({data:s,format:"rgba8unorm",width:r,height:o,sampler:{minFilter:"nearest",magFilter:"nearest",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}});return{module:ss,props:{colormapTexture:a}}}case q.CMYK:return{module:ts};case q.YCbCr:return{module:es};case q.CIELab:return{module:Jt};default:throw new Error(`Unsupported PhotometricInterpretation ${i}`)}}function no(i,e){const{module:t,props:s}=i;if(!s)return{module:t};const r={};for(const[o,a]of Object.entries(s)){const n=typeof a=="function"?a(e):a;n!==void 0&&(r[o]=n)}return{module:t,props:r}}async function We(i){const e=i.ProjectedCSTypeGeoKey||i.GeographicTypeGeoKey||null,t=await ho(e);if(!t)return null;const s=Ut(t);return{def:t,parsed:s,coordinatesUnits:s.units}}async function ho(i){if(i===null)return null;const e=`https://epsg.io/${i}.json`,t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch projection data from ${e}`);return await t.json()}function Ut(i){const e="__deck.gl-geotiff-internal__";return F.defs(e,i),F.defs(e)}const Po=Object.freeze(Object.defineProperty({__proto__:null,epsgIoGeoKeyParser:We,parseCrs:Ut},Symbol.toStringTag,{value:"Module"})),lo={geoKeysParser:We,debug:!1,debugOpacity:.5};class Ro extends j{static layerName="COGLayer";static defaultProps=lo;initializeState(){this.setState({})}updateState(e){super.updateState(e);const{props:t,oldProps:s,changeFlags:r}=e;(r.dataChanged||t.geotiff!==s.geotiff)&&this._parseGeoTIFF()}async _parseGeoTIFF(){const e=await Bt(this.props.geotiff),t=this.props.geoKeysParser,s=await Zr(e,t),r=await e.getImage(),o=await e.getImageCount(),a=[];for(let m=0;m<o;m++)a.push(await e.getImage(m));const n=await t(r.getGeoKeys());if(!n)throw new Error("Could not determine source projection from GeoTIFF geo keys");const h=F(n.def,"EPSG:4326"),c=(m,p)=>h.forward([m,p],!1),u=(m,p)=>h.inverse([m,p],!1);if(this.props.onGeoTIFFLoad){const m=jt(r,h);this.props.onGeoTIFFLoad(e,{projection:n,geographicBounds:m})}const{getTileData:l,renderTile:d}=ro(r.fileDirectory,this.context.device);this.setState({metadata:s,forwardReproject:c,inverseReproject:u,images:a,defaultGetTileData:l,defaultRenderTile:d})}async _getTileData(e,t,s){const{signal:r}=e,{x:o,y:a,z:n}=e.index,h=t[t.length-1-n],c=h.getHeight(),u=h.getWidth(),l=s.tileMatrices[n],{tileWidth:d,tileHeight:m}=l,p=co(o,a,l),{forwardTransform:f,inverseTransform:g}=Ft(p),y=[o*d,a*m,Math.min((o+1)*d,u),Math.min((a+1)*m,c)],_=this.props.getTileData||this.state.defaultGetTileData,x=r&&this.props.signal?AbortSignal.any([r,this.props.signal]):r||this.props.signal;return{data:await _(h,{device:this.context.device,window:y,signal:x,pool:this.props.pool||Wt()}),forwardTransform:f,inverseTransform:g}}_renderSubLayers(e,t,s,r){const{maxError:o,debug:a,debugOpacity:n}=this.props,{tile:h}=e;if(!e.data)return null;const{data:c,forwardTransform:u,inverseTransform:l}=e.data,d=[];if(c){const{height:m,width:p}=c,f=this.props.renderTile||this.state.defaultRenderTile;d.push(new Nt({id:`${e.id}-raster`,width:p,height:m,renderPipeline:f(c),maxError:o,reprojectionFns:{forwardTransform:u,inverseTransform:l,forwardReproject:s,inverseReproject:r},debug:a,debugOpacity:n}))}if(a){const m=h?.projectedBounds;if(!m||!t)return[];const{topLeft:p,topRight:f,bottomLeft:g,bottomRight:y}=m,_=t.projectToWgs84(p),x=t.projectToWgs84(f),b=t.projectToWgs84(y),M=t.projectToWgs84(g),S=[_,x,b,M,_];d.push(new wt({id:`${this.id}-${h.id}-bounds`,data:[S],getPath:v=>v,getColor:[255,0,0,255],getWidth:2,widthUnits:"pixels",pickable:!1}))}return d}renderTileLayer(e,t,s,r){class o extends Wr{constructor(n){super(e,n)}}return new he({id:`cog-tile-layer-${this.id}`,TilesetClass:o,getTileData:async a=>this._getTileData(a,r,e),renderSubLayers:a=>this._renderSubLayers(a,e,t,s)})}renderLayers(){const{forwardReproject:e,inverseReproject:t,metadata:s,images:r}=this.state;return!e||!t||!s||!r?null:this.renderTileLayer(s,e,t,r)}}function co(i,e,t){const{tileWidth:s,tileHeight:r}=t,o=i*s,a=e*r,[n,h,c,u,l,d]=t.geotransform,m=n*o+h*a+c,p=u*o+l*a+d;return[n,h,m,u,l,p]}const uo={geoKeysParser:We};class zo extends j{static layerName="GeoTIFFLayer";static defaultProps=uo;initializeState(){this.setState({})}updateState(e){super.updateState(e);const{props:t,oldProps:s,changeFlags:r}=e;(r.dataChanged||t.geotiff!==s.geotiff||t.maxError!==s.maxError)&&this._parseGeoTIFF()}async _parseGeoTIFF(){const e=await Bt(this.props.geotiff),t=await e.getImage(),s=this.props.geoKeysParser,r=await s(t.getGeoKeys());if(!r)throw new Error("Could not determine source projection from GeoTIFF geo keys");const o=F(r.def,"EPSG:4326");if(this.props.onGeoTIFFLoad){const u=jt(t,o);this.props.onGeoTIFFLoad(e,{projection:r,geographicBounds:u})}const a=await Vr(e,r.def),{texture:n,height:h,width:c}=await Kr(t,{pool:this.props.pool||Wt()});this.setState({reprojectionFns:a,imageData:n,height:h,width:c})}renderLayers(){const{reprojectionFns:e,imageData:t,height:s,width:r}=this.state;if(!e||!t||!s||!r)return null;const{maxError:o,debug:a,debugOpacity:n}=this.props;return new Nt(this.getSubLayerProps({id:"raster",width:r,height:s,reprojectionFns:e,maxError:o,texture:t,debug:a,debugOpacity:n}))}}class mo{constructor(){this.ids=[],this.values=[],this.length=0}clear(){this.length=0}push(e,t){let s=this.length++;for(;s>0;){const r=s-1>>1,o=this.values[r];if(t>=o)break;this.ids[s]=this.ids[r],this.values[s]=o,s=r}this.ids[s]=e,this.values[s]=t}pop(){if(this.length===0)return;const e=this.ids,t=this.values,s=e[0],r=--this.length;if(r>0){const o=e[r],a=t[r];let n=0;const h=r>>1;for(;n<h;){const c=(n<<1)+1,u=c+1,l=c+(+(u<r)&+(t[u]<t[c]));if(t[l]>=a)break;e[n]=e[l],t[n]=t[l],n=l}e[n]=o,t[n]=a}return s}peek(){return this.length>0?this.ids[0]:void 0}peekValue(){return this.length>0?this.values[0]:void 0}shrink(){this.ids.length=this.values.length=this.length}}const yt=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],_e=3;class ke{static from(e,t=0){if(t%8!==0)throw new Error("byteOffset must be 8-byte aligned.");if(!e||e.byteLength===void 0||e.buffer)throw new Error("Data must be an instance of ArrayBuffer or SharedArrayBuffer.");const[s,r]=new Uint8Array(e,t+0,2);if(s!==251)throw new Error("Data does not appear to be in a Flatbush format.");const o=r>>4;if(o!==_e)throw new Error(`Got v${o} data when expected v${_e}.`);const a=yt[r&15];if(!a)throw new Error("Unrecognized array type.");const[n]=new Uint16Array(e,t+2,1),[h]=new Uint32Array(e,t+4,1);return new ke(h,n,a,void 0,e,t)}constructor(e,t=16,s=Float64Array,r=ArrayBuffer,o,a=0){if(e===void 0)throw new Error("Missing required argument: numItems.");if(isNaN(e)||e<=0)throw new Error(`Unexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+t,2),65535),this.byteOffset=a;let n=e,h=n;this._levelBounds=[n*4];do n=Math.ceil(n/this.nodeSize),h+=n,this._levelBounds.push(h*4);while(n!==1);this.ArrayType=s,this.IndexArrayType=h<16384?Uint16Array:Uint32Array;const c=yt.indexOf(s),u=h*4*s.BYTES_PER_ELEMENT;if(c<0)throw new Error(`Unexpected typed array class: ${s}.`);if(o)this.data=o,this._boxes=new s(o,a+8,h*4),this._indices=new this.IndexArrayType(o,a+8+u,h),this._pos=h*4,this.minX=this._boxes[this._pos-4],this.minY=this._boxes[this._pos-3],this.maxX=this._boxes[this._pos-2],this.maxY=this._boxes[this._pos-1];else{const l=this.data=new r(8+u+h*this.IndexArrayType.BYTES_PER_ELEMENT);this._boxes=new s(l,8,h*4),this._indices=new this.IndexArrayType(l,8+u,h),this._pos=0,this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,new Uint8Array(l,0,2).set([251,(_e<<4)+c]),new Uint16Array(l,2,1)[0]=t,new Uint32Array(l,4,1)[0]=e}this._queue=new mo}add(e,t,s=e,r=t){const o=this._pos>>2,a=this._boxes;return this._indices[o]=o,a[this._pos++]=e,a[this._pos++]=t,a[this._pos++]=s,a[this._pos++]=r,e<this.minX&&(this.minX=e),t<this.minY&&(this.minY=t),s>this.maxX&&(this.maxX=s),r>this.maxY&&(this.maxY=r),o}finish(){if(this._pos>>2!==this.numItems)throw new Error(`Added ${this._pos>>2} items when expected ${this.numItems}.`);const e=this._boxes;if(this.numItems<=this.nodeSize){e[this._pos++]=this.minX,e[this._pos++]=this.minY,e[this._pos++]=this.maxX,e[this._pos++]=this.maxY;return}const t=this.maxX-this.minX||1,s=this.maxY-this.minY||1,r=new Uint32Array(this.numItems),o=65535;for(let a=0,n=0;a<this.numItems;a++){const h=e[n++],c=e[n++],u=e[n++],l=e[n++],d=Math.floor(o*((h+u)/2-this.minX)/t),m=Math.floor(o*((c+l)/2-this.minY)/s);r[a]=fo(d,m)}ve(r,e,this._indices,0,this.numItems-1,this.nodeSize);for(let a=0,n=0;a<this._levelBounds.length-1;a++){const h=this._levelBounds[a];for(;n<h;){const c=n;let u=e[n++],l=e[n++],d=e[n++],m=e[n++];for(let p=1;p<this.nodeSize&&n<h;p++)u=Math.min(u,e[n++]),l=Math.min(l,e[n++]),d=Math.max(d,e[n++]),m=Math.max(m,e[n++]);this._indices[this._pos>>2]=c,e[this._pos++]=u,e[this._pos++]=l,e[this._pos++]=d,e[this._pos++]=m}}}search(e,t,s,r,o){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let a=this._boxes.length-4;const n=[],h=[];for(;a!==void 0;){const c=Math.min(a+this.nodeSize*4,_t(a,this._levelBounds));for(let u=a;u<c;u+=4){const l=this._boxes[u];if(s<l)continue;const d=this._boxes[u+1];if(r<d)continue;const m=this._boxes[u+2];if(e>m)continue;const p=this._boxes[u+3];if(t>p)continue;const f=this._indices[u>>2]|0;a>=this.numItems*4?n.push(f):(o===void 0||o(f,l,d,m,p))&&h.push(f)}a=n.pop()}return h}neighbors(e,t,s=1/0,r=1/0,o){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let a=this._boxes.length-4;const n=this._queue,h=[],c=r*r;e:for(;a!==void 0;){const u=Math.min(a+this.nodeSize*4,_t(a,this._levelBounds));for(let l=a;l<u;l+=4){const d=this._indices[l>>2]|0,m=this._boxes[l],p=this._boxes[l+1],f=this._boxes[l+2],g=this._boxes[l+3],y=e<m?m-e:e>f?e-f:0,_=t<p?p-t:t>g?t-g:0,x=y*y+_*_;x>c||(a>=this.numItems*4?n.push(d<<1,x):(o===void 0||o(d))&&n.push((d<<1)+1,x))}for(;n.length&&n.peek()&1;)if(n.peekValue()>c||(h.push(n.pop()>>1),h.length===s))break e;a=n.length?n.pop()>>1:void 0}return n.clear(),h}}function _t(i,e){let t=0,s=e.length-1;for(;t<s;){const r=t+s>>1;e[r]>i?s=r:t=r+1}return e[t]}function ve(i,e,t,s,r,o){if(Math.floor(s/o)>=Math.floor(r/o))return;const a=i[s],n=i[s+r>>1],h=i[r];let c=h;const u=Math.max(a,n);h>u?c=u:u===a?c=Math.max(n,h):u===n&&(c=Math.max(a,h));let l=s-1,d=r+1;for(;;){do l++;while(i[l]<c);do d--;while(i[d]>c);if(l>=d)break;po(i,e,t,l,d)}ve(i,e,t,s,d,o),ve(i,e,t,d+1,r,o)}function po(i,e,t,s,r){const o=i[s];i[s]=i[r],i[r]=o;const a=4*s,n=4*r,h=e[a],c=e[a+1],u=e[a+2],l=e[a+3];e[a]=e[n],e[a+1]=e[n+1],e[a+2]=e[n+2],e[a+3]=e[n+3],e[n]=h,e[n+1]=c,e[n+2]=u,e[n+3]=l;const d=t[s];t[s]=t[r],t[r]=d}function fo(i,e){let t=i^e,s=65535^t,r=65535^(i|e),o=i&(e^65535),a=t|s>>1,n=t>>1^t,h=r>>1^s&o>>1^r,c=t&r>>1^o>>1^o;t=a,s=n,r=h,o=c,a=t&t>>2^s&s>>2,n=t&s>>2^s&(t^s)>>2,h^=t&r>>2^s&o>>2,c^=s&r>>2^(t^s)&o>>2,t=a,s=n,r=h,o=c,a=t&t>>4^s&s>>4,n=t&s>>4^s&(t^s)>>4,h^=t&r>>4^s&o>>4,c^=s&r>>4^(t^s)&o>>4,t=a,s=n,r=h,o=c,h^=t&r>>8^s&o>>8,c^=s&r>>8^(t^s)&o>>8,t=h^h>>1,s=c^c>>1;let u=i^e,l=s|65535^(u|t);return u=(u|u<<8)&16711935,u=(u|u<<4)&252645135,u=(u|u<<2)&858993459,u=(u|u<<1)&1431655765,l=(l|l<<8)&16711935,l=(l|l<<4)&252645135,l=(l|l<<2)&858993459,l=(l|l<<1)&1431655765,(l<<1|u)>>>0}class go extends Ne{sources;index;constructor(e,t){super(t),this.sources=e.map((r,o)=>({x:r.x===void 0?o:r.x,y:r.y===void 0?0:r.y,z:r.z===void 0?0:r.z,...r}));const s=new ke(e.length);for(const r of e){const[o,a,n,h]=r.bbox;s.add(o,a,n,h)}s.finish(),this.index=s}getTileIndices({viewport:e,maxZoom:t,minZoom:s}){if(e.zoom<(s??-1/0))return[];if(e.zoom>(t??1/0))return[];const r=e.getBounds();return this.index.search(...r).map(o=>this.sources[o])}}const yo={};class Oo extends j{static layerName="MosaicLayer";static defaultProps=yo;renderTileLayer(e,t){const{id:s,minZoom:r,maxZoom:o,extent:a,maxCacheByteSize:n,maxCacheSize:h,maxRequests:c}=this.props;class u extends go{constructor(d){super(e,d)}}return new he({id:`mosaic-layer-${s}`,TilesetClass:u,minZoom:r,maxZoom:o,extent:a,...n!==void 0&&{maxCacheByteSize:n},maxCacheSize:h,maxRequests:c,getTileData:async l=>{const d=l.index,{signal:m}=l,p=this.props.getSource&&await this.props.getSource(d,{signal:m});return{source:d,data:p,signal:m}},renderSubLayers:l=>{const{data:d}=l,{source:m,signal:p,data:f}=d;return t(m,{data:f,signal:p})}})}renderLayers(){const{sources:e,renderSource:t}=this.props;return!e||e.length===0?null:this.renderTileLayer(e,t)}}const Eo={...Hr};export{Ro as COGLayer,zo as GeoTIFFLayer,Oo as MosaicLayer,go as MosaicTileset2D,Eo as __TEST_EXPORTS,Vr as extractGeotiffReprojectors,Ft as fromGeoTransform,Kr as loadRgbImage,Zr as parseCOGTileMatrixSet,Xr as parseColormap,Po as proj,Io as texture};
