var O=Object.defineProperty,D=(n,t,e)=>t in n?O(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,p=(n,t,e)=>D(n,typeof t!="symbol"?t+"":t,e);class ${constructor(){p(this,"adapters",new Map),p(this,"changeListeners",[]),p(this,"unsubscribers",new Map)}register(t){if(this.adapters.set(t.type,t),t.onLayerChange){const e=t.onLayerChange((s,i)=>{this.notifyChange(s,i)});this.unsubscribers.set(t.type,e)}}unregister(t){const e=this.unsubscribers.get(t);e&&(e(),this.unsubscribers.delete(t)),this.adapters.delete(t)}getAllLayerIds(){const t=[];return this.adapters.forEach(e=>{t.push(...e.getLayerIds())}),t}hasLayer(t){for(const e of this.adapters.values())if(e.getLayerIds().includes(t))return!0;return!1}getAdapterForLayer(t){for(const e of this.adapters.values())if(e.getLayerIds().includes(t))return e;return null}getLayerState(t){const e=this.getAdapterForLayer(t);return e?e.getLayerState(t):null}setVisibility(t,e){const s=this.getAdapterForLayer(t);return s?(s.setVisibility(t,e),!0):!1}setOpacity(t,e){const s=this.getAdapterForLayer(t);return s?(s.setOpacity(t,e),!0):!1}getSymbolType(t){const e=this.getAdapterForLayer(t);return e&&e.getSymbolType?e.getSymbolType(t):null}getBounds(t){const e=this.getAdapterForLayer(t);return e&&e.getBounds?e.getBounds(t):null}getNativeLayerIds(t){const e=this.getAdapterForLayer(t);return e&&e.getNativeLayerIds?e.getNativeLayerIds(t):null}removeLayer(t){const e=this.getAdapterForLayer(t);return e&&e.removeLayer?(e.removeLayer(t),!0):!1}onChange(t){return this.changeListeners.push(t),()=>{const e=this.changeListeners.indexOf(t);e>=0&&this.changeListeners.splice(e,1)}}notifyChange(t,e){this.changeListeners.forEach(s=>s(t,e))}destroy(){this.unsubscribers.forEach(t=>t()),this.unsubscribers.clear(),this.adapters.clear(),this.changeListeners=[]}}function A(n){switch(n){case"fill":return"fill-opacity";case"line":return"line-opacity";case"circle":return"circle-opacity";case"symbol":return["icon-opacity","text-opacity"];case"raster":return"raster-opacity";case"background":return"background-opacity";case"heatmap":return"heatmap-opacity";case"fill-extrusion":return"fill-extrusion-opacity";case"hillshade":return"hillshade-exaggeration";case"color-relief":return null;default:return`${n}-opacity`}}function v(n,t,e){const s=A(e);if(s===null)return 1;if(Array.isArray(s)){const r=n.getPaintProperty(t,s[0]);return r??1}const i=n.getPaintProperty(t,s);return i??1}function P(n,t,e,s){const i=A(e);i!==null&&(Array.isArray(i)?i.forEach(r=>{n.setPaintProperty(t,r,s)}):n.setPaintProperty(t,i,s))}function M(n,t){try{const e=n.getLayer(t);return e?e.type:null}catch(e){return console.warn(`Failed to get layer type for ${t}:`,e),null}}function S(n){if(Array.isArray(n))return n.map(t=>S(t));if(n&&typeof n=="object")try{return JSON.parse(JSON.stringify(n))}catch{return n}return n}function B(n,t,e){var s;if(!e.has(t))try{const i=n.getLayer(t);if(!i)return;const r={},l=(s=n.getStyle().layers)==null?void 0:s.find(a=>a.id===t);i.type==="raster"?(Object.assign(r,{"raster-opacity":1,"raster-brightness-min":0,"raster-brightness-max":1,"raster-saturation":0,"raster-contrast":0,"raster-hue-rotate":0}),l&&"paint"in l&&l.paint&&Object.entries(l.paint).forEach(([o,d])=>{o.startsWith("raster-")&&(r[o]=S(d))})):l&&"paint"in l&&l.paint&&Object.entries(l.paint).forEach(([a,o])=>{r[a]=S(o)}),e.set(t,{paint:r})}catch(i){console.warn(`Failed to cache original style for ${t}:`,i)}}function N(n,t,e){const s=e.get(t);if(!s)return{};const i={};return Object.entries(s.paint).forEach(([r,c])=>{try{const l=S(c);n.setPaintProperty(t,r,l),i[r]=l}catch(l){console.warn(`Failed to restore ${r} for ${t}:`,l)}}),i}function k(n,t,e){const s=r=>Math.max(0,Math.min(255,Math.round(r))),i=r=>{const c=s(r).toString(16);return c.length===1?`0${c}`:c};return`#${i(n)}${i(t)}${i(e)}`}function L(n){if(typeof n=="string"){if(n.startsWith("#")){if(n.length===4){const t=n[1],e=n[2],s=n[3];return`#${t}${t}${e}${e}${s}${s}`}return n}if(n.startsWith("rgb")){const t=n.match(/\d+/g);if(t&&t.length>=3){const[e,s,i]=t.map(r=>parseInt(r,10));return k(e,s,i)}}}else if(Array.isArray(n)&&n.length>=3)return k(n[0],n[1],n[2]);return"#3388ff"}function w(n,t){let e=0;if(t&&Number(t)!==1){const s=Number(t);s>0&&s<1&&(e=Math.min(4,Math.ceil(Math.abs(Math.log10(s)))))}return n.toFixed(e)}const R={fill:["fill-color","fill-outline-color"],line:["line-color"],circle:["circle-color","circle-stroke-color"],symbol:["icon-color","text-color"],background:["background-color"],heatmap:["heatmap-color"],"fill-extrusion":["fill-extrusion-color"]};function x(n){if(!Array.isArray(n)||n.length===0)return null;for(const t of n)if(typeof t=="string"){if(t.startsWith("#")||t.startsWith("rgb")||t.startsWith("hsl"))return L(t)}else if(Array.isArray(t)){const e=x(t);if(e)return e}return null}function T(n,t,e){var s;const i=R[e];if(!i)return null;for(const r of i){try{const a=n.getPaintProperty(t,r);if(a){if(typeof a=="string")return L(a);if(Array.isArray(a)){const o=x(a);if(o)return o}}}catch{}const c=n.getStyle(),l=(s=c?.layers)==null?void 0:s.find(a=>a.id===t);if(l&&"paint"in l&&l.paint){const a=l.paint[r];if(a){if(typeof a=="string")return L(a);if(Array.isArray(a)){const o=x(a);if(o)return o}}}}return null}function F(n){const t=R[n.type];if(!t)return null;for(const e of t)if("paint"in n&&n.paint){const s=n.paint[e];if(s){if(typeof s=="string")return L(s);if(Array.isArray(s)){const i=x(s);if(i)return i}}}return null}function f(n,t){let e=n.replace("#","");e.length===3&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);const s=Math.max(0,parseInt(e.slice(0,2),16)-Math.round(255*t)),i=Math.max(0,parseInt(e.slice(2,4),16)-Math.round(255*t)),r=Math.max(0,parseInt(e.slice(4,6),16)-Math.round(255*t));return k(s,i,r)}function U(n,t){const s=f(t,.3);return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <rect x="2" y="2" width="${n-4}" height="${n-4}"
          fill="${t}" stroke="${s}" stroke-width="1" rx="1"/>
  </svg>`}function _(n,t,e=2){const s=n/2,i=2;return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <line x1="${i}" y1="${s}" x2="${n-i}" y2="${s}"
          stroke="${t}" stroke-width="${e}" stroke-linecap="round"/>
  </svg>`}function H(n,t){const e=n/2,s=n/2,i=n/2-3,r=f(t,.3);return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <circle cx="${e}" cy="${s}" r="${i}" fill="${t}"
            stroke="${r}" stroke-width="1"/>
  </svg>`}function q(n,t){const e=f(t,.3),s=n/2,i=n*.5,r=n*.7;return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <path d="M${s} ${n-2}
             L${s-i/2} ${n-r}
             A${i/2} ${i/2} 0 1 1 ${s+i/2} ${n-r}
             Z"
          fill="${t}" stroke="${e}" stroke-width="1"/>
    <circle cx="${s}" cy="${n-r-i/4}" r="${i/5}" fill="white"/>
  </svg>`}function V(n){const e=`rasterGrad_${Math.random().toString(36).slice(2,9)}`;return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="${e}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#e0e0e0"/>
        <stop offset="50%" stop-color="#808080"/>
        <stop offset="100%" stop-color="#404040"/>
      </linearGradient>
    </defs>
    <rect x="2" y="2" width="${n-4}" height="${n-4}"
          fill="url(#${e})" rx="1"/>
  </svg>`}function G(n,t){return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <rect x="1" y="1" width="${n-2}" height="${n-2}" fill="${t}" rx="2"/>
    <rect x="3" y="3" width="${n-6}" height="${n-6}" fill="none"
          stroke="white" stroke-width="1" stroke-opacity="0.5" rx="1"/>
  </svg>`}function j(n){const e=`heatmapGrad_${Math.random().toString(36).slice(2,9)}`;return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="${e}" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#ffff00"/>
        <stop offset="50%" stop-color="#ff8800"/>
        <stop offset="100%" stop-color="#ff0000"/>
      </radialGradient>
    </defs>
    <rect x="2" y="2" width="${n-4}" height="${n-4}"
          fill="url(#${e})" rx="1"/>
  </svg>`}function Y(n){const e=`hillshadeGrad_${Math.random().toString(36).slice(2,9)}`;return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="${e}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#ffffff"/>
        <stop offset="100%" stop-color="#666666"/>
      </linearGradient>
    </defs>
    <rect x="2" y="2" width="${n-4}" height="${n-4}"
          fill="url(#${e})" rx="1"/>
  </svg>`}function X(n,t){const e=f(t,.3),s=t,i=f(t,.2),r=3;return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <polygon points="${2+r},2 ${n-2},2 ${n-2},${n-2-r} ${n-2-r},${n-2} 2,${n-2} 2,${2+r}"
             fill="${s}" stroke="${e}" stroke-width="1"/>
    <polygon points="2,${2+r} ${2+r},2 ${2+r},${n-2-r} 2,${n-2}"
             fill="${i}" stroke="${e}" stroke-width="0.5"/>
    <polygon points="${2+r},${n-2-r} ${n-2},${n-2-r} ${n-2-r},${n-2} 2,${n-2}"
             fill="${i}" stroke="${e}" stroke-width="0.5"/>
  </svg>`}function J(n,t){const s=f(t,.3);return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <rect x="2" y="2" width="${n-4}" height="${n-4}"
          fill="${t}" stroke="${s}" stroke-width="1"/>
  </svg>`}function Z(n,t){const s=f(t,.3),i=(n-4)/2;return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <rect x="2" y="2" width="${i}" height="${i}" fill="${t}" stroke="${s}" stroke-width="0.5"/>
    <rect x="${2+i}" y="2" width="${i}" height="${i}" fill="${t}" stroke="${s}" stroke-width="0.5" opacity="0.8"/>
    <rect x="2" y="${2+i}" width="${i}" height="${i}" fill="${t}" stroke="${s}" stroke-width="0.5" opacity="0.6"/>
    <rect x="${2+i}" y="${2+i}" width="${i}" height="${i}" fill="${t}" stroke="${s}" stroke-width="0.5" opacity="0.4"/>
  </svg>`}function K(n,t){const s=f(t,.3),i=n-4;return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <rect x="4" y="2" width="${i-2}" height="${i-2}" fill="${f(t,.2)}" stroke="${s}" stroke-width="0.5" rx="1"/>
    <rect x="3" y="3" width="${i-2}" height="${i-2}" fill="${f(t,.1)}" stroke="${s}" stroke-width="0.5" rx="1"/>
    <rect x="2" y="4" width="${i-2}" height="${i-2}" fill="${t}" stroke="${s}" stroke-width="0.5" rx="1"/>
    <line x1="5" y1="7" x2="${2+i-5}" y2="7" stroke="${s}" stroke-width="0.5" opacity="0.5"/>
    <line x1="5" y1="10" x2="${2+i-5}" y2="10" stroke="${s}" stroke-width="0.5" opacity="0.5"/>
  </svg>`}function Q(n,t){const s=f(t,.3),i=`customRasterGrad_${Math.random().toString(36).slice(2,9)}`;return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="${i}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="${t}"/>
        <stop offset="100%" stop-color="${f(t,.4)}"/>
      </linearGradient>
    </defs>
    <rect x="2" y="2" width="${n-4}" height="${n-4}"
          fill="url(#${i})" stroke="${s}" stroke-width="1" rx="1"/>
    <line x1="${n/2}" y1="2" x2="${n/2}" y2="${n-2}" stroke="${s}" stroke-width="0.5" opacity="0.3"/>
    <line x1="2" y1="${n/2}" x2="${n-2}" y2="${n/2}" stroke="${s}" stroke-width="0.5" opacity="0.3"/>
  </svg>`}function W(n){const t=["#a8d4a8","#8ec4e8","#d4c4a8"],e="#666666";return`<svg width="${n}" height="${n}" viewBox="0 0 ${n} ${n}" xmlns="http://www.w3.org/2000/svg">
    <rect x="4" y="1" width="${n-6}" height="${n-6}" fill="${t[2]}" stroke="${e}" stroke-width="0.75" rx="1"/>
    <rect x="2" y="3" width="${n-6}" height="${n-6}" fill="${t[1]}" stroke="${e}" stroke-width="0.75" rx="1"/>
    <rect x="0" y="5" width="${n-6}" height="${n-6}" fill="${t[0]}" stroke="${e}" stroke-width="0.75" rx="1"/>
  </svg>`}function E(n,t,e={}){const s=e.size||16,i=e.strokeWidth||2,r=t||"#888888";switch(n){case"fill":return U(s,r);case"line":return _(s,r,i);case"circle":return H(s,r);case"symbol":return q(s,r);case"raster":return V(s);case"background":return G(s,r);case"heatmap":return j(s);case"hillshade":return Y(s);case"fill-extrusion":return X(s,r);case"background-group":return W(s);case"cog":return Z(s,r);case"zarr":return K(s,r);case"custom-raster":return Q(s,r);default:return J(s,r)}}function I(n=16){return W(n)}class z{constructor(t={}){p(this,"map"),p(this,"mapContainer"),p(this,"container"),p(this,"button"),p(this,"panel"),p(this,"resizeHandler",null),p(this,"mapResizeHandler",null),p(this,"state"),p(this,"targetLayers"),p(this,"styleEditors"),p(this,"initialSourceIds",null),p(this,"initialLayerIds",null),p(this,"minPanelWidth"),p(this,"maxPanelWidth"),p(this,"maxPanelHeight"),p(this,"showStyleEditor"),p(this,"showOpacitySlider"),p(this,"showLayerSymbol"),p(this,"excludeDrawnLayers"),p(this,"excludeLayerPatterns"),p(this,"customLayerRegistry",null),p(this,"customLayerUnsubscribe",null),p(this,"removedCustomLayerIds",new Set),p(this,"nativeLayerGroups",new Map),p(this,"basemapStyleUrl",null),p(this,"basemapLayerIds",null),p(this,"widthSliderEl",null),p(this,"widthThumbEl",null),p(this,"widthValueEl",null),p(this,"isWidthSliderActive",!1),p(this,"widthDragRectWidth",null),p(this,"widthDragStartX",null),p(this,"widthDragStartWidth",null),p(this,"widthFrame",null),p(this,"contextMenuEl",null),p(this,"enableContextMenu"),p(this,"enableDragAndDrop"),p(this,"onLayerRename"),p(this,"onLayerReorder"),p(this,"onLayerRemove"),this.minPanelWidth=t.panelMinWidth||240,this.maxPanelWidth=t.panelMaxWidth||420,this.maxPanelHeight=t.panelMaxHeight||600,this.showStyleEditor=t.showStyleEditor!==!1,this.showOpacitySlider=t.showOpacitySlider!==!1,this.showLayerSymbol=t.showLayerSymbol!==!1,this.excludeDrawnLayers=t.excludeDrawnLayers!==!1,this.excludeLayerPatterns=this.wildcardPatternsToRegex(t.excludeLayers||[]),this.enableContextMenu=t.enableContextMenu!==!1,this.enableDragAndDrop=t.enableDragAndDrop!==!1,this.onLayerRename=t.onLayerRename,this.onLayerReorder=t.onLayerReorder,this.onLayerRemove=t.onLayerRemove,this.state={collapsed:t.collapsed!==!1,panelWidth:t.panelWidth||350,activeStyleEditor:null,layerStates:t.layerStates||{},originalStyles:new Map,userInteractingWithSlider:!1,backgroundLegendOpen:!1,backgroundLayerVisibility:new Map,onlyRenderedFilter:!1,contextMenu:{visible:!1,targetLayerId:null,x:0,y:0},renamingLayerId:null,customLayerNames:new Map,drag:{active:!1,layerId:null,startY:0,currentY:0,placeholder:null,draggedElement:null},isStyleOperationInProgress:!1},this.targetLayers=t.layers||Object.keys(this.state.layerStates),this.styleEditors=new Map,t.customLayerAdapters&&t.customLayerAdapters.length>0&&(this.customLayerRegistry=new $,t.customLayerAdapters.forEach(e=>{this.customLayerRegistry.register(e)})),this.basemapStyleUrl=t.basemapStyleUrl||null}onAdd(t){this.map=t,this.mapContainer=t.getContainer();const e=this.map.getStyle();return e&&e.sources?this.initialSourceIds=new Set(Object.keys(e.sources)):this.initialSourceIds=new Set,e&&e.layers?this.initialLayerIds=new Set(e.layers.map(s=>s.id)):this.initialLayerIds=new Set,this.container=this.createContainer(),this.button=this.createToggleButton(),this.panel=this.createPanel(),this.container.appendChild(this.button),this.mapContainer.appendChild(this.panel),this.enableContextMenu&&(this.contextMenuEl=this.createContextMenu(),this.mapContainer.appendChild(this.contextMenuEl)),this.updateWidthDisplay(),this.setupEventListeners(),this.basemapStyleUrl&&!this.basemapLayerIds?this.fetchBasemapStyle().then(()=>{Object.keys(this.state.layerStates).length===0&&this.autoDetectLayers(),this.buildLayerItems()}).catch(s=>{console.warn("Failed to fetch basemap style, falling back to heuristic detection:",s),Object.keys(this.state.layerStates).length===0&&this.autoDetectLayers(),this.buildLayerItems()}):(Object.keys(this.state.layerStates).length===0&&this.autoDetectLayers(),this.buildLayerItems()),this.state.collapsed||requestAnimationFrame(()=>{this.updatePanelPosition()}),this.container}async fetchBasemapStyle(){if(this.basemapStyleUrl)try{const t=await fetch(this.basemapStyleUrl);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const e=await t.json();e&&Array.isArray(e.layers)?this.basemapLayerIds=new Set(e.layers.map(s=>s.id)):this.basemapLayerIds=new Set}catch(t){throw console.warn("Failed to fetch basemap style from URL:",this.basemapStyleUrl,t),t}}onRemove(){var t,e,s;this.customLayerUnsubscribe&&(this.customLayerUnsubscribe(),this.customLayerUnsubscribe=null),this.customLayerRegistry&&(this.customLayerRegistry.destroy(),this.customLayerRegistry=null),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.mapResizeHandler&&(this.map.off("resize",this.mapResizeHandler),this.mapResizeHandler=null),this.contextMenuEl&&((t=this.contextMenuEl.parentNode)==null||t.removeChild(this.contextMenuEl),this.contextMenuEl=null),this.cleanupDragState(),(e=this.panel.parentNode)==null||e.removeChild(this.panel),(s=this.container.parentNode)==null||s.removeChild(this.container)}autoDetectLayers(){const t=this.map.getStyle();if(!t||!t.layers)return;const e=t.layers.map(s=>s.id);if(this.targetLayers.length===0){const s=[],i=[],r=this.basemapLayerIds!==null&&this.basemapLayerIds.size>0,c=r?new Set:this.detectUserAddedSources();e.forEach(l=>{const a=this.map.getLayer(l);if(a){if(this.excludeDrawnLayers&&this.isDrawnLayer(l)){i.push(l);return}if(this.isExcludedByPattern(l)){i.push(l);return}if(r)this.basemapLayerIds.has(l)?i.push(l):s.push(l);else{const o=a.source;o&&c.has(o)?s.push(l):i.push(l)}}}),i.length>0&&(this.state.layerStates.Background={visible:!0,opacity:1,name:"Background"}),s.forEach(l=>{const a=this.map.getLayer(l);if(!a)return;const d=this.map.getLayoutProperty(l,"visibility")!=="none",h=a.type,u=v(this.map,l,h),y=this.generateFriendlyName(l);this.state.layerStates[l]={visible:d,opacity:u,name:y}})}else{const s=[],i=[];e.forEach(r=>{if(this.isExcludedByPattern(r)){i.push(r);return}this.targetLayers.includes(r)?s.push(r):i.push(r)}),i.length>0&&(this.state.layerStates.Background={visible:!0,opacity:1,name:"Background"}),s.forEach(r=>{const c=this.map.getLayer(r);if(!c)return;const a=this.map.getLayoutProperty(r,"visibility")!=="none",o=c.type,d=v(this.map,r,o),h=this.generateFriendlyName(r);this.state.layerStates[r]={visible:a,opacity:d,name:h}})}this.customLayerRegistry&&this.customLayerRegistry.getAllLayerIds().forEach(i=>{if(this.state.layerStates[i])return;const r=this.customLayerRegistry.getLayerState(i);r&&(this.state.layerStates[i]={visible:r.visible,opacity:r.opacity,name:r.name,isCustomLayer:!0,customLayerType:this.customLayerRegistry.getSymbolType(i)||void 0})}),this.targetLayers=Object.keys(this.state.layerStates)}detectUserAddedSources(){const t=new Set,e=this.map.getStyle();if(!e||!e.sources)return t;const s=new Set,i=["demotiles.maplibre.org","api.maptiler.com","tiles.stadiamaps.com","api.mapbox.com","basemaps.cartocdn.com","tiles.mapbox.com","a.basemaps.cartocdn.com","b.basemaps.cartocdn.com","c.basemaps.cartocdn.com","d.basemaps.cartocdn.com","tiles.arcgis.com","server.arcgisonline.com","services.arcgisonline.com"],r=e.sprite;if(r&&typeof r=="string")try{const c=new URL(r);s.add(c.hostname)}catch{}if(e.glyphs)try{const c=new URL(e.glyphs.replace("{fontstack}","x").replace("{range}","x"));s.add(c.hostname)}catch{}for(const[c,l]of Object.entries(e.sources)){if(this.initialSourceIds&&this.initialSourceIds.has(c))continue;const a=l,o=a.type;if(o==="image"||o==="video"||o==="canvas"){t.add(c);continue}if(o==="geojson"){if(a.data&&typeof a.data=="object")t.add(c);else if(a.data&&typeof a.data=="string")try{const d=new URL(a.data);i.some(u=>d.hostname.includes(u))||s.has(d.hostname)||t.add(c)}catch{t.add(c)}continue}if(o==="raster"||o==="raster-dem"||o==="vector"){const d=a.url||a.tiles&&a.tiles[0]||"";if(d)try{const u=new URL(d.replace(/{[^}]+}/g,"0")).hostname,y=i.some(g=>u===g||u.endsWith("."+g)),m=s.has(u);!y&&!m&&t.add(c)}catch{t.add(c)}}}return t}generateFriendlyName(t){let e=t.replace(/^(layer[-_]?|gl[-_]?)/,"");return e=e.replace(/[-_]/g," "),e=e.replace(/\b\w/g,s=>s.toUpperCase()),e||t}isDrawnLayer(t){return[/^gm[-_\s]/i,/^gl-draw[-_]/i,/^mapbox-gl-draw[-_]/i,/^terra-draw[-_]/i,/^maplibre-gl-draw[-_]/i,/^draw[-_]layer/i,/^measure-/i,/^pmtiles-source-/i,/^stac-search-footprints/i].some(s=>s.test(t))}wildcardPatternsToRegex(t){return t.map(e=>{const i=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");return new RegExp(`^${i}$`,"i")})}isExcludedByPattern(t){return this.excludeLayerPatterns.some(e=>e.test(t))}createContainer(){const t=document.createElement("div");return t.className="maplibregl-ctrl maplibregl-ctrl-group maplibregl-ctrl-layer-control",t}createToggleButton(){const t=document.createElement("button");t.type="button",t.title="Layer Control",t.setAttribute("aria-label","Layer Control");const e=document.createElement("span");return e.className="layer-control-icon",e.innerHTML='<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 3 3 8.25 12 13.5 21 8.25 12 3"></polygon><polyline points="3 12.75 12 18 21 12.75"></polyline><polyline points="3 17.25 12 22 21 17.25"></polyline></svg>',t.appendChild(e),t}createPanel(){const t=document.createElement("div");t.className="layer-control-panel",t.style.width=`${this.state.panelWidth}px`,t.style.maxHeight=`${this.maxPanelHeight}px`,this.state.collapsed||t.classList.add("expanded");const e=this.createPanelHeader();t.appendChild(e);const s=this.createActionButtons();return t.appendChild(s),t}getControlPosition(){const t=this.container.parentElement;return t?t.classList.contains("maplibregl-ctrl-top-left")?"top-left":t.classList.contains("maplibregl-ctrl-top-right")?"top-right":t.classList.contains("maplibregl-ctrl-bottom-left")?"bottom-left":t.classList.contains("maplibregl-ctrl-bottom-right")?"bottom-right":"top-right":"top-right"}updatePanelPosition(){if(!this.button||!this.panel||!this.mapContainer)return;const t=this.button.getBoundingClientRect(),e=this.mapContainer.getBoundingClientRect(),s=this.getControlPosition(),i=t.top-e.top,r=e.bottom-t.bottom,c=t.left-e.left,l=e.right-t.right,a=5;switch(this.panel.style.top="",this.panel.style.bottom="",this.panel.style.left="",this.panel.style.right="",s){case"top-left":this.panel.style.top=`${i+t.height+a}px`,this.panel.style.left=`${c}px`;break;case"top-right":this.panel.style.top=`${i+t.height+a}px`,this.panel.style.right=`${l}px`;break;case"bottom-left":this.panel.style.bottom=`${r+t.height+a}px`,this.panel.style.left=`${c}px`;break;case"bottom-right":this.panel.style.bottom=`${r+t.height+a}px`,this.panel.style.right=`${l}px`;break}}createActionButtons(){const t=document.createElement("div");t.className="layer-control-actions";const e=document.createElement("button");e.type="button",e.className="layer-control-action-btn",e.textContent="Show All",e.title="Show all layers",e.addEventListener("click",()=>this.setAllLayersVisibility(!0));const s=document.createElement("button");return s.type="button",s.className="layer-control-action-btn",s.textContent="Hide All",s.title="Hide all layers",s.addEventListener("click",()=>this.setAllLayersVisibility(!1)),t.appendChild(e),t.appendChild(s),t}setAllLayersVisibility(t){Object.keys(this.state.layerStates).forEach(e=>{this.toggleLayerVisibility(e,t);const s=this.panel.querySelector(`[data-layer-id="${e}"]`);if(s){const i=s.querySelector(".layer-control-checkbox");i&&(i.checked=t,i.indeterminate=!1)}})}createPanelHeader(){const t=document.createElement("div");t.className="layer-control-panel-header";const e=document.createElement("span");e.className="layer-control-panel-title",e.textContent="Layers",t.appendChild(e);const s=this.createWidthControl();return t.appendChild(s),t}createWidthControl(){const t=document.createElement("label");t.className="layer-control-width-control",t.title="Adjust layer panel width";const e=document.createElement("span");e.textContent="Width",t.appendChild(e);const s=document.createElement("div");s.className="layer-control-width-slider",s.setAttribute("role","slider"),s.setAttribute("aria-valuemin",String(this.minPanelWidth)),s.setAttribute("aria-valuemax",String(this.maxPanelWidth)),s.setAttribute("aria-valuenow",String(this.state.panelWidth)),s.setAttribute("aria-valuestep","10"),s.setAttribute("aria-label","Layer panel width"),s.tabIndex=0;const i=document.createElement("div");i.className="layer-control-width-track";const r=document.createElement("div");r.className="layer-control-width-thumb",s.appendChild(i),s.appendChild(r),this.widthSliderEl=s,this.widthThumbEl=r;const c=document.createElement("span");return c.className="layer-control-width-value",this.widthValueEl=c,t.appendChild(s),t.appendChild(c),this.updateWidthDisplay(),this.setupWidthSliderEvents(s),t}setupWidthSliderEvents(t){t.addEventListener("pointerdown",s=>{s.preventDefault();const i=t.getBoundingClientRect();this.widthDragRectWidth=i.width||1,this.widthDragStartX=s.clientX,this.widthDragStartWidth=this.state.panelWidth,this.isWidthSliderActive=!0,t.setPointerCapture(s.pointerId),this.updateWidthFromPointer(s,!0)}),t.addEventListener("pointermove",s=>{this.isWidthSliderActive&&this.updateWidthFromPointer(s)});const e=s=>{if(this.isWidthSliderActive){if(s.pointerId!==void 0)try{t.releasePointerCapture(s.pointerId)}catch{}this.isWidthSliderActive=!1,this.widthDragRectWidth=null,this.widthDragStartX=null,this.widthDragStartWidth=null,this.updateWidthDisplay()}};t.addEventListener("pointerup",e),t.addEventListener("pointercancel",e),t.addEventListener("lostpointercapture",e),t.addEventListener("keydown",s=>{let i=!0;const r=s.shiftKey?20:10;switch(s.key){case"ArrowLeft":case"ArrowDown":this.applyPanelWidth(this.state.panelWidth-r,!0);break;case"ArrowRight":case"ArrowUp":this.applyPanelWidth(this.state.panelWidth+r,!0);break;case"Home":this.applyPanelWidth(this.minPanelWidth,!0);break;case"End":this.applyPanelWidth(this.maxPanelWidth,!0);break;case"PageUp":this.applyPanelWidth(this.state.panelWidth+50,!0);break;case"PageDown":this.applyPanelWidth(this.state.panelWidth-50,!0);break;default:i=!1}i&&(s.preventDefault(),this.updateWidthDisplay())})}updateWidthFromPointer(t,e=!1){if(!this.widthSliderEl)return;const s=this.widthDragRectWidth||this.widthSliderEl.getBoundingClientRect().width||1,i=this.maxPanelWidth-this.minPanelWidth;let r;if(e){const c=this.widthSliderEl.getBoundingClientRect(),l=c.width>0?(t.clientX-c.left)/c.width:0,a=Math.min(1,Math.max(0,l));r=this.minPanelWidth+a*i,this.widthDragStartWidth=r,this.widthDragStartX=t.clientX}else{const c=t.clientX-(this.widthDragStartX||t.clientX);r=(this.widthDragStartWidth||this.state.panelWidth)+c/s*i}this.applyPanelWidth(r,this.isWidthSliderActive)}applyPanelWidth(t,e=!1){const s=Math.round(Math.min(this.maxPanelWidth,Math.max(this.minPanelWidth,t))),i=()=>{this.state.panelWidth=s;const r=`${s}px`;this.panel.style.width=r,this.updateWidthDisplay()};if(e){i();return}this.widthFrame&&cancelAnimationFrame(this.widthFrame),this.widthFrame=requestAnimationFrame(()=>{i(),this.widthFrame=null})}updateWidthDisplay(){if(this.widthValueEl&&(this.widthValueEl.textContent=`${this.state.panelWidth}px`),this.widthSliderEl){this.widthSliderEl.setAttribute("aria-valuenow",String(this.state.panelWidth));const t=(this.state.panelWidth-this.minPanelWidth)/(this.maxPanelWidth-this.minPanelWidth||1);if(this.widthThumbEl){const e=this.widthSliderEl.clientWidth;if(e===0){requestAnimationFrame(()=>this.updateWidthDisplay());return}const s=this.widthThumbEl.offsetWidth||14,r=Math.max(0,e-16-s),c=Math.min(1,Math.max(0,t)),l=8+r*c;this.widthThumbEl.style.left=`${l}px`}}}setupEventListeners(){this.button.addEventListener("click",()=>this.toggle()),document.addEventListener("click",t=>{const e=t.target;this.contextMenuEl&&this.state.contextMenu.visible&&(this.contextMenuEl.contains(e)||this.hideContextMenu()),!this.container.contains(e)&&!this.panel.contains(e)&&this.collapse()}),this.resizeHandler=()=>{this.state.collapsed||this.updatePanelPosition()},window.addEventListener("resize",this.resizeHandler),this.mapResizeHandler=()=>{this.state.collapsed||this.updatePanelPosition()},this.map.on("resize",this.mapResizeHandler),this.setupLayerChangeListeners()}setupLayerChangeListeners(){this.map.on("styledata",()=>{setTimeout(()=>{this.updateLayerStatesFromMap(),this.checkForNewLayers()},100)}),this.map.on("data",t=>{t.sourceDataType==="content"&&setTimeout(()=>{this.updateLayerStatesFromMap(),this.checkForNewLayers()},100)}),this.map.on("sourcedata",t=>{t.sourceDataType==="metadata"&&setTimeout(()=>{this.checkForNewLayers()},150)}),this.customLayerRegistry&&(this.customLayerUnsubscribe=this.customLayerRegistry.onChange((t,e)=>{t==="add"&&e&&this.removedCustomLayerIds.delete(e),setTimeout(()=>this.checkForNewLayers(),100)}))}toggle(){this.state.collapsed?this.expand():this.collapse()}expand(){this.state.collapsed=!1,this.panel.classList.add("expanded"),this.updatePanelPosition()}collapse(){this.state.collapsed=!0,this.panel.classList.remove("expanded")}buildLayerItems(){this.panel.querySelectorAll(".layer-control-item").forEach(e=>e.remove()),this.styleEditors.clear(),Object.entries(this.state.layerStates).forEach(([e,s])=>{(this.targetLayers.length===0||this.targetLayers.includes(e))&&this.addLayerItem(e,s)})}addLayerItem(t,e){const s=document.createElement("div");s.className="layer-control-item",s.setAttribute("data-layer-id",t);const i=document.createElement("div");if(i.className="layer-control-row",this.enableDragAndDrop)if(t==="Background"){const a=this.createDisabledDragHandle();i.appendChild(a)}else{const a=this.createDragHandle(t);i.appendChild(a)}const r=document.createElement("input");r.type="checkbox",r.className="layer-control-checkbox",r.checked=e.visible,r.addEventListener("change",()=>{this.toggleLayerVisibility(t,r.checked)});const c=this.state.customLayerNames.get(t)||e.name||t,l=document.createElement("span");if(l.className="layer-control-name",l.textContent=c,l.title=c,i.appendChild(r),this.showLayerSymbol)if(t==="Background"){const a=this.createBackgroundGroupSymbol();i.appendChild(a)}else{const a=this.createLayerSymbol(t);a&&i.appendChild(a)}if(i.appendChild(l),this.showOpacitySlider){const a=document.createElement("input");a.type="range",a.className="layer-control-opacity",a.min="0",a.max="1",a.step="0.01",a.value=String(e.opacity),a.title=`Opacity: ${Math.round(e.opacity*100)}%`,a.addEventListener("mousedown",()=>{this.state.userInteractingWithSlider=!0}),a.addEventListener("mouseup",()=>{this.state.userInteractingWithSlider=!1}),a.addEventListener("input",()=>{this.changeLayerOpacity(t,parseFloat(a.value)),a.title=`Opacity: ${Math.round(parseFloat(a.value)*100)}%`}),i.appendChild(a)}if(this.showStyleEditor)if(t==="Background"){const a=this.createBackgroundLegendButton();i.appendChild(a)}else{const a=this.createStyleButton(t);a&&i.appendChild(a)}s.appendChild(i),this.enableContextMenu&&t!=="Background"&&i.addEventListener("contextmenu",a=>{a.preventDefault(),a.stopPropagation(),this.showContextMenu(t,a.clientX,a.clientY)}),this.panel.appendChild(s)}createLayerSymbol(t){const e=this.state.layerStates[t];if(e?.isCustomLayer){const a=e.customLayerType||"custom-raster",d=E(a,"#4a90d9"),h=document.createElement("span");return h.className="layer-control-symbol",h.innerHTML=d,h.title=`Layer type: ${a}`,h}const s=this.map.getLayer(t);if(!s)return null;const i=s.type,r=T(this.map,t,i),c=E(i,r),l=document.createElement("span");return l.className="layer-control-symbol",l.innerHTML=c,l.title=`Layer type: ${i}`,l}createBackgroundLayerSymbol(t){const e=F(t),s=E(t.type,e,{size:14}),i=document.createElement("span");return i.className="background-legend-layer-symbol",i.innerHTML=s,i.title=`Layer type: ${t.type}`,i}createBackgroundGroupSymbol(){const t=I(16),e=document.createElement("span");return e.className="layer-control-symbol",e.innerHTML=t,e.title="Background layers",e}toggleLayerVisibility(t,e){var s;if(t==="Background"){this.toggleBackgroundVisibility(e);return}if(this.state.isStyleOperationInProgress=!0,this.state.layerStates[t]&&(this.state.layerStates[t].visible=e),(s=this.customLayerRegistry)!=null&&s.setVisibility(t,e)){setTimeout(()=>{this.state.isStyleOperationInProgress=!1},200);return}this.map.setLayoutProperty(t,"visibility",e?"visible":"none"),setTimeout(()=>{this.state.isStyleOperationInProgress=!1},200)}changeLayerOpacity(t,e){var s;if(t==="Background"){this.changeBackgroundOpacity(e);return}if(this.state.isStyleOperationInProgress=!0,this.state.layerStates[t]&&(this.state.layerStates[t].opacity=e),(s=this.customLayerRegistry)!=null&&s.setOpacity(t,e)){setTimeout(()=>{this.state.isStyleOperationInProgress=!1},200);return}const i=M(this.map,t);i&&P(this.map,t,i,e),setTimeout(()=>{this.state.isStyleOperationInProgress=!1},200)}isUserAddedLayer(t){if(this.state.layerStates[t]!==void 0&&t!=="Background")return!0;if(this.basemapLayerIds!==null&&this.basemapLayerIds.size>0)return!this.basemapLayerIds.has(t);if(this.initialLayerIds!==null&&!this.initialLayerIds.has(t))return!0;const e=this.map.getLayer(t);if(e){const s=e.source;if(s)return this.detectUserAddedSources().has(s)}return!1}toggleBackgroundVisibility(t){if(this.state.layerStates.Background&&(this.state.layerStates.Background.visible=t),(this.map.getStyle().layers||[]).forEach(s=>{this.isUserAddedLayer(s.id)||(this.state.backgroundLayerVisibility.set(s.id,t),this.map.setLayoutProperty(s.id,"visibility",t?"visible":"none"))}),this.state.backgroundLegendOpen){const s=this.panel.querySelector(".layer-control-background-legend");s&&s.querySelectorAll(".background-legend-checkbox").forEach(r=>{r.checked=t})}}changeBackgroundOpacity(t){this.state.layerStates.Background&&(this.state.layerStates.Background.opacity=t),(this.map.getStyle().layers||[]).forEach(s=>{if(!this.isUserAddedLayer(s.id)){const i=M(this.map,s.id);i&&P(this.map,s.id,i,t)}})}createBackgroundLegendButton(){const t=document.createElement("button");return t.className="layer-control-style-button layer-control-background-legend-button",t.innerHTML="&#9881;",t.title="Show background layer details",t.setAttribute("aria-label","Show background layer visibility controls"),t.setAttribute("aria-expanded",String(this.state.backgroundLegendOpen)),t.addEventListener("click",e=>{e.stopPropagation(),this.toggleBackgroundLegend()}),t}toggleBackgroundLegend(){this.state.backgroundLegendOpen?this.closeBackgroundLegend():this.openBackgroundLegend()}openBackgroundLegend(){this.state.activeStyleEditor&&this.closeStyleEditor(this.state.activeStyleEditor);const t=this.panel.querySelector('[data-layer-id="Background"]');if(!t)return;let e=t.querySelector(".layer-control-background-legend");if(e){const i=e.querySelector(".background-legend-layer-list");i&&this.populateBackgroundLayerList(i)}else e=this.createBackgroundLegendPanel(),t.appendChild(e);this.state.backgroundLegendOpen=!0;const s=t.querySelector(".layer-control-background-legend-button");s&&(s.setAttribute("aria-expanded","true"),s.classList.add("active")),setTimeout(()=>{e?.scrollIntoView({behavior:"smooth",block:"nearest"})},50)}closeBackgroundLegend(){const t=this.panel.querySelector('[data-layer-id="Background"]');if(!t)return;const e=t.querySelector(".layer-control-background-legend");e&&e.remove(),this.state.backgroundLegendOpen=!1;const s=t.querySelector(".layer-control-background-legend-button");s&&(s.setAttribute("aria-expanded","false"),s.classList.remove("active"))}createBackgroundLegendPanel(){const t=document.createElement("div");t.className="layer-control-background-legend";const e=document.createElement("div");e.className="background-legend-header";const s=document.createElement("span");s.className="background-legend-title",s.textContent="Background Layers";const i=document.createElement("button");i.className="background-legend-close",i.innerHTML="&times;",i.title="Close",i.addEventListener("click",u=>{u.stopPropagation(),this.closeBackgroundLegend()}),e.appendChild(s),e.appendChild(i);const r=document.createElement("div");r.className="background-legend-actions";const c=document.createElement("button");c.className="background-legend-action-btn",c.textContent="Show All",c.addEventListener("click",()=>this.setAllBackgroundLayersVisibility(!0));const l=document.createElement("button");l.className="background-legend-action-btn",l.textContent="Hide All",l.addEventListener("click",()=>this.setAllBackgroundLayersVisibility(!1)),r.appendChild(c),r.appendChild(l);const a=document.createElement("div");a.className="background-legend-filter";const o=document.createElement("input");o.type="checkbox",o.className="background-legend-filter-checkbox",o.id="background-legend-only-rendered",o.checked=this.state.onlyRenderedFilter,o.addEventListener("change",()=>{this.state.onlyRenderedFilter=o.checked;const u=t.querySelector(".background-legend-layer-list");u&&this.populateBackgroundLayerList(u)});const d=document.createElement("label");d.className="background-legend-filter-label",d.htmlFor="background-legend-only-rendered",d.textContent="Only rendered",a.appendChild(o),a.appendChild(d);const h=document.createElement("div");return h.className="background-legend-layer-list",this.populateBackgroundLayerList(h),t.appendChild(e),t.appendChild(r),t.appendChild(a),t.appendChild(h),t}isLayerRendered(t){try{const e=this.map.getLayer(t);return!e||this.map.getLayoutProperty(t,"visibility")==="none"?!1:e.type==="raster"||e.type==="hillshade"||e.type==="background"?!0:this.map.queryRenderedFeatures({layers:[t]}).length>0}catch{return!0}}populateBackgroundLayerList(t){if(t.innerHTML="",(this.map.getStyle().layers||[]).forEach(s=>{if(!this.isUserAddedLayer(s.id)){if(this.excludeDrawnLayers&&this.isDrawnLayer(s.id)||this.isExcludedByPattern(s.id)||this.state.onlyRenderedFilter&&!this.isLayerRendered(s.id))return;const i=document.createElement("div");i.className="background-legend-layer-row",i.setAttribute("data-background-layer-id",s.id);const r=document.createElement("input");r.type="checkbox",r.className="background-legend-checkbox";const l=this.map.getLayoutProperty(s.id,"visibility")!=="none";r.checked=l,this.state.backgroundLayerVisibility.set(s.id,l),r.addEventListener("change",()=>{this.toggleIndividualBackgroundLayer(s.id,r.checked)});const a=document.createElement("span");a.className="background-legend-layer-name",a.textContent=this.generateFriendlyName(s.id),a.title=s.id;const o=document.createElement("span");if(o.className="background-legend-layer-type",o.textContent=s.type,i.appendChild(r),this.showLayerSymbol){const d=this.createBackgroundLayerSymbol(s);d&&i.appendChild(d)}i.appendChild(a),i.appendChild(o),t.appendChild(i)}}),t.children.length===0){const s=document.createElement("p");s.className="background-legend-empty",s.textContent=this.state.onlyRenderedFilter?"No rendered layers in current view.":"No background layers found.",t.appendChild(s)}}toggleIndividualBackgroundLayer(t,e){this.state.backgroundLayerVisibility.set(t,e),this.map.setLayoutProperty(t,"visibility",e?"visible":"none"),this.updateBackgroundCheckboxState()}setAllBackgroundLayersVisibility(t){(this.map.getStyle().layers||[]).forEach(i=>{this.isUserAddedLayer(i.id)||(this.state.backgroundLayerVisibility.set(i.id,t),this.map.setLayoutProperty(i.id,"visibility",t?"visible":"none"))});const s=this.panel.querySelector(".layer-control-background-legend");s&&s.querySelectorAll(".background-legend-checkbox").forEach(r=>{r.checked=t}),this.updateBackgroundCheckboxState()}updateBackgroundCheckboxState(){const t=this.map.getStyle().layers||[];let e=!1,s=!0;t.forEach(r=>{if(!this.isUserAddedLayer(r.id)){const c=this.state.backgroundLayerVisibility.get(r.id);c===!0&&(e=!0),c===!1&&(s=!1)}});const i=this.panel.querySelector('[data-layer-id="Background"]');if(i){const r=i.querySelector(".layer-control-checkbox");r&&(r.checked=e,r.indeterminate=e&&!s)}this.state.layerStates.Background&&(this.state.layerStates.Background.visible=e)}createStyleButton(t){if(t==="Background")return null;const e=this.state.layerStates[t],s=e?.isCustomLayer===!0,i=document.createElement("button");return i.className="layer-control-style-button",i.innerHTML="&#9881;",s?(i.title="Layer info (style editing not available)",i.setAttribute("aria-label",`Layer info for ${t}`)):(i.title="Edit layer style",i.setAttribute("aria-label",`Edit style for ${t}`)),i.addEventListener("click",r=>{r.stopPropagation(),this.toggleStyleEditor(t)}),i}toggleStyleEditor(t){if(this.state.activeStyleEditor===t){this.closeStyleEditor(t);return}this.state.activeStyleEditor&&this.closeStyleEditor(this.state.activeStyleEditor),this.openStyleEditor(t)}openStyleEditor(t){var e;const s=this.panel.querySelector(`[data-layer-id="${t}"]`);if(!s)return;const i=this.state.layerStates[t];if(i?.isCustomLayer){const c=(e=this.customLayerRegistry)==null?void 0:e.getNativeLayerIds(t);if(c&&c.length>0){for(const o of c)this.state.originalStyles.has(o)||this.map.getLayer(o)&&B(this.map,o,this.state.originalStyles);const a=this.createNativeSubLayerStyleEditor(t,c);if(a){s.appendChild(a),this.styleEditors.set(t,a),this.state.activeStyleEditor=t,setTimeout(()=>{a.scrollIntoView({behavior:"smooth",block:"nearest"})},50);return}}const l=this.createCustomLayerInfoPanel(t);s.appendChild(l),this.styleEditors.set(t,l),this.state.activeStyleEditor=t,setTimeout(()=>{l.scrollIntoView({behavior:"smooth",block:"nearest"})},50);return}this.state.originalStyles.has(t)||this.map.getLayer(t)&&B(this.map,t,this.state.originalStyles);const r=this.createStyleEditor(t);r&&(s.appendChild(r),this.styleEditors.set(t,r),this.state.activeStyleEditor=t,setTimeout(()=>{r.scrollIntoView({behavior:"smooth",block:"nearest"})},50))}createCustomLayerInfoPanel(t){const e=document.createElement("div");e.className="layer-control-style-editor layer-control-custom-info";const s=document.createElement("div");s.className="style-editor-header";const i=document.createElement("span");i.className="style-editor-title",i.textContent="Layer Info";const r=document.createElement("button");r.className="style-editor-close",r.innerHTML="&times;",r.title="Close",r.addEventListener("click",h=>{h.stopPropagation(),this.closeStyleEditor(t)}),s.appendChild(i),s.appendChild(r);const c=document.createElement("div");c.className="style-editor-controls";const l=document.createElement("p");l.className="layer-control-custom-info-text",l.textContent="This is a custom layer. Style editing is not available for this layer type. Use the visibility toggle and opacity slider to control the layer.",c.appendChild(l);const a=document.createElement("div");a.className="style-editor-actions";const o=document.createElement("button");o.className="style-editor-button style-editor-button-remove",o.textContent="Remove",o.title="Remove layer from map",o.addEventListener("click",h=>{h.stopPropagation(),confirm("Are you sure you want to remove this layer?")&&(this.closeStyleEditor(t),this.removeLayer(t))});const d=document.createElement("button");return d.className="style-editor-button style-editor-button-close",d.textContent="Close",d.addEventListener("click",h=>{h.stopPropagation(),this.closeStyleEditor(t)}),a.appendChild(o),a.appendChild(d),e.appendChild(s),e.appendChild(c),e.appendChild(a),e}createNativeSubLayerStyleEditor(t,e){const s=new Map;for(const m of e){const g=this.map.getLayer(m);if(g){const b=g.type;s.has(b)||s.set(b,[]),s.get(b).push(m)}}if(s.size===0)return null;const i=document.createElement("div");i.className="layer-control-style-editor";const r=document.createElement("div");r.className="style-editor-header";const c=document.createElement("span");c.className="style-editor-title",c.textContent="Edit Style";const l=document.createElement("button");l.className="style-editor-close",l.innerHTML="&times;",l.title="Close",l.addEventListener("click",m=>{m.stopPropagation(),this.closeStyleEditor(t)}),r.appendChild(c),r.appendChild(l),i.appendChild(r);const a=document.createElement("div");a.className="style-editor-controls";const o={fill:"Fill",line:"Line",circle:"Circle",symbol:"Symbol",raster:"Raster"};for(const[m,g]of s){if(s.size>1){const C=document.createElement("div");C.className="style-editor-section-header",C.textContent=o[m]||m,a.appendChild(C)}const b=g[0];this.addStyleControlsForNativeGroup(a,g,b,m)}const d=document.createElement("div");d.className="style-editor-actions";const h=document.createElement("button");h.className="style-editor-button style-editor-button-reset",h.textContent="Reset",h.addEventListener("click",m=>{m.stopPropagation();for(const g of e)N(this.map,g,this.state.originalStyles);this.closeStyleEditor(t),this.openStyleEditor(t)});const u=document.createElement("button");u.className="style-editor-button style-editor-button-remove",u.textContent="Remove",u.title="Remove layer from map",u.addEventListener("click",m=>{m.stopPropagation(),confirm("Are you sure you want to remove this layer?")&&(this.closeStyleEditor(t),this.removeLayer(t))});const y=document.createElement("button");return y.className="style-editor-button style-editor-button-close",y.textContent="Close",y.addEventListener("click",m=>{m.stopPropagation(),this.closeStyleEditor(t)}),d.appendChild(h),d.appendChild(u),d.appendChild(y),i.appendChild(a),i.appendChild(d),i}addStyleControlsForNativeGroup(t,e,s,i){this.nativeLayerGroups.set(s,e),this.addStyleControlsForLayerType(t,s,i)}closeStyleEditor(t){const e=this.styleEditors.get(t);e&&(e.remove(),this.styleEditors.delete(t)),this.nativeLayerGroups.clear(),this.state.activeStyleEditor===t&&(this.state.activeStyleEditor=null)}createStyleEditor(t){const e=this.map.getLayer(t);if(!e)return null;const s=document.createElement("div");s.className="layer-control-style-editor";const i=document.createElement("div");i.className="style-editor-header";const r=document.createElement("span");r.className="style-editor-title",r.textContent="Edit Style";const c=document.createElement("button");c.className="style-editor-close",c.innerHTML="&times;",c.title="Close",c.addEventListener("click",y=>{y.stopPropagation(),this.closeStyleEditor(t)}),i.appendChild(r),i.appendChild(c);const l=document.createElement("div");l.className="style-editor-controls";const a=e.type;this.addStyleControlsForLayerType(l,t,a);const o=document.createElement("div");o.className="style-editor-actions";const d=document.createElement("button");d.className="style-editor-button style-editor-button-reset",d.textContent="Reset",d.addEventListener("click",y=>{y.stopPropagation(),this.resetLayerStyle(t)});const h=document.createElement("button");h.className="style-editor-button style-editor-button-remove",h.textContent="Remove",h.title="Remove layer from map",h.addEventListener("click",y=>{y.stopPropagation(),confirm("Are you sure you want to remove this layer?")&&(this.closeStyleEditor(t),this.removeLayer(t))});const u=document.createElement("button");return u.className="style-editor-button style-editor-button-close",u.textContent="Close",u.addEventListener("click",y=>{y.stopPropagation(),this.closeStyleEditor(t)}),o.appendChild(d),o.appendChild(h),o.appendChild(u),s.appendChild(i),s.appendChild(l),s.appendChild(o),s}addStyleControlsForLayerType(t,e,s){switch(s){case"fill":this.addFillControls(t,e);break;case"line":this.addLineControls(t,e);break;case"circle":this.addCircleControls(t,e);break;case"raster":this.addRasterControls(t,e);break;case"symbol":this.addSymbolControls(t,e);break;default:t.textContent=`Style controls for ${s} layers not yet implemented.`}}addFillControls(t,e){var s;const r=(s=this.map.getStyle().layers)==null?void 0:s.find(o=>o.id===e);let c;r&&"paint"in r&&r.paint&&"fill-color"in r.paint&&(c=r.paint["fill-color"]),c||(c=this.map.getPaintProperty(e,"fill-color")),this.createColorControl(t,e,"fill-color","Fill Color",L(c||"#088"));const l=this.map.getPaintProperty(e,"fill-opacity");l!==void 0&&typeof l=="number"&&this.createSliderControl(t,e,"fill-opacity","Fill Opacity",l,0,1,.05);const a=this.map.getPaintProperty(e,"fill-outline-color");a!==void 0&&this.createColorControl(t,e,"fill-outline-color","Outline Color",L(a))}addLineControls(t,e){var s;const r=(s=this.map.getStyle().layers)==null?void 0:s.find(d=>d.id===e);let c;r&&"paint"in r&&r.paint&&"line-color"in r.paint&&(c=r.paint["line-color"]),c||(c=this.map.getPaintProperty(e,"line-color")),this.createColorControl(t,e,"line-color","Line Color",L(c||"#000"));const l=this.map.getPaintProperty(e,"line-width");this.createSliderControl(t,e,"line-width","Line Width",typeof l=="number"?l:1,0,20,.5);const a=this.map.getPaintProperty(e,"line-opacity");a!==void 0&&typeof a=="number"&&this.createSliderControl(t,e,"line-opacity","Line Opacity",a,0,1,.05);const o=this.map.getPaintProperty(e,"line-blur");o!==void 0&&typeof o=="number"&&this.createSliderControl(t,e,"line-blur","Line Blur",o,0,5,.1)}addCircleControls(t,e){var s;const r=(s=this.map.getStyle().layers)==null?void 0:s.find(h=>h.id===e);let c;r&&"paint"in r&&r.paint&&"circle-color"in r.paint&&(c=r.paint["circle-color"]),c||(c=this.map.getPaintProperty(e,"circle-color")),this.createColorControl(t,e,"circle-color","Circle Color",L(c||"#000"));const l=this.map.getPaintProperty(e,"circle-radius");this.createSliderControl(t,e,"circle-radius","Radius",typeof l=="number"?l:5,0,40,.5);const a=this.map.getPaintProperty(e,"circle-opacity");a!==void 0&&typeof a=="number"&&this.createSliderControl(t,e,"circle-opacity","Opacity",a,0,1,.05);const o=this.map.getPaintProperty(e,"circle-stroke-color");o!==void 0&&this.createColorControl(t,e,"circle-stroke-color","Stroke Color",L(o));const d=this.map.getPaintProperty(e,"circle-stroke-width");d!==void 0&&typeof d=="number"&&this.createSliderControl(t,e,"circle-stroke-width","Stroke Width",d,0,10,.1)}addRasterControls(t,e){const s=this.map.getPaintProperty(e,"raster-opacity");this.createSliderControl(t,e,"raster-opacity","Opacity",typeof s=="number"?s:1,0,1,.05);const i=this.map.getPaintProperty(e,"raster-brightness-min");this.createSliderControl(t,e,"raster-brightness-min","Brightness Min",typeof i=="number"?i:0,-1,1,.05);const r=this.map.getPaintProperty(e,"raster-brightness-max");this.createSliderControl(t,e,"raster-brightness-max","Brightness Max",typeof r=="number"?r:1,-1,1,.05);const c=this.map.getPaintProperty(e,"raster-saturation");this.createSliderControl(t,e,"raster-saturation","Saturation",typeof c=="number"?c:0,-1,1,.05);const l=this.map.getPaintProperty(e,"raster-contrast");this.createSliderControl(t,e,"raster-contrast","Contrast",typeof l=="number"?l:0,-1,1,.05);const a=this.map.getPaintProperty(e,"raster-hue-rotate");this.createSliderControl(t,e,"raster-hue-rotate","Hue Rotate",typeof a=="number"?a:0,0,350,5)}addSymbolControls(t,e){const s=this.map.getPaintProperty(e,"text-color");s!==void 0&&this.createColorControl(t,e,"text-color","Text Color",L(s));const i=this.map.getPaintProperty(e,"text-opacity");i!==void 0&&typeof i=="number"&&this.createSliderControl(t,e,"text-opacity","Text Opacity",i,0,1,.05);const r=this.map.getPaintProperty(e,"icon-opacity");r!==void 0&&typeof r=="number"&&this.createSliderControl(t,e,"icon-opacity","Icon Opacity",r,0,1,.05)}createColorControl(t,e,s,i,r){const c=document.createElement("div");c.className="style-control-group";const l=document.createElement("label");l.className="style-control-label",l.textContent=i;const a=document.createElement("div");a.className="style-control-color-group";const o=document.createElement("input");o.type="color",o.className="style-control-color-picker",o.value=r,o.dataset.property=s;const d=document.createElement("input");d.type="text",d.className="style-control-color-value",d.value=r,d.readOnly=!0,o.addEventListener("input",()=>{const h=o.value;d.value=h;const u=this.nativeLayerGroups.get(e)||[e];for(const y of u)this.map.setPaintProperty(y,s,h)}),a.appendChild(o),a.appendChild(d),c.appendChild(l),c.appendChild(a),t.appendChild(c)}createSliderControl(t,e,s,i,r,c,l,a){const o=document.createElement("div");o.className="style-control-group";const d=document.createElement("label");d.className="style-control-label",d.textContent=i;const h=document.createElement("div");h.className="style-control-input-wrapper";const u=document.createElement("input");u.type="range",u.className="style-control-slider",u.min=String(c),u.max=String(l),u.step=String(a),u.value=String(r),u.dataset.property=s;const y=document.createElement("span");y.className="style-control-value",y.textContent=w(r,a),u.addEventListener("input",()=>{const m=parseFloat(u.value);y.textContent=w(m,a);const g=this.nativeLayerGroups.get(e)||[e];for(const b of g)this.map.setPaintProperty(b,s,m)}),h.appendChild(u),h.appendChild(y),o.appendChild(d),o.appendChild(h),t.appendChild(o)}resetLayerStyle(t){if(!this.state.originalStyles.get(t))return;N(this.map,t,this.state.originalStyles);const s=this.styleEditors.get(t);s&&(s.querySelectorAll(".style-control-slider").forEach(c=>{var l;const a=c.dataset.property;if(a){const o=this.map.getPaintProperty(t,a);if(o!==void 0&&typeof o=="number"){c.value=String(o);const d=(l=c.parentElement)==null?void 0:l.querySelector(".style-control-value");if(d){const h=parseFloat(c.step);d.textContent=w(o,h)}}}}),s.querySelectorAll(".style-control-color-picker").forEach(c=>{var l;const a=c.dataset.property;if(a){const o=this.map.getPaintProperty(t,a);if(o!==void 0){const d=L(o);c.value=d;const h=(l=c.parentElement)==null?void 0:l.querySelector(".style-control-color-value");h&&(h.textContent=d)}}}))}updateLayerStatesFromMap(){this.state.userInteractingWithSlider||Object.keys(this.state.layerStates).forEach(t=>{var e;try{if((e=this.state.layerStates[t])!=null&&e.isCustomLayer||t==="Background")return;const s=this.map.getLayer(t);if(!s)return;const r=this.map.getLayoutProperty(t,"visibility")!=="none",c=s.type,l=v(this.map,t,c);this.state.layerStates[t]&&(this.state.layerStates[t].visible=r,this.state.layerStates[t].opacity=l),this.updateUIForLayer(t,r,l)}catch(s){console.warn(`Failed to update state for layer ${t}:`,s)}})}updateUIForLayer(t,e,s){this.panel.querySelectorAll(".layer-control-item").forEach(r=>{if(r.dataset.layerId===t){const c=r.querySelector(".layer-control-checkbox"),l=r.querySelector(".layer-control-opacity");c&&(c.checked=e),l&&(l.value=String(s),l.title=`Opacity: ${Math.round(s*100)}%`)}})}checkForNewLayers(){if(!this.state.isStyleOperationInProgress)try{const t=this.map.getStyle();if(!t||!t.layers)return;const e=new Set(t.layers.map(a=>a.id)),s=this.targetLayers.length===0||this.targetLayers.length===1&&this.targetLayers[0]==="Background"||this.targetLayers.every(a=>a==="Background"||this.state.layerStates[a]),i=[],r=this.basemapLayerIds!==null&&this.basemapLayerIds.size>0,c=!r&&this.initialLayerIds!==null&&this.initialLayerIds.size>0;e.forEach(a=>{if(a!=="Background"&&!this.state.layerStates[a]){const o=this.map.getLayer(a);if(o){if(this.initialLayerIds!==null&&this.initialLayerIds.has(a))return;if(s){if(this.excludeDrawnLayers&&this.isDrawnLayer(a)||this.isExcludedByPattern(a)||!this.isUserAddedLayer(a))return;if(r){if(this.basemapLayerIds.has(a))return}else if(c){if(this.initialLayerIds.has(a)){const d=this.detectUserAddedSources(),h=o.source;if(!h||!d.has(h))return}}else{const d=this.detectUserAddedSources(),h=o.source;if(!h||!d.has(h))return}}i.push(a)}}});const l=[];if(Object.keys(this.state.layerStates).forEach(a=>{const o=this.state.layerStates[a];a!=="Background"&&!o.isCustomLayer&&!e.has(a)&&l.push(a)}),l.length>0&&l.forEach(a=>{delete this.state.layerStates[a];const o=this.panel.querySelector(`[data-layer-id="${a}"]`);o&&o.remove(),this.state.activeStyleEditor===a&&(this.state.activeStyleEditor=null),this.styleEditors.delete(a)}),i.length>0&&i.forEach(a=>{const o=this.map.getLayer(a);if(!o)return;const d=o.type,h=v(this.map,a,d),y=this.map.getLayoutProperty(a,"visibility")!=="none";this.state.layerStates[a]={visible:y,opacity:h,name:this.generateFriendlyName(a)},this.addLayerItem(a,this.state.layerStates[a])}),this.customLayerRegistry){const a=this.customLayerRegistry.getAllLayerIds();a.forEach(o=>{if(!this.state.layerStates[o]&&!this.removedCustomLayerIds.has(o)){const d=this.customLayerRegistry.getLayerState(o);d&&(this.state.layerStates[o]={visible:d.visible,opacity:d.opacity,name:d.name,isCustomLayer:!0,customLayerType:this.customLayerRegistry.getSymbolType(o)||void 0},this.addLayerItem(o,this.state.layerStates[o]))}}),Object.keys(this.state.layerStates).forEach(o=>{if(this.state.layerStates[o].isCustomLayer&&!a.includes(o)){delete this.state.layerStates[o];const h=this.panel.querySelector(`[data-layer-id="${o}"]`);h&&h.remove(),this.state.activeStyleEditor===o&&(this.state.activeStyleEditor=null),this.styleEditors.delete(o)}})}}catch(t){console.warn("Failed to check for new layers:",t)}}registerCustomAdapter(t){this.customLayerRegistry||(this.customLayerRegistry=new $,this.customLayerUnsubscribe=this.customLayerRegistry.onChange((e,s)=>{e==="add"&&s&&this.removedCustomLayerIds.delete(s),this.checkForNewLayers()})),this.customLayerRegistry.register(t),this.panel&&this.checkForNewLayers()}createContextMenu(){const t=document.createElement("div");t.className="layer-control-context-menu",t.style.display="none";const e=this.createContextMenuItem("Rename","",()=>{this.state.contextMenu.targetLayerId&&this.startRenaming(this.state.contextMenu.targetLayerId),this.hideContextMenu()}),s=this.createContextMenuItem("Zoom to Layer","",()=>{this.state.contextMenu.targetLayerId&&this.zoomToLayer(this.state.contextMenu.targetLayerId),this.hideContextMenu()}),i=document.createElement("div");i.className="context-menu-separator";const r=this.createContextMenuItem("Move Up","",()=>{this.state.contextMenu.targetLayerId&&this.moveLayerUp(this.state.contextMenu.targetLayerId),this.hideContextMenu()}),c=this.createContextMenuItem("Move to Top","",()=>{this.state.contextMenu.targetLayerId&&this.moveLayerToTop(this.state.contextMenu.targetLayerId),this.hideContextMenu()}),l=this.createContextMenuItem("Move Down","",()=>{this.state.contextMenu.targetLayerId&&this.moveLayerDown(this.state.contextMenu.targetLayerId),this.hideContextMenu()}),a=this.createContextMenuItem("Move to Bottom","",()=>{this.state.contextMenu.targetLayerId&&this.moveLayerToBottom(this.state.contextMenu.targetLayerId),this.hideContextMenu()}),o=document.createElement("div");o.className="context-menu-separator";const d=this.createContextMenuItem("Remove Layer","",()=>{this.state.contextMenu.targetLayerId&&this.removeLayer(this.state.contextMenu.targetLayerId),this.hideContextMenu()},!0);return t.appendChild(e),t.appendChild(s),t.appendChild(i),t.appendChild(r),t.appendChild(c),t.appendChild(l),t.appendChild(a),t.appendChild(o),t.appendChild(d),t}createContextMenuItem(t,e,s,i=!1){const r=document.createElement("div");r.className="context-menu-item"+(i?" context-menu-item-danger":"");const c=document.createElement("span");c.className="context-menu-item-icon",c.textContent=e;const l=document.createElement("span");return l.className="context-menu-item-label",l.textContent=t,r.appendChild(c),r.appendChild(l),r.addEventListener("click",a=>{a.stopPropagation(),s()}),r}showContextMenu(t,e,s){if(!this.contextMenuEl)return;this.state.contextMenu={visible:!0,targetLayerId:t,x:e,y:s};const i=this.mapContainer.getBoundingClientRect();let r=e-i.left,c=s-i.top;this.contextMenuEl.style.display="block";const l=this.contextMenuEl.getBoundingClientRect();r+l.width>i.width&&(r=i.width-l.width-5),c+l.height>i.height&&(c=i.height-l.height-5),this.contextMenuEl.style.left=`${r}px`,this.contextMenuEl.style.top=`${c}px`}hideContextMenu(){this.contextMenuEl&&(this.state.contextMenu={visible:!1,targetLayerId:null,x:0,y:0},this.contextMenuEl.style.display="none")}startRenaming(t){var e;const s=this.panel.querySelector(`[data-layer-id="${t}"]`);if(!s)return;const i=s.querySelector(".layer-control-name");if(!i)return;this.state.renamingLayerId=t;const r=this.state.customLayerNames.get(t)||((e=this.state.layerStates[t])==null?void 0:e.name)||t,c=document.createElement("input");c.type="text",c.className="layer-control-name-input",c.value=r;const l=()=>{var a;const o=c.value.trim()||r,d=r;o!==d&&(this.state.customLayerNames.set(t,o),this.state.layerStates[t]&&(this.state.layerStates[t].name=o),(a=this.onLayerRename)==null||a.call(this,t,d,o));const h=document.createElement("span");h.className="layer-control-name",h.textContent=o,h.title=o,c.replaceWith(h),this.state.renamingLayerId=null};c.addEventListener("blur",l),c.addEventListener("keydown",a=>{if(a.key==="Enter")a.preventDefault(),l();else if(a.key==="Escape"){a.preventDefault();const o=document.createElement("span");o.className="layer-control-name",o.textContent=r,o.title=r,c.replaceWith(o),this.state.renamingLayerId=null}}),i.replaceWith(c),c.focus(),c.select()}zoomToLayer(t){const e=this.state.layerStates[t];if(e?.isCustomLayer&&this.customLayerRegistry){const i=this.customLayerRegistry.getBounds(t);if(i){this.map.fitBounds(i,{padding:50});return}}const s=this.map.getLayer(t);if(s)try{const i=s.source;let r=i?this.map.querySourceFeatures(i):[];if(r.length===0&&(r=this.map.queryRenderedFeatures({layers:[t]})),r.length===0)return;let c=1/0,l=1/0,a=-1/0,o=-1/0;r.forEach(d=>{if(!d.geometry)return;const h=u=>{if(typeof u[0]=="number"){const[y,m]=u;c=Math.min(c,y),l=Math.min(l,m),a=Math.max(a,y),o=Math.max(o,m)}else u.forEach(h)};d.geometry.type==="Point"?h(d.geometry.coordinates):d.geometry.type==="LineString"||d.geometry.type==="MultiPoint"?d.geometry.coordinates.forEach(h):d.geometry.type==="Polygon"||d.geometry.type==="MultiLineString"?d.geometry.coordinates.forEach(u=>u.forEach(h)):d.geometry.type==="MultiPolygon"&&d.geometry.coordinates.forEach(u=>u.forEach(y=>y.forEach(h)))}),c!==1/0&&l!==1/0&&a!==-1/0&&o!==-1/0&&this.map.fitBounds([[c,l],[a,o]],{padding:50})}catch(i){console.warn(`Failed to zoom to layer ${t}:`,i)}}getUserLayerIdsInMapOrder(){const t=this.map.getStyle();if(!t?.layers)return[];const e=t.layers.map(l=>l.id),s=Object.keys(this.state.layerStates).filter(l=>l!=="Background"),i=s.filter(l=>e.includes(l)),r=s.filter(l=>{var a;return((a=this.state.layerStates[l])==null?void 0:a.isCustomLayer)&&!e.includes(l)}),c=i.sort((l,a)=>e.indexOf(a)-e.indexOf(l));return[...r,...c]}isMapLibreLayer(t){return this.map.getLayer(t)!==void 0}findNextMapLibreLayer(t,e,s){for(let i=e;s===1?i<t.length:i>=0;i+=s)if(this.isMapLibreLayer(t[i]))return t[i]}moveLayerUp(t){var e,s;const i=this.getUserLayerIdsInMapOrder(),r=i.indexOf(t);if(r<=0)return;if(!((e=this.state.layerStates[t])==null?void 0:e.isCustomLayer)&&this.isMapLibreLayer(t))try{const o=r>=2?this.findNextMapLibreLayer(i,r-2,-1):void 0;this.map.moveLayer(t,o)}catch{}const l={},a=[...i];[a[r],a[r-1]]=[a[r-1],a[r]],this.state.layerStates.Background&&(l.Background=this.state.layerStates.Background),a.forEach(o=>{this.state.layerStates[o]&&(l[o]=this.state.layerStates[o])}),this.state.layerStates=l,this.buildLayerItems(),(s=this.onLayerReorder)==null||s.call(this,this.getUserLayerIdsInMapOrder())}moveLayerToTop(t){var e,s;const i=this.getUserLayerIdsInMapOrder(),r=i.indexOf(t);if(r<=0)return;if(!((e=this.state.layerStates[t])==null?void 0:e.isCustomLayer)&&this.isMapLibreLayer(t))try{this.map.moveLayer(t)}catch{}const l={},a=[...i];a.splice(r,1),a.unshift(t),this.state.layerStates.Background&&(l.Background=this.state.layerStates.Background),a.forEach(o=>{this.state.layerStates[o]&&(l[o]=this.state.layerStates[o])}),this.state.layerStates=l,this.buildLayerItems(),(s=this.onLayerReorder)==null||s.call(this,this.getUserLayerIdsInMapOrder())}moveLayerDown(t){var e,s;const i=this.getUserLayerIdsInMapOrder(),r=i.indexOf(t);if(r<0||r>=i.length-1)return;if(!((e=this.state.layerStates[t])==null?void 0:e.isCustomLayer)&&this.isMapLibreLayer(t)){const o=this.findNextMapLibreLayer(i,r+1,1);if(o)try{this.map.moveLayer(t,o)}catch{}}const l={},a=[...i];[a[r],a[r+1]]=[a[r+1],a[r]],this.state.layerStates.Background&&(l.Background=this.state.layerStates.Background),a.forEach(o=>{this.state.layerStates[o]&&(l[o]=this.state.layerStates[o])}),this.state.layerStates=l,this.buildLayerItems(),(s=this.onLayerReorder)==null||s.call(this,this.getUserLayerIdsInMapOrder())}moveLayerToBottom(t){var e,s;const i=this.getUserLayerIdsInMapOrder();if(i.length<=1)return;const r=i.indexOf(t);if(r<0||r===i.length-1)return;if(!((e=this.state.layerStates[t])==null?void 0:e.isCustomLayer)&&this.isMapLibreLayer(t)){const o=this.findNextMapLibreLayer(i,i.length-1,-1);if(o&&o!==t)try{this.map.moveLayer(t,o)}catch{}}const l={},a=[...i];a.splice(r,1),a.push(t),this.state.layerStates.Background&&(l.Background=this.state.layerStates.Background),a.forEach(o=>{this.state.layerStates[o]&&(l[o]=this.state.layerStates[o])}),this.state.layerStates=l,this.buildLayerItems(),(s=this.onLayerReorder)==null||s.call(this,this.getUserLayerIdsInMapOrder())}removeLayer(t){var e,s;this.state.isStyleOperationInProgress=!0;const i=this.state.layerStates[t];i?.isCustomLayer&&this.customLayerRegistry&&(this.removedCustomLayerIds.add(t),this.customLayerRegistry.setVisibility(t,!1),this.customLayerRegistry.removeLayer(t));try{const c=this.map.getLayer(t);if(c){const l=c.source;if(this.map.removeLayer(t),l){const a=this.map.getStyle();if(!((e=a?.layers)==null?void 0:e.some(d=>d.source===l)))try{this.map.removeSource(l)}catch{}}}}catch(c){console.warn(`Failed to remove layer ${t}:`,c)}delete this.state.layerStates[t],this.state.customLayerNames.delete(t);const r=this.panel.querySelector(`[data-layer-id="${t}"]`);r&&r.remove(),(s=this.onLayerRemove)==null||s.call(this,t),setTimeout(()=>{this.state.isStyleOperationInProgress=!1},200)}createDragHandle(t){const e=document.createElement("div");return e.className="layer-control-drag-handle",e.innerHTML=`<svg viewBox="0 0 16 16" fill="currentColor">
      <circle cx="5" cy="3" r="1.5"/>
      <circle cx="11" cy="3" r="1.5"/>
      <circle cx="5" cy="8" r="1.5"/>
      <circle cx="11" cy="8" r="1.5"/>
      <circle cx="5" cy="13" r="1.5"/>
      <circle cx="11" cy="13" r="1.5"/>
    </svg>`,e.title="Drag to reorder",e.addEventListener("pointerdown",s=>{s.preventDefault(),s.stopPropagation(),this.startDrag(t,s)}),e}createDisabledDragHandle(){const t=document.createElement("div");return t.className="layer-control-drag-handle layer-control-drag-handle-disabled",t.innerHTML=`<svg viewBox="0 0 16 16" fill="currentColor">
      <circle cx="5" cy="3" r="1.5"/>
      <circle cx="11" cy="3" r="1.5"/>
      <circle cx="5" cy="8" r="1.5"/>
      <circle cx="11" cy="8" r="1.5"/>
      <circle cx="5" cy="13" r="1.5"/>
      <circle cx="11" cy="13" r="1.5"/>
    </svg>`,t}startDrag(t,e){var s;const i=this.panel.querySelector(`[data-layer-id="${t}"]`);if(!i)return;const r=i.getBoundingClientRect();this.state.drag={active:!0,layerId:t,startY:e.clientY,currentY:e.clientY,placeholder:null,draggedElement:null},this.panel.classList.add("dragging-active"),i.classList.add("dragging");const c=document.createElement("div");c.className="layer-control-drop-placeholder",c.style.height=`${r.height}px`,(s=i.parentNode)==null||s.insertBefore(c,i),this.state.drag.placeholder=c;const l=i.cloneNode(!0);l.classList.remove("dragging"),l.className="layer-control-item layer-control-item-dragging",l.style.width=`${r.width}px`,l.style.left=`${r.left}px`,l.style.top=`${r.top}px`,document.body.appendChild(l),this.state.drag.draggedElement=l;const a=d=>this.onDragMove(d),o=d=>{document.removeEventListener("pointermove",a),document.removeEventListener("pointerup",o),document.removeEventListener("pointercancel",o),this.endDrag(d)};document.addEventListener("pointermove",a),document.addEventListener("pointerup",o),document.addEventListener("pointercancel",o)}onDragMove(t){var e,s;if(!this.state.drag.active||!this.state.drag.draggedElement)return;const i=this.state.drag.placeholder;if(!i)return;const r=t.clientY-this.state.drag.startY,c=this.state.drag.draggedElement,l=parseFloat(c.style.top)||0;c.style.top=`${l+r}px`,this.state.drag.startY=t.clientY,this.state.drag.currentY=t.clientY;const a=Array.from(this.panel.querySelectorAll(".layer-control-item:not(.dragging)")).filter(o=>o.dataset.layerId!=="Background");for(const o of a){const d=o.getBoundingClientRect();if(t.clientY>=d.top&&t.clientY<=d.bottom){const h=d.top+d.height/2;t.clientY<h?i.nextSibling!==o&&((e=o.parentNode)==null||e.insertBefore(i,o)):i.previousSibling!==o&&((s=o.parentNode)==null||s.insertBefore(i,o.nextSibling));break}}}endDrag(t){var e;if(!this.state.drag.active)return;const s=this.state.drag.layerId,i=this.state.drag.placeholder,r=this.panel.querySelector(`[data-layer-id="${s}"]`);r&&i&&((e=i.parentNode)==null||e.insertBefore(r,i),r.classList.remove("dragging")),this.cleanupDragState(),this.applyUIOrderToMap()}cleanupDragState(){this.state.drag.draggedElement&&this.state.drag.draggedElement.remove(),this.state.drag.placeholder&&this.state.drag.placeholder.remove(),this.panel.classList.remove("dragging-active"),this.panel.querySelectorAll(".layer-control-item.dragging").forEach(t=>{t.classList.remove("dragging")}),this.state.drag={active:!1,layerId:null,startY:0,currentY:0,placeholder:null,draggedElement:null}}applyUIOrderToMap(){var t,e;this.state.isStyleOperationInProgress=!0;const s=this.panel.querySelectorAll(".layer-control-item"),i=[];s.forEach(a=>{const o=a.dataset.layerId;o&&o!=="Background"&&i.push(o)});const r=[...i].reverse(),c=this.map.getStyle(),l=new Set(((t=c?.layers)==null?void 0:t.map(a=>a.id))||[]);for(let a=0;a<r.length;a++){const o=r[a];if(!l.has(o))continue;let d;for(let h=a-1;h>=0;h--)if(l.has(r[h])){d=r[h];break}try{this.map.moveLayer(o,d)}catch{}}(e=this.onLayerReorder)==null||e.call(this,i),setTimeout(()=>{this.state.isStyleOperationInProgress=!1},200)}}export{z as L};
