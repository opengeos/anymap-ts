import{r as k}from"./utils-2CUC2toc.js";import{I as v}from"./icon-layer-3MvTvT3W.js";import{S as A}from"./scatterplot-layer-BGmV2bSt.js";import{T as M}from"./text-layer-DOd6HXhO.js";import{P as O}from"./path-layer-B8abEUIb.js";import{S as _}from"./solid-polygon-layer-MRV8xqxE.js";import{d as h}from"./mapbox-overlay-C46bI65L.js";import{C as z}from"./composite-layer-BGeqYk6R.js";function W(s,o){if(!s)return null;const e="startIndices"in s?s.startIndices[o]:o,t=s.featureIds.value[e];return e!==-1?F(s,t,e):null}function F(s,o,e){const t={properties:{...s.properties[o]}};for(const i in s.numericProps)t.properties[i]=s.numericProps[i].value[e];return t}function R(s,o){const e={points:null,lines:null,polygons:null};for(const t in e){const i=s[t].globalFeatureIds.value;e[t]=new Uint8ClampedArray(i.length*4);const n=[];for(let r=0;r<i.length;r++)o(i[r],n),e[t][r*4+0]=n[0],e[t][r*4+1]=n[1],e[t][r*4+2]=n[2],e[t][r*4+3]=255}return e}const P={circle:{type:A,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:v,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:M,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},x={type:O,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},S={type:_,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function y({type:s,props:o}){const e={};for(const t in o)e[t]=s.defaultProps[o[t]];return e}function L(s,o){const{transitions:e,updateTriggers:t}=s.props,i={updateTriggers:{},transitions:e&&{getPosition:e.geometry}};for(const n in o){const r=o[n];let a=s.props[n];n.startsWith("get")&&(a=s.getSubLayerAccessor(a),i.updateTriggers[r]=t[n],e&&(i.transitions[r]=e[n])),i[r]=a}return i}function w(s){if(Array.isArray(s))return s;switch(h.assert(s.type,"GeoJSON does not have type"),s.type){case"Feature":return[s];case"FeatureCollection":return h.assert(Array.isArray(s.features),"GeoJSON does not have features array"),s.features;default:return[{geometry:s}]}}function m(s,o,e={}){const t={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:i=0,endRow:n=s.length}=e;for(let r=i;r<n;r++){const a=s[r],{geometry:l}=a;if(l)if(l.type==="GeometryCollection"){h.assert(Array.isArray(l.geometries),"GeoJSON does not have geometries array");const{geometries:p}=l;for(let u=0;u<p.length;u++){const d=p[u];b(d,t,o,a,r)}}else b(l,t,o,a,r)}return t}function b(s,o,e,t,i){const{type:n,coordinates:r}=s,{pointFeatures:a,lineFeatures:l,polygonFeatures:p,polygonOutlineFeatures:u}=o;if(!B(n,r)){h.warn(`${n} coordinates are malformed`)();return}switch(n){case"Point":a.push(e({geometry:s},t,i));break;case"MultiPoint":r.forEach(d=>{a.push(e({geometry:{type:"Point",coordinates:d}},t,i))});break;case"LineString":l.push(e({geometry:s},t,i));break;case"MultiLineString":r.forEach(d=>{l.push(e({geometry:{type:"LineString",coordinates:d}},t,i))});break;case"Polygon":p.push(e({geometry:s},t,i)),r.forEach(d=>{u.push(e({geometry:{type:"LineString",coordinates:d}},t,i))});break;case"MultiPolygon":r.forEach(d=>{p.push(e({geometry:{type:"Polygon",coordinates:d}},t,i)),d.forEach(g=>{u.push(e({geometry:{type:"LineString",coordinates:g}},t,i))})});break}}const E={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function B(s,o){let e=E[s];for(h.assert(e,`Unknown GeoJSON type ${s}`);o&&--e>0;)o=o[0];return o&&Number.isFinite(o[0])}function C(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function f(s){return s.geometry.coordinates}function G(s,o){const e=C(),{pointFeatures:t,lineFeatures:i,polygonFeatures:n,polygonOutlineFeatures:r}=s;return e.points.data=t,e.points._dataDiff=o.pointFeatures&&(()=>o.pointFeatures),e.points.getPosition=f,e.lines.data=i,e.lines._dataDiff=o.lineFeatures&&(()=>o.lineFeatures),e.lines.getPath=f,e.polygons.data=n,e.polygons._dataDiff=o.polygonFeatures&&(()=>o.polygonFeatures),e.polygons.getPolygon=f,e.polygonsOutline.data=r,e.polygonsOutline._dataDiff=o.polygonOutlineFeatures&&(()=>o.polygonOutlineFeatures),e.polygonsOutline.getPath=f,e}function N(s,o){const e=C(),{points:t,lines:i,polygons:n}=s,r=R(s,o);e.points.data={length:t.positions.value.length/t.positions.size,attributes:{...t.attributes,getPosition:t.positions,instancePickingColors:{size:4,value:r.points}},properties:t.properties,numericProps:t.numericProps,featureIds:t.featureIds},e.lines.data={length:i.pathIndices.value.length-1,startIndices:i.pathIndices.value,attributes:{...i.attributes,getPath:i.positions,instancePickingColors:{size:4,value:r.lines}},properties:i.properties,numericProps:i.numericProps,featureIds:i.featureIds},e.lines._pathType="open";const a=n.positions.value.length/n.positions.size,l=Array(a).fill(1);for(const p of n.primitivePolygonIndices.value)l[p-1]=0;return e.polygons.data={length:n.polygonIndices.value.length-1,startIndices:n.polygonIndices.value,attributes:{...n.attributes,getPolygon:n.positions,instanceVertexValid:{size:1,value:new Uint16Array(l)},pickingColors:{size:4,value:r.polygons}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},e.polygons._normalize=!1,n.triangles&&(e.polygons.data.attributes.indices=n.triangles.value),e.polygonsOutline.data={length:n.primitivePolygonIndices.value.length-1,startIndices:n.primitivePolygonIndices.value,attributes:{...n.attributes,getPath:n.positions,instancePickingColors:{size:4,value:r.polygons}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},e.polygonsOutline._pathType="open",e}const U=["points","linestrings","polygons"],J={...y(P.circle),...y(P.icon),...y(P.text),...y(x),...y(S),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:s=>s.properties.icon},getText:{type:"accessor",value:s=>s.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class I extends z{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:o,changeFlags:e}){if(!e.dataChanged)return;const{data:t}=this.props,i=t&&"points"in t&&"polygons"in t&&"lines"in t;this.setState({binary:i}),i?this._updateStateBinary({props:o,changeFlags:e}):this._updateStateJSON({props:o,changeFlags:e})}_updateStateBinary({props:o,changeFlags:e}){const t=N(o.data,this.encodePickingColor);this.setState({layerProps:t})}_updateStateJSON({props:o,changeFlags:e}){const t=w(o.data),i=this.getSubLayerRow.bind(this);let n={};const r={};if(Array.isArray(e.dataChanged)){const l=this.state.features;for(const p in l)n[p]=l[p].slice(),r[p]=[];for(const p of e.dataChanged){const u=m(t,i,p);for(const d in l)r[d].push(k({data:n[d],getIndex:g=>g.__source.index,dataRange:p,replace:u[d]}))}}else n=m(t,i);const a=G(n,r);this.setState({features:n,featuresDiff:r,layerProps:a})}getPickingInfo(o){const e=super.getPickingInfo(o),{index:t,sourceLayer:i}=e;return e.featureType=U.find(n=>i.id.startsWith(`${this.id}-${n}-`)),t>=0&&i.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(e.index=this.props.data.points.globalFeatureIds.value[t]),e}_updateAutoHighlight(o){const e=`${this.id}-points-`,t=o.featureType==="points";for(const i of this.getSubLayers())i.id.startsWith(e)===t&&i.updateAutoHighlight(o)}_renderPolygonLayer(){var r;const{extruded:o,wireframe:e}=this.props,{layerProps:t}=this.state,i="polygons-fill",n=this.shouldRenderSubLayer(i,(r=t.polygons)==null?void 0:r.data)&&this.getSubLayerClass(i,S.type);if(n){const a=L(this,S.props),l=o&&e;return l||delete a.getLineColor,a.updateTriggers.lineColors=l,new n(a,this.getSubLayerProps({id:i,updateTriggers:a.updateTriggers}),t.polygons)}return null}_renderLineLayers(){var l,p;const{extruded:o,stroked:e}=this.props,{layerProps:t}=this.state,i="polygons-stroke",n="linestrings",r=!o&&e&&this.shouldRenderSubLayer(i,(l=t.polygonsOutline)==null?void 0:l.data)&&this.getSubLayerClass(i,x.type),a=this.shouldRenderSubLayer(n,(p=t.lines)==null?void 0:p.data)&&this.getSubLayerClass(n,x.type);if(r||a){const u=L(this,x.props);return[r&&new r(u,this.getSubLayerProps({id:i,updateTriggers:u.updateTriggers}),t.polygonsOutline),a&&new a(u,this.getSubLayerProps({id:n,updateTriggers:u.updateTriggers}),t.lines)]}return null}_renderPointLayers(){var a;const{pointType:o}=this.props,{layerProps:e,binary:t}=this.state;let{highlightedObjectIndex:i}=this.props;!t&&Number.isFinite(i)&&(i=e.points.data.findIndex(l=>l.__source.index===i));const n=new Set(o.split("+")),r=[];for(const l of n){const p=`points-${l}`,u=P[l],d=u&&this.shouldRenderSubLayer(p,(a=e.points)==null?void 0:a.data)&&this.getSubLayerClass(p,u.type);if(d){const g=L(this,u.props);let c=e.points;if(l==="text"&&t){const{instancePickingColors:$,...T}=c.data.attributes;c={...c,data:{...c.data,attributes:T}}}r.push(new d(g,this.getSubLayerProps({id:p,updateTriggers:g.updateTriggers,highlightedObjectIndex:i}),c))}}return r}renderLayers(){const{extruded:o}=this.props,e=this._renderPolygonLayer(),t=this._renderLineLayers(),i=this._renderPointLayers();return[!o&&e,t,i,o&&e]}getSubLayerAccessor(o){const{binary:e}=this.state;return!e||typeof o!="function"?super.getSubLayerAccessor(o):(t,i)=>{const{data:n,index:r}=i,a=W(n,r);return o(a,i)}}}I.layerName="GeoJsonLayer";I.defaultProps=J;export{I as G};
